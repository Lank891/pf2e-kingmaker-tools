(()=>{var e={6075:e=>{var t;self,t=()=>{return e={7629:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(9474),r=i(1687),o=i(8652),l=i(8160),c=i(3292),u=i(6354),d=i(8901),m=i(9708),h=i(6914),p=i(2294),f=i(6133),g=i(1152),y=i(8863),v=i(2036),b={Base:class{constructor(e){this.type=e,this.$_root=null,this._definition={},this._reset()}_reset(){this._ids=new p.Ids,this._preferences=null,this._refs=new f.Manager,this._cache=null,this._valids=null,this._invalids=null,this._flags={},this._rules=[],this._singleRules=new Map,this.$_terms={},this.$_temp={ruleset:null,whens:{}}}describe(){return s("function"==typeof m.describe,"Manifest functionality disabled"),m.describe(this)}allow(...e){return l.verifyFlat(e,"allow"),this._values(e,"_valids")}alter(e){s(e&&"object"==typeof e&&!Array.isArray(e),"Invalid targets argument"),s(!this._inRuleset(),"Cannot set alterations inside a ruleset");const t=this.clone();t.$_terms.alterations=t.$_terms.alterations||[];for(const i in e){const a=e[i];s("function"==typeof a,"Alteration adjuster for",i,"must be a function"),t.$_terms.alterations.push({target:i,adjuster:a})}return t.$_temp.ruleset=!1,t}artifact(e){return s(void 0!==e,"Artifact cannot be undefined"),s(!this._cache,"Cannot set an artifact with a rule cache"),this.$_setFlag("artifact",e)}cast(e){return s(!1===e||"string"==typeof e,"Invalid to value"),s(!1===e||this._definition.cast[e],"Type",this.type,"does not support casting to",e),this.$_setFlag("cast",!1===e?void 0:e)}default(e,t){return this._default("default",e,t)}description(e){return s(e&&"string"==typeof e,"Description must be a non-empty string"),this.$_setFlag("description",e)}empty(e){const t=this.clone();return void 0!==e&&(e=t.$_compile(e,{override:!1})),t.$_setFlag("empty",e,{clone:!1})}error(e){return s(e,"Missing error"),s(e instanceof Error||"function"==typeof e,"Must provide a valid Error object or a function"),this.$_setFlag("error",e)}example(e,t={}){return s(void 0!==e,"Missing example"),l.assertOptions(t,["override"]),this._inner("examples",e,{single:!0,override:t.override})}external(e,t){return"object"==typeof e&&(s(!t,"Cannot combine options with description"),t=e.description,e=e.method),s("function"==typeof e,"Method must be a function"),s(void 0===t||t&&"string"==typeof t,"Description must be a non-empty string"),this._inner("externals",{method:e,description:t},{single:!0})}failover(e,t){return this._default("failover",e,t)}forbidden(){return this.presence("forbidden")}id(e){return e?(s("string"==typeof e,"id must be a non-empty string"),s(/^[^\.]+$/.test(e),"id cannot contain period character"),this.$_setFlag("id",e)):this.$_setFlag("id",void 0)}invalid(...e){return this._values(e,"_invalids")}label(e){return s(e&&"string"==typeof e,"Label name must be a non-empty string"),this.$_setFlag("label",e)}meta(e){return s(void 0!==e,"Meta cannot be undefined"),this._inner("metas",e,{single:!0})}note(...e){s(e.length,"Missing notes");for(const t of e)s(t&&"string"==typeof t,"Notes must be non-empty strings");return this._inner("notes",e)}only(e=!0){return s("boolean"==typeof e,"Invalid mode:",e),this.$_setFlag("only",e)}optional(){return this.presence("optional")}prefs(e){s(e,"Missing preferences"),s(void 0===e.context,"Cannot override context"),s(void 0===e.externals,"Cannot override externals"),s(void 0===e.warnings,"Cannot override warnings"),s(void 0===e.debug,"Cannot override debug"),l.checkPreferences(e);const t=this.clone();return t._preferences=l.preferences(t._preferences,e),t}presence(e){return s(["optional","required","forbidden"].includes(e),"Unknown presence mode",e),this.$_setFlag("presence",e)}raw(e=!0){return this.$_setFlag("result",e?"raw":void 0)}result(e){return s(["raw","strip"].includes(e),"Unknown result mode",e),this.$_setFlag("result",e)}required(){return this.presence("required")}strict(e){const t=this.clone(),i=void 0!==e&&!e;return t._preferences=l.preferences(t._preferences,{convert:i}),t}strip(e=!0){return this.$_setFlag("result",e?"strip":void 0)}tag(...e){s(e.length,"Missing tags");for(const t of e)s(t&&"string"==typeof t,"Tags must be non-empty strings");return this._inner("tags",e)}unit(e){return s(e&&"string"==typeof e,"Unit name must be a non-empty string"),this.$_setFlag("unit",e)}valid(...e){l.verifyFlat(e,"valid");const t=this.allow(...e);return t.$_setFlag("only",!!t._valids,{clone:!1}),t}when(e,t){const i=this.clone();i.$_terms.whens||(i.$_terms.whens=[]);const a=c.when(i,e,t);if(!["any","link"].includes(i.type)){const e=a.is?[a]:a.switch;for(const t of e)s(!t.then||"any"===t.then.type||t.then.type===i.type,"Cannot combine",i.type,"with",t.then&&t.then.type),s(!t.otherwise||"any"===t.otherwise.type||t.otherwise.type===i.type,"Cannot combine",i.type,"with",t.otherwise&&t.otherwise.type)}return i.$_terms.whens.push(a),i.$_mutateRebuild()}cache(e){s(!this._inRuleset(),"Cannot set caching inside a ruleset"),s(!this._cache,"Cannot override schema cache"),s(void 0===this._flags.artifact,"Cannot cache a rule with an artifact");const t=this.clone();return t._cache=e||o.provider.provision(),t.$_temp.ruleset=!1,t}clone(){const e=Object.create(Object.getPrototypeOf(this));return this._assign(e)}concat(e){s(l.isSchema(e),"Invalid schema object"),s("any"===this.type||"any"===e.type||e.type===this.type,"Cannot merge type",this.type,"with another type:",e.type),s(!this._inRuleset(),"Cannot concatenate onto a schema with open ruleset"),s(!e._inRuleset(),"Cannot concatenate a schema with open ruleset");let t=this.clone();if("any"===this.type&&"any"!==e.type){const i=e.clone();for(const e of Object.keys(t))"type"!==e&&(i[e]=t[e]);t=i}t._ids.concat(e._ids),t._refs.register(e,f.toSibling),t._preferences=t._preferences?l.preferences(t._preferences,e._preferences):e._preferences,t._valids=v.merge(t._valids,e._valids,e._invalids),t._invalids=v.merge(t._invalids,e._invalids,e._valids);for(const i of e._singleRules.keys())t._singleRules.has(i)&&(t._rules=t._rules.filter((e=>e.keep||e.name!==i)),t._singleRules.delete(i));for(const i of e._rules)e._definition.rules[i.method].multi||t._singleRules.set(i.name,i),t._rules.push(i);if(t._flags.empty&&e._flags.empty){t._flags.empty=t._flags.empty.concat(e._flags.empty);const i=Object.assign({},e._flags);delete i.empty,r(t._flags,i)}else if(e._flags.empty){t._flags.empty=e._flags.empty;const i=Object.assign({},e._flags);delete i.empty,r(t._flags,i)}else r(t._flags,e._flags);for(const i in e.$_terms){const s=e.$_terms[i];s?t.$_terms[i]?t.$_terms[i]=t.$_terms[i].concat(s):t.$_terms[i]=s.slice():t.$_terms[i]||(t.$_terms[i]=s)}return this.$_root._tracer&&this.$_root._tracer._combine(t,[this,e]),t.$_mutateRebuild()}extend(e){return s(!e.base,"Cannot extend type with another base"),d.type(this,e)}extract(e){return e=Array.isArray(e)?e:e.split("."),this._ids.reach(e)}fork(e,t){s(!this._inRuleset(),"Cannot fork inside a ruleset");let i=this;for(let s of[].concat(e))s=Array.isArray(s)?s:s.split("."),i=i._ids.fork(s,t,i);return i.$_temp.ruleset=!1,i}rule(e){const t=this._definition;l.assertOptions(e,Object.keys(t.modifiers)),s(!1!==this.$_temp.ruleset,"Cannot apply rules to empty ruleset or the last rule added does not support rule properties");const i=null===this.$_temp.ruleset?this._rules.length-1:this.$_temp.ruleset;s(i>=0&&i<this._rules.length,"Cannot apply rules to empty ruleset");const n=this.clone();for(let r=i;r<n._rules.length;++r){const i=n._rules[r],o=a(i);for(const a in e)t.modifiers[a](o,e[a]),s(o.name===i.name,"Cannot change rule name");n._rules[r]=o,n._singleRules.get(o.name)===i&&n._singleRules.set(o.name,o)}return n.$_temp.ruleset=!1,n.$_mutateRebuild()}get ruleset(){s(!this._inRuleset(),"Cannot start a new ruleset without closing the previous one");const e=this.clone();return e.$_temp.ruleset=e._rules.length,e}get $(){return this.ruleset}tailor(e){e=[].concat(e),s(!this._inRuleset(),"Cannot tailor inside a ruleset");let t=this;if(this.$_terms.alterations)for(const{target:i,adjuster:a}of this.$_terms.alterations)e.includes(i)&&(t=a(t),s(l.isSchema(t),"Alteration adjuster for",i,"failed to return a schema object"));return t=t.$_modify({each:t=>t.tailor(e),ref:!1}),t.$_temp.ruleset=!1,t.$_mutateRebuild()}tracer(){return g.location?g.location(this):this}validate(e,t){return y.entry(e,this,t)}validateAsync(e,t){return y.entryAsync(e,this,t)}$_addRule(e){"string"==typeof e&&(e={name:e}),s(e&&"object"==typeof e,"Invalid options"),s(e.name&&"string"==typeof e.name,"Invalid rule name");for(const t in e)s("_"!==t[0],"Cannot set private rule properties");const t=Object.assign({},e);t._resolve=[],t.method=t.method||t.name;const i=this._definition.rules[t.method],a=t.args;s(i,"Unknown rule",t.method);const n=this.clone();if(a){s(1===Object.keys(a).length||Object.keys(a).length===this._definition.rules[t.name].args.length,"Invalid rule definition for",this.type,t.name);for(const e in a){let r=a[e];if(i.argsByName){const o=i.argsByName.get(e);if(o.ref&&l.isResolvable(r))t._resolve.push(e),n.$_mutateRegister(r);else if(o.normalize&&(r=o.normalize(r),a[e]=r),o.assert){const t=l.validateArg(r,e,o);s(!t,t,"or reference")}}void 0!==r?a[e]=r:delete a[e]}}return i.multi||(n._ruleRemove(t.name,{clone:!1}),n._singleRules.set(t.name,t)),!1===n.$_temp.ruleset&&(n.$_temp.ruleset=null),i.priority?n._rules.unshift(t):n._rules.push(t),n}$_compile(e,t){return c.schema(this.$_root,e,t)}$_createError(e,t,i,s,a,n={}){const r=!1!==n.flags?this._flags:{},o=n.messages?h.merge(this._definition.messages,n.messages):this._definition.messages;return new u.Report(e,t,i,r,o,s,a)}$_getFlag(e){return this._flags[e]}$_getRule(e){return this._singleRules.get(e)}$_mapLabels(e){return e=Array.isArray(e)?e:e.split("."),this._ids.labels(e)}$_match(e,t,i,s){(i=Object.assign({},i)).abortEarly=!0,i._externals=!1,t.snapshot();const a=!y.validate(e,this,t,i,s).errors;return t.restore(),a}$_modify(e){return l.assertOptions(e,["each","once","ref","schema"]),p.schema(this,e)||this}$_mutateRebuild(){return s(!this._inRuleset(),"Cannot add this rule inside a ruleset"),this._refs.reset(),this._ids.reset(),this.$_modify({each:(e,{source:t,name:i,path:s,key:a})=>{const n=this._definition[t][i]&&this._definition[t][i].register;!1!==n&&this.$_mutateRegister(e,{family:n,key:a})}}),this._definition.rebuild&&this._definition.rebuild(this),this.$_temp.ruleset=!1,this}$_mutateRegister(e,{family:t,key:i}={}){this._refs.register(e,t),this._ids.register(e,{key:i})}$_property(e){return this._definition.properties[e]}$_reach(e){return this._ids.reach(e)}$_rootReferences(){return this._refs.roots()}$_setFlag(e,t,i={}){s("_"===e[0]||!this._inRuleset(),"Cannot set flag inside a ruleset");const a=this._definition.flags[e]||{};if(n(t,a.default)&&(t=void 0),n(t,this._flags[e]))return this;const r=!1!==i.clone?this.clone():this;return void 0!==t?(r._flags[e]=t,r.$_mutateRegister(t)):delete r._flags[e],"_"!==e[0]&&(r.$_temp.ruleset=!1),r}$_parent(e,...t){return this[e][l.symbols.parent].call(this,...t)}$_validate(e,t,i){return y.validate(e,this,t,i)}_assign(e){e.type=this.type,e.$_root=this.$_root,e.$_temp=Object.assign({},this.$_temp),e.$_temp.whens={},e._ids=this._ids.clone(),e._preferences=this._preferences,e._valids=this._valids&&this._valids.clone(),e._invalids=this._invalids&&this._invalids.clone(),e._rules=this._rules.slice(),e._singleRules=a(this._singleRules,{shallow:!0}),e._refs=this._refs.clone(),e._flags=Object.assign({},this._flags),e._cache=null,e.$_terms={};for(const t in this.$_terms)e.$_terms[t]=this.$_terms[t]?this.$_terms[t].slice():null;e.$_super={};for(const t in this.$_super)e.$_super[t]=this._super[t].bind(e);return e}_bare(){const e=this.clone();e._reset();const t=e._definition.terms;for(const i in t){const s=t[i];e.$_terms[i]=s.init}return e.$_mutateRebuild()}_default(e,t,i={}){return l.assertOptions(i,"literal"),s(void 0!==t,"Missing",e,"value"),s("function"==typeof t||!i.literal,"Only function value supports literal option"),"function"==typeof t&&i.literal&&(t={[l.symbols.literal]:!0,literal:t}),this.$_setFlag(e,t)}_generate(e,t,i){if(!this.$_terms.whens)return{schema:this};const s=[],a=[];for(let n=0;n<this.$_terms.whens.length;++n){const r=this.$_terms.whens[n];if(r.concat){s.push(r.concat),a.push(`${n}.concat`);continue}const o=r.ref?r.ref.resolve(e,t,i):e,l=r.is?[r]:r.switch,c=a.length;for(let c=0;c<l.length;++c){const{is:u,then:d,otherwise:m}=l[c],h=`${n}${r.switch?"."+c:""}`;if(u.$_match(o,t.nest(u,`${h}.is`),i)){if(d){const n=t.localize([...t.path,`${h}.then`],t.ancestors,t.schemas),{schema:r,id:o}=d._generate(e,n,i);s.push(r),a.push(`${h}.then${o?`(${o})`:""}`);break}}else if(m){const n=t.localize([...t.path,`${h}.otherwise`],t.ancestors,t.schemas),{schema:r,id:o}=m._generate(e,n,i);s.push(r),a.push(`${h}.otherwise${o?`(${o})`:""}`);break}}if(r.break&&a.length>c)break}const n=a.join(", ");if(t.mainstay.tracer.debug(t,"rule","when",n),!n)return{schema:this};if(!t.mainstay.tracer.active&&this.$_temp.whens[n])return{schema:this.$_temp.whens[n],id:n};let r=this;this._definition.generate&&(r=this._definition.generate(this,e,t,i));for(const e of s)r=r.concat(e);return this.$_root._tracer&&this.$_root._tracer._combine(r,[this,...s]),this.$_temp.whens[n]=r,{schema:r,id:n}}_inner(e,t,i={}){s(!this._inRuleset(),`Cannot set ${e} inside a ruleset`);const a=this.clone();return a.$_terms[e]&&!i.override||(a.$_terms[e]=[]),i.single?a.$_terms[e].push(t):a.$_terms[e].push(...t),a.$_temp.ruleset=!1,a}_inRuleset(){return null!==this.$_temp.ruleset&&!1!==this.$_temp.ruleset}_ruleRemove(e,t={}){if(!this._singleRules.has(e))return this;const i=!1!==t.clone?this.clone():this;i._singleRules.delete(e);const s=[];for(let t=0;t<i._rules.length;++t){const a=i._rules[t];a.name!==e||a.keep?s.push(a):i._inRuleset()&&t<i.$_temp.ruleset&&--i.$_temp.ruleset}return i._rules=s,i}_values(e,t){l.verifyFlat(e,t.slice(1,-1));const i=this.clone(),a=e[0]===l.symbols.override;if(a&&(e=e.slice(1)),!i[t]&&e.length?i[t]=new v:a&&(i[t]=e.length?new v:null,i.$_mutateRebuild()),!i[t])return i;a&&i[t].override();for(const a of e){s(void 0!==a,"Cannot call allow/valid/invalid with undefined"),s(a!==l.symbols.override,"Override must be the first value");const e="_invalids"===t?"_valids":"_invalids";i[e]&&(i[e].remove(a),i[e].length||(s("_valids"===t||!i._flags.only,"Setting invalid value",a,"leaves schema rejecting all values due to previous valid rule"),i[e]=null)),i[t].add(a,i._refs)}return i}}};b.Base.prototype[l.symbols.any]={version:l.version,compile:c.compile,root:"$_root"},b.Base.prototype.isImmutable=!0,b.Base.prototype.deny=b.Base.prototype.invalid,b.Base.prototype.disallow=b.Base.prototype.invalid,b.Base.prototype.equal=b.Base.prototype.valid,b.Base.prototype.exist=b.Base.prototype.required,b.Base.prototype.not=b.Base.prototype.invalid,b.Base.prototype.options=b.Base.prototype.prefs,b.Base.prototype.preferences=b.Base.prototype.prefs,e.exports=new b.Base},8652:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(8160),r={max:1e3,supported:new Set(["undefined","boolean","number","string"])};t.provider={provision:e=>new r.Cache(e)},r.Cache=class{constructor(e={}){n.assertOptions(e,["max"]),s(void 0===e.max||e.max&&e.max>0&&isFinite(e.max),"Invalid max cache size"),this._max=e.max||r.max,this._map=new Map,this._list=new r.List}get length(){return this._map.size}set(e,t){if(null!==e&&!r.supported.has(typeof e))return;let i=this._map.get(e);if(i)return i.value=t,void this._list.first(i);i=this._list.unshift({key:e,value:t}),this._map.set(e,i),this._compact()}get(e){const t=this._map.get(e);if(t)return this._list.first(t),a(t.value)}_compact(){if(this._map.size>this._max){const e=this._list.pop();this._map.delete(e.key)}}},r.List=class{constructor(){this.tail=null,this.head=null}unshift(e){return e.next=null,e.prev=this.head,this.head&&(this.head.next=e),this.head=e,this.tail||(this.tail=e),e}first(e){e!==this.head&&(this._remove(e),this.unshift(e))}pop(){return this._remove(this.tail)}_remove(e){const{next:t,prev:i}=e;return t.prev=i,i&&(i.next=t),e===this.tail&&(this.tail=t),e.prev=null,e.next=null,e}}},8160:(e,t,i)=>{"use strict";const s=i(375),a=i(7916),n=i(5934);let r,o;const l={isoDate:/^(?:[-+]\d{2})?(?:\d{4}(?!\d{2}\b))(?:(-?)(?:(?:0[1-9]|1[0-2])(?:\1(?:[12]\d|0[1-9]|3[01]))?|W(?:[0-4]\d|5[0-2])(?:-?[1-7])?|(?:00[1-9]|0[1-9]\d|[12]\d{2}|3(?:[0-5]\d|6[1-6])))(?![T]$|[T][\d]+Z$)(?:[T\s](?:(?:(?:[01]\d|2[0-3])(?:(:?)[0-5]\d)?|24\:?00)(?:[.,]\d+(?!:))?)(?:\2[0-5]\d(?:[.,]\d+)?)?(?:[Z]|(?:[+-])(?:[01]\d|2[0-3])(?::?[0-5]\d)?)?)?)?$/};t.version=n.version,t.defaults={abortEarly:!0,allowUnknown:!1,artifacts:!1,cache:!0,context:null,convert:!0,dateFormat:"iso",errors:{escapeHtml:!1,label:"path",language:null,render:!0,stack:!1,wrap:{label:'"',array:"[]"}},externals:!0,messages:{},nonEnumerables:!1,noDefaults:!1,presence:"optional",skipFunctions:!1,stripUnknown:!1,warnings:!1},t.symbols={any:Symbol.for("@hapi/joi/schema"),arraySingle:Symbol("arraySingle"),deepDefault:Symbol("deepDefault"),errors:Symbol("errors"),literal:Symbol("literal"),override:Symbol("override"),parent:Symbol("parent"),prefs:Symbol("prefs"),ref:Symbol("ref"),template:Symbol("template"),values:Symbol("values")},t.assertOptions=function(e,t,i="Options"){s(e&&"object"==typeof e&&!Array.isArray(e),"Options must be of type object");const a=Object.keys(e).filter((e=>!t.includes(e)));s(0===a.length,`${i} contain unknown keys: ${a}`)},t.checkPreferences=function(e){o=o||i(3378);const t=o.preferences.validate(e);if(t.error)throw new a([t.error.details[0].message])},t.compare=function(e,t,i){switch(i){case"=":return e===t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}},t.default=function(e,t){return void 0===e?t:e},t.isIsoDate=function(e){return l.isoDate.test(e)},t.isNumber=function(e){return"number"==typeof e&&!isNaN(e)},t.isResolvable=function(e){return!!e&&(e[t.symbols.ref]||e[t.symbols.template])},t.isSchema=function(e,i={}){const a=e&&e[t.symbols.any];return!!a&&(s(i.legacy||a.version===t.version,"Cannot mix different versions of joi schemas"),!0)},t.isValues=function(e){return e[t.symbols.values]},t.limit=function(e){return Number.isSafeInteger(e)&&e>=0},t.preferences=function(e,s){r=r||i(6914),e=e||{},s=s||{};const a=Object.assign({},e,s);return s.errors&&e.errors&&(a.errors=Object.assign({},e.errors,s.errors),a.errors.wrap=Object.assign({},e.errors.wrap,s.errors.wrap)),s.messages&&(a.messages=r.compile(s.messages,e.messages)),delete a[t.symbols.prefs],a},t.tryWithPath=function(e,t,i={}){try{return e()}catch(e){throw void 0!==e.path?e.path=t+"."+e.path:e.path=t,i.append&&(e.message=`${e.message} (${e.path})`),e}},t.validateArg=function(e,i,{assert:s,message:a}){if(t.isSchema(s)){const t=s.validate(e);if(!t.error)return;return t.error.message}if(!s(e))return i?`${i} ${a}`:a},t.verifyFlat=function(e,t){for(const i of e)s(!Array.isArray(i),"Method no longer accepts array arguments:",t)}},3292:(e,t,i)=>{"use strict";const s=i(375),a=i(8160),n=i(6133),r={};t.schema=function(e,t,i={}){a.assertOptions(i,["appendPath","override"]);try{return r.schema(e,t,i)}catch(e){throw i.appendPath&&void 0!==e.path&&(e.message=`${e.message} (${e.path})`),e}},r.schema=function(e,t,i){s(void 0!==t,"Invalid undefined schema"),Array.isArray(t)&&(s(t.length,"Invalid empty array schema"),1===t.length&&(t=t[0]));const n=(t,...s)=>!1!==i.override?t.valid(e.override,...s):t.valid(...s);if(r.simple(t))return n(e,t);if("function"==typeof t)return e.custom(t);if(s("object"==typeof t,"Invalid schema content:",typeof t),a.isResolvable(t))return n(e,t);if(a.isSchema(t))return t;if(Array.isArray(t)){for(const i of t)if(!r.simple(i))return e.alternatives().try(...t);return n(e,...t)}return t instanceof RegExp?e.string().regex(t):t instanceof Date?n(e.date(),t):(s(Object.getPrototypeOf(t)===Object.getPrototypeOf({}),"Schema can only contain plain objects"),e.object().keys(t))},t.ref=function(e,t){return n.isRef(e)?e:n.create(e,t)},t.compile=function(e,i,n={}){a.assertOptions(n,["legacy"]);const o=i&&i[a.symbols.any];if(o)return s(n.legacy||o.version===a.version,"Cannot mix different versions of joi schemas:",o.version,a.version),i;if("object"!=typeof i||!n.legacy)return t.schema(e,i,{appendPath:!0});const l=r.walk(i);return l?l.compile(l.root,i):t.schema(e,i,{appendPath:!0})},r.walk=function(e){if("object"!=typeof e)return null;if(Array.isArray(e)){for(const t of e){const e=r.walk(t);if(e)return e}return null}const t=e[a.symbols.any];if(t)return{root:e[t.root],compile:t.compile};s(Object.getPrototypeOf(e)===Object.getPrototypeOf({}),"Schema can only contain plain objects");for(const t in e){const i=r.walk(e[t]);if(i)return i}return null},r.simple=function(e){return null===e||["boolean","string","number"].includes(typeof e)},t.when=function(e,i,o){if(void 0===o&&(s(i&&"object"==typeof i,"Missing options"),o=i,i=n.create(".")),Array.isArray(o)&&(o={switch:o}),a.assertOptions(o,["is","not","then","otherwise","switch","break"]),a.isSchema(i))return s(void 0===o.is,'"is" can not be used with a schema condition'),s(void 0===o.not,'"not" can not be used with a schema condition'),s(void 0===o.switch,'"switch" can not be used with a schema condition'),r.condition(e,{is:i,then:o.then,otherwise:o.otherwise,break:o.break});if(s(n.isRef(i)||"string"==typeof i,"Invalid condition:",i),s(void 0===o.not||void 0===o.is,'Cannot combine "is" with "not"'),void 0===o.switch){let l=o;void 0!==o.not&&(l={is:o.not,then:o.otherwise,otherwise:o.then,break:o.break});let c=void 0!==l.is?e.$_compile(l.is):e.$_root.invalid(null,!1,0,"").required();return s(void 0!==l.then||void 0!==l.otherwise,'options must have at least one of "then", "otherwise", or "switch"'),s(void 0===l.break||void 0===l.then||void 0===l.otherwise,"Cannot specify then, otherwise, and break all together"),void 0===o.is||n.isRef(o.is)||a.isSchema(o.is)||(c=c.required()),r.condition(e,{ref:t.ref(i),is:c,then:l.then,otherwise:l.otherwise,break:l.break})}s(Array.isArray(o.switch),'"switch" must be an array'),s(void 0===o.is,'Cannot combine "switch" with "is"'),s(void 0===o.not,'Cannot combine "switch" with "not"'),s(void 0===o.then,'Cannot combine "switch" with "then"');const l={ref:t.ref(i),switch:[],break:o.break};for(let t=0;t<o.switch.length;++t){const i=o.switch[t],r=t===o.switch.length-1;a.assertOptions(i,r?["is","then","otherwise"]:["is","then"]),s(void 0!==i.is,'Switch statement missing "is"'),s(void 0!==i.then,'Switch statement missing "then"');const c={is:e.$_compile(i.is),then:e.$_compile(i.then)};if(n.isRef(i.is)||a.isSchema(i.is)||(c.is=c.is.required()),r){s(void 0===o.otherwise||void 0===i.otherwise,'Cannot specify "otherwise" inside and outside a "switch"');const t=void 0!==o.otherwise?o.otherwise:i.otherwise;void 0!==t&&(s(void 0===l.break,"Cannot specify both otherwise and break"),c.otherwise=e.$_compile(t))}l.switch.push(c)}return l},r.condition=function(e,t){for(const i of["then","otherwise"])void 0===t[i]?delete t[i]:t[i]=e.$_compile(t[i]);return t}},6354:(e,t,i)=>{"use strict";const s=i(5688),a=i(8160),n=i(3328);t.Report=class{constructor(e,i,s,a,n,r,o){if(this.code=e,this.flags=a,this.messages=n,this.path=r.path,this.prefs=o,this.state=r,this.value=i,this.message=null,this.template=null,this.local=s||{},this.local.label=t.label(this.flags,this.state,this.prefs,this.messages),void 0===this.value||this.local.hasOwnProperty("value")||(this.local.value=this.value),this.path.length){const e=this.path[this.path.length-1];"object"!=typeof e&&(this.local.key=e)}}_setTemplate(e){if(this.template=e,!this.flags.label&&0===this.path.length){const e=this._template(this.template,"root");e&&(this.local.label=e)}}toString(){if(this.message)return this.message;const e=this.code;if(!this.prefs.errors.render)return this.code;const t=this._template(this.template)||this._template(this.prefs.messages)||this._template(this.messages);return void 0===t?`Error code "${e}" is not defined, your custom type is missing the correct messages definition`:(this.message=t.render(this.value,this.state,this.prefs,this.local,{errors:this.prefs.errors,messages:[this.prefs.messages,this.messages]}),this.prefs.errors.label||(this.message=this.message.replace(/^"" /,"").trim()),this.message)}_template(e,i){return t.template(this.value,e,i||this.code,this.state,this.prefs)}},t.path=function(e){let t="";for(const i of e)"object"!=typeof i&&("string"==typeof i?(t&&(t+="."),t+=i):t+=`[${i}]`);return t},t.template=function(e,t,i,s,r){if(!t)return;if(n.isTemplate(t))return"root"!==i?t:null;let o=r.errors.language;if(a.isResolvable(o)&&(o=o.resolve(e,s,r)),o&&t[o]){if(void 0!==t[o][i])return t[o][i];if(void 0!==t[o]["*"])return t[o]["*"]}return t[i]?t[i]:t["*"]},t.label=function(e,i,s,a){if(!s.errors.label)return"";if(e.label)return e.label;let n=i.path;return"key"===s.errors.label&&i.path.length>1&&(n=i.path.slice(-1)),t.path(n)||t.template(null,s.messages,"root",i,s)||a&&t.template(null,a,"root",i,s)||"value"},t.process=function(e,i,s){if(!e)return null;const{override:a,message:n,details:r}=t.details(e);if(a)return a;if(s.errors.stack)return new t.ValidationError(n,r,i);const o=Error.stackTraceLimit;Error.stackTraceLimit=0;const l=new t.ValidationError(n,r,i);return Error.stackTraceLimit=o,l},t.details=function(e,t={}){let i=[];const s=[];for(const a of e){if(a instanceof Error){if(!1!==t.override)return{override:a};const e=a.toString();i.push(e),s.push({message:e,type:"override",context:{error:a}});continue}const e=a.toString();i.push(e),s.push({message:e,path:a.path.filter((e=>"object"!=typeof e)),type:a.code,context:a.local})}return i.length>1&&(i=[...new Set(i)]),{message:i.join(". "),details:s}},t.ValidationError=class extends Error{constructor(e,t,i){super(e),this._original=i,this.details=t}static isError(e){return e instanceof t.ValidationError}},t.ValidationError.prototype.isJoi=!0,t.ValidationError.prototype.name="ValidationError",t.ValidationError.prototype.annotate=s.error},8901:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(8160),r=i(6914),o={};t.type=function(e,t){const i=Object.getPrototypeOf(e),l=a(i),c=e._assign(Object.create(l)),u=Object.assign({},t);delete u.base,l._definition=u;const d=i._definition||{};u.messages=r.merge(d.messages,u.messages),u.properties=Object.assign({},d.properties,u.properties),c.type=u.type,u.flags=Object.assign({},d.flags,u.flags);const m=Object.assign({},d.terms);if(u.terms)for(const e in u.terms){const t=u.terms[e];s(void 0===c.$_terms[e],"Invalid term override for",u.type,e),c.$_terms[e]=t.init,m[e]=t}u.terms=m,u.args||(u.args=d.args),u.prepare=o.prepare(u.prepare,d.prepare),u.coerce&&("function"==typeof u.coerce&&(u.coerce={method:u.coerce}),u.coerce.from&&!Array.isArray(u.coerce.from)&&(u.coerce={method:u.coerce.method,from:[].concat(u.coerce.from)})),u.coerce=o.coerce(u.coerce,d.coerce),u.validate=o.validate(u.validate,d.validate);const h=Object.assign({},d.rules);if(u.rules)for(const e in u.rules){const t=u.rules[e];s("object"==typeof t,"Invalid rule definition for",u.type,e);let i=t.method;if(void 0===i&&(i=function(){return this.$_addRule(e)}),i&&(s(!l[e],"Rule conflict in",u.type,e),l[e]=i),s(!h[e],"Rule conflict in",u.type,e),h[e]=t,t.alias){const e=[].concat(t.alias);for(const i of e)l[i]=t.method}t.args&&(t.argsByName=new Map,t.args=t.args.map((e=>("string"==typeof e&&(e={name:e}),s(!t.argsByName.has(e.name),"Duplicated argument name",e.name),n.isSchema(e.assert)&&(e.assert=e.assert.strict().label(e.name)),t.argsByName.set(e.name,e),e))))}u.rules=h;const p=Object.assign({},d.modifiers);if(u.modifiers)for(const e in u.modifiers){s(!l[e],"Rule conflict in",u.type,e);const t=u.modifiers[e];s("function"==typeof t,"Invalid modifier definition for",u.type,e);const i=function(t){return this.rule({[e]:t})};l[e]=i,p[e]=t}if(u.modifiers=p,u.overrides){l._super=i,c.$_super={};for(const e in u.overrides)s(i[e],"Cannot override missing",e),u.overrides[e][n.symbols.parent]=i[e],c.$_super[e]=i[e].bind(c);Object.assign(l,u.overrides)}u.cast=Object.assign({},d.cast,u.cast);const f=Object.assign({},d.manifest,u.manifest);return f.build=o.build(u.manifest&&u.manifest.build,d.manifest&&d.manifest.build),u.manifest=f,u.rebuild=o.rebuild(u.rebuild,d.rebuild),c},o.build=function(e,t){return e&&t?function(i,s){return t(e(i,s),s)}:e||t},o.coerce=function(e,t){return e&&t?{from:e.from&&t.from?[...new Set([...e.from,...t.from])]:null,method(i,s){let a;if((!t.from||t.from.includes(typeof i))&&(a=t.method(i,s),a)){if(a.errors||void 0===a.value)return a;i=a.value}if(!e.from||e.from.includes(typeof i)){const t=e.method(i,s);if(t)return t}return a}}:e||t},o.prepare=function(e,t){return e&&t?function(i,s){const a=e(i,s);if(a){if(a.errors||void 0===a.value)return a;i=a.value}return t(i,s)||a}:e||t},o.rebuild=function(e,t){return e&&t?function(i){t(i),e(i)}:e||t},o.validate=function(e,t){return e&&t?function(i,s){const a=t(i,s);if(a){if(a.errors&&(!Array.isArray(a.errors)||a.errors.length))return a;i=a.value}return e(i,s)||a}:e||t}},5107:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(8652),r=i(8160),o=i(3292),l=i(6354),c=i(8901),u=i(9708),d=i(6133),m=i(3328),h=i(1152);let p;const f={types:{alternatives:i(4946),any:i(8068),array:i(546),boolean:i(4937),date:i(7500),function:i(390),link:i(8785),number:i(3832),object:i(8966),string:i(7417),symbol:i(8826)},aliases:{alt:"alternatives",bool:"boolean",func:"function"},root:function(){const e={_types:new Set(Object.keys(f.types))};for(const t of e._types)e[t]=function(...e){return s(!e.length||["alternatives","link","object"].includes(t),"The",t,"type does not allow arguments"),f.generate(this,f.types[t],e)};for(const t of["allow","custom","disallow","equal","exist","forbidden","invalid","not","only","optional","options","prefs","preferences","required","strip","valid","when"])e[t]=function(...e){return this.any()[t](...e)};Object.assign(e,f.methods);for(const t in f.aliases){const i=f.aliases[t];e[t]=e[i]}return e.x=e.expression,h.setup&&h.setup(e),e}};f.methods={ValidationError:l.ValidationError,version:r.version,cache:n.provider,assert(e,t,...i){f.assert(e,t,!0,i)},attempt:(e,t,...i)=>f.assert(e,t,!1,i),build(e){return s("function"==typeof u.build,"Manifest functionality disabled"),u.build(this,e)},checkPreferences(e){r.checkPreferences(e)},compile(e,t){return o.compile(this,e,t)},defaults(e){s("function"==typeof e,"modifier must be a function");const t=Object.assign({},this);for(const i of t._types){const a=e(t[i]());s(r.isSchema(a),"modifier must return a valid schema object"),t[i]=function(...e){return f.generate(this,a,e)}}return t},expression:(...e)=>new m(...e),extend(...e){r.verifyFlat(e,"extend"),p=p||i(3378),s(e.length,"You need to provide at least one extension"),this.assert(e,p.extensions);const t=Object.assign({},this);t._types=new Set(t._types);for(let i of e){"function"==typeof i&&(i=i(t)),this.assert(i,p.extension);const e=f.expandExtension(i,t);for(const i of e){s(void 0===t[i.type]||t._types.has(i.type),"Cannot override name",i.type);const e=i.base||this.any(),a=c.type(e,i);t._types.add(i.type),t[i.type]=function(...e){return f.generate(this,a,e)}}}return t},isError:l.ValidationError.isError,isExpression:m.isTemplate,isRef:d.isRef,isSchema:r.isSchema,in:(...e)=>d.in(...e),override:r.symbols.override,ref:(...e)=>d.create(...e),types(){const e={};for(const t of this._types)e[t]=this[t]();for(const t in f.aliases)e[t]=this[t]();return e}},f.assert=function(e,t,i,s){const n=s[0]instanceof Error||"string"==typeof s[0]?s[0]:null,o=null!==n?s[1]:s[0],c=t.validate(e,r.preferences({errors:{stack:!0}},o||{}));let u=c.error;if(!u)return c.value;if(n instanceof Error)throw n;const d=i&&"function"==typeof u.annotate?u.annotate():u.message;throw u instanceof l.ValidationError==0&&(u=a(u)),u.message=n?`${n} ${d}`:d,u},f.generate=function(e,t,i){return s(e,"Must be invoked on a Joi instance."),t.$_root=e,t._definition.args&&i.length?t._definition.args(t,...i):t},f.expandExtension=function(e,t){if("string"==typeof e.type)return[e];const i=[];for(const s of t._types)if(e.type.test(s)){const a=Object.assign({},e);a.type=s,a.base=t[s](),i.push(a)}return i},e.exports=f.root()},6914:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(3328);t.compile=function(e,t){if("string"==typeof e)return s(!t,"Cannot set single message string"),new n(e);if(n.isTemplate(e))return s(!t,"Cannot set single message template"),e;s("object"==typeof e&&!Array.isArray(e),"Invalid message options"),t=t?a(t):{};for(let i in e){const a=e[i];if("root"===i||n.isTemplate(a)){t[i]=a;continue}if("string"==typeof a){t[i]=new n(a);continue}s("object"==typeof a&&!Array.isArray(a),"Invalid message for",i);const r=i;for(i in t[r]=t[r]||{},a){const e=a[i];"root"===i||n.isTemplate(e)?t[r][i]=e:(s("string"==typeof e,"Invalid message for",i,"in",r),t[r][i]=new n(e))}}return t},t.decompile=function(e){const t={};for(let i in e){const s=e[i];if("root"===i){t.root=s;continue}if(n.isTemplate(s)){t[i]=s.describe({compact:!0});continue}const a=i;for(i in t[a]={},s){const e=s[i];"root"!==i?t[a][i]=e.describe({compact:!0}):t[a].root=e}}return t},t.merge=function(e,i){if(!e)return t.compile(i);if(!i)return e;if("string"==typeof i)return new n(i);if(n.isTemplate(i))return i;const r=a(e);for(let e in i){const t=i[e];if("root"===e||n.isTemplate(t)){r[e]=t;continue}if("string"==typeof t){r[e]=new n(t);continue}s("object"==typeof t&&!Array.isArray(t),"Invalid message for",e);const a=e;for(e in r[a]=r[a]||{},t){const i=t[e];"root"===e||n.isTemplate(i)?r[a][e]=i:(s("string"==typeof i,"Invalid message for",e,"in",a),r[a][e]=new n(i))}}return r}},2294:(e,t,i)=>{"use strict";const s=i(375),a=i(8160),n=i(6133),r={};t.Ids=r.Ids=class{constructor(){this._byId=new Map,this._byKey=new Map,this._schemaChain=!1}clone(){const e=new r.Ids;return e._byId=new Map(this._byId),e._byKey=new Map(this._byKey),e._schemaChain=this._schemaChain,e}concat(e){e._schemaChain&&(this._schemaChain=!0);for(const[t,i]of e._byId.entries())s(!this._byKey.has(t),"Schema id conflicts with existing key:",t),this._byId.set(t,i);for(const[t,i]of e._byKey.entries())s(!this._byId.has(t),"Schema key conflicts with existing id:",t),this._byKey.set(t,i)}fork(e,t,i){const n=this._collect(e);n.push({schema:i});const o=n.shift();let l={id:o.id,schema:t(o.schema)};s(a.isSchema(l.schema),"adjuster function failed to return a joi schema type");for(const e of n)l={id:e.id,schema:r.fork(e.schema,l.id,l.schema)};return l.schema}labels(e,t=[]){const i=e[0],s=this._get(i);if(!s)return[...t,...e].join(".");const a=e.slice(1);return t=[...t,s.schema._flags.label||i],a.length?s.schema._ids.labels(a,t):t.join(".")}reach(e,t=[]){const i=e[0],a=this._get(i);s(a,"Schema does not contain path",[...t,...e].join("."));const n=e.slice(1);return n.length?a.schema._ids.reach(n,[...t,i]):a.schema}register(e,{key:t}={}){if(!e||!a.isSchema(e))return;(e.$_property("schemaChain")||e._ids._schemaChain)&&(this._schemaChain=!0);const i=e._flags.id;if(i){const t=this._byId.get(i);s(!t||t.schema===e,"Cannot add different schemas with the same id:",i),s(!this._byKey.has(i),"Schema id conflicts with existing key:",i),this._byId.set(i,{schema:e,id:i})}t&&(s(!this._byKey.has(t),"Schema already contains key:",t),s(!this._byId.has(t),"Schema key conflicts with existing id:",t),this._byKey.set(t,{schema:e,id:t}))}reset(){this._byId=new Map,this._byKey=new Map,this._schemaChain=!1}_collect(e,t=[],i=[]){const a=e[0],n=this._get(a);s(n,"Schema does not contain path",[...t,...e].join(".")),i=[n,...i];const r=e.slice(1);return r.length?n.schema._ids._collect(r,[...t,a],i):i}_get(e){return this._byId.get(e)||this._byKey.get(e)}},r.fork=function(e,i,s){const a=t.schema(e,{each:(e,{key:t})=>{if(i===(e._flags.id||t))return s},ref:!1});return a?a.$_mutateRebuild():e},t.schema=function(e,t){let i;for(const s in e._flags){if("_"===s[0])continue;const a=r.scan(e._flags[s],{source:"flags",name:s},t);void 0!==a&&(i=i||e.clone(),i._flags[s]=a)}for(let s=0;s<e._rules.length;++s){const a=e._rules[s],n=r.scan(a.args,{source:"rules",name:a.name},t);if(void 0!==n){i=i||e.clone();const t=Object.assign({},a);t.args=n,i._rules[s]=t,i._singleRules.get(a.name)===a&&i._singleRules.set(a.name,t)}}for(const s in e.$_terms){if("_"===s[0])continue;const a=r.scan(e.$_terms[s],{source:"terms",name:s},t);void 0!==a&&(i=i||e.clone(),i.$_terms[s]=a)}return i},r.scan=function(e,t,i,s,o){const l=s||[];if(null===e||"object"!=typeof e)return;let c;if(Array.isArray(e)){for(let s=0;s<e.length;++s){const a="terms"===t.source&&"keys"===t.name&&e[s].key,n=r.scan(e[s],t,i,[s,...l],a);void 0!==n&&(c=c||e.slice(),c[s]=n)}return c}if(!1!==i.schema&&a.isSchema(e)||!1!==i.ref&&n.isRef(e)){const s=i.each(e,{...t,path:l,key:o});if(s===e)return;return s}for(const s in e){if("_"===s[0])continue;const a=r.scan(e[s],t,i,[s,...l],o);void 0!==a&&(c=c||Object.assign({},e),c[s]=a)}return c}},6133:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(9621),r=i(8160);let o;const l={symbol:Symbol("ref"),defaults:{adjust:null,in:!1,iterables:null,map:null,separator:".",type:"value"}};t.create=function(e,t={}){s("string"==typeof e,"Invalid reference key:",e),r.assertOptions(t,["adjust","ancestor","in","iterables","map","prefix","render","separator"]),s(!t.prefix||"object"==typeof t.prefix,"options.prefix must be of type object");const i=Object.assign({},l.defaults,t);delete i.prefix;const a=i.separator,n=l.context(e,a,t.prefix);if(i.type=n.type,e=n.key,"value"===i.type)if(n.root&&(s(!a||e[0]!==a,"Cannot specify relative path with root prefix"),i.ancestor="root",e||(e=null)),a&&a===e)e=null,i.ancestor=0;else if(void 0!==i.ancestor)s(!a||!e||e[0]!==a,"Cannot combine prefix with ancestor option");else{const[t,s]=l.ancestor(e,a);s&&""===(e=e.slice(s))&&(e=null),i.ancestor=t}return i.path=a?null===e?[]:e.split(a):[e],new l.Ref(i)},t.in=function(e,i={}){return t.create(e,{...i,in:!0})},t.isRef=function(e){return!!e&&!!e[r.symbols.ref]},l.Ref=class{constructor(e){s("object"==typeof e,"Invalid reference construction"),r.assertOptions(e,["adjust","ancestor","in","iterables","map","path","render","separator","type","depth","key","root","display"]),s([!1,void 0].includes(e.separator)||"string"==typeof e.separator&&1===e.separator.length,"Invalid separator"),s(!e.adjust||"function"==typeof e.adjust,"options.adjust must be a function"),s(!e.map||Array.isArray(e.map),"options.map must be an array"),s(!e.map||!e.adjust,"Cannot set both map and adjust options"),Object.assign(this,l.defaults,e),s("value"===this.type||void 0===this.ancestor,"Non-value references cannot reference ancestors"),Array.isArray(this.map)&&(this.map=new Map(this.map)),this.depth=this.path.length,this.key=this.path.length?this.path.join(this.separator):null,this.root=this.path[0],this.updateDisplay()}resolve(e,t,i,a,n={}){return s(!this.in||n.in,"Invalid in() reference usage"),"global"===this.type?this._resolve(i.context,t,n):"local"===this.type?this._resolve(a,t,n):this.ancestor?"root"===this.ancestor?this._resolve(t.ancestors[t.ancestors.length-1],t,n):(s(this.ancestor<=t.ancestors.length,"Invalid reference exceeds the schema root:",this.display),this._resolve(t.ancestors[this.ancestor-1],t,n)):this._resolve(e,t,n)}_resolve(e,t,i){let s;if("value"===this.type&&t.mainstay.shadow&&!1!==i.shadow&&(s=t.mainstay.shadow.get(this.absolute(t))),void 0===s&&(s=n(e,this.path,{iterables:this.iterables,functions:!0})),this.adjust&&(s=this.adjust(s)),this.map){const e=this.map.get(s);void 0!==e&&(s=e)}return t.mainstay&&t.mainstay.tracer.resolve(t,this,s),s}toString(){return this.display}absolute(e){return[...e.path.slice(0,-this.ancestor),...this.path]}clone(){return new l.Ref(this)}describe(){const e={path:this.path};"value"!==this.type&&(e.type=this.type),"."!==this.separator&&(e.separator=this.separator),"value"===this.type&&1!==this.ancestor&&(e.ancestor=this.ancestor),this.map&&(e.map=[...this.map]);for(const t of["adjust","iterables","render"])null!==this[t]&&void 0!==this[t]&&(e[t]=this[t]);return!1!==this.in&&(e.in=!0),{ref:e}}updateDisplay(){const e=null!==this.key?this.key:"";if("value"!==this.type)return void(this.display=`ref:${this.type}:${e}`);if(!this.separator)return void(this.display=`ref:${e}`);if(!this.ancestor)return void(this.display=`ref:${this.separator}${e}`);if("root"===this.ancestor)return void(this.display=`ref:root:${e}`);if(1===this.ancestor)return void(this.display=`ref:${e||".."}`);const t=new Array(this.ancestor+1).fill(this.separator).join("");this.display=`ref:${t}${e||""}`}},l.Ref.prototype[r.symbols.ref]=!0,t.build=function(e){return"value"===(e=Object.assign({},l.defaults,e)).type&&void 0===e.ancestor&&(e.ancestor=1),new l.Ref(e)},l.context=function(e,t,i={}){if(e=e.trim(),i){const s=void 0===i.global?"$":i.global;if(s!==t&&e.startsWith(s))return{key:e.slice(s.length),type:"global"};const a=void 0===i.local?"#":i.local;if(a!==t&&e.startsWith(a))return{key:e.slice(a.length),type:"local"};const n=void 0===i.root?"/":i.root;if(n!==t&&e.startsWith(n))return{key:e.slice(n.length),type:"value",root:!0}}return{key:e,type:"value"}},l.ancestor=function(e,t){if(!t)return[1,0];if(e[0]!==t)return[1,0];if(e[1]!==t)return[0,1];let i=2;for(;e[i]===t;)++i;return[i-1,i]},t.toSibling=0,t.toParent=1,t.Manager=class{constructor(){this.refs=[]}register(e,s){if(e)if(s=void 0===s?t.toParent:s,Array.isArray(e))for(const t of e)this.register(t,s);else if(r.isSchema(e))for(const t of e._refs.refs)t.ancestor-s>=0&&this.refs.push({ancestor:t.ancestor-s,root:t.root});else t.isRef(e)&&"value"===e.type&&e.ancestor-s>=0&&this.refs.push({ancestor:e.ancestor-s,root:e.root}),o=o||i(3328),o.isTemplate(e)&&this.register(e.refs(),s)}get length(){return this.refs.length}clone(){const e=new t.Manager;return e.refs=a(this.refs),e}reset(){this.refs=[]}roots(){return this.refs.filter((e=>!e.ancestor)).map((e=>e.root))}}},3378:(e,t,i)=>{"use strict";const s=i(5107),a={};a.wrap=s.string().min(1).max(2).allow(!1),t.preferences=s.object({allowUnknown:s.boolean(),abortEarly:s.boolean(),artifacts:s.boolean(),cache:s.boolean(),context:s.object(),convert:s.boolean(),dateFormat:s.valid("date","iso","string","time","utc"),debug:s.boolean(),errors:{escapeHtml:s.boolean(),label:s.valid("path","key",!1),language:[s.string(),s.object().ref()],render:s.boolean(),stack:s.boolean(),wrap:{label:a.wrap,array:a.wrap,string:a.wrap}},externals:s.boolean(),messages:s.object(),noDefaults:s.boolean(),nonEnumerables:s.boolean(),presence:s.valid("required","optional","forbidden"),skipFunctions:s.boolean(),stripUnknown:s.object({arrays:s.boolean(),objects:s.boolean()}).or("arrays","objects").allow(!0,!1),warnings:s.boolean()}).strict(),a.nameRx=/^[a-zA-Z0-9]\w*$/,a.rule=s.object({alias:s.array().items(s.string().pattern(a.nameRx)).single(),args:s.array().items(s.string(),s.object({name:s.string().pattern(a.nameRx).required(),ref:s.boolean(),assert:s.alternatives([s.function(),s.object().schema()]).conditional("ref",{is:!0,then:s.required()}),normalize:s.function(),message:s.string().when("assert",{is:s.function(),then:s.required()})})),convert:s.boolean(),manifest:s.boolean(),method:s.function().allow(!1),multi:s.boolean(),validate:s.function()}),t.extension=s.object({type:s.alternatives([s.string(),s.object().regex()]).required(),args:s.function(),cast:s.object().pattern(a.nameRx,s.object({from:s.function().maxArity(1).required(),to:s.function().minArity(1).maxArity(2).required()})),base:s.object().schema().when("type",{is:s.object().regex(),then:s.forbidden()}),coerce:[s.function().maxArity(3),s.object({method:s.function().maxArity(3).required(),from:s.array().items(s.string()).single()})],flags:s.object().pattern(a.nameRx,s.object({setter:s.string(),default:s.any()})),manifest:{build:s.function().arity(2)},messages:[s.object(),s.string()],modifiers:s.object().pattern(a.nameRx,s.function().minArity(1).maxArity(2)),overrides:s.object().pattern(a.nameRx,s.function()),prepare:s.function().maxArity(3),rebuild:s.function().arity(1),rules:s.object().pattern(a.nameRx,a.rule),terms:s.object().pattern(a.nameRx,s.object({init:s.array().allow(null).required(),manifest:s.object().pattern(/.+/,[s.valid("schema","single"),s.object({mapped:s.object({from:s.string().required(),to:s.string().required()}).required()})])})),validate:s.function().maxArity(3)}).strict(),t.extensions=s.array().items(s.object(),s.function().arity(1)).strict(),a.desc={buffer:s.object({buffer:s.string()}),func:s.object({function:s.function().required(),options:{literal:!0}}),override:s.object({override:!0}),ref:s.object({ref:s.object({type:s.valid("value","global","local"),path:s.array().required(),separator:s.string().length(1).allow(!1),ancestor:s.number().min(0).integer().allow("root"),map:s.array().items(s.array().length(2)).min(1),adjust:s.function(),iterables:s.boolean(),in:s.boolean(),render:s.boolean()}).required()}),regex:s.object({regex:s.string().min(3)}),special:s.object({special:s.valid("deep").required()}),template:s.object({template:s.string().required(),options:s.object()}),value:s.object({value:s.alternatives([s.object(),s.array()]).required()})},a.desc.entity=s.alternatives([s.array().items(s.link("...")),s.boolean(),s.function(),s.number(),s.string(),a.desc.buffer,a.desc.func,a.desc.ref,a.desc.regex,a.desc.special,a.desc.template,a.desc.value,s.link("/")]),a.desc.values=s.array().items(null,s.boolean(),s.function(),s.number().allow(1/0,-1/0),s.string().allow(""),s.symbol(),a.desc.buffer,a.desc.func,a.desc.override,a.desc.ref,a.desc.regex,a.desc.template,a.desc.value),a.desc.messages=s.object().pattern(/.+/,[s.string(),a.desc.template,s.object().pattern(/.+/,[s.string(),a.desc.template])]),t.description=s.object({type:s.string().required(),flags:s.object({cast:s.string(),default:s.any(),description:s.string(),empty:s.link("/"),failover:a.desc.entity,id:s.string(),label:s.string(),only:!0,presence:["optional","required","forbidden"],result:["raw","strip"],strip:s.boolean(),unit:s.string()}).unknown(),preferences:{allowUnknown:s.boolean(),abortEarly:s.boolean(),artifacts:s.boolean(),cache:s.boolean(),convert:s.boolean(),dateFormat:["date","iso","string","time","utc"],errors:{escapeHtml:s.boolean(),label:["path","key"],language:[s.string(),a.desc.ref],wrap:{label:a.wrap,array:a.wrap}},externals:s.boolean(),messages:a.desc.messages,noDefaults:s.boolean(),nonEnumerables:s.boolean(),presence:["required","optional","forbidden"],skipFunctions:s.boolean(),stripUnknown:s.object({arrays:s.boolean(),objects:s.boolean()}).or("arrays","objects").allow(!0,!1),warnings:s.boolean()},allow:a.desc.values,invalid:a.desc.values,rules:s.array().min(1).items({name:s.string().required(),args:s.object().min(1),keep:s.boolean(),message:[s.string(),a.desc.messages],warn:s.boolean()}),keys:s.object().pattern(/.*/,s.link("/")),link:a.desc.ref}).pattern(/^[a-z]\w*$/,s.any())},493:(e,t,i)=>{"use strict";const s=i(8571),a=i(9621),n=i(8160),r={value:Symbol("value")};e.exports=r.State=class{constructor(e,t,i){this.path=e,this.ancestors=t,this.mainstay=i.mainstay,this.schemas=i.schemas,this.debug=null}localize(e,t=null,i=null){const s=new r.State(e,t,this);return i&&s.schemas&&(s.schemas=[r.schemas(i),...s.schemas]),s}nest(e,t){const i=new r.State(this.path,this.ancestors,this);return i.schemas=i.schemas&&[r.schemas(e),...i.schemas],i.debug=t,i}shadow(e,t){this.mainstay.shadow=this.mainstay.shadow||new r.Shadow,this.mainstay.shadow.set(this.path,e,t)}snapshot(){this.mainstay.shadow&&(this._snapshot=s(this.mainstay.shadow.node(this.path))),this.mainstay.snapshot()}restore(){this.mainstay.shadow&&(this.mainstay.shadow.override(this.path,this._snapshot),this._snapshot=void 0),this.mainstay.restore()}commit(){this.mainstay.shadow&&(this.mainstay.shadow.override(this.path,this._snapshot),this._snapshot=void 0),this.mainstay.commit()}},r.schemas=function(e){return n.isSchema(e)?{schema:e}:e},r.Shadow=class{constructor(){this._values=null}set(e,t,i){if(!e.length)return;if("strip"===i&&"number"==typeof e[e.length-1])return;this._values=this._values||new Map;let s=this._values;for(let t=0;t<e.length;++t){const i=e[t];let a=s.get(i);a||(a=new Map,s.set(i,a)),s=a}s[r.value]=t}get(e){const t=this.node(e);if(t)return t[r.value]}node(e){if(this._values)return a(this._values,e,{iterables:!0})}override(e,t){if(!this._values)return;const i=e.slice(0,-1),s=e[e.length-1],n=a(this._values,i,{iterables:!0});t?n.set(s,t):n&&n.delete(s)}}},3328:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(5277),r=i(1447),o=i(8160),l=i(6354),c=i(6133),u={symbol:Symbol("template"),opens:new Array(1e3).join("\0"),closes:new Array(1e3).join(""),dateFormat:{date:Date.prototype.toDateString,iso:Date.prototype.toISOString,string:Date.prototype.toString,time:Date.prototype.toTimeString,utc:Date.prototype.toUTCString}};e.exports=u.Template=class{constructor(e,t){if(s("string"==typeof e,"Template source must be a string"),s(!e.includes("\0")&&!e.includes(""),"Template source cannot contain reserved control characters"),this.source=e,this.rendered=e,this._template=null,t){const{functions:e,...i}=t;this._settings=Object.keys(i).length?a(i):void 0,this._functions=e,this._functions&&(s(Object.keys(this._functions).every((e=>"string"==typeof e)),"Functions keys must be strings"),s(Object.values(this._functions).every((e=>"function"==typeof e)),"Functions values must be functions"))}else this._settings=void 0,this._functions=void 0;this._parse()}_parse(){if(!this.source.includes("{"))return;const e=u.encode(this.source),t=u.split(e);let i=!1;const s=[],a=t.shift();a&&s.push(a);for(const e of t){const t="{"!==e[0],a=t?"}":"}}",n=e.indexOf(a);if(-1===n||"{"===e[1]){s.push(`{${u.decode(e)}`);continue}let r=e.slice(t?0:1,n);const o=":"===r[0];o&&(r=r.slice(1));const l=this._ref(u.decode(r),{raw:t,wrapped:o});s.push(l),"string"!=typeof l&&(i=!0);const c=e.slice(n+a.length);c&&s.push(u.decode(c))}i?this._template=s:this.rendered=s.join("")}static date(e,t){return u.dateFormat[t.dateFormat].call(e)}describe(e={}){if(!this._settings&&e.compact)return this.source;const t={template:this.source};return this._settings&&(t.options=this._settings),this._functions&&(t.functions=this._functions),t}static build(e){return new u.Template(e.template,e.options||e.functions?{...e.options,functions:e.functions}:void 0)}isDynamic(){return!!this._template}static isTemplate(e){return!!e&&!!e[o.symbols.template]}refs(){if(!this._template)return;const e=[];for(const t of this._template)"string"!=typeof t&&e.push(...t.refs);return e}resolve(e,t,i,s){return this._template&&1===this._template.length?this._part(this._template[0],e,t,i,s,{}):this.render(e,t,i,s)}_part(e,...t){return e.ref?e.ref.resolve(...t):e.formula.evaluate(t)}render(e,t,i,s,a={}){if(!this.isDynamic())return this.rendered;const r=[];for(const o of this._template)if("string"==typeof o)r.push(o);else{const l=this._part(o,e,t,i,s,a),c=u.stringify(l,e,t,i,s,a);if(void 0!==c){const e=o.raw||!1===(a.errors&&a.errors.escapeHtml)?c:n(c);r.push(u.wrap(e,o.wrapped&&i.errors.wrap.label))}}return r.join("")}_ref(e,{raw:t,wrapped:i}){const s=[],a=e=>{const t=c.create(e,this._settings);return s.push(t),e=>{const i=t.resolve(...e);return void 0!==i?i:null}};try{const t=this._functions?{...u.functions,...this._functions}:u.functions;var n=new r.Parser(e,{reference:a,functions:t,constants:u.constants})}catch(t){throw t.message=`Invalid template variable "${e}" fails due to: ${t.message}`,t}if(n.single){if("reference"===n.single.type){const e=s[0];return{ref:e,raw:t,refs:s,wrapped:i||"local"===e.type&&"label"===e.key}}return u.stringify(n.single.value)}return{formula:n,raw:t,refs:s}}toString(){return this.source}},u.Template.prototype[o.symbols.template]=!0,u.Template.prototype.isImmutable=!0,u.encode=function(e){return e.replace(/\\(\{+)/g,((e,t)=>u.opens.slice(0,t.length))).replace(/\\(\}+)/g,((e,t)=>u.closes.slice(0,t.length)))},u.decode=function(e){return e.replace(/\u0000/g,"{").replace(/\u0001/g,"}")},u.split=function(e){const t=[];let i="";for(let s=0;s<e.length;++s){const a=e[s];if("{"===a){let a="";for(;s+1<e.length&&"{"===e[s+1];)a+="{",++s;t.push(i),i=a}else i+=a}return t.push(i),t},u.wrap=function(e,t){return t?1===t.length?`${t}${e}${t}`:`${t[0]}${e}${t[1]}`:e},u.stringify=function(e,t,i,s,a,n={}){const r=typeof e,o=s&&s.errors&&s.errors.wrap||{};let l=!1;if(c.isRef(e)&&e.render&&(l=e.in,e=e.resolve(t,i,s,a,{in:e.in,...n})),null===e)return"null";if("string"===r)return u.wrap(e,n.arrayItems&&o.string);if("number"===r||"function"===r||"symbol"===r)return e.toString();if("object"!==r)return JSON.stringify(e);if(e instanceof Date)return u.Template.date(e,s);if(e instanceof Map){const t=[];for(const[i,s]of e.entries())t.push(`${i.toString()} -> ${s.toString()}`);e=t}if(!Array.isArray(e))return e.toString();const d=[];for(const r of e)d.push(u.stringify(r,t,i,s,a,{arrayItems:!0,...n}));return u.wrap(d.join(", "),!l&&o.array)},u.constants={true:!0,false:!1,null:null,second:1e3,minute:6e4,hour:36e5,day:864e5},u.functions={if:(e,t,i)=>e?t:i,length:e=>"string"==typeof e?e.length:e&&"object"==typeof e?Array.isArray(e)?e.length:Object.keys(e).length:null,msg(e){const[t,i,s,a,n]=this,r=n.messages;if(!r)return"";const o=l.template(t,r[0],e,i,s)||l.template(t,r[1],e,i,s);return o?o.render(t,i,s,a,n):""},number:e=>"number"==typeof e?e:"string"==typeof e?parseFloat(e):"boolean"==typeof e?e?1:0:e instanceof Date?e.getTime():null}},4946:(e,t,i)=>{"use strict";const s=i(375),a=i(1687),n=i(8068),r=i(8160),o=i(3292),l=i(6354),c=i(6133),u={};e.exports=n.extend({type:"alternatives",flags:{match:{default:"any"}},terms:{matches:{init:[],register:c.toSibling}},args:(e,...t)=>1===t.length&&Array.isArray(t[0])?e.try(...t[0]):e.try(...t),validate(e,t){const{schema:i,error:s,state:n,prefs:r}=t;if(i._flags.match){const t=[],o=[];for(let s=0;s<i.$_terms.matches.length;++s){const a=i.$_terms.matches[s],l=n.nest(a.schema,`match.${s}`);l.snapshot();const c=a.schema.$_validate(e,l,r);c.errors?(o.push(c.errors),l.restore()):(t.push(c.value),l.commit())}if(0===t.length)return{errors:s("alternatives.any",{details:o.map((e=>l.details(e,{override:!1})))})};if("one"===i._flags.match)return 1===t.length?{value:t[0]}:{errors:s("alternatives.one")};if(t.length!==i.$_terms.matches.length)return{errors:s("alternatives.all",{details:o.map((e=>l.details(e,{override:!1})))})};const c=e=>e.$_terms.matches.some((e=>"object"===e.schema.type||"alternatives"===e.schema.type&&c(e.schema)));return c(i)?{value:t.reduce(((e,t)=>a(e,t,{mergeArrays:!1})))}:{value:t[t.length-1]}}const o=[];for(let t=0;t<i.$_terms.matches.length;++t){const s=i.$_terms.matches[t];if(s.schema){const i=n.nest(s.schema,`match.${t}`);i.snapshot();const a=s.schema.$_validate(e,i,r);if(!a.errors)return i.commit(),a;i.restore(),o.push({schema:s.schema,reports:a.errors});continue}const a=s.ref?s.ref.resolve(e,n,r):e,l=s.is?[s]:s.switch;for(let i=0;i<l.length;++i){const o=l[i],{is:c,then:u,otherwise:d}=o,m=`match.${t}${s.switch?"."+i:""}`;if(c.$_match(a,n.nest(c,`${m}.is`),r)){if(u)return u.$_validate(e,n.nest(u,`${m}.then`),r)}else if(d)return d.$_validate(e,n.nest(d,`${m}.otherwise`),r)}}return u.errors(o,t)},rules:{conditional:{method(e,t){s(!this._flags._endedSwitch,"Unreachable condition"),s(!this._flags.match,"Cannot combine match mode",this._flags.match,"with conditional rule"),s(void 0===t.break,"Cannot use break option with alternatives conditional");const i=this.clone(),a=o.when(i,e,t),n=a.is?[a]:a.switch;for(const e of n)if(e.then&&e.otherwise){i.$_setFlag("_endedSwitch",!0,{clone:!1});break}return i.$_terms.matches.push(a),i.$_mutateRebuild()}},match:{method(e){if(s(["any","one","all"].includes(e),"Invalid alternatives match mode",e),"any"!==e)for(const t of this.$_terms.matches)s(t.schema,"Cannot combine match mode",e,"with conditional rules");return this.$_setFlag("match",e)}},try:{method(...e){s(e.length,"Missing alternative schemas"),r.verifyFlat(e,"try"),s(!this._flags._endedSwitch,"Unreachable condition");const t=this.clone();for(const i of e)t.$_terms.matches.push({schema:t.$_compile(i)});return t.$_mutateRebuild()}}},overrides:{label(e){return this.$_parent("label",e).$_modify({each:(t,i)=>"is"!==i.path[0]&&"string"!=typeof t._flags.label?t.label(e):void 0,ref:!1})}},rebuild(e){e.$_modify({each:t=>{r.isSchema(t)&&"array"===t.type&&e.$_setFlag("_arrayItems",!0,{clone:!1})}})},manifest:{build(e,t){if(t.matches)for(const i of t.matches){const{schema:t,ref:s,is:a,not:n,then:r,otherwise:o}=i;e=t?e.try(t):s?e.conditional(s,{is:a,then:r,not:n,otherwise:o,switch:i.switch}):e.conditional(a,{then:r,otherwise:o})}return e}},messages:{"alternatives.all":"{{#label}} does not match all of the required types","alternatives.any":"{{#label}} does not match any of the allowed types","alternatives.match":"{{#label}} does not match any of the allowed types","alternatives.one":"{{#label}} matches more than one allowed type","alternatives.types":"{{#label}} must be one of {{#types}}"}}),u.errors=function(e,{error:t,state:i}){if(!e.length)return{errors:t("alternatives.any")};if(1===e.length)return{errors:e[0].reports};const s=new Set,a=[];for(const{reports:n,schema:r}of e){if(n.length>1)return u.unmatched(e,t);const o=n[0];if(o instanceof l.Report==0)return u.unmatched(e,t);if(o.state.path.length!==i.path.length){a.push({type:r.type,report:o});continue}if("any.only"===o.code){for(const e of o.local.valids)s.add(e);continue}const[c,d]=o.code.split(".");"base"===d?s.add(c):a.push({type:r.type,report:o})}return a.length?1===a.length?{errors:a[0].report}:u.unmatched(e,t):{errors:t("alternatives.types",{types:[...s]})}},u.unmatched=function(e,t){const i=[];for(const t of e)i.push(...t.reports);return{errors:t("alternatives.match",l.details(i,{override:!1}))}}},8068:(e,t,i)=>{"use strict";const s=i(375),a=i(7629),n=i(8160),r=i(6914);e.exports=a.extend({type:"any",flags:{only:{default:!1}},terms:{alterations:{init:null},examples:{init:null},externals:{init:null},metas:{init:[]},notes:{init:[]},shared:{init:null},tags:{init:[]},whens:{init:null}},rules:{custom:{method(e,t){return s("function"==typeof e,"Method must be a function"),s(void 0===t||t&&"string"==typeof t,"Description must be a non-empty string"),this.$_addRule({name:"custom",args:{method:e,description:t}})},validate(e,t,{method:i}){try{return i(e,t)}catch(e){return t.error("any.custom",{error:e})}},args:["method","description"],multi:!0},messages:{method(e){return this.prefs({messages:e})}},shared:{method(e){s(n.isSchema(e)&&e._flags.id,"Schema must be a schema with an id");const t=this.clone();return t.$_terms.shared=t.$_terms.shared||[],t.$_terms.shared.push(e),t.$_mutateRegister(e),t}},warning:{method(e,t){return s(e&&"string"==typeof e,"Invalid warning code"),this.$_addRule({name:"warning",args:{code:e,local:t},warn:!0})},validate:(e,t,{code:i,local:s})=>t.error(i,s),args:["code","local"],multi:!0}},modifiers:{keep(e,t=!0){e.keep=t},message(e,t){e.message=r.compile(t)},warn(e,t=!0){e.warn=t}},manifest:{build(e,t){for(const i in t){const s=t[i];if(["examples","externals","metas","notes","tags"].includes(i))for(const t of s)e=e[i.slice(0,-1)](t);else if("alterations"!==i)if("whens"!==i){if("shared"===i)for(const t of s)e=e.shared(t)}else for(const t of s){const{ref:i,is:s,not:a,then:n,otherwise:r,concat:o}=t;e=o?e.concat(o):i?e.when(i,{is:s,not:a,then:n,otherwise:r,switch:t.switch,break:t.break}):e.when(s,{then:n,otherwise:r,break:t.break})}else{const t={};for(const{target:e,adjuster:i}of s)t[e]=i;e=e.alter(t)}}return e}},messages:{"any.custom":"{{#label}} failed custom validation because {{#error.message}}","any.default":"{{#label}} threw an error when running default method","any.failover":"{{#label}} threw an error when running failover method","any.invalid":"{{#label}} contains an invalid value","any.only":'{{#label}} must be {if(#valids.length == 1, "", "one of ")}{{#valids}}',"any.ref":"{{#label}} {{#arg}} references {{:#ref}} which {{#reason}}","any.required":"{{#label}} is required","any.unknown":"{{#label}} is not allowed"}})},546:(e,t,i)=>{"use strict";const s=i(375),a=i(9474),n=i(9621),r=i(8068),o=i(8160),l=i(3292),c={};e.exports=r.extend({type:"array",flags:{single:{default:!1},sparse:{default:!1}},terms:{items:{init:[],manifest:"schema"},ordered:{init:[],manifest:"schema"},_exclusions:{init:[]},_inclusions:{init:[]},_requireds:{init:[]}},coerce:{from:"object",method(e,{schema:t,state:i,prefs:s}){if(!Array.isArray(e))return;const a=t.$_getRule("sort");return a?c.sort(t,e,a.args.options,i,s):void 0}},validate(e,{schema:t,error:i}){if(!Array.isArray(e)){if(t._flags.single){const t=[e];return t[o.symbols.arraySingle]=!0,{value:t}}return{errors:i("array.base")}}if(t.$_getRule("items")||t.$_terms.externals)return{value:e.slice()}},rules:{has:{method(e){e=this.$_compile(e,{appendPath:!0});const t=this.$_addRule({name:"has",args:{schema:e}});return t.$_mutateRegister(e),t},validate(e,{state:t,prefs:i,error:s},{schema:a}){const n=[e,...t.ancestors];for(let s=0;s<e.length;++s){const r=t.localize([...t.path,s],n,a);if(a.$_match(e[s],r,i))return e}const r=a._flags.label;return r?s("array.hasKnown",{patternLabel:r}):s("array.hasUnknown",null)},multi:!0},items:{method(...e){o.verifyFlat(e,"items");const t=this.$_addRule("items");for(let i=0;i<e.length;++i){const s=o.tryWithPath((()=>this.$_compile(e[i])),i,{append:!0});t.$_terms.items.push(s)}return t.$_mutateRebuild()},validate(e,{schema:t,error:i,state:s,prefs:a,errorsArray:n}){const r=t.$_terms._requireds.slice(),l=t.$_terms.ordered.slice(),u=[...t.$_terms._inclusions,...r],d=!e[o.symbols.arraySingle];delete e[o.symbols.arraySingle];const m=n();let h=e.length;for(let n=0;n<h;++n){const o=e[n];let p=!1,f=!1;const g=d?n:new Number(n),y=[...s.path,g];if(!t._flags.sparse&&void 0===o){if(m.push(i("array.sparse",{key:g,path:y,pos:n,value:void 0},s.localize(y))),a.abortEarly)return m;l.shift();continue}const v=[e,...s.ancestors];for(const e of t.$_terms._exclusions)if(e.$_match(o,s.localize(y,v,e),a,{presence:"ignore"})){if(m.push(i("array.excludes",{pos:n,value:o},s.localize(y))),a.abortEarly)return m;p=!0,l.shift();break}if(p)continue;if(t.$_terms.ordered.length){if(l.length){const r=l.shift(),u=r.$_validate(o,s.localize(y,v,r),a);if(u.errors){if(m.push(...u.errors),a.abortEarly)return m}else if("strip"===r._flags.result)c.fastSplice(e,n),--n,--h;else{if(!t._flags.sparse&&void 0===u.value){if(m.push(i("array.sparse",{key:g,path:y,pos:n,value:void 0},s.localize(y))),a.abortEarly)return m;continue}e[n]=u.value}continue}if(!t.$_terms.items.length){if(m.push(i("array.orderedLength",{pos:n,limit:t.$_terms.ordered.length})),a.abortEarly)return m;break}}const b=[];let k=r.length;for(let l=0;l<k;++l){const u=s.localize(y,v,r[l]);u.snapshot();const d=r[l].$_validate(o,u,a);if(b[l]=d,!d.errors){if(u.commit(),e[n]=d.value,f=!0,c.fastSplice(r,l),--l,--k,!t._flags.sparse&&void 0===d.value&&(m.push(i("array.sparse",{key:g,path:y,pos:n,value:void 0},s.localize(y))),a.abortEarly))return m;break}u.restore()}if(f)continue;const w=a.stripUnknown&&!!a.stripUnknown.arrays||!1;k=u.length;for(const l of u){let u;const d=r.indexOf(l);if(-1!==d)u=b[d];else{const r=s.localize(y,v,l);if(r.snapshot(),u=l.$_validate(o,r,a),!u.errors){r.commit(),"strip"===l._flags.result?(c.fastSplice(e,n),--n,--h):t._flags.sparse||void 0!==u.value?e[n]=u.value:(m.push(i("array.sparse",{key:g,path:y,pos:n,value:void 0},s.localize(y))),p=!0),f=!0;break}r.restore()}if(1===k){if(w){c.fastSplice(e,n),--n,--h,f=!0;break}if(m.push(...u.errors),a.abortEarly)return m;p=!0;break}}if(!p&&(t.$_terms._inclusions.length||t.$_terms._requireds.length)&&!f){if(w){c.fastSplice(e,n),--n,--h;continue}if(m.push(i("array.includes",{pos:n,value:o},s.localize(y))),a.abortEarly)return m}}return r.length&&c.fillMissedErrors(t,m,r,e,s,a),l.length&&(c.fillOrderedErrors(t,m,l,e,s,a),m.length||c.fillDefault(l,e,s,a)),m.length?m:e},priority:!0,manifest:!1},length:{method(e){return this.$_addRule({name:"length",args:{limit:e},operator:"="})},validate:(e,t,{limit:i},{name:s,operator:a,args:n})=>o.compare(e.length,i,a)?e:t.error("array."+s,{limit:n.limit,value:e}),args:[{name:"limit",ref:!0,assert:o.limit,message:"must be a positive integer"}]},max:{method(e){return this.$_addRule({name:"max",method:"length",args:{limit:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"length",args:{limit:e},operator:">="})}},ordered:{method(...e){o.verifyFlat(e,"ordered");const t=this.$_addRule("items");for(let i=0;i<e.length;++i){const s=o.tryWithPath((()=>this.$_compile(e[i])),i,{append:!0});c.validateSingle(s,t),t.$_mutateRegister(s),t.$_terms.ordered.push(s)}return t.$_mutateRebuild()}},single:{method(e){const t=void 0===e||!!e;return s(!t||!this._flags._arrayItems,"Cannot specify single rule when array has array items"),this.$_setFlag("single",t)}},sort:{method(e={}){o.assertOptions(e,["by","order"]);const t={order:e.order||"ascending"};return e.by&&(t.by=l.ref(e.by,{ancestor:0}),s(!t.by.ancestor,"Cannot sort by ancestor")),this.$_addRule({name:"sort",args:{options:t}})},validate(e,{error:t,state:i,prefs:s,schema:a},{options:n}){const{value:r,errors:o}=c.sort(a,e,n,i,s);if(o)return o;for(let i=0;i<e.length;++i)if(e[i]!==r[i])return t("array.sort",{order:n.order,by:n.by?n.by.key:"value"});return e},convert:!0},sparse:{method(e){const t=void 0===e||!!e;return this._flags.sparse===t?this:(t?this.clone():this.$_addRule("items")).$_setFlag("sparse",t,{clone:!1})}},unique:{method(e,t={}){s(!e||"function"==typeof e||"string"==typeof e,"comparator must be a function or a string"),o.assertOptions(t,["ignoreUndefined","separator"]);const i={name:"unique",args:{options:t,comparator:e}};if(e)if("string"==typeof e){const s=o.default(t.separator,".");i.path=s?e.split(s):[e]}else i.comparator=e;return this.$_addRule(i)},validate(e,{state:t,error:i,schema:r},{comparator:o,options:l},{comparator:c,path:u}){const d={string:Object.create(null),number:Object.create(null),undefined:Object.create(null),boolean:Object.create(null),bigint:Object.create(null),object:new Map,function:new Map,custom:new Map},m=c||a,h=l.ignoreUndefined;for(let a=0;a<e.length;++a){const r=u?n(e[a],u):e[a],l=c?d.custom:d[typeof r];if(s(l,"Failed to find unique map container for type",typeof r),l instanceof Map){const s=l.entries();let n;for(;!(n=s.next()).done;)if(m(n.value[0],r)){const s=t.localize([...t.path,a],[e,...t.ancestors]),r={pos:a,value:e[a],dupePos:n.value[1],dupeValue:e[n.value[1]]};return u&&(r.path=o),i("array.unique",r,s)}l.set(r,a)}else{if((!h||void 0!==r)&&void 0!==l[r]){const s={pos:a,value:e[a],dupePos:l[r],dupeValue:e[l[r]]};return u&&(s.path=o),i("array.unique",s,t.localize([...t.path,a],[e,...t.ancestors]))}l[r]=a}}return e},args:["comparator","options"],multi:!0}},cast:{set:{from:Array.isArray,to:(e,t)=>new Set(e)}},rebuild(e){e.$_terms._inclusions=[],e.$_terms._exclusions=[],e.$_terms._requireds=[];for(const t of e.$_terms.items)c.validateSingle(t,e),"required"===t._flags.presence?e.$_terms._requireds.push(t):"forbidden"===t._flags.presence?e.$_terms._exclusions.push(t):e.$_terms._inclusions.push(t);for(const t of e.$_terms.ordered)c.validateSingle(t,e)},manifest:{build:(e,t)=>(t.items&&(e=e.items(...t.items)),t.ordered&&(e=e.ordered(...t.ordered)),e)},messages:{"array.base":"{{#label}} must be an array","array.excludes":"{{#label}} contains an excluded value","array.hasKnown":"{{#label}} does not contain at least one required match for type {:#patternLabel}","array.hasUnknown":"{{#label}} does not contain at least one required match","array.includes":"{{#label}} does not match any of the allowed types","array.includesRequiredBoth":"{{#label}} does not contain {{#knownMisses}} and {{#unknownMisses}} other required value(s)","array.includesRequiredKnowns":"{{#label}} does not contain {{#knownMisses}}","array.includesRequiredUnknowns":"{{#label}} does not contain {{#unknownMisses}} required value(s)","array.length":"{{#label}} must contain {{#limit}} items","array.max":"{{#label}} must contain less than or equal to {{#limit}} items","array.min":"{{#label}} must contain at least {{#limit}} items","array.orderedLength":"{{#label}} must contain at most {{#limit}} items","array.sort":"{{#label}} must be sorted in {#order} order by {{#by}}","array.sort.mismatching":"{{#label}} cannot be sorted due to mismatching types","array.sort.unsupported":"{{#label}} cannot be sorted due to unsupported type {#type}","array.sparse":"{{#label}} must not be a sparse array item","array.unique":"{{#label}} contains a duplicate value"}}),c.fillMissedErrors=function(e,t,i,s,a,n){const r=[];let o=0;for(const e of i){const t=e._flags.label;t?r.push(t):++o}r.length?o?t.push(e.$_createError("array.includesRequiredBoth",s,{knownMisses:r,unknownMisses:o},a,n)):t.push(e.$_createError("array.includesRequiredKnowns",s,{knownMisses:r},a,n)):t.push(e.$_createError("array.includesRequiredUnknowns",s,{unknownMisses:o},a,n))},c.fillOrderedErrors=function(e,t,i,s,a,n){const r=[];for(const e of i)"required"===e._flags.presence&&r.push(e);r.length&&c.fillMissedErrors(e,t,r,s,a,n)},c.fillDefault=function(e,t,i,s){const a=[];let n=!0;for(let r=e.length-1;r>=0;--r){const o=e[r],l=[t,...i.ancestors],c=o.$_validate(void 0,i.localize(i.path,l,o),s).value;if(n){if(void 0===c)continue;n=!1}a.unshift(c)}a.length&&t.push(...a)},c.fastSplice=function(e,t){let i=t;for(;i<e.length;)e[i++]=e[i];--e.length},c.validateSingle=function(e,t){("array"===e.type||e._flags._arrayItems)&&(s(!t._flags.single,"Cannot specify array item with single rule enabled"),t.$_setFlag("_arrayItems",!0,{clone:!1}))},c.sort=function(e,t,i,s,a){const n="ascending"===i.order?1:-1,r=-1*n,o=n,l=(l,u)=>{let d=c.compare(l,u,r,o);if(null!==d)return d;if(i.by&&(l=i.by.resolve(l,s,a),u=i.by.resolve(u,s,a)),d=c.compare(l,u,r,o),null!==d)return d;const m=typeof l;if(m!==typeof u)throw e.$_createError("array.sort.mismatching",t,null,s,a);if("number"!==m&&"string"!==m)throw e.$_createError("array.sort.unsupported",t,{type:m},s,a);return"number"===m?(l-u)*n:l<u?r:o};try{return{value:t.slice().sort(l)}}catch(e){return{errors:e}}},c.compare=function(e,t,i,s){return e===t?0:void 0===e?1:void 0===t?-1:null===e?s:null===t?i:null}},4937:(e,t,i)=>{"use strict";const s=i(375),a=i(8068),n=i(8160),r=i(2036),o={isBool:function(e){return"boolean"==typeof e}};e.exports=a.extend({type:"boolean",flags:{sensitive:{default:!1}},terms:{falsy:{init:null,manifest:"values"},truthy:{init:null,manifest:"values"}},coerce(e,{schema:t}){if("boolean"!=typeof e){if("string"==typeof e){const i=t._flags.sensitive?e:e.toLowerCase();e="true"===i||"false"!==i&&e}return"boolean"!=typeof e&&(e=t.$_terms.truthy&&t.$_terms.truthy.has(e,null,null,!t._flags.sensitive)||(!t.$_terms.falsy||!t.$_terms.falsy.has(e,null,null,!t._flags.sensitive))&&e),{value:e}}},validate(e,{error:t}){if("boolean"!=typeof e)return{value:e,errors:t("boolean.base")}},rules:{truthy:{method(...e){n.verifyFlat(e,"truthy");const t=this.clone();t.$_terms.truthy=t.$_terms.truthy||new r;for(let i=0;i<e.length;++i){const a=e[i];s(void 0!==a,"Cannot call truthy with undefined"),t.$_terms.truthy.add(a)}return t}},falsy:{method(...e){n.verifyFlat(e,"falsy");const t=this.clone();t.$_terms.falsy=t.$_terms.falsy||new r;for(let i=0;i<e.length;++i){const a=e[i];s(void 0!==a,"Cannot call falsy with undefined"),t.$_terms.falsy.add(a)}return t}},sensitive:{method(e=!0){return this.$_setFlag("sensitive",e)}}},cast:{number:{from:o.isBool,to:(e,t)=>e?1:0},string:{from:o.isBool,to:(e,t)=>e?"true":"false"}},manifest:{build:(e,t)=>(t.truthy&&(e=e.truthy(...t.truthy)),t.falsy&&(e=e.falsy(...t.falsy)),e)},messages:{"boolean.base":"{{#label}} must be a boolean"}})},7500:(e,t,i)=>{"use strict";const s=i(375),a=i(8068),n=i(8160),r=i(3328),o={isDate:function(e){return e instanceof Date}};e.exports=a.extend({type:"date",coerce:{from:["number","string"],method:(e,{schema:t})=>({value:o.parse(e,t._flags.format)||e})},validate(e,{schema:t,error:i,prefs:s}){if(e instanceof Date&&!isNaN(e.getTime()))return;const a=t._flags.format;return s.convert&&a&&"string"==typeof e?{value:e,errors:i("date.format",{format:a})}:{value:e,errors:i("date.base")}},rules:{compare:{method:!1,validate(e,t,{date:i},{name:s,operator:a,args:r}){const o="now"===i?Date.now():i.getTime();return n.compare(e.getTime(),o,a)?e:t.error("date."+s,{limit:r.date,value:e})},args:[{name:"date",ref:!0,normalize:e=>"now"===e?e:o.parse(e),assert:e=>null!==e,message:"must have a valid date format"}]},format:{method(e){return s(["iso","javascript","unix"].includes(e),"Unknown date format",e),this.$_setFlag("format",e)}},greater:{method(e){return this.$_addRule({name:"greater",method:"compare",args:{date:e},operator:">"})}},iso:{method(){return this.format("iso")}},less:{method(e){return this.$_addRule({name:"less",method:"compare",args:{date:e},operator:"<"})}},max:{method(e){return this.$_addRule({name:"max",method:"compare",args:{date:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"compare",args:{date:e},operator:">="})}},timestamp:{method(e="javascript"){return s(["javascript","unix"].includes(e),'"type" must be one of "javascript, unix"'),this.format(e)}}},cast:{number:{from:o.isDate,to:(e,t)=>e.getTime()},string:{from:o.isDate,to:(e,{prefs:t})=>r.date(e,t)}},messages:{"date.base":"{{#label}} must be a valid date","date.format":'{{#label}} must be in {msg("date.format." + #format) || #format} format',"date.greater":"{{#label}} must be greater than {{:#limit}}","date.less":"{{#label}} must be less than {{:#limit}}","date.max":"{{#label}} must be less than or equal to {{:#limit}}","date.min":"{{#label}} must be greater than or equal to {{:#limit}}","date.format.iso":"ISO 8601 date","date.format.javascript":"timestamp or number of milliseconds","date.format.unix":"timestamp or number of seconds"}}),o.parse=function(e,t){if(e instanceof Date)return e;if("string"!=typeof e&&(isNaN(e)||!isFinite(e)))return null;if(/^\s*$/.test(e))return null;if("iso"===t)return n.isIsoDate(e)?o.date(e.toString()):null;const i=e;if("string"==typeof e&&/^[+-]?\d+(\.\d+)?$/.test(e)&&(e=parseFloat(e)),t){if("javascript"===t)return o.date(1*e);if("unix"===t)return o.date(1e3*e);if("string"==typeof i)return null}return o.date(e)},o.date=function(e){const t=new Date(e);return isNaN(t.getTime())?null:t}},390:(e,t,i)=>{"use strict";const s=i(375),a=i(7824);e.exports=a.extend({type:"function",properties:{typeof:"function"},rules:{arity:{method(e){return s(Number.isSafeInteger(e)&&e>=0,"n must be a positive integer"),this.$_addRule({name:"arity",args:{n:e}})},validate:(e,t,{n:i})=>e.length===i?e:t.error("function.arity",{n:i})},class:{method(){return this.$_addRule("class")},validate:(e,t)=>/^\s*class\s/.test(e.toString())?e:t.error("function.class",{value:e})},minArity:{method(e){return s(Number.isSafeInteger(e)&&e>0,"n must be a strict positive integer"),this.$_addRule({name:"minArity",args:{n:e}})},validate:(e,t,{n:i})=>e.length>=i?e:t.error("function.minArity",{n:i})},maxArity:{method(e){return s(Number.isSafeInteger(e)&&e>=0,"n must be a positive integer"),this.$_addRule({name:"maxArity",args:{n:e}})},validate:(e,t,{n:i})=>e.length<=i?e:t.error("function.maxArity",{n:i})}},messages:{"function.arity":"{{#label}} must have an arity of {{#n}}","function.class":"{{#label}} must be a class","function.maxArity":"{{#label}} must have an arity lesser or equal to {{#n}}","function.minArity":"{{#label}} must have an arity greater or equal to {{#n}}"}})},7824:(e,t,i)=>{"use strict";const s=i(978),a=i(375),n=i(8571),r=i(3652),o=i(8068),l=i(8160),c=i(3292),u=i(6354),d=i(6133),m=i(3328),h={renameDefaults:{alias:!1,multiple:!1,override:!1}};e.exports=o.extend({type:"_keys",properties:{typeof:"object"},flags:{unknown:{default:!1}},terms:{dependencies:{init:null},keys:{init:null,manifest:{mapped:{from:"schema",to:"key"}}},patterns:{init:null},renames:{init:null}},args:(e,t)=>e.keys(t),validate(e,{schema:t,error:i,state:s,prefs:a}){if(!e||typeof e!==t.$_property("typeof")||Array.isArray(e))return{value:e,errors:i("object.base",{type:t.$_property("typeof")})};if(!(t.$_terms.renames||t.$_terms.dependencies||t.$_terms.keys||t.$_terms.patterns||t.$_terms.externals))return;e=h.clone(e,a);const n=[];if(t.$_terms.renames&&!h.rename(t,e,s,a,n))return{value:e,errors:n};if(!t.$_terms.keys&&!t.$_terms.patterns&&!t.$_terms.dependencies)return{value:e,errors:n};const r=new Set(Object.keys(e));if(t.$_terms.keys){const i=[e,...s.ancestors];for(const o of t.$_terms.keys){const t=o.key,l=e[t];r.delete(t);const c=s.localize([...s.path,t],i,o),u=o.schema.$_validate(l,c,a);if(u.errors){if(a.abortEarly)return{value:e,errors:u.errors};void 0!==u.value&&(e[t]=u.value),n.push(...u.errors)}else"strip"===o.schema._flags.result||void 0===u.value&&void 0!==l?delete e[t]:void 0!==u.value&&(e[t]=u.value)}}if(r.size||t._flags._hasPatternMatch){const i=h.unknown(t,e,r,n,s,a);if(i)return i}if(t.$_terms.dependencies)for(const i of t.$_terms.dependencies){if(null!==i.key&&!1===h.isPresent(i.options)(i.key.resolve(e,s,a,null,{shadow:!1})))continue;const r=h.dependencies[i.rel](t,i,e,s,a);if(r){const i=t.$_createError(r.code,e,r.context,s,a);if(a.abortEarly)return{value:e,errors:i};n.push(i)}}return{value:e,errors:n}},rules:{and:{method(...e){return l.verifyFlat(e,"and"),h.dependency(this,"and",null,e)}},append:{method(e){return null==e||0===Object.keys(e).length?this:this.keys(e)}},assert:{method(e,t,i){m.isTemplate(e)||(e=c.ref(e)),a(void 0===i||"string"==typeof i,"Message must be a string"),t=this.$_compile(t,{appendPath:!0});const s=this.$_addRule({name:"assert",args:{subject:e,schema:t,message:i}});return s.$_mutateRegister(e),s.$_mutateRegister(t),s},validate(e,{error:t,prefs:i,state:s},{subject:a,schema:n,message:r}){const o=a.resolve(e,s,i),l=d.isRef(a)?a.absolute(s):[];return n.$_match(o,s.localize(l,[e,...s.ancestors],n),i)?e:t("object.assert",{subject:a,message:r})},args:["subject","schema","message"],multi:!0},instance:{method(e,t){return a("function"==typeof e,"constructor must be a function"),t=t||e.name,this.$_addRule({name:"instance",args:{constructor:e,name:t}})},validate:(e,t,{constructor:i,name:s})=>e instanceof i?e:t.error("object.instance",{type:s,value:e}),args:["constructor","name"]},keys:{method(e){a(void 0===e||"object"==typeof e,"Object schema must be a valid object"),a(!l.isSchema(e),"Object schema cannot be a joi schema");const t=this.clone();if(e)if(Object.keys(e).length){t.$_terms.keys=t.$_terms.keys?t.$_terms.keys.filter((t=>!e.hasOwnProperty(t.key))):new h.Keys;for(const i in e)l.tryWithPath((()=>t.$_terms.keys.push({key:i,schema:this.$_compile(e[i])})),i)}else t.$_terms.keys=new h.Keys;else t.$_terms.keys=null;return t.$_mutateRebuild()}},length:{method(e){return this.$_addRule({name:"length",args:{limit:e},operator:"="})},validate:(e,t,{limit:i},{name:s,operator:a,args:n})=>l.compare(Object.keys(e).length,i,a)?e:t.error("object."+s,{limit:n.limit,value:e}),args:[{name:"limit",ref:!0,assert:l.limit,message:"must be a positive integer"}]},max:{method(e){return this.$_addRule({name:"max",method:"length",args:{limit:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"length",args:{limit:e},operator:">="})}},nand:{method(...e){return l.verifyFlat(e,"nand"),h.dependency(this,"nand",null,e)}},or:{method(...e){return l.verifyFlat(e,"or"),h.dependency(this,"or",null,e)}},oxor:{method(...e){return h.dependency(this,"oxor",null,e)}},pattern:{method(e,t,i={}){const s=e instanceof RegExp;s||(e=this.$_compile(e,{appendPath:!0})),a(void 0!==t,"Invalid rule"),l.assertOptions(i,["fallthrough","matches"]),s&&a(!e.flags.includes("g")&&!e.flags.includes("y"),"pattern should not use global or sticky mode"),t=this.$_compile(t,{appendPath:!0});const n=this.clone();n.$_terms.patterns=n.$_terms.patterns||[];const r={[s?"regex":"schema"]:e,rule:t};return i.matches&&(r.matches=this.$_compile(i.matches),"array"!==r.matches.type&&(r.matches=r.matches.$_root.array().items(r.matches)),n.$_mutateRegister(r.matches),n.$_setFlag("_hasPatternMatch",!0,{clone:!1})),i.fallthrough&&(r.fallthrough=!0),n.$_terms.patterns.push(r),n.$_mutateRegister(t),n}},ref:{method(){return this.$_addRule("ref")},validate:(e,t)=>d.isRef(e)?e:t.error("object.refType",{value:e})},regex:{method(){return this.$_addRule("regex")},validate:(e,t)=>e instanceof RegExp?e:t.error("object.regex",{value:e})},rename:{method(e,t,i={}){a("string"==typeof e||e instanceof RegExp,"Rename missing the from argument"),a("string"==typeof t||t instanceof m,"Invalid rename to argument"),a(t!==e,"Cannot rename key to same name:",e),l.assertOptions(i,["alias","ignoreUndefined","override","multiple"]);const n=this.clone();n.$_terms.renames=n.$_terms.renames||[];for(const t of n.$_terms.renames)a(t.from!==e,"Cannot rename the same key multiple times");return t instanceof m&&n.$_mutateRegister(t),n.$_terms.renames.push({from:e,to:t,options:s(h.renameDefaults,i)}),n}},schema:{method(e="any"){return this.$_addRule({name:"schema",args:{type:e}})},validate:(e,t,{type:i})=>!l.isSchema(e)||"any"!==i&&e.type!==i?t.error("object.schema",{type:i}):e},unknown:{method(e){return this.$_setFlag("unknown",!1!==e)}},with:{method(e,t,i={}){return h.dependency(this,"with",e,t,i)}},without:{method(e,t,i={}){return h.dependency(this,"without",e,t,i)}},xor:{method(...e){return l.verifyFlat(e,"xor"),h.dependency(this,"xor",null,e)}}},overrides:{default(e,t){return void 0===e&&(e=l.symbols.deepDefault),this.$_parent("default",e,t)}},rebuild(e){if(e.$_terms.keys){const t=new r.Sorter;for(const i of e.$_terms.keys)l.tryWithPath((()=>t.add(i,{after:i.schema.$_rootReferences(),group:i.key})),i.key);e.$_terms.keys=new h.Keys(...t.nodes)}},manifest:{build(e,t){if(t.keys&&(e=e.keys(t.keys)),t.dependencies)for(const{rel:i,key:s=null,peers:a,options:n}of t.dependencies)e=h.dependency(e,i,s,a,n);if(t.patterns)for(const{regex:i,schema:s,rule:a,fallthrough:n,matches:r}of t.patterns)e=e.pattern(i||s,a,{fallthrough:n,matches:r});if(t.renames)for(const{from:i,to:s,options:a}of t.renames)e=e.rename(i,s,a);return e}},messages:{"object.and":"{{#label}} contains {{#presentWithLabels}} without its required peers {{#missingWithLabels}}","object.assert":'{{#label}} is invalid because {if(#subject.key, `"` + #subject.key + `" failed to ` + (#message || "pass the assertion test"), #message || "the assertion failed")}',"object.base":"{{#label}} must be of type {{#type}}","object.instance":"{{#label}} must be an instance of {{:#type}}","object.length":'{{#label}} must have {{#limit}} key{if(#limit == 1, "", "s")}',"object.max":'{{#label}} must have less than or equal to {{#limit}} key{if(#limit == 1, "", "s")}',"object.min":'{{#label}} must have at least {{#limit}} key{if(#limit == 1, "", "s")}',"object.missing":"{{#label}} must contain at least one of {{#peersWithLabels}}","object.nand":"{{:#mainWithLabel}} must not exist simultaneously with {{#peersWithLabels}}","object.oxor":"{{#label}} contains a conflict between optional exclusive peers {{#peersWithLabels}}","object.pattern.match":"{{#label}} keys failed to match pattern requirements","object.refType":"{{#label}} must be a Joi reference","object.regex":"{{#label}} must be a RegExp object","object.rename.multiple":"{{#label}} cannot rename {{:#from}} because multiple renames are disabled and another key was already renamed to {{:#to}}","object.rename.override":"{{#label}} cannot rename {{:#from}} because override is disabled and target {{:#to}} exists","object.schema":"{{#label}} must be a Joi schema of {{#type}} type","object.unknown":"{{#label}} is not allowed","object.with":"{{:#mainWithLabel}} missing required peer {{:#peerWithLabel}}","object.without":"{{:#mainWithLabel}} conflict with forbidden peer {{:#peerWithLabel}}","object.xor":"{{#label}} contains a conflict between exclusive peers {{#peersWithLabels}}"}}),h.clone=function(e,t){if("object"==typeof e){if(t.nonEnumerables)return n(e,{shallow:!0});const i=Object.create(Object.getPrototypeOf(e));return Object.assign(i,e),i}const i=function(...t){return e.apply(this,t)};return i.prototype=n(e.prototype),Object.defineProperty(i,"name",{value:e.name,writable:!1}),Object.defineProperty(i,"length",{value:e.length,writable:!1}),Object.assign(i,e),i},h.dependency=function(e,t,i,s,n){a(null===i||"string"==typeof i,t,"key must be a strings"),n||(n=s.length>1&&"object"==typeof s[s.length-1]?s.pop():{}),l.assertOptions(n,["separator","isPresent"]),s=[].concat(s);const r=l.default(n.separator,"."),o=[];for(const e of s)a("string"==typeof e,t,"peers must be strings"),o.push(c.ref(e,{separator:r,ancestor:0,prefix:!1}));null!==i&&(i=c.ref(i,{separator:r,ancestor:0,prefix:!1}));const u=e.clone();return u.$_terms.dependencies=u.$_terms.dependencies||[],u.$_terms.dependencies.push(new h.Dependency(t,i,o,s,n)),u},h.dependencies={and(e,t,i,s,a){const n=[],r=[],o=t.peers.length,l=h.isPresent(t.options);for(const e of t.peers)!1===l(e.resolve(i,s,a,null,{shadow:!1}))?n.push(e.key):r.push(e.key);if(n.length!==o&&r.length!==o)return{code:"object.and",context:{present:r,presentWithLabels:h.keysToLabels(e,r),missing:n,missingWithLabels:h.keysToLabels(e,n)}}},nand(e,t,i,s,a){const n=[],r=h.isPresent(t.options);for(const e of t.peers)r(e.resolve(i,s,a,null,{shadow:!1}))&&n.push(e.key);if(n.length!==t.peers.length)return;const o=t.paths[0],l=t.paths.slice(1);return{code:"object.nand",context:{main:o,mainWithLabel:h.keysToLabels(e,o),peers:l,peersWithLabels:h.keysToLabels(e,l)}}},or(e,t,i,s,a){const n=h.isPresent(t.options);for(const e of t.peers)if(n(e.resolve(i,s,a,null,{shadow:!1})))return;return{code:"object.missing",context:{peers:t.paths,peersWithLabels:h.keysToLabels(e,t.paths)}}},oxor(e,t,i,s,a){const n=[],r=h.isPresent(t.options);for(const e of t.peers)r(e.resolve(i,s,a,null,{shadow:!1}))&&n.push(e.key);if(!n.length||1===n.length)return;const o={peers:t.paths,peersWithLabels:h.keysToLabels(e,t.paths)};return o.present=n,o.presentWithLabels=h.keysToLabels(e,n),{code:"object.oxor",context:o}},with(e,t,i,s,a){const n=h.isPresent(t.options);for(const r of t.peers)if(!1===n(r.resolve(i,s,a,null,{shadow:!1})))return{code:"object.with",context:{main:t.key.key,mainWithLabel:h.keysToLabels(e,t.key.key),peer:r.key,peerWithLabel:h.keysToLabels(e,r.key)}}},without(e,t,i,s,a){const n=h.isPresent(t.options);for(const r of t.peers)if(n(r.resolve(i,s,a,null,{shadow:!1})))return{code:"object.without",context:{main:t.key.key,mainWithLabel:h.keysToLabels(e,t.key.key),peer:r.key,peerWithLabel:h.keysToLabels(e,r.key)}}},xor(e,t,i,s,a){const n=[],r=h.isPresent(t.options);for(const e of t.peers)r(e.resolve(i,s,a,null,{shadow:!1}))&&n.push(e.key);if(1===n.length)return;const o={peers:t.paths,peersWithLabels:h.keysToLabels(e,t.paths)};return 0===n.length?{code:"object.missing",context:o}:(o.present=n,o.presentWithLabels=h.keysToLabels(e,n),{code:"object.xor",context:o})}},h.keysToLabels=function(e,t){return Array.isArray(t)?t.map((t=>e.$_mapLabels(t))):e.$_mapLabels(t)},h.isPresent=function(e){return"function"==typeof e.isPresent?e.isPresent:e=>void 0!==e},h.rename=function(e,t,i,s,a){const n={};for(const r of e.$_terms.renames){const o=[],l="string"!=typeof r.from;if(l)for(const e in t){if(void 0===t[e]&&r.options.ignoreUndefined)continue;if(e===r.to)continue;const i=r.from.exec(e);i&&o.push({from:e,to:r.to,match:i})}else!Object.prototype.hasOwnProperty.call(t,r.from)||void 0===t[r.from]&&r.options.ignoreUndefined||o.push(r);for(const c of o){const o=c.from;let u=c.to;if(u instanceof m&&(u=u.render(t,i,s,c.match)),o!==u){if(!r.options.multiple&&n[u]&&(a.push(e.$_createError("object.rename.multiple",t,{from:o,to:u,pattern:l},i,s)),s.abortEarly))return!1;if(Object.prototype.hasOwnProperty.call(t,u)&&!r.options.override&&!n[u]&&(a.push(e.$_createError("object.rename.override",t,{from:o,to:u,pattern:l},i,s)),s.abortEarly))return!1;void 0===t[o]?delete t[u]:t[u]=t[o],n[u]=!0,r.options.alias||delete t[o]}}}return!0},h.unknown=function(e,t,i,s,a,n){if(e.$_terms.patterns){let r=!1;const o=e.$_terms.patterns.map((e=>{if(e.matches)return r=!0,[]})),l=[t,...a.ancestors];for(const r of i){const c=t[r],u=[...a.path,r];for(let d=0;d<e.$_terms.patterns.length;++d){const m=e.$_terms.patterns[d];if(m.regex){const e=m.regex.test(r);if(a.mainstay.tracer.debug(a,"rule",`pattern.${d}`,e?"pass":"error"),!e)continue}else if(!m.schema.$_match(r,a.nest(m.schema,`pattern.${d}`),n))continue;i.delete(r);const h=a.localize(u,l,{schema:m.rule,key:r}),p=m.rule.$_validate(c,h,n);if(p.errors){if(n.abortEarly)return{value:t,errors:p.errors};s.push(...p.errors)}if(m.matches&&o[d].push(r),t[r]=p.value,!m.fallthrough)break}}if(r)for(let i=0;i<o.length;++i){const r=o[i];if(!r)continue;const c=e.$_terms.patterns[i].matches,d=a.localize(a.path,l,c),m=c.$_validate(r,d,n);if(m.errors){const i=u.details(m.errors,{override:!1});i.matches=r;const o=e.$_createError("object.pattern.match",t,i,a,n);if(n.abortEarly)return{value:t,errors:o};s.push(o)}}}if(i.size&&(e.$_terms.keys||e.$_terms.patterns)){if(n.stripUnknown&&!e._flags.unknown||n.skipFunctions){const e=!(!n.stripUnknown||!0!==n.stripUnknown&&!n.stripUnknown.objects);for(const s of i)e?(delete t[s],i.delete(s)):"function"==typeof t[s]&&i.delete(s)}if(!l.default(e._flags.unknown,n.allowUnknown))for(const r of i){const i=a.localize([...a.path,r],[]),o=e.$_createError("object.unknown",t[r],{child:r},i,n,{flags:!1});if(n.abortEarly)return{value:t,errors:o};s.push(o)}}},h.Dependency=class{constructor(e,t,i,s,a){this.rel=e,this.key=t,this.peers=i,this.paths=s,this.options=a}describe(){const e={rel:this.rel,peers:this.paths};return null!==this.key&&(e.key=this.key.key),"."!==this.peers[0].separator&&(e.options={...e.options,separator:this.peers[0].separator}),this.options.isPresent&&(e.options={...e.options,isPresent:this.options.isPresent}),e}},h.Keys=class extends Array{concat(e){const t=this.slice(),i=new Map;for(let e=0;e<t.length;++e)i.set(t[e].key,e);for(const s of e){const e=s.key,a=i.get(e);void 0!==a?t[a]={key:e,schema:t[a].schema.concat(s.schema)}:t.push(s)}return t}}},8785:(e,t,i)=>{"use strict";const s=i(375),a=i(8068),n=i(8160),r=i(3292),o=i(6354),l={};e.exports=a.extend({type:"link",properties:{schemaChain:!0},terms:{link:{init:null,manifest:"single",register:!1}},args:(e,t)=>e.ref(t),validate(e,{schema:t,state:i,prefs:a}){s(t.$_terms.link,"Uninitialized link schema");const n=l.generate(t,e,i,a),r=t.$_terms.link[0].ref;return n.$_validate(e,i.nest(n,`link:${r.display}:${n.type}`),a)},generate:(e,t,i,s)=>l.generate(e,t,i,s),rules:{ref:{method(e){s(!this.$_terms.link,"Cannot reinitialize schema"),e=r.ref(e),s("value"===e.type||"local"===e.type,"Invalid reference type:",e.type),s("local"===e.type||"root"===e.ancestor||e.ancestor>0,"Link cannot reference itself");const t=this.clone();return t.$_terms.link=[{ref:e}],t}},relative:{method(e=!0){return this.$_setFlag("relative",e)}}},overrides:{concat(e){s(this.$_terms.link,"Uninitialized link schema"),s(n.isSchema(e),"Invalid schema object"),s("link"!==e.type,"Cannot merge type link with another link");const t=this.clone();return t.$_terms.whens||(t.$_terms.whens=[]),t.$_terms.whens.push({concat:e}),t.$_mutateRebuild()}},manifest:{build:(e,t)=>(s(t.link,"Invalid link description missing link"),e.ref(t.link))}}),l.generate=function(e,t,i,s){let a=i.mainstay.links.get(e);if(a)return a._generate(t,i,s).schema;const n=e.$_terms.link[0].ref,{perspective:r,path:o}=l.perspective(n,i);l.assert(r,"which is outside of schema boundaries",n,e,i,s);try{a=o.length?r.$_reach(o):r}catch(t){l.assert(!1,"to non-existing schema",n,e,i,s)}return l.assert("link"!==a.type,"which is another link",n,e,i,s),e._flags.relative||i.mainstay.links.set(e,a),a._generate(t,i,s).schema},l.perspective=function(e,t){if("local"===e.type){for(const{schema:i,key:s}of t.schemas){if((i._flags.id||s)===e.path[0])return{perspective:i,path:e.path.slice(1)};if(i.$_terms.shared)for(const t of i.$_terms.shared)if(t._flags.id===e.path[0])return{perspective:t,path:e.path.slice(1)}}return{perspective:null,path:null}}return"root"===e.ancestor?{perspective:t.schemas[t.schemas.length-1].schema,path:e.path}:{perspective:t.schemas[e.ancestor]&&t.schemas[e.ancestor].schema,path:e.path}},l.assert=function(e,t,i,a,n,r){e||s(!1,`"${o.label(a._flags,n,r)}" contains link reference "${i.display}" ${t}`)}},3832:(e,t,i)=>{"use strict";const s=i(375),a=i(8068),n=i(8160),r={numberRx:/^\s*[+-]?(?:(?:\d+(?:\.\d*)?)|(?:\.\d+))(?:e([+-]?\d+))?\s*$/i,precisionRx:/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/,exponentialPartRegex:/[eE][+-]?\d+$/,leadingSignAndZerosRegex:/^[+-]?(0*)?/,dotRegex:/\./,trailingZerosRegex:/0+$/,decimalPlaces(e){const t=e.toString(),i=t.indexOf("."),s=t.indexOf("e");return(i<0?0:(s<0?t.length:s)-i-1)+(s<0?0:Math.max(0,-parseInt(t.slice(s+1))))}};e.exports=a.extend({type:"number",flags:{unsafe:{default:!1}},coerce:{from:"string",method(e,{schema:t,error:i}){if(!e.match(r.numberRx))return;e=e.trim();const s={value:parseFloat(e)};if(0===s.value&&(s.value=0),!t._flags.unsafe)if(e.match(/e/i)){if(r.extractSignificantDigits(e)!==r.extractSignificantDigits(String(s.value)))return s.errors=i("number.unsafe"),s}else{const t=s.value.toString();if(t.match(/e/i))return s;if(t!==r.normalizeDecimal(e))return s.errors=i("number.unsafe"),s}return s}},validate(e,{schema:t,error:i,prefs:s}){if(e===1/0||e===-1/0)return{value:e,errors:i("number.infinity")};if(!n.isNumber(e))return{value:e,errors:i("number.base")};const a={value:e};if(s.convert){const e=t.$_getRule("precision");if(e){const t=Math.pow(10,e.args.limit);a.value=Math.round(a.value*t)/t}}return 0===a.value&&(a.value=0),!t._flags.unsafe&&(e>Number.MAX_SAFE_INTEGER||e<Number.MIN_SAFE_INTEGER)&&(a.errors=i("number.unsafe")),a},rules:{compare:{method:!1,validate:(e,t,{limit:i},{name:s,operator:a,args:r})=>n.compare(e,i,a)?e:t.error("number."+s,{limit:r.limit,value:e}),args:[{name:"limit",ref:!0,assert:n.isNumber,message:"must be a number"}]},greater:{method(e){return this.$_addRule({name:"greater",method:"compare",args:{limit:e},operator:">"})}},integer:{method(){return this.$_addRule("integer")},validate:(e,t)=>Math.trunc(e)-e==0?e:t.error("number.integer")},less:{method(e){return this.$_addRule({name:"less",method:"compare",args:{limit:e},operator:"<"})}},max:{method(e){return this.$_addRule({name:"max",method:"compare",args:{limit:e},operator:"<="})}},min:{method(e){return this.$_addRule({name:"min",method:"compare",args:{limit:e},operator:">="})}},multiple:{method(e){const t="number"==typeof e?r.decimalPlaces(e):null,i=Math.pow(10,t);return this.$_addRule({name:"multiple",args:{base:e,baseDecimalPlace:t,pfactor:i}})},validate:(e,t,{base:i,baseDecimalPlace:s,pfactor:a},n)=>r.decimalPlaces(e)>s?t.error("number.multiple",{multiple:n.args.base,value:e}):Math.round(a*e)%Math.round(a*i)==0?e:t.error("number.multiple",{multiple:n.args.base,value:e}),args:[{name:"base",ref:!0,assert:e=>"number"==typeof e&&isFinite(e)&&e>0,message:"must be a positive number"},"baseDecimalPlace","pfactor"],multi:!0},negative:{method(){return this.sign("negative")}},port:{method(){return this.$_addRule("port")},validate:(e,t)=>Number.isSafeInteger(e)&&e>=0&&e<=65535?e:t.error("number.port")},positive:{method(){return this.sign("positive")}},precision:{method(e){return s(Number.isSafeInteger(e),"limit must be an integer"),this.$_addRule({name:"precision",args:{limit:e}})},validate(e,t,{limit:i}){const s=e.toString().match(r.precisionRx);return Math.max((s[1]?s[1].length:0)-(s[2]?parseInt(s[2],10):0),0)<=i?e:t.error("number.precision",{limit:i,value:e})},convert:!0},sign:{method(e){return s(["negative","positive"].includes(e),"Invalid sign",e),this.$_addRule({name:"sign",args:{sign:e}})},validate:(e,t,{sign:i})=>"negative"===i&&e<0||"positive"===i&&e>0?e:t.error(`number.${i}`)},unsafe:{method(e=!0){return s("boolean"==typeof e,"enabled must be a boolean"),this.$_setFlag("unsafe",e)}}},cast:{string:{from:e=>"number"==typeof e,to:(e,t)=>e.toString()}},messages:{"number.base":"{{#label}} must be a number","number.greater":"{{#label}} must be greater than {{#limit}}","number.infinity":"{{#label}} cannot be infinity","number.integer":"{{#label}} must be an integer","number.less":"{{#label}} must be less than {{#limit}}","number.max":"{{#label}} must be less than or equal to {{#limit}}","number.min":"{{#label}} must be greater than or equal to {{#limit}}","number.multiple":"{{#label}} must be a multiple of {{#multiple}}","number.negative":"{{#label}} must be a negative number","number.port":"{{#label}} must be a valid port","number.positive":"{{#label}} must be a positive number","number.precision":"{{#label}} must have no more than {{#limit}} decimal places","number.unsafe":"{{#label}} must be a safe number"}}),r.extractSignificantDigits=function(e){return e.replace(r.exponentialPartRegex,"").replace(r.dotRegex,"").replace(r.trailingZerosRegex,"").replace(r.leadingSignAndZerosRegex,"")},r.normalizeDecimal=function(e){return(e=e.replace(/^\+/,"").replace(/\.0*$/,"").replace(/^(-?)\.([^\.]*)$/,"$10.$2").replace(/^(-?)0+([0-9])/,"$1$2")).includes(".")&&e.endsWith("0")&&(e=e.replace(/0+$/,"")),"-0"===e?"0":e}},8966:(e,t,i)=>{"use strict";const s=i(7824);e.exports=s.extend({type:"object",cast:{map:{from:e=>e&&"object"==typeof e,to:(e,t)=>new Map(Object.entries(e))}}})},7417:(e,t,i)=>{"use strict";const s=i(375),a=i(5380),n=i(1745),r=i(9959),o=i(6064),l=i(9926),c=i(5752),u=i(8068),d=i(8160),m={tlds:l instanceof Set&&{tlds:{allow:l,deny:null}},base64Regex:{true:{true:/^(?:[\w\-]{2}[\w\-]{2})*(?:[\w\-]{2}==|[\w\-]{3}=)?$/,false:/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/},false:{true:/^(?:[\w\-]{2}[\w\-]{2})*(?:[\w\-]{2}(==)?|[\w\-]{3}=?)?$/,false:/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}(==)?|[A-Za-z0-9+\/]{3}=?)?$/}},dataUriRegex:/^data:[\w+.-]+\/[\w+.-]+;((charset=[\w-]+|base64),)?(.*)$/,hexRegex:{withPrefix:/^0x[0-9a-f]+$/i,withOptionalPrefix:/^(?:0x)?[0-9a-f]+$/i,withoutPrefix:/^[0-9a-f]+$/i},ipRegex:r.regex({cidr:"forbidden"}).regex,isoDurationRegex:/^P(?!$)(\d+Y)?(\d+M)?(\d+W)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+S)?)?$/,guidBrackets:{"{":"}","[":"]","(":")","":""},guidVersions:{uuidv1:"1",uuidv2:"2",uuidv3:"3",uuidv4:"4",uuidv5:"5",uuidv6:"6",uuidv7:"7",uuidv8:"8"},guidSeparators:new Set([void 0,!0,!1,"-",":"]),normalizationForms:["NFC","NFD","NFKC","NFKD"]};e.exports=u.extend({type:"string",flags:{insensitive:{default:!1},truncate:{default:!1}},terms:{replacements:{init:null}},coerce:{from:"string",method(e,{schema:t,state:i,prefs:s}){const a=t.$_getRule("normalize");a&&(e=e.normalize(a.args.form));const n=t.$_getRule("case");n&&(e="upper"===n.args.direction?e.toLocaleUpperCase():e.toLocaleLowerCase());const r=t.$_getRule("trim");if(r&&r.args.enabled&&(e=e.trim()),t.$_terms.replacements)for(const i of t.$_terms.replacements)e=e.replace(i.pattern,i.replacement);const o=t.$_getRule("hex");if(o&&o.args.options.byteAligned&&e.length%2!=0&&(e=`0${e}`),t.$_getRule("isoDate")){const t=m.isoDate(e);t&&(e=t)}if(t._flags.truncate){const a=t.$_getRule("max");if(a){let n=a.args.limit;if(d.isResolvable(n)&&(n=n.resolve(e,i,s),!d.limit(n)))return{value:e,errors:t.$_createError("any.ref",n,{ref:a.args.limit,arg:"limit",reason:"must be a positive integer"},i,s)};e=e.slice(0,n)}}return{value:e}}},validate(e,{schema:t,error:i}){if("string"!=typeof e)return{value:e,errors:i("string.base")};if(""===e){const s=t.$_getRule("min");if(s&&0===s.args.limit)return;return{value:e,errors:i("string.empty")}}},rules:{alphanum:{method(){return this.$_addRule("alphanum")},validate:(e,t)=>/^[a-zA-Z0-9]+$/.test(e)?e:t.error("string.alphanum")},base64:{method(e={}){return d.assertOptions(e,["paddingRequired","urlSafe"]),e={urlSafe:!1,paddingRequired:!0,...e},s("boolean"==typeof e.paddingRequired,"paddingRequired must be boolean"),s("boolean"==typeof e.urlSafe,"urlSafe must be boolean"),this.$_addRule({name:"base64",args:{options:e}})},validate:(e,t,{options:i})=>m.base64Regex[i.paddingRequired][i.urlSafe].test(e)?e:t.error("string.base64")},case:{method(e){return s(["lower","upper"].includes(e),"Invalid case:",e),this.$_addRule({name:"case",args:{direction:e}})},validate:(e,t,{direction:i})=>"lower"===i&&e===e.toLocaleLowerCase()||"upper"===i&&e===e.toLocaleUpperCase()?e:t.error(`string.${i}case`),convert:!0},creditCard:{method(){return this.$_addRule("creditCard")},validate(e,t){let i=e.length,s=0,a=1;for(;i--;){const t=e.charAt(i)*a;s+=t-9*(t>9),a^=3}return s>0&&s%10==0?e:t.error("string.creditCard")}},dataUri:{method(e={}){return d.assertOptions(e,["paddingRequired"]),e={paddingRequired:!0,...e},s("boolean"==typeof e.paddingRequired,"paddingRequired must be boolean"),this.$_addRule({name:"dataUri",args:{options:e}})},validate(e,t,{options:i}){const s=e.match(m.dataUriRegex);if(s){if(!s[2])return e;if("base64"!==s[2])return e;if(m.base64Regex[i.paddingRequired].false.test(s[3]))return e}return t.error("string.dataUri")}},domain:{method(e){e&&d.assertOptions(e,["allowFullyQualified","allowUnicode","maxDomainSegments","minDomainSegments","tlds"]);const t=m.addressOptions(e);return this.$_addRule({name:"domain",args:{options:e},address:t})},validate:(e,t,i,{address:s})=>a.isValid(e,s)?e:t.error("string.domain")},email:{method(e={}){d.assertOptions(e,["allowFullyQualified","allowUnicode","ignoreLength","maxDomainSegments","minDomainSegments","multiple","separator","tlds"]),s(void 0===e.multiple||"boolean"==typeof e.multiple,"multiple option must be an boolean");const t=m.addressOptions(e),i=new RegExp(`\\s*[${e.separator?o(e.separator):","}]\\s*`);return this.$_addRule({name:"email",args:{options:e},regex:i,address:t})},validate(e,t,{options:i},{regex:s,address:a}){const r=i.multiple?e.split(s):[e],o=[];for(const e of r)n.isValid(e,a)||o.push(e);return o.length?t.error("string.email",{value:e,invalids:o}):e}},guid:{alias:"uuid",method(e={}){d.assertOptions(e,["version","separator"]);let t="";if(e.version){const i=[].concat(e.version);s(i.length>=1,"version must have at least 1 valid version specified");const a=new Set;for(let e=0;e<i.length;++e){const n=i[e];s("string"==typeof n,"version at position "+e+" must be a string");const r=m.guidVersions[n.toLowerCase()];s(r,"version at position "+e+" must be one of "+Object.keys(m.guidVersions).join(", ")),s(!a.has(r),"version at position "+e+" must not be a duplicate"),t+=r,a.add(r)}}s(m.guidSeparators.has(e.separator),'separator must be one of true, false, "-", or ":"');const i=void 0===e.separator?"[:-]?":!0===e.separator?"[:-]":!1===e.separator?"[]?":`\\${e.separator}`,a=new RegExp(`^([\\[{\\(]?)[0-9A-F]{8}(${i})[0-9A-F]{4}\\2?[${t||"0-9A-F"}][0-9A-F]{3}\\2?[${t?"89AB":"0-9A-F"}][0-9A-F]{3}\\2?[0-9A-F]{12}([\\]}\\)]?)$`,"i");return this.$_addRule({name:"guid",args:{options:e},regex:a})},validate(e,t,i,{regex:s}){const a=s.exec(e);return a?m.guidBrackets[a[1]]!==a[a.length-1]?t.error("string.guid"):e:t.error("string.guid")}},hex:{method(e={}){return d.assertOptions(e,["byteAligned","prefix"]),e={byteAligned:!1,prefix:!1,...e},s("boolean"==typeof e.byteAligned,"byteAligned must be boolean"),s("boolean"==typeof e.prefix||"optional"===e.prefix,'prefix must be boolean or "optional"'),this.$_addRule({name:"hex",args:{options:e}})},validate:(e,t,{options:i})=>("optional"===i.prefix?m.hexRegex.withOptionalPrefix:!0===i.prefix?m.hexRegex.withPrefix:m.hexRegex.withoutPrefix).test(e)?i.byteAligned&&e.length%2!=0?t.error("string.hexAlign"):e:t.error("string.hex")},hostname:{method(){return this.$_addRule("hostname")},validate:(e,t)=>a.isValid(e,{minDomainSegments:1})||m.ipRegex.test(e)?e:t.error("string.hostname")},insensitive:{method(){return this.$_setFlag("insensitive",!0)}},ip:{method(e={}){d.assertOptions(e,["cidr","version"]);const{cidr:t,versions:i,regex:s}=r.regex(e),a=e.version?i:void 0;return this.$_addRule({name:"ip",args:{options:{cidr:t,version:a}},regex:s})},validate:(e,t,{options:i},{regex:s})=>s.test(e)?e:i.version?t.error("string.ipVersion",{value:e,cidr:i.cidr,version:i.version}):t.error("string.ip",{value:e,cidr:i.cidr})},isoDate:{method(){return this.$_addRule("isoDate")},validate:(e,{error:t})=>m.isoDate(e)?e:t("string.isoDate")},isoDuration:{method(){return this.$_addRule("isoDuration")},validate:(e,t)=>m.isoDurationRegex.test(e)?e:t.error("string.isoDuration")},length:{method(e,t){return m.length(this,"length",e,"=",t)},validate(e,t,{limit:i,encoding:s},{name:a,operator:n,args:r}){const o=!s&&e.length;return d.compare(o,i,n)?e:t.error("string."+a,{limit:r.limit,value:e,encoding:s})},args:[{name:"limit",ref:!0,assert:d.limit,message:"must be a positive integer"},"encoding"]},lowercase:{method(){return this.case("lower")}},max:{method(e,t){return m.length(this,"max",e,"<=",t)},args:["limit","encoding"]},min:{method(e,t){return m.length(this,"min",e,">=",t)},args:["limit","encoding"]},normalize:{method(e="NFC"){return s(m.normalizationForms.includes(e),"normalization form must be one of "+m.normalizationForms.join(", ")),this.$_addRule({name:"normalize",args:{form:e}})},validate:(e,{error:t},{form:i})=>e===e.normalize(i)?e:t("string.normalize",{value:e,form:i}),convert:!0},pattern:{alias:"regex",method(e,t={}){s(e instanceof RegExp,"regex must be a RegExp"),s(!e.flags.includes("g")&&!e.flags.includes("y"),"regex should not use global or sticky mode"),"string"==typeof t&&(t={name:t}),d.assertOptions(t,["invert","name"]);const i=["string.pattern",t.invert?".invert":"",t.name?".name":".base"].join("");return this.$_addRule({name:"pattern",args:{regex:e,options:t},errorCode:i})},validate:(e,t,{regex:i,options:s},{errorCode:a})=>i.test(e)^s.invert?e:t.error(a,{name:s.name,regex:i,value:e}),args:["regex","options"],multi:!0},replace:{method(e,t){"string"==typeof e&&(e=new RegExp(o(e),"g")),s(e instanceof RegExp,"pattern must be a RegExp"),s("string"==typeof t,"replacement must be a String");const i=this.clone();return i.$_terms.replacements||(i.$_terms.replacements=[]),i.$_terms.replacements.push({pattern:e,replacement:t}),i}},token:{method(){return this.$_addRule("token")},validate:(e,t)=>/^\w+$/.test(e)?e:t.error("string.token")},trim:{method(e=!0){return s("boolean"==typeof e,"enabled must be a boolean"),this.$_addRule({name:"trim",args:{enabled:e}})},validate:(e,t,{enabled:i})=>i&&e!==e.trim()?t.error("string.trim"):e,convert:!0},truncate:{method(e=!0){return s("boolean"==typeof e,"enabled must be a boolean"),this.$_setFlag("truncate",e)}},uppercase:{method(){return this.case("upper")}},uri:{method(e={}){d.assertOptions(e,["allowRelative","allowQuerySquareBrackets","domain","relativeOnly","scheme","encodeUri"]),e.domain&&d.assertOptions(e.domain,["allowFullyQualified","allowUnicode","maxDomainSegments","minDomainSegments","tlds"]);const{regex:t,scheme:i}=c.regex(e),s=e.domain?m.addressOptions(e.domain):null;return this.$_addRule({name:"uri",args:{options:e},regex:t,domain:s,scheme:i})},validate(e,t,{options:i},{regex:s,domain:n,scheme:r}){if(["http:/","https:/"].includes(e))return t.error("string.uri");let o=s.exec(e);if(!o&&t.prefs.convert&&i.encodeUri){const t=encodeURI(e);o=s.exec(t),o&&(e=t)}if(o){const s=o[1]||o[2];return!n||i.allowRelative&&!s||a.isValid(s,n)?e:t.error("string.domain",{value:s})}return i.relativeOnly?t.error("string.uriRelativeOnly"):i.scheme?t.error("string.uriCustomScheme",{scheme:r,value:e}):t.error("string.uri")}}},manifest:{build(e,t){if(t.replacements)for(const{pattern:i,replacement:s}of t.replacements)e=e.replace(i,s);return e}},messages:{"string.alphanum":"{{#label}} must only contain alpha-numeric characters","string.base":"{{#label}} must be a string","string.base64":"{{#label}} must be a valid base64 string","string.creditCard":"{{#label}} must be a credit card","string.dataUri":"{{#label}} must be a valid dataUri string","string.domain":"{{#label}} must contain a valid domain name","string.email":"{{#label}} must be a valid email","string.empty":"{{#label}} is not allowed to be empty","string.guid":"{{#label}} must be a valid GUID","string.hex":"{{#label}} must only contain hexadecimal characters","string.hexAlign":"{{#label}} hex decoded representation must be byte aligned","string.hostname":"{{#label}} must be a valid hostname","string.ip":"{{#label}} must be a valid ip address with a {{#cidr}} CIDR","string.ipVersion":"{{#label}} must be a valid ip address of one of the following versions {{#version}} with a {{#cidr}} CIDR","string.isoDate":"{{#label}} must be in iso format","string.isoDuration":"{{#label}} must be a valid ISO 8601 duration","string.length":"{{#label}} length must be {{#limit}} characters long","string.lowercase":"{{#label}} must only contain lowercase characters","string.max":"{{#label}} length must be less than or equal to {{#limit}} characters long","string.min":"{{#label}} length must be at least {{#limit}} characters long","string.normalize":"{{#label}} must be unicode normalized in the {{#form}} form","string.token":"{{#label}} must only contain alpha-numeric and underscore characters","string.pattern.base":"{{#label}} with value {:[.]} fails to match the required pattern: {{#regex}}","string.pattern.name":"{{#label}} with value {:[.]} fails to match the {{#name}} pattern","string.pattern.invert.base":"{{#label}} with value {:[.]} matches the inverted pattern: {{#regex}}","string.pattern.invert.name":"{{#label}} with value {:[.]} matches the inverted {{#name}} pattern","string.trim":"{{#label}} must not have leading or trailing whitespace","string.uri":"{{#label}} must be a valid uri","string.uriCustomScheme":"{{#label}} must be a valid uri with a scheme matching the {{#scheme}} pattern","string.uriRelativeOnly":"{{#label}} must be a valid relative uri","string.uppercase":"{{#label}} must only contain uppercase characters"}}),m.addressOptions=function(e){if(!e)return m.tlds||e;if(s(void 0===e.minDomainSegments||Number.isSafeInteger(e.minDomainSegments)&&e.minDomainSegments>0,"minDomainSegments must be a positive integer"),s(void 0===e.maxDomainSegments||Number.isSafeInteger(e.maxDomainSegments)&&e.maxDomainSegments>0,"maxDomainSegments must be a positive integer"),!1===e.tlds)return e;if(!0===e.tlds||void 0===e.tlds)return s(m.tlds,"Built-in TLD list disabled"),Object.assign({},e,m.tlds);s("object"==typeof e.tlds,"tlds must be true, false, or an object");const t=e.tlds.deny;if(t)return Array.isArray(t)&&(e=Object.assign({},e,{tlds:{deny:new Set(t)}})),s(e.tlds.deny instanceof Set,"tlds.deny must be an array, Set, or boolean"),s(!e.tlds.allow,"Cannot specify both tlds.allow and tlds.deny lists"),m.validateTlds(e.tlds.deny,"tlds.deny"),e;const i=e.tlds.allow;return i?!0===i?(s(m.tlds,"Built-in TLD list disabled"),Object.assign({},e,m.tlds)):(Array.isArray(i)&&(e=Object.assign({},e,{tlds:{allow:new Set(i)}})),s(e.tlds.allow instanceof Set,"tlds.allow must be an array, Set, or boolean"),m.validateTlds(e.tlds.allow,"tlds.allow"),e):e},m.validateTlds=function(e,t){for(const i of e)s(a.isValid(i,{minDomainSegments:1,maxDomainSegments:1}),`${t} must contain valid top level domain names`)},m.isoDate=function(e){if(!d.isIsoDate(e))return null;/.*T.*[+-]\d\d$/.test(e)&&(e+="00");const t=new Date(e);return isNaN(t.getTime())?null:t.toISOString()},m.length=function(e,t,i,a,n){return s(!n||!1,"Invalid encoding:",n),e.$_addRule({name:t,method:"length",args:{limit:i,encoding:n},operator:a})}},8826:(e,t,i)=>{"use strict";const s=i(375),a=i(8068),n={};n.Map=class extends Map{slice(){return new n.Map(this)}},e.exports=a.extend({type:"symbol",terms:{map:{init:new n.Map}},coerce:{method(e,{schema:t,error:i}){const s=t.$_terms.map.get(e);return s&&(e=s),t._flags.only&&"symbol"!=typeof e?{value:e,errors:i("symbol.map",{map:t.$_terms.map})}:{value:e}}},validate(e,{error:t}){if("symbol"!=typeof e)return{value:e,errors:t("symbol.base")}},rules:{map:{method(e){e&&!e[Symbol.iterator]&&"object"==typeof e&&(e=Object.entries(e)),s(e&&e[Symbol.iterator],"Iterable must be an iterable or object");const t=this.clone(),i=[];for(const a of e){s(a&&a[Symbol.iterator],"Entry must be an iterable");const[e,n]=a;s("object"!=typeof e&&"function"!=typeof e&&"symbol"!=typeof e,"Key must not be of type object, function, or Symbol"),s("symbol"==typeof n,"Value must be a Symbol"),t.$_terms.map.set(e,n),i.push(n)}return t.valid(...i)}}},manifest:{build:(e,t)=>(t.map&&(e=e.map(t.map)),e)},messages:{"symbol.base":"{{#label}} must be a symbol","symbol.map":"{{#label}} must be one of {{#map}}"}})},8863:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(738),r=i(9621),o=i(8160),l=i(6354),c=i(493),u={result:Symbol("result")};t.entry=function(e,t,i){let a=o.defaults;i&&(s(void 0===i.warnings,"Cannot override warnings preference in synchronous validation"),s(void 0===i.artifacts,"Cannot override artifacts preference in synchronous validation"),a=o.preferences(o.defaults,i));const n=u.entry(e,t,a);s(!n.mainstay.externals.length,"Schema with external rules must use validateAsync()");const r={value:n.value};return n.error&&(r.error=n.error),n.mainstay.warnings.length&&(r.warning=l.details(n.mainstay.warnings)),n.mainstay.debug&&(r.debug=n.mainstay.debug),n.mainstay.artifacts&&(r.artifacts=n.mainstay.artifacts),r},t.entryAsync=async function(e,t,i){let s=o.defaults;i&&(s=o.preferences(o.defaults,i));const a=u.entry(e,t,s),n=a.mainstay;if(a.error)throw n.debug&&(a.error.debug=n.debug),a.error;if(n.externals.length){let t=a.value;const c=[];for(const a of n.externals){const d=a.state.path,m="link"===a.schema.type?n.links.get(a.schema):null;let h,p,f=t;const g=d.length?[t]:[],y=d.length?r(e,d):e;if(d.length){h=d[d.length-1];let e=t;for(const t of d.slice(0,-1))e=e[t],g.unshift(e);p=g[0],f=p[h]}try{const e=(e,t)=>(m||a.schema).$_createError(e,f,t,a.state,s),r=await a.method(f,{schema:a.schema,linked:m,state:a.state,prefs:i,original:y,error:e,errorsArray:u.errorsArray,warn:(e,t)=>n.warnings.push((m||a.schema).$_createError(e,f,t,a.state,s)),message:(e,t)=>(m||a.schema).$_createError("external",f,t,a.state,s,{messages:e})});if(void 0===r||r===f)continue;if(r instanceof l.Report){if(n.tracer.log(a.schema,a.state,"rule","external","error"),c.push(r),s.abortEarly)break;continue}if(Array.isArray(r)&&r[o.symbols.errors]){if(n.tracer.log(a.schema,a.state,"rule","external","error"),c.push(...r),s.abortEarly)break;continue}p?(n.tracer.value(a.state,"rule",f,r,"external"),p[h]=r):(n.tracer.value(a.state,"rule",t,r,"external"),t=r)}catch(e){throw s.errors.label&&(e.message+=` (${a.label})`),e}}if(a.value=t,c.length)throw a.error=l.process(c,e,s),n.debug&&(a.error.debug=n.debug),a.error}if(!s.warnings&&!s.debug&&!s.artifacts)return a.value;const c={value:a.value};return n.warnings.length&&(c.warning=l.details(n.warnings)),n.debug&&(c.debug=n.debug),n.artifacts&&(c.artifacts=n.artifacts),c},u.Mainstay=class{constructor(e,t,i){this.externals=[],this.warnings=[],this.tracer=e,this.debug=t,this.links=i,this.shadow=null,this.artifacts=null,this._snapshots=[]}snapshot(){this._snapshots.push({externals:this.externals.slice(),warnings:this.warnings.slice()})}restore(){const e=this._snapshots.pop();this.externals=e.externals,this.warnings=e.warnings}commit(){this._snapshots.pop()}},u.entry=function(e,i,s){const{tracer:a,cleanup:n}=u.tracer(i,s),r=s.debug?[]:null,o=i._ids._schemaChain?new Map:null,d=new u.Mainstay(a,r,o),m=i._ids._schemaChain?[{schema:i}]:null,h=new c([],[],{mainstay:d,schemas:m}),p=t.validate(e,i,h,s);n&&i.$_root.untrace();const f=l.process(p.errors,e,s);return{value:p.value,error:f,mainstay:d}},u.tracer=function(e,t){return e.$_root._tracer?{tracer:e.$_root._tracer._register(e)}:t.debug?(s(e.$_root.trace,"Debug mode not supported"),{tracer:e.$_root.trace()._register(e),cleanup:!0}):{tracer:u.ignore}},t.validate=function(e,t,i,s,a={}){if(t.$_terms.whens&&(t=t._generate(e,i,s).schema),t._preferences&&(s=u.prefs(t,s)),t._cache&&s.cache){const s=t._cache.get(e);if(i.mainstay.tracer.debug(i,"validate","cached",!!s),s)return s}const n=(a,n,r)=>t.$_createError(a,e,n,r||i,s),r={original:e,prefs:s,schema:t,state:i,error:n,errorsArray:u.errorsArray,warn:(e,t,s)=>i.mainstay.warnings.push(n(e,t,s)),message:(a,n)=>t.$_createError("custom",e,n,i,s,{messages:a})};i.mainstay.tracer.entry(t,i);const l=t._definition;if(l.prepare&&void 0!==e&&s.convert){const t=l.prepare(e,r);if(t){if(i.mainstay.tracer.value(i,"prepare",e,t.value),t.errors)return u.finalize(t.value,[].concat(t.errors),r);e=t.value}}if(l.coerce&&void 0!==e&&s.convert&&(!l.coerce.from||l.coerce.from.includes(typeof e))){const t=l.coerce.method(e,r);if(t){if(i.mainstay.tracer.value(i,"coerced",e,t.value),t.errors)return u.finalize(t.value,[].concat(t.errors),r);e=t.value}}const c=t._flags.empty;c&&c.$_match(u.trim(e,t),i.nest(c),o.defaults)&&(i.mainstay.tracer.value(i,"empty",e,void 0),e=void 0);const d=a.presence||t._flags.presence||(t._flags._endedSwitch?null:s.presence);if(void 0===e){if("forbidden"===d)return u.finalize(e,null,r);if("required"===d)return u.finalize(e,[t.$_createError("any.required",e,null,i,s)],r);if("optional"===d){if(t._flags.default!==o.symbols.deepDefault)return u.finalize(e,null,r);i.mainstay.tracer.value(i,"default",e,{}),e={}}}else if("forbidden"===d)return u.finalize(e,[t.$_createError("any.unknown",e,null,i,s)],r);const m=[];if(t._valids){const a=t._valids.get(e,i,s,t._flags.insensitive);if(a)return s.convert&&(i.mainstay.tracer.value(i,"valids",e,a.value),e=a.value),i.mainstay.tracer.filter(t,i,"valid",a),u.finalize(e,null,r);if(t._flags.only){const a=t.$_createError("any.only",e,{valids:t._valids.values({display:!0})},i,s);if(s.abortEarly)return u.finalize(e,[a],r);m.push(a)}}if(t._invalids){const a=t._invalids.get(e,i,s,t._flags.insensitive);if(a){i.mainstay.tracer.filter(t,i,"invalid",a);const n=t.$_createError("any.invalid",e,{invalids:t._invalids.values({display:!0})},i,s);if(s.abortEarly)return u.finalize(e,[n],r);m.push(n)}}if(l.validate){const t=l.validate(e,r);if(t&&(i.mainstay.tracer.value(i,"base",e,t.value),e=t.value,t.errors)){if(!Array.isArray(t.errors))return m.push(t.errors),u.finalize(e,m,r);if(t.errors.length)return m.push(...t.errors),u.finalize(e,m,r)}}return t._rules.length?u.rules(e,m,r):u.finalize(e,m,r)},u.rules=function(e,t,i){const{schema:s,state:a,prefs:n}=i;for(const r of s._rules){const l=s._definition.rules[r.method];if(l.convert&&n.convert){a.mainstay.tracer.log(s,a,"rule",r.name,"full");continue}let c,d=r.args;if(r._resolve.length){d=Object.assign({},d);for(const t of r._resolve){const i=l.argsByName.get(t),r=d[t].resolve(e,a,n),u=i.normalize?i.normalize(r):r,m=o.validateArg(u,null,i);if(m){c=s.$_createError("any.ref",r,{arg:t,ref:d[t],reason:m},a,n);break}d[t]=u}}c=c||l.validate(e,i,d,r);const m=u.rule(c,r);if(m.errors){if(a.mainstay.tracer.log(s,a,"rule",r.name,"error"),r.warn){a.mainstay.warnings.push(...m.errors);continue}if(n.abortEarly)return u.finalize(e,m.errors,i);t.push(...m.errors)}else a.mainstay.tracer.log(s,a,"rule",r.name,"pass"),a.mainstay.tracer.value(a,"rule",e,m.value,r.name),e=m.value}return u.finalize(e,t,i)},u.rule=function(e,t){return e instanceof l.Report?(u.error(e,t),{errors:[e],value:null}):Array.isArray(e)&&e[o.symbols.errors]?(e.forEach((e=>u.error(e,t))),{errors:e,value:null}):{errors:null,value:e}},u.error=function(e,t){return t.message&&e._setTemplate(t.message),e},u.finalize=function(e,t,i){t=t||[];const{schema:a,state:n,prefs:r}=i;if(t.length){const s=u.default("failover",void 0,t,i);void 0!==s&&(n.mainstay.tracer.value(n,"failover",e,s),e=s,t=[])}if(t.length&&a._flags.error)if("function"==typeof a._flags.error){t=a._flags.error(t),Array.isArray(t)||(t=[t]);for(const e of t)s(e instanceof Error||e instanceof l.Report,"error() must return an Error object")}else t=[a._flags.error];if(void 0===e){const s=u.default("default",e,t,i);n.mainstay.tracer.value(n,"default",e,s),e=s}if(a._flags.cast&&void 0!==e){const t=a._definition.cast[a._flags.cast];if(t.from(e)){const s=t.to(e,i);n.mainstay.tracer.value(n,"cast",e,s,a._flags.cast),e=s}}if(a.$_terms.externals&&r.externals&&!1!==r._externals)for(const{method:e}of a.$_terms.externals)n.mainstay.externals.push({method:e,schema:a,state:n,label:l.label(a._flags,n,r)});const o={value:e,errors:t.length?t:null};return a._flags.result&&(o.value="strip"===a._flags.result?void 0:i.original,n.mainstay.tracer.value(n,a._flags.result,e,o.value),n.shadow(e,a._flags.result)),a._cache&&!1!==r.cache&&!a._refs.length&&a._cache.set(i.original,o),void 0===e||o.errors||void 0===a._flags.artifact||(n.mainstay.artifacts=n.mainstay.artifacts||new Map,n.mainstay.artifacts.has(a._flags.artifact)||n.mainstay.artifacts.set(a._flags.artifact,[]),n.mainstay.artifacts.get(a._flags.artifact).push(n.path)),o},u.prefs=function(e,t){const i=t===o.defaults;return i&&e._preferences[o.symbols.prefs]?e._preferences[o.symbols.prefs]:(t=o.preferences(t,e._preferences),i&&(e._preferences[o.symbols.prefs]=t),t)},u.default=function(e,t,i,s){const{schema:n,state:r,prefs:l}=s,c=n._flags[e];if(l.noDefaults||void 0===c)return t;if(r.mainstay.tracer.log(n,r,"rule",e,"full"),!c)return c;if("function"==typeof c){const o=c.length?[a(r.ancestors[0]),s]:[];try{return c(...o)}catch(t){return void i.push(n.$_createError(`any.${e}`,null,{error:t},r,l))}}return"object"!=typeof c?c:c[o.symbols.literal]?c.literal:o.isResolvable(c)?c.resolve(t,r,l):a(c)},u.trim=function(e,t){if("string"!=typeof e)return e;const i=t.$_getRule("trim");return i&&i.args.enabled?e.trim():e},u.ignore={active:!1,debug:n,entry:n,filter:n,log:n,resolve:n,value:n},u.errorsArray=function(){const e=[];return e[o.symbols.errors]=!0,e}},2036:(e,t,i)=>{"use strict";const s=i(375),a=i(9474),n=i(8160),r={};e.exports=r.Values=class{constructor(e,t){this._values=new Set(e),this._refs=new Set(t),this._lowercase=r.lowercases(e),this._override=!1}get length(){return this._values.size+this._refs.size}add(e,t){n.isResolvable(e)?this._refs.has(e)||(this._refs.add(e),t&&t.register(e)):this.has(e,null,null,!1)||(this._values.add(e),"string"==typeof e&&this._lowercase.set(e.toLowerCase(),e))}static merge(e,t,i){if(e=e||new r.Values,t){if(t._override)return t.clone();for(const i of[...t._values,...t._refs])e.add(i)}if(i)for(const t of[...i._values,...i._refs])e.remove(t);return e.length?e:null}remove(e){n.isResolvable(e)?this._refs.delete(e):(this._values.delete(e),"string"==typeof e&&this._lowercase.delete(e.toLowerCase()))}has(e,t,i,s){return!!this.get(e,t,i,s)}get(e,t,i,s){if(!this.length)return!1;if(this._values.has(e))return{value:e};if("string"==typeof e&&e&&s){const t=this._lowercase.get(e.toLowerCase());if(t)return{value:t}}if(!this._refs.size&&"object"!=typeof e)return!1;if("object"==typeof e)for(const t of this._values)if(a(t,e))return{value:t};if(t)for(const n of this._refs){const r=n.resolve(e,t,i,null,{in:!0});if(void 0===r)continue;const o=n.in&&"object"==typeof r?Array.isArray(r)?r:Object.keys(r):[r];for(const t of o)if(typeof t==typeof e)if(s&&e&&"string"==typeof e){if(t.toLowerCase()===e.toLowerCase())return{value:t,ref:n}}else if(a(t,e))return{value:t,ref:n}}return!1}override(){this._override=!0}values(e){if(e&&e.display){const e=[];for(const t of[...this._values,...this._refs])void 0!==t&&e.push(t);return e}return Array.from([...this._values,...this._refs])}clone(){const e=new r.Values(this._values,this._refs);return e._override=this._override,e}concat(e){s(!e._override,"Cannot concat override set of values");const t=new r.Values([...this._values,...e._values],[...this._refs,...e._refs]);return t._override=this._override,t}describe(){const e=[];this._override&&e.push({override:!0});for(const t of this._values.values())e.push(t&&"object"==typeof t?{value:t}:t);for(const t of this._refs.values())e.push(t.describe());return e}},r.Values.prototype[n.symbols.values]=!0,r.Values.prototype.slice=r.Values.prototype.clone,r.lowercases=function(e){const t=new Map;if(e)for(const i of e)"string"==typeof i&&t.set(i.toLowerCase(),i);return t}},978:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(1687),r=i(9621),o={};e.exports=function(e,t,i={}){if(s(e&&"object"==typeof e,"Invalid defaults value: must be an object"),s(!t||!0===t||"object"==typeof t,"Invalid source value: must be true, falsy or an object"),s("object"==typeof i,"Invalid options: must be an object"),!t)return null;if(i.shallow)return o.applyToDefaultsWithShallow(e,t,i);const r=a(e);if(!0===t)return r;const l=void 0!==i.nullOverride&&i.nullOverride;return n(r,t,{nullOverride:l,mergeArrays:!1})},o.applyToDefaultsWithShallow=function(e,t,i){const l=i.shallow;s(Array.isArray(l),"Invalid keys");const c=new Map,u=!0===t?null:new Set;for(let i of l){i=Array.isArray(i)?i:i.split(".");const s=r(e,i);s&&"object"==typeof s?c.set(s,u&&r(t,i)||s):u&&u.add(i)}const d=a(e,{},c);if(!u)return d;for(const e of u)o.reachCopy(d,t,e);const m=void 0!==i.nullOverride&&i.nullOverride;return n(d,t,{nullOverride:m,mergeArrays:!1})},o.reachCopy=function(e,t,i){for(const e of i){if(!(e in t))return;const i=t[e];if("object"!=typeof i||null===i)return;t=i}const s=t;let a=e;for(let e=0;e<i.length-1;++e){const t=i[e];"object"!=typeof a[t]&&(a[t]={}),a=a[t]}a[i[i.length-1]]=s}},375:(e,t,i)=>{"use strict";const s=i(7916);e.exports=function(e,...t){if(!e){if(1===t.length&&t[0]instanceof Error)throw t[0];throw new s(t)}}},8571:(e,t,i)=>{"use strict";const s=i(9621),a=i(4277),n=i(7043),r={needsProtoHack:new Set([a.set,a.map,a.weakSet,a.weakMap])};e.exports=r.clone=function(e,t={},i=null){if("object"!=typeof e||null===e)return e;let s=r.clone,o=i;if(t.shallow){if(!0!==t.shallow)return r.cloneWithShallow(e,t);s=e=>e}else if(o){const t=o.get(e);if(t)return t}else o=new Map;const l=a.getInternalProto(e);if(l===a.buffer)return!1;if(l===a.date)return new Date(e.getTime());if(l===a.regex)return new RegExp(e);const c=r.base(e,l,t);if(c===e)return e;if(o&&o.set(e,c),l===a.set)for(const i of e)c.add(s(i,t,o));else if(l===a.map)for(const[i,a]of e)c.set(i,s(a,t,o));const u=n.keys(e,t);for(const i of u){if("__proto__"===i)continue;if(l===a.array&&"length"===i){c.length=e.length;continue}const n=Object.getOwnPropertyDescriptor(e,i);n?n.get||n.set?Object.defineProperty(c,i,n):n.enumerable?c[i]=s(e[i],t,o):Object.defineProperty(c,i,{enumerable:!1,writable:!0,configurable:!0,value:s(e[i],t,o)}):Object.defineProperty(c,i,{enumerable:!0,writable:!0,configurable:!0,value:s(e[i],t,o)})}return c},r.cloneWithShallow=function(e,t){const i=t.shallow;(t=Object.assign({},t)).shallow=!1;const a=new Map;for(const t of i){const i=s(e,t);"object"!=typeof i&&"function"!=typeof i||a.set(i,i)}return r.clone(e,t,a)},r.base=function(e,t,i){if(!1===i.prototype)return r.needsProtoHack.has(t)?new t.constructor:t===a.array?[]:{};const s=Object.getPrototypeOf(e);if(s&&s.isImmutable)return e;if(t===a.array){const e=[];return s!==t&&Object.setPrototypeOf(e,s),e}if(r.needsProtoHack.has(t)){const e=new s.constructor;return s!==t&&Object.setPrototypeOf(e,s),e}return Object.create(s)}},9474:(e,t,i)=>{"use strict";const s=i(4277),a={mismatched:null};e.exports=function(e,t,i){return i=Object.assign({prototype:!0},i),!!a.isDeepEqual(e,t,i,[])},a.isDeepEqual=function(e,t,i,n){if(e===t)return 0!==e||1/e==1/t;const r=typeof e;if(r!==typeof t)return!1;if(null===e||null===t)return!1;if("function"===r){if(!i.deepFunction||e.toString()!==t.toString())return!1}else if("object"!==r)return e!=e&&t!=t;const o=a.getSharedType(e,t,!!i.prototype);switch(o){case s.buffer:return!1;case s.promise:return e===t;case s.regex:return e.toString()===t.toString();case a.mismatched:return!1}for(let i=n.length-1;i>=0;--i)if(n[i].isSame(e,t))return!0;n.push(new a.SeenEntry(e,t));try{return!!a.isDeepEqualObj(o,e,t,i,n)}finally{n.pop()}},a.getSharedType=function(e,t,i){if(i)return Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?a.mismatched:s.getInternalProto(e);const n=s.getInternalProto(e);return n!==s.getInternalProto(t)?a.mismatched:n},a.valueOf=function(e){const t=e.valueOf;if(void 0===t)return e;try{return t.call(e)}catch(e){return e}},a.hasOwnEnumerableProperty=function(e,t){return Object.prototype.propertyIsEnumerable.call(e,t)},a.isSetSimpleEqual=function(e,t){for(const i of Set.prototype.values.call(e))if(!Set.prototype.has.call(t,i))return!1;return!0},a.isDeepEqualObj=function(e,t,i,n,r){const{isDeepEqual:o,valueOf:l,hasOwnEnumerableProperty:c}=a,{keys:u,getOwnPropertySymbols:d}=Object;if(e===s.array){if(!n.part){if(t.length!==i.length)return!1;for(let e=0;e<t.length;++e)if(!o(t[e],i[e],n,r))return!1;return!0}for(const e of t)for(const t of i)if(o(e,t,n,r))return!0}else if(e===s.set){if(t.size!==i.size)return!1;if(!a.isSetSimpleEqual(t,i)){const e=new Set(Set.prototype.values.call(i));for(const i of Set.prototype.values.call(t)){if(e.delete(i))continue;let t=!1;for(const s of e)if(o(i,s,n,r)){e.delete(s),t=!0;break}if(!t)return!1}}}else if(e===s.map){if(t.size!==i.size)return!1;for(const[e,s]of Map.prototype.entries.call(t)){if(void 0===s&&!Map.prototype.has.call(i,e))return!1;if(!o(s,Map.prototype.get.call(i,e),n,r))return!1}}else if(e===s.error&&(t.name!==i.name||t.message!==i.message))return!1;const m=l(t),h=l(i);if((t!==m||i!==h)&&!o(m,h,n,r))return!1;const p=u(t);if(!n.part&&p.length!==u(i).length&&!n.skip)return!1;let f=0;for(const e of p)if(n.skip&&n.skip.includes(e))void 0===i[e]&&++f;else{if(!c(i,e))return!1;if(!o(t[e],i[e],n,r))return!1}if(!n.part&&p.length-f!==u(i).length)return!1;if(!1!==n.symbols){const e=d(t),s=new Set(d(i));for(const a of e){if(!n.skip||!n.skip.includes(a))if(c(t,a)){if(!c(i,a))return!1;if(!o(t[a],i[a],n,r))return!1}else if(c(i,a))return!1;s.delete(a)}for(const e of s)if(c(i,e))return!1}return!0},a.SeenEntry=class{constructor(e,t){this.obj=e,this.ref=t}isSame(e,t){return this.obj===e&&this.ref===t}}},7916:(e,t,i)=>{"use strict";const s=i(8761);e.exports=class extends Error{constructor(e){super(e.filter((e=>""!==e)).map((e=>"string"==typeof e?e:e instanceof Error?e.message:s(e))).join(" ")||"Unknown error"),"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t.assert)}}},5277:e=>{"use strict";const t={};e.exports=function(e){if(!e)return"";let i="";for(let s=0;s<e.length;++s){const a=e.charCodeAt(s);t.isSafe(a)?i+=e[s]:i+=t.escapeHtmlChar(a)}return i},t.escapeHtmlChar=function(e){return t.namedHtml.get(e)||(e>=256?"&#"+e+";":`&#x${e.toString(16).padStart(2,"0")};`)},t.isSafe=function(e){return t.safeCharCodes.has(e)},t.namedHtml=new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[34,"&quot;"],[160,"&nbsp;"],[162,"&cent;"],[163,"&pound;"],[164,"&curren;"],[169,"&copy;"],[174,"&reg;"]]),t.safeCharCodes=function(){const e=new Set;for(let t=32;t<123;++t)(t>=97||t>=65&&t<=90||t>=48&&t<=57||32===t||46===t||44===t||45===t||58===t||95===t)&&e.add(t);return e}()},6064:e=>{"use strict";e.exports=function(e){return e.replace(/[\^\$\.\*\+\-\?\=\!\:\|\\\/\(\)\[\]\{\}\,]/g,"\\$&")}},738:e=>{"use strict";e.exports=function(){}},1687:(e,t,i)=>{"use strict";const s=i(375),a=i(8571),n=i(7043),r={};e.exports=r.merge=function(e,t,i){if(s(e&&"object"==typeof e,"Invalid target value: must be an object"),s(null==t||"object"==typeof t,"Invalid source value: must be null, undefined, or an object"),!t)return e;if(i=Object.assign({nullOverride:!0,mergeArrays:!0},i),Array.isArray(t)){s(Array.isArray(e),"Cannot merge array onto an object"),i.mergeArrays||(e.length=0);for(let s=0;s<t.length;++s)e.push(a(t[s],{symbols:i.symbols}));return e}const o=n.keys(t,i);for(let s=0;s<o.length;++s){const n=o[s];if("__proto__"===n||!Object.prototype.propertyIsEnumerable.call(t,n))continue;const l=t[n];if(l&&"object"==typeof l){if(e[n]===l)continue;!e[n]||"object"!=typeof e[n]||Array.isArray(e[n])!==Array.isArray(l)||l instanceof Date||l instanceof RegExp?e[n]=a(l,{symbols:i.symbols}):r.merge(e[n],l,i)}else(null!=l||i.nullOverride)&&(e[n]=l)}return e}},9621:(e,t,i)=>{"use strict";const s=i(375),a={};e.exports=function(e,t,i){if(!1===t||null==t)return e;"string"==typeof(i=i||{})&&(i={separator:i});const n=Array.isArray(t);s(!n||!i.separator,"Separator option is not valid for array-based chain");const r=n?t:t.split(i.separator||".");let o=e;for(let e=0;e<r.length;++e){let n=r[e];const l=i.iterables&&a.iterables(o);if(Array.isArray(o)||"set"===l){const e=Number(n);Number.isInteger(e)&&(n=e<0?o.length+e:e)}if(!o||"function"==typeof o&&!1===i.functions||!l&&void 0===o[n]){s(!i.strict||e+1===r.length,"Missing segment",n,"in reach path ",t),s("object"==typeof o||!0===i.functions||"function"!=typeof o,"Invalid segment",n,"in reach path ",t),o=i.default;break}o=l?"set"===l?[...o][n]:o.get(n):o[n]}return o},a.iterables=function(e){return e instanceof Set?"set":e instanceof Map?"map":void 0}},8761:e=>{"use strict";e.exports=function(...e){try{return JSON.stringify(...e)}catch(e){return"[Cannot display object: "+e.message+"]"}}},4277:(e,t)=>{"use strict";const i={};t=e.exports={array:Array.prototype,buffer:!1,date:Date.prototype,error:Error.prototype,generic:Object.prototype,map:Map.prototype,promise:Promise.prototype,regex:RegExp.prototype,set:Set.prototype,weakMap:WeakMap.prototype,weakSet:WeakSet.prototype},i.typeMap=new Map([["[object Error]",t.error],["[object Map]",t.map],["[object Promise]",t.promise],["[object Set]",t.set],["[object WeakMap]",t.weakMap],["[object WeakSet]",t.weakSet]]),t.getInternalProto=function(e){if(Array.isArray(e))return t.array;if(e instanceof Date)return t.date;if(e instanceof RegExp)return t.regex;if(e instanceof Error)return t.error;const s=Object.prototype.toString.call(e);return i.typeMap.get(s)||t.generic}},7043:(e,t)=>{"use strict";t.keys=function(e,t={}){return!1!==t.symbols?Reflect.ownKeys(e):Object.getOwnPropertyNames(e)}},3652:(e,t,i)=>{"use strict";const s=i(375),a={};t.Sorter=class{constructor(){this._items=[],this.nodes=[]}add(e,t){const i=[].concat((t=t||{}).before||[]),a=[].concat(t.after||[]),n=t.group||"?",r=t.sort||0;s(!i.includes(n),`Item cannot come before itself: ${n}`),s(!i.includes("?"),"Item cannot come before unassociated items"),s(!a.includes(n),`Item cannot come after itself: ${n}`),s(!a.includes("?"),"Item cannot come after unassociated items"),Array.isArray(e)||(e=[e]);for(const t of e){const e={seq:this._items.length,sort:r,before:i,after:a,group:n,node:t};this._items.push(e)}if(!t.manual){const e=this._sort();s(e,"item","?"!==n?`added into group ${n}`:"","created a dependencies error")}return this.nodes}merge(e){Array.isArray(e)||(e=[e]);for(const t of e)if(t)for(const e of t._items)this._items.push(Object.assign({},e));this._items.sort(a.mergeSort);for(let e=0;e<this._items.length;++e)this._items[e].seq=e;const t=this._sort();return s(t,"merge created a dependencies error"),this.nodes}sort(){const e=this._sort();return s(e,"sort created a dependencies error"),this.nodes}_sort(){const e={},t=Object.create(null),i=Object.create(null);for(const s of this._items){const a=s.seq,n=s.group;i[n]=i[n]||[],i[n].push(a),e[a]=s.before;for(const e of s.after)t[e]=t[e]||[],t[e].push(a)}for(const t in e){const s=[];for(const a in e[t]){const n=e[t][a];i[n]=i[n]||[],s.push(...i[n])}e[t]=s}for(const s in t)if(i[s])for(const a of i[s])e[a].push(...t[s]);const s={};for(const t in e){const i=e[t];for(const e of i)s[e]=s[e]||[],s[e].push(t)}const a={},n=[];for(let e=0;e<this._items.length;++e){let t=e;if(s[e]){t=null;for(let e=0;e<this._items.length;++e){if(!0===a[e])continue;s[e]||(s[e]=[]);const i=s[e].length;let n=0;for(let t=0;t<i;++t)a[s[e][t]]&&++n;if(n===i){t=e;break}}}null!==t&&(a[t]=!0,n.push(t))}if(n.length!==this._items.length)return!1;const r={};for(const e of this._items)r[e.seq]=e;this._items=[],this.nodes=[];for(const e of n){const t=r[e];this.nodes.push(t.node),this._items.push(t)}return!0}},a.mergeSort=(e,t)=>e.sort===t.sort?0:e.sort<t.sort?-1:1},5380:(e,t,i)=>{"use strict";const s=i(443),a=i(2178),n={minDomainSegments:2,nonAsciiRx:/[^\x00-\x7f]/,domainControlRx:/[\x00-\x20@\:\/\\#!\$&\'\(\)\*\+,;=\?]/,tldSegmentRx:/^[a-zA-Z](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?$/,domainSegmentRx:/^[a-zA-Z0-9](?:[a-zA-Z0-9\-]*[a-zA-Z0-9])?$/,URL:s.URL||URL};t.analyze=function(e,t={}){if(!e)return a.code("DOMAIN_NON_EMPTY_STRING");if("string"!=typeof e)throw new Error("Invalid input: domain must be a string");if(e.length>256)return a.code("DOMAIN_TOO_LONG");if(n.nonAsciiRx.test(e)){if(!1===t.allowUnicode)return a.code("DOMAIN_INVALID_UNICODE_CHARS");e=e.normalize("NFC")}if(n.domainControlRx.test(e))return a.code("DOMAIN_INVALID_CHARS");e=n.punycode(e),t.allowFullyQualified&&"."===e[e.length-1]&&(e=e.slice(0,-1));const i=t.minDomainSegments||n.minDomainSegments,s=e.split(".");if(s.length<i)return a.code("DOMAIN_SEGMENTS_COUNT");if(t.maxDomainSegments&&s.length>t.maxDomainSegments)return a.code("DOMAIN_SEGMENTS_COUNT_MAX");const r=t.tlds;if(r){const e=s[s.length-1].toLowerCase();if(r.deny&&r.deny.has(e)||r.allow&&!r.allow.has(e))return a.code("DOMAIN_FORBIDDEN_TLDS")}for(let e=0;e<s.length;++e){const t=s[e];if(!t.length)return a.code("DOMAIN_EMPTY_SEGMENT");if(t.length>63)return a.code("DOMAIN_LONG_SEGMENT");if(e<s.length-1){if(!n.domainSegmentRx.test(t))return a.code("DOMAIN_INVALID_CHARS")}else if(!n.tldSegmentRx.test(t))return a.code("DOMAIN_INVALID_TLDS_CHARS")}return null},t.isValid=function(e,i){return!t.analyze(e,i)},n.punycode=function(e){e.includes("%")&&(e=e.replace(/%/g,"%25"));try{return new n.URL(`http://${e}`).host}catch(t){return e}}},1745:(e,t,i)=>{"use strict";const s=i(9848),a=i(5380),n=i(2178),r={nonAsciiRx:/[^\x00-\x7f]/,encoder:new(s.TextEncoder||TextEncoder)};t.analyze=function(e,t){return r.email(e,t)},t.isValid=function(e,t){return!r.email(e,t)},r.email=function(e,t={}){if("string"!=typeof e)throw new Error("Invalid input: email must be a string");if(!e)return n.code("EMPTY_STRING");const i=!r.nonAsciiRx.test(e);if(!i){if(!1===t.allowUnicode)return n.code("FORBIDDEN_UNICODE");e=e.normalize("NFC")}const s=e.split("@");if(2!==s.length)return s.length>2?n.code("MULTIPLE_AT_CHAR"):n.code("MISSING_AT_CHAR");const[o,l]=s;if(!o)return n.code("EMPTY_LOCAL");if(!t.ignoreLength){if(e.length>254)return n.code("ADDRESS_TOO_LONG");if(r.encoder.encode(o).length>64)return n.code("LOCAL_TOO_LONG")}return r.local(o,i)||a.analyze(l,t)},r.local=function(e,t){const i=e.split(".");for(const e of i){if(!e.length)return n.code("EMPTY_LOCAL_SEGMENT");if(t){if(!r.atextRx.test(e))return n.code("INVALID_LOCAL_CHARS")}else for(const t of e){if(r.atextRx.test(t))continue;const e=r.binary(t);if(!r.atomRx.test(e))return n.code("INVALID_LOCAL_CHARS")}}},r.binary=function(e){return Array.from(r.encoder.encode(e)).map((e=>String.fromCharCode(e))).join("")},r.atextRx=/^[\w!#\$%&'\*\+\-/=\?\^`\{\|\}~]+$/,r.atomRx=new RegExp(["(?:[\\xc2-\\xdf][\\x80-\\xbf])","(?:\\xe0[\\xa0-\\xbf][\\x80-\\xbf])|(?:[\\xe1-\\xec][\\x80-\\xbf]{2})|(?:\\xed[\\x80-\\x9f][\\x80-\\xbf])|(?:[\\xee-\\xef][\\x80-\\xbf]{2})","(?:\\xf0[\\x90-\\xbf][\\x80-\\xbf]{2})|(?:[\\xf1-\\xf3][\\x80-\\xbf]{3})|(?:\\xf4[\\x80-\\x8f][\\x80-\\xbf]{2})"].join("|"))},2178:(e,t)=>{"use strict";t.codes={EMPTY_STRING:"Address must be a non-empty string",FORBIDDEN_UNICODE:"Address contains forbidden Unicode characters",MULTIPLE_AT_CHAR:"Address cannot contain more than one @ character",MISSING_AT_CHAR:"Address must contain one @ character",EMPTY_LOCAL:"Address local part cannot be empty",ADDRESS_TOO_LONG:"Address too long",LOCAL_TOO_LONG:"Address local part too long",EMPTY_LOCAL_SEGMENT:"Address local part contains empty dot-separated segment",INVALID_LOCAL_CHARS:"Address local part contains invalid character",DOMAIN_NON_EMPTY_STRING:"Domain must be a non-empty string",DOMAIN_TOO_LONG:"Domain too long",DOMAIN_INVALID_UNICODE_CHARS:"Domain contains forbidden Unicode characters",DOMAIN_INVALID_CHARS:"Domain contains invalid character",DOMAIN_INVALID_TLDS_CHARS:"Domain contains invalid tld character",DOMAIN_SEGMENTS_COUNT:"Domain lacks the minimum required number of segments",DOMAIN_SEGMENTS_COUNT_MAX:"Domain contains too many segments",DOMAIN_FORBIDDEN_TLDS:"Domain uses forbidden TLD",DOMAIN_EMPTY_SEGMENT:"Domain contains empty dot-separated segment",DOMAIN_LONG_SEGMENT:"Domain contains dot-separated segment that is too long"},t.code=function(e){return{code:e,error:t.codes[e]}}},9959:(e,t,i)=>{"use strict";const s=i(375),a=i(5752);t.regex=function(e={}){s(void 0===e.cidr||"string"==typeof e.cidr,"options.cidr must be a string");const t=e.cidr?e.cidr.toLowerCase():"optional";s(["required","optional","forbidden"].includes(t),"options.cidr must be one of required, optional, forbidden"),s(void 0===e.version||"string"==typeof e.version||Array.isArray(e.version),"options.version must be a string or an array of string");let i=e.version||["ipv4","ipv6","ipvfuture"];Array.isArray(i)||(i=[i]),s(i.length>=1,"options.version must have at least 1 version specified");for(let e=0;e<i.length;++e)s("string"==typeof i[e],"options.version must only contain strings"),i[e]=i[e].toLowerCase(),s(["ipv4","ipv6","ipvfuture"].includes(i[e]),"options.version contains unknown version "+i[e]+" - must be one of ipv4, ipv6, ipvfuture");i=Array.from(new Set(i));const n=`(?:${i.map((e=>{if("forbidden"===t)return a.ip[e];const i=`\\/${"ipv4"===e?a.ip.v4Cidr:a.ip.v6Cidr}`;return"required"===t?`${a.ip[e]}${i}`:`${a.ip[e]}(?:${i})?`})).join("|")})`,r=new RegExp(`^${n}$`);return{cidr:t,versions:i,regex:r,raw:n}}},5752:(e,t,i)=>{"use strict";const s=i(375),a=i(6064),n={generate:function(){const e={},t="\\dA-Fa-f",i="["+t+"]",s="\\w-\\.~",a="!\\$&'\\(\\)\\*\\+,;=",n="%"+t,r=s+n+a+":@",o="["+r+"]",l="(?:0{0,2}\\d|0?[1-9]\\d|1\\d\\d|2[0-4]\\d|25[0-5])";e.ipv4address="(?:"+l+"\\.){3}"+l;const c=i+"{1,4}",u="(?:"+c+":"+c+"|"+e.ipv4address+")",d="(?:"+c+":){6}"+u,m="::(?:"+c+":){5}"+u,h="(?:"+c+")?::(?:"+c+":){4}"+u,p="(?:(?:"+c+":){0,1}"+c+")?::(?:"+c+":){3}"+u,f="(?:(?:"+c+":){0,2}"+c+")?::(?:"+c+":){2}"+u,g="(?:(?:"+c+":){0,3}"+c+")?::"+c+":"+u,y="(?:(?:"+c+":){0,4}"+c+")?::"+u,v="(?:(?:"+c+":){0,5}"+c+")?::"+c,b="(?:(?:"+c+":){0,6}"+c+")?::";e.ipv4Cidr="(?:\\d|[1-2]\\d|3[0-2])",e.ipv6Cidr="(?:0{0,2}\\d|0?[1-9]\\d|1[01]\\d|12[0-8])",e.ipv6address="(?:"+d+"|"+m+"|"+h+"|"+p+"|"+f+"|"+g+"|"+y+"|"+v+"|"+b+")",e.ipvFuture="v"+i+"+\\.["+s+a+":]+",e.scheme="[a-zA-Z][a-zA-Z\\d+-\\.]*",e.schemeRegex=new RegExp(e.scheme);const k="["+s+n+a+":]*",w="["+s+n+a+"]{1,255}",S="(?:\\[(?:"+e.ipv6address+"|"+e.ipvFuture+")\\]|"+e.ipv4address+"|"+w+")",x="(?:"+k+"@)?"+S+"(?::\\d*)?",R="(?:"+k+"@)?("+S+")(?::\\d*)?",_=o+"*",C=o+"+",A="(?:\\/"+_+")*",$="\\/(?:"+C+A+")?",T=C+A,I="["+s+n+a+"@]+"+A,D="(?:\\/\\/\\/"+_+A+")";return e.hierPart="(?:(?:\\/\\/"+x+A+")|"+$+"|"+T+"|"+D+")",e.hierPartCapture="(?:(?:\\/\\/"+R+A+")|"+$+"|"+T+")",e.relativeRef="(?:(?:\\/\\/"+x+A+")|"+$+"|"+I+"|)",e.relativeRefCapture="(?:(?:\\/\\/"+R+A+")|"+$+"|"+I+"|)",e.query="["+r+"\\/\\?]*(?=#|$)",e.queryWithSquareBrackets="["+r+"\\[\\]\\/\\?]*(?=#|$)",e.fragment="["+r+"\\/\\?]*",e}};n.rfc3986=n.generate(),t.ip={v4Cidr:n.rfc3986.ipv4Cidr,v6Cidr:n.rfc3986.ipv6Cidr,ipv4:n.rfc3986.ipv4address,ipv6:n.rfc3986.ipv6address,ipvfuture:n.rfc3986.ipvFuture},n.createRegex=function(e){const t=n.rfc3986,i="(?:\\?"+(e.allowQuerySquareBrackets?t.queryWithSquareBrackets:t.query)+")?(?:#"+t.fragment+")?",r=e.domain?t.relativeRefCapture:t.relativeRef;if(e.relativeOnly)return n.wrap(r+i);let o="";if(e.scheme){s(e.scheme instanceof RegExp||"string"==typeof e.scheme||Array.isArray(e.scheme),"scheme must be a RegExp, String, or Array");const i=[].concat(e.scheme);s(i.length>=1,"scheme must have at least 1 scheme specified");const n=[];for(let e=0;e<i.length;++e){const r=i[e];s(r instanceof RegExp||"string"==typeof r,"scheme at position "+e+" must be a RegExp or String"),r instanceof RegExp?n.push(r.source.toString()):(s(t.schemeRegex.test(r),"scheme at position "+e+" must be a valid scheme"),n.push(a(r)))}o=n.join("|")}const l="(?:"+(o?"(?:"+o+")":t.scheme)+":"+(e.domain?t.hierPartCapture:t.hierPart)+")",c=e.allowRelative?"(?:"+l+"|"+r+")":l;return n.wrap(c+i,o)},n.wrap=function(e,t){return{raw:e=`(?=.)(?!https?:/(?:$|[^/]))(?!https?:///)(?!https?:[^/])${e}`,regex:new RegExp(`^${e}$`),scheme:t}},n.uriRegex=n.createRegex({}),t.regex=function(e={}){return e.scheme||e.allowRelative||e.relativeOnly||e.allowQuerySquareBrackets||e.domain?n.createRegex(e):n.uriRegex}},1447:(e,t)=>{"use strict";const i={operators:["!","^","*","/","%","+","-","<","<=",">",">=","==","!=","&&","||","??"],operatorCharacters:["!","^","*","/","%","+","-","<","=",">","&","|","?"],operatorsOrder:[["^"],["*","/","%"],["+","-"],["<","<=",">",">="],["==","!="],["&&"],["||","??"]],operatorsPrefix:["!","n"],literals:{'"':'"',"`":"`","'":"'","[":"]"},numberRx:/^(?:[0-9]*(\.[0-9]*)?){1}$/,tokenRx:/^[\w\$\#\.\@\:\{\}]+$/,symbol:Symbol("formula"),settings:Symbol("settings")};t.Parser=class{constructor(e,t={}){if(!t[i.settings]&&t.constants)for(const e in t.constants){const i=t.constants[e];if(null!==i&&!["boolean","number","string"].includes(typeof i))throw new Error(`Formula constant ${e} contains invalid ${typeof i} value type`)}this.settings=t[i.settings]?t:Object.assign({[i.settings]:!0,constants:{},functions:{}},t),this.single=null,this._parts=null,this._parse(e)}_parse(e){let s=[],a="",n=0,r=!1;const o=e=>{if(n)throw new Error("Formula missing closing parenthesis");const o=s.length?s[s.length-1]:null;if(r||a||e){if(o&&"reference"===o.type&&")"===e)return o.type="function",o.value=this._subFormula(a,o.value),void(a="");if(")"===e){const e=new t.Parser(a,this.settings);s.push({type:"segment",value:e})}else if(r){if("]"===r)return s.push({type:"reference",value:a}),void(a="");s.push({type:"literal",value:a})}else if(i.operatorCharacters.includes(a))o&&"operator"===o.type&&i.operators.includes(o.value+a)?o.value+=a:s.push({type:"operator",value:a});else if(a.match(i.numberRx))s.push({type:"constant",value:parseFloat(a)});else if(void 0!==this.settings.constants[a])s.push({type:"constant",value:this.settings.constants[a]});else{if(!a.match(i.tokenRx))throw new Error(`Formula contains invalid token: ${a}`);s.push({type:"reference",value:a})}a=""}};for(const t of e)r?t===r?(o(),r=!1):a+=t:n?"("===t?(a+=t,++n):")"===t?(--n,n?a+=t:o(t)):a+=t:t in i.literals?r=i.literals[t]:"("===t?(o(),++n):i.operatorCharacters.includes(t)?(o(),a=t,o()):" "!==t?a+=t:o();o(),s=s.map(((e,t)=>"operator"!==e.type||"-"!==e.value||t&&"operator"!==s[t-1].type?e:{type:"operator",value:"n"}));let l=!1;for(const e of s){if("operator"===e.type){if(i.operatorsPrefix.includes(e.value))continue;if(!l)throw new Error("Formula contains an operator in invalid position");if(!i.operators.includes(e.value))throw new Error(`Formula contains an unknown operator ${e.value}`)}else if(l)throw new Error("Formula missing expected operator");l=!l}if(!l)throw new Error("Formula contains invalid trailing operator");1===s.length&&["reference","literal","constant"].includes(s[0].type)&&(this.single={type:"reference"===s[0].type?"reference":"value",value:s[0].value}),this._parts=s.map((e=>{if("operator"===e.type)return i.operatorsPrefix.includes(e.value)?e:e.value;if("reference"!==e.type)return e.value;if(this.settings.tokenRx&&!this.settings.tokenRx.test(e.value))throw new Error(`Formula contains invalid reference ${e.value}`);return this.settings.reference?this.settings.reference(e.value):i.reference(e.value)}))}_subFormula(e,s){const a=this.settings.functions[s];if("function"!=typeof a)throw new Error(`Formula contains unknown function ${s}`);let n=[];if(e){let t="",a=0,r=!1;const o=()=>{if(!t)throw new Error(`Formula contains function ${s} with invalid arguments ${e}`);n.push(t),t=""};for(let s=0;s<e.length;++s){const n=e[s];r?(t+=n,n===r&&(r=!1)):n in i.literals&&!a?(t+=n,r=i.literals[n]):","!==n||a?(t+=n,"("===n?++a:")"===n&&--a):o()}o()}return n=n.map((e=>new t.Parser(e,this.settings))),function(e){const t=[];for(const i of n)t.push(i.evaluate(e));return a.call(e,...t)}}evaluate(e){const t=this._parts.slice();for(let s=t.length-2;s>=0;--s){const a=t[s];if(a&&"operator"===a.type){const n=t[s+1];t.splice(s+1,1);const r=i.evaluate(n,e);t[s]=i.single(a.value,r)}}return i.operatorsOrder.forEach((s=>{for(let a=1;a<t.length-1;)if(s.includes(t[a])){const s=t[a],n=i.evaluate(t[a-1],e),r=i.evaluate(t[a+1],e);t.splice(a,2);const o=i.calculate(s,n,r);t[a-1]=0===o?0:o}else a+=2})),i.evaluate(t[0],e)}},t.Parser.prototype[i.symbol]=!0,i.reference=function(e){return function(t){return t&&void 0!==t[e]?t[e]:null}},i.evaluate=function(e,t){return null===e?null:"function"==typeof e?e(t):e[i.symbol]?e.evaluate(t):e},i.single=function(e,t){if("!"===e)return!t;const i=-t;return 0===i?0:i},i.calculate=function(e,t,s){if("??"===e)return i.exists(t)?t:s;if("string"==typeof t||"string"==typeof s){if("+"===e)return(t=i.exists(t)?t:"")+(i.exists(s)?s:"")}else switch(e){case"^":return Math.pow(t,s);case"*":return t*s;case"/":return t/s;case"%":return t%s;case"+":return t+s;case"-":return t-s}switch(e){case"<":return t<s;case"<=":return t<=s;case">":return t>s;case">=":return t>=s;case"==":return t===s;case"!=":return t!==s;case"&&":return t&&s;case"||":return t||s}return null},i.exists=function(e){return null!=e}},9926:()=>{},5688:()=>{},9708:()=>{},1152:()=>{},443:()=>{},9848:()=>{},5934:e=>{"use strict";e.exports=JSON.parse('{"version":"17.13.1"}')}},t={},function i(s){var a=t[s];if(void 0!==a)return a.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,i),n.exports}(5107);var e,t},e.exports=t()},8127:function(e,t,i){"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==i.g&&i.g,e.exports=function(){"use strict";var e,t="3.7.7",i=t,s="function"==typeof Buffer,a="function"==typeof TextDecoder?new TextDecoder:void 0,n="function"==typeof TextEncoder?new TextEncoder:void 0,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=Array.prototype.slice.call(r),l=(e={},o.forEach((function(t,i){return e[t]=i})),e),c=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,u=String.fromCharCode.bind(String),d="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):function(e){return new Uint8Array(Array.prototype.slice.call(e,0))},m=function(e){return e.replace(/=/g,"").replace(/[+\/]/g,(function(e){return"+"==e?"-":"_"}))},h=function(e){return e.replace(/[^A-Za-z0-9\+\/]/g,"")},p=function(e){for(var t,i,s,a,n="",r=e.length%3,l=0;l<e.length;){if((i=e.charCodeAt(l++))>255||(s=e.charCodeAt(l++))>255||(a=e.charCodeAt(l++))>255)throw new TypeError("invalid character found");n+=o[(t=i<<16|s<<8|a)>>18&63]+o[t>>12&63]+o[t>>6&63]+o[63&t]}return r?n.slice(0,r-3)+"===".substring(r):n},f="function"==typeof btoa?function(e){return btoa(e)}:s?function(e){return Buffer.from(e,"binary").toString("base64")}:p,g=s?function(e){return Buffer.from(e).toString("base64")}:function(e){for(var t=4096,i=[],s=0,a=e.length;s<a;s+=t)i.push(u.apply(null,e.subarray(s,s+t)));return f(i.join(""))},y=function(e,t){return void 0===t&&(t=!1),t?m(g(e)):g(e)},v=function(e){if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?u(192|t>>>6)+u(128|63&t):u(224|t>>>12&15)+u(128|t>>>6&63)+u(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return u(240|t>>>18&7)+u(128|t>>>12&63)+u(128|t>>>6&63)+u(128|63&t)},b=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,k=function(e){return e.replace(b,v)},w=s?function(e){return Buffer.from(e,"utf8").toString("base64")}:n?function(e){return g(n.encode(e))}:function(e){return f(k(e))},S=function(e,t){return void 0===t&&(t=!1),t?m(w(e)):w(e)},x=function(e){return S(e,!0)},R=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,_=function(e){switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return u(55296+(t>>>10))+u(56320+(1023&t));case 3:return u((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return u((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},C=function(e){return e.replace(R,_)},A=function(e){if(e=e.replace(/\s+/g,""),!c.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(3&e.length));for(var t,i,s,a="",n=0;n<e.length;)t=l[e.charAt(n++)]<<18|l[e.charAt(n++)]<<12|(i=l[e.charAt(n++)])<<6|(s=l[e.charAt(n++)]),a+=64===i?u(t>>16&255):64===s?u(t>>16&255,t>>8&255):u(t>>16&255,t>>8&255,255&t);return a},$="function"==typeof atob?function(e){return atob(h(e))}:s?function(e){return Buffer.from(e,"base64").toString("binary")}:A,T=s?function(e){return d(Buffer.from(e,"base64"))}:function(e){return d($(e).split("").map((function(e){return e.charCodeAt(0)})))},I=function(e){return T(M(e))},D=s?function(e){return Buffer.from(e,"base64").toString("utf8")}:a?function(e){return a.decode(T(e))}:function(e){return C($(e))},M=function(e){return h(e.replace(/[-_]/g,(function(e){return"-"==e?"+":"/"})))},E=function(e){return D(M(e))},L=function(e){return{value:e,enumerable:!1,writable:!0,configurable:!0}},O=function(){var e=function(e,t){return Object.defineProperty(String.prototype,e,L(t))};e("fromBase64",(function(){return E(this)})),e("toBase64",(function(e){return S(this,e)})),e("toBase64URI",(function(){return S(this,!0)})),e("toBase64URL",(function(){return S(this,!0)})),e("toUint8Array",(function(){return I(this)}))},P=function(){var e=function(e,t){return Object.defineProperty(Uint8Array.prototype,e,L(t))};e("toBase64",(function(e){return y(this,e)})),e("toBase64URI",(function(){return y(this,!0)})),e("toBase64URL",(function(){return y(this,!0)}))},F=function(){O(),P()},B={version:t,VERSION:i,atob:$,atobPolyfill:A,btoa:f,btoaPolyfill:p,fromBase64:E,toBase64:S,encode:S,encodeURI:x,encodeURL:x,utob:k,btou:C,decode:E,isValid:function(e){if("string"!=typeof e)return!1;var t=e.replace(/\s+/g,"").replace(/={0,2}$/,"");return!/[^\s0-9a-zA-Z\+/]/.test(t)||!/[^\s0-9a-zA-Z\-_]/.test(t)},fromUint8Array:y,toUint8Array:I,extendString:O,extendUint8Array:P,extendBuiltins:F,Base64:{}};return Object.keys(B).forEach((function(e){return B.Base64[e]=B[e]})),B}()},7094:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.armyStatisticsByLevel=void 0;t.armyStatisticsByLevel=new Map,[{level:1,scouting:7,standardDC:15,ac:16,highSave:10,lowSave:4,attack:9,maximumTactics:1},{level:2,scouting:8,standardDC:16,ac:18,highSave:11,lowSave:5,attack:11,maximumTactics:1},{level:3,scouting:9,standardDC:18,ac:19,highSave:12,lowSave:6,attack:12,maximumTactics:1},{level:4,scouting:11,standardDC:19,ac:21,highSave:14,lowSave:8,attack:14,maximumTactics:2},{level:5,scouting:12,standardDC:20,ac:22,highSave:15,lowSave:9,attack:15,maximumTactics:2},{level:6,scouting:14,standardDC:22,ac:24,highSave:17,lowSave:11,attack:17,maximumTactics:2},{level:7,scouting:15,standardDC:23,ac:25,highSave:18,lowSave:12,attack:18,maximumTactics:2},{level:8,scouting:16,standardDC:24,ac:27,highSave:19,lowSave:13,attack:20,maximumTactics:3},{level:9,scouting:18,standardDC:26,ac:28,highSave:21,lowSave:15,attack:21,maximumTactics:3},{level:10,scouting:19,standardDC:27,ac:30,highSave:22,lowSave:16,attack:23,maximumTactics:3},{level:11,scouting:21,standardDC:28,ac:31,highSave:24,lowSave:18,attack:24,maximumTactics:3},{level:12,scouting:22,standardDC:30,ac:33,highSave:25,lowSave:19,attack:26,maximumTactics:4},{level:13,scouting:23,standardDC:31,ac:34,highSave:26,lowSave:20,attack:27,maximumTactics:4},{level:14,scouting:25,standardDC:32,ac:36,highSave:28,lowSave:22,attack:29,maximumTactics:4},{level:15,scouting:26,standardDC:34,ac:37,highSave:29,lowSave:23,attack:30,maximumTactics:4},{level:16,scouting:28,standardDC:35,ac:39,highSave:30,lowSave:25,attack:32,maximumTactics:5},{level:17,scouting:29,standardDC:36,ac:40,highSave:32,lowSave:26,attack:33,maximumTactics:5},{level:18,scouting:30,standardDC:38,ac:42,highSave:33,lowSave:27,attack:35,maximumTactics:5},{level:19,scouting:32,standardDC:39,ac:43,highSave:35,lowSave:29,attack:36,maximumTactics:5},{level:20,scouting:33,standardDC:40,ac:45,highSave:36,lowSave:30,attack:38,maximumTactics:6}].forEach((e=>t.armyStatisticsByLevel.set(e.level,e)))},4913:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPlayerArmies=t.isPlayerArmyActor=t.isSpecialArmy=t.getArmyTactics=t.isArmyTactic=t.isCampaignFeature=t.getScoutingDC=t.getArmyModifiers=t.getSelectedArmies=t.calculateTotalArmyConsumption=t.updateKingdomArmyConsumption=t.isEffectItem=void 0;const s=i(4767),a=i(1451),n=i(6185);function r(e){return"effect"===e.type}function o(e){return"army"===e?.type}function l(e){const t=[],i=[];return e?.scenes?.map((e=>e.tokens))?.forEach((e=>{e.forEach((e=>{const t=e.actor;t&&!e.hidden&&t.hasPlayerOwner&&i.push(t)}))})),(0,n.distinctBy)(i,(e=>e.uuid)).map((e=>e.system.consumption??0)).forEach((e=>t.push(e))),(0,n.sum)(t)}function c(e,t){return e.items.find((e=>r(e)&&e.slug===t))?.badge?.value??0}function u(e){return Array.from(e.user?.targets??[]).filter((e=>o(e.actor))).map((e=>e.actor))}function d(e){return"campaignFeature"===e.type}function m(e){return d(e)&&"kingmaker"===e.system.campaign&&"army-tactic"===e.system.category}function h(e){return o(e)&&e.hasPlayerOwner&&"Recruitable Armies"===e.folder?.name}t.isEffectItem=r,t.updateKingdomArmyConsumption=async function({actor:e=null,kingdomActor:t,game:i,forceUpdate:n=!1}){(0,a.getBooleanSetting)(i,"autoCalculateArmyConsumption")&&t&&(n||o(e))&&await(0,s.saveKingdom)(t,{consumption:{armies:Math.max(l(i),0)}})},t.calculateTotalArmyConsumption=l,t.getSelectedArmies=u,t.getArmyModifiers=function(e){const t=[],i=u(e);if(i.length>0){const e=i[0],s=c(e,"mired"),a=c(e,"weary"),n={type:"circumstance",phases:["army"],enabled:!0};a>0&&t.push({...n,value:-a,name:"Weary"}),s>0&&t.push({...n,value:-s,name:"Mired",activities:["deploy-army"]})}return t},t.getScoutingDC=function(e){return Math.max(...u(e).map((e=>e.system.scouting??0)),0)},t.isCampaignFeature=d,t.isArmyTactic=m,t.getArmyTactics=async function(e){return function(e){return(e?.filter((e=>d(e)))??[]).filter((e=>m(e)))}([...await(e.packs.get("pf2e.kingmaker-features")?.getDocuments()),...e.items??[]])},t.isSpecialArmy=function(e){return"common"!==e.system.traits.rarity},t.isPlayerArmyActor=h,t.getPlayerArmies=function(e){return e?.actors?.filter((e=>h(e)))??[]}},4309:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.skillDialog=void 0;const s=i(6185),a=i(6893);class SkillDialog extends FormApplication{onOk;skills;selectedSkills;selectedLores;showLores;all;allProficiency;showAll;atLeastOne;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-skills-dialog",e.title="Choose Skills",e.template="modules/pf2e-kingmaker-tools/templates/common/skills-dialog.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e.width=250,e}constructor(e,t){super(e,t),this.skills=t.availableSkills,this.selectedSkills=t.selectedSkills??[],this.selectedLores=t.selectedLores??[],this.showLores=void 0!==t.selectedLores,this.onOk=t.onSave,this.all=t.all??!1,this.showAll=void 0!==t.all,this.allProficiency=t.allProficiency,this.atLeastOne=t.atLeastOne??!1}getData(){return{skills:this.skills.map((e=>{const t=this.selectedSkills.find((t=>t.id===e));return{id:e,label:(0,s.unslugify)(e),selected:void 0!==t,proficiency:t?.proficiency}})),lores:[...this.selectedLores.map((e=>({id:e.id,label:(0,s.unslugify)(e.id),proficiency:e?.proficiency}))),{id:"",label:""}],showLores:this.showLores,proficiencies:(0,s.toLabelAndValue)([...a.allTrainedSkillRanks],{capitalizeLabel:!0}),showAll:this.showAll,all:this.all,allProficiency:this.allProficiency,errors:this.validate()}}async _updateObject(e,t){console.log(t),this.selectedSkills=this.skills.filter((e=>t[e])).map((e=>{const i=t[`${e}-proficiency`];return{id:e,proficiency:"-"===i?void 0:i}}));const i=Object.entries(t).filter((([e,t])=>e.endsWith("-lore")&&!(0,s.isBlank)(t)&&(0,s.slugifyable)(t.trim()))).map((([,e])=>{const i=(0,s.loreToLoreSkill)(e);return{id:i,proficiency:t[i+"-lore-proficiency"]}}));this.selectedLores=(0,s.distinctBy)(i,(e=>e.id)),this.all=t.all,this.allProficiency=t["all-proficiency"],this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,s.listenClick)(t,".save",(async()=>{this.onOk({selectedSkills:this.selectedSkills,selectedLores:this.selectedLores,all:this.all,allProficiency:this.allProficiency}),await this.close()}))}validate(){const e=[];return this.atLeastOne&&0===this.selectedSkills.length&&0===this.selectedLores.length&&!this.all&&e.push("Must select at least one skill"),e}}t.skillDialog=function(e){new SkillDialog(null,e).render(!0)}},9884:(e,t)=>{"use strict";var i;function s(e,t){return 1===e?Math.max(0,t-1):20===e?Math.min(3,t+1):t}Object.defineProperty(t,"__esModule",{value:!0}),t.determineDegreeOfSuccess=t.degreeToProperty=t.allDegreesOfSuccesses=t.DegreeOfSuccess=void 0,function(e){e[e.CRITICAL_FAILURE=0]="CRITICAL_FAILURE",e[e.FAILURE=1]="FAILURE",e[e.SUCCESS=2]="SUCCESS",e[e.CRITICAL_SUCCESS=3]="CRITICAL_SUCCESS"}(i||(t.DegreeOfSuccess=i={})),t.allDegreesOfSuccesses=["criticalSuccess","success","failure","criticalFailure"],t.degreeToProperty=function(e){return e===i.CRITICAL_SUCCESS?"criticalSuccess":e===i.SUCCESS?"success":e===i.FAILURE?"failure":"criticalFailure"},t.determineDegreeOfSuccess=function(e,t,a){return s(e,t<=a-10?i.CRITICAL_FAILURE:t>=a+10?i.CRITICAL_SUCCESS:t>=a?i.SUCCESS:i.FAILURE)}},2865:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.openJournal=void 0,t.openJournal=async function(e){const t=await fromUuid(e);t instanceof JournalEntryPage?t?.parent?.sheet?.render(!0,{pageId:t.id}):t.sheet.render(!0)}},4227:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rollCultEvent=t.rollKingdomEvent=void 0;const s=i(6375),a=i(1451);async function n(e,t){const i=await(0,s.findRollTableUuidWithFallback)(e,t,"pf2e-kingmaker-tools.kingmaker-tools-rolltables"),n={rollMode:(0,a.getStringSetting)(e,"kingdomEventRollMode")};await(0,s.rollRollTable)(e,i,n)}t.rollKingdomEvent=async function(e){const t=(0,a.getStringSetting)(e,"kingdomEventsTable").trim();await n(e,t)},t.rollCultEvent=async function(e){const t=(0,a.getStringSetting)(e,"kingdomCultTable").trim();await n(e,t)}},9602:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kingdomChatButtons=void 0;const s=i(4767),a=i(6690),n=i(171),r=i(5663),o=i(1436);t.kingdomChatButtons=[{selector:".km-pay-structure",callback:async(e,t,i)=>{i.preventDefault();const s=i.currentTarget,a=(0,o.parsePayButton)(s);await(0,o.payStructure)(t,a)}},{selector:".km-gain-fame-button",callback:async(e,t,i)=>{i.preventDefault();const a=(0,r.gainFame)((0,s.getKingdom)(t),1);await ChatMessage.create({content:"Gaining 1 Fame"}),await(0,s.saveKingdom)(t,a)}},{selector:".km-gain-lose",callback:async(e,t,i)=>{i.preventDefault();const s=i.currentTarget;await(0,n.updateResources)(e,t,s)}},{selector:".km-apply-modifier-effect",callback:async(e,t,i)=>{i.preventDefault();const n=i.currentTarget,r=n.dataset.activity,o=n.dataset.degree,l=parseInt(n.dataset.index??"0",10),c=(0,s.getKingdom)(t),u=(0,a.getKingdomActivitiesById)(c.homebrewActivities),d=u[r]?.[o]?.modifiers?.(c)?.[l];if(void 0!==d){const e={...d};void 0!==e.consumeId&&(e.consumeId=crypto.randomUUID());const i=[...c.modifiers,e];await(0,s.saveKingdom)(t,{modifiers:i})}else console.error(`Can not find modifier ${r}.${o}.modifiers.${l}`)}}]},5593:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateAbilityModifier=t.allAbilities=void 0,t.allAbilities=["culture","economy","loyalty","stability"],t.calculateAbilityModifier=function(e){return Math.floor((e-10)/2)}},1290:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getPerformableActivities=t.createActivityLabel=t.groupKingdomActivities=t.getActivitySkills=t.allKingdomPhases=void 0;const s=i(6690),a=i(7094);t.allKingdomPhases=["army","civic","commerce","event","leadership","region","upkeep"],t.getActivitySkills=function(e,t){return t?Object.entries(e).filter((([e,i])=>i<=t[e])).map((([e])=>e)):Object.keys(e)},t.groupKingdomActivities=function(e){const t={untrained:new Set,trained:new Set,expert:new Set,master:new Set,legendary:new Set,oncePerRound:new Set,leadership:new Set,region:new Set,event:new Set,army:new Set,commerce:new Set,upkeep:new Set,civic:new Set};return Object.entries(e).forEach((([e,i])=>{if(t[i.phase].add(e),i.oncePerRound&&t.oncePerRound.add(e),Object.values(i.skills).every((e=>0===e)))t.untrained.add(e);else if(Object.values(i.skills).every((e=>1===e)))t.trained.add(e);else if(Object.values(i.skills).every((e=>2===e)))t.expert.add(e);else if(Object.values(i.skills).every((e=>3===e)))t.master.add(e);else if(Object.values(i.skills).every((e=>4===e)))return t.legendary.add(e),t})),t},t.createActivityLabel=function(e,t,i){const n=i.level,r=(0,s.getKingdomActivitiesById)(i.homebrewActivities)[t],o=r.title,l=[];if("claim-hex"===t)n>=9?l.push("three times per turn"):n>=4?l.push("twice per turn"):l.push("once per turn");else if("train-army"===t){const e=a.armyStatisticsByLevel.get(i.level)?.maximumTactics??6;l.push(`Max ${e} per Army`)}return e.trained.has(t)?l.push("trained"):e.expert.has(t)?l.push("expert"):e.master.has(t)&&l.push("master"),e.oncePerRound.has(t)&&l.push("once per turn"),r.hint&&l.push(r.hint),o+(l.length>0?` (${l.join(", ")})`:"")},t.getPerformableActivities=function(e,t,i,s){return Object.fromEntries(Object.values(s).map((s=>{const a=s.skills,n="capital-investment"!==s.id||t,r=i||Object.entries(a).some((([t,i])=>e[t]>=i))&&n;return[s.id,r]})))}},6690:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getKingdomActivities=t.getKingdomActivitiesById=t.createResourceButton=t.gainSolution=t.loseUnrest=t.gainUnrest=t.loseRP=t.gainRP=t.loseRolledRD=t.gainRolledRD=t.loseRuin=t.gainRuin=t.loseCommodities=t.gainCommodities=t.loseFame=t.gainFame=t.gainXp=void 0;const s=i(6893),a=i(7894),n=i(6185);function r(e,t=0){return e.map((e=>({[e]:t}))).reduce(((e,t)=>Object.assign(e,t)),{})}const o={"abandon-hex":{title:"Abandon Hex",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"After careful consideration, you decide that you would rather not hold onto a particular hex as part of your claimed territory. You renounce your claim to it and pull back any settlers or explorers. Attempt a basic Exploration or Wilderness check. You can abandon more than one hex at a time, but each additional hex you abandon increases the DC of this check by 1.",requirement:"The hex to be abandoned must be controlled.",skills:r(["exploration","wilderness"]),criticalSuccess:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Settlers and explorers return and resettle elsewhere in your kingdom, bringing with them bits of salvage from the abandoned hexes. ${g(1)} per abandoned hex.`},success:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Settlers and explorers return and resettle elsewhere in your kingdom, bringing with them bits of salvage from the abandoned hexes. ${v(1)}`},failure:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Some citizens become disgruntled refugees who refuse to leave the hex. ${v(2)} and then attempt a @Check[type:flat|dc:6]. If you fail, the refugees become bandits, and during your next Event phase, your kingdom experiences a Squatters kingdom event automatically in addition to any other event that might occur.`},criticalFailure:{msg:`You abandon the hex or hexes, decreasing your kingdom's Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 532). Some citizens become disgruntled refugees who refuse to leave the hex. ${v(3)} and automatically experience a Bandit Activity kingdom event.`},special:"The Unrest gained from abandoning a hex doubles if it includes a settlement. A settlement in an abandoned hex becomes a Freehold (page 536)."},"build-roads":{title:"Build Roads",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>You order your kingdom’s engineers to construct a network of robust roads through the hex. Travel along roads is treated as if it were open terrain.</p>\n<p>Spend RP as determined by the hex’s most inhospitable terrain (if the hex includes any rivers that cross the hex from one hex side to any other, you must spend double the normal RP cost to also build bridges; this adds the Bridge structure to that hex):</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Work with the GM to determine where your roads appear on the map.</p>`,requirement:"The hex in which you seek to build roads must be claimed by your kingdom.",skills:r(["engineering"]),criticalSuccess:{msg:"You build roads into the target hex and, if possible, one adjacent claimed hex that doesn’t yet have roads and whose terrain features are at least as hospitable as those of the target hex"},success:{msg:"You build roads in the hex."},failure:{msg:"You fail to build roads in the hex."},criticalFailure:{msg:"Your attempt to build roads ends in disaster. Not only do you fail to build roads, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. "+v(1)}},"build-structure":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"civic",dc:"custom",title:"Build Structure",description:"You attempt to build a structure in the settlement that’s granting the Civic activity. You may choose any structure for which you meet the requirements. Select the appropriate number of contiguous buildable lots in a single block as specified by the structure’s entry and spend the specified RP and Commodity cost. Then attempt the structure’s skill check.\n\nYou can also use this activity to attempt to repair a structure that was damaged as the result of an event but hasn’t been replaced by Rubble. To do this, first spend half the structure’s listed RP and Commodity cost, and then attempt the specified check. The existing structure gives you a +2 item bonus to the check.\n\nOn a success, record the new construction on the Urban Grid. Unless the structure’s entry states otherwise, its effects are immediate; if the structure adjusts a Ruin’s point total, adjust it upon construction.\n",skills:r([...s.allSkills]),criticalSuccess:{msg:"You construct or repair the structure with great efficiency and get back half of the Commodities spent in construction or repair."},success:{msg:"You construct or repair the structure."},failure:{msg:"You fail to construct or repair the structure. You can try to complete it next Kingdom turn; if you do so, you do not need to re-pay the RP and Commodity cost."},criticalFailure:{msg:"You fail to construct the structure; if you were attempting to repair a damaged structure, it is reduced to Rubble. In either event, Rubble now fills the structure’s lots, which must be cleared with the Demolish activity before you can attempt to Build a Structure in them again."}},"capital-investment":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Capital Investment",description:"You contribute funds from your personal wealth for the good of the kingdom, including coinage, gems, jewelry, weapons and armor salvaged from enemies, magical or alchemical items, and so on. Your contribution generates economic activity in the form of RP that can be used during your current Kingdom turn or on the next Kingdom turn (your choice).\n\nYou can use Capital Investment to repay funds from Tap Treasury (page 528). In this case, no roll is needed and you simply deduct the appropriate amount of funds from your personal wealth to pay back that which was borrowed. When you use Capital Investment to generate RP, the amount of gp required to make an investment is set by your kingdom’s level. Investments below this amount cause your attempt at Capital Investment to suffer an automatic critical failure, while investments above this amount are lost. The investment required is equal to the value listed on Table 10–9: Party Treasure by Level @UUID[Compendium.pf2e.journals.S55aqwWIzpQRFhcq.JournalEntryPage.Ly8l2GT6dbvuY3A2]{Treasure}; use the value for your kingdom’s level under the “Currency per Additional PC” as the required investment value. This is a basic check.",requirement:"You must be within the influence of a settlement that contains at least one Bank.",skills:r(["trade"]),criticalSuccess:{msg:`Success Your kingdom reaps the benefits of your investment. ${p(4)}`},success:{msg:`Your investment helps the economy. ${p(2)}`},failure:{msg:`Your investment ends up being used to shore up shortfalls elsewhere. ${g("1d4")}`},criticalFailure:{msg:`Your investment is embezzled, lost, or otherwise misappropriated. Choose one of the following: either ${p(1)} and also increase your Crime by an equal amount, or gain 0 RP and ${m("crime",1)}`}},"celebrate-holiday":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Celebrate Holiday",description:"You declare a day of celebration. Holidays may be religious, historical, martial, or simply festive, but all relieve your citizens from their labors and give them a chance to make merry at the kingdom’s expense. Attempt a basic check, but if your kingdom Celebrated a Holiday the previous turn, the DC increases by 4, as your kingdom hasn’t had a chance to recover from the previous gala.",skills:r(["folklore"]),criticalSuccess:{msg:"Your holidays are a delight to your people. The event is expensive, but incidental income from the celebrants covers the cost. You gain a +2 circumstance bonus to Loyalty-based checks until the end of your next Kingdom turn.",modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:2,name:"Celebrate Holiday: Critical Success",type:"circumstance"}]},success:{msg:`Your holidays are a success, but they’re also expensive. You gain a +1 circumstance bonus to Loyalty-based checks until the end of your next Kingdom turn. ${f(1)}. If you can’t afford this cost, treat this result as a Critical Failure instead.`,modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:1,name:"Celebrate Holiday: Success",type:"circumstance"}]},failure:{msg:`The holiday passes with little enthusiasm, but is still expensive. ${f(1)}. If you can’t afford this cost, treat this result as a Critical Failure instead.`},criticalFailure:{msg:`Your festival days are poorly organized, and the citizens actively mock your failed attempt to celebrate. ${w({turn:"next",value:"4",mode:"lose",type:"resource-dice"})}. The failure also causes you to take a –1 circumstance penalty to Loyalty-based checks until the end of the next Kingdom turn.`,modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:-1,name:"Celebrate Holiday: Critical Failure",type:"circumstance"}]}},"claim-hex":{title:"Claim Hex",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",requirement:"You have Reconnoitered the hex to be claimed during hexploration. This hex must be adjacent to at least one hex that’s already part of your kingdom. If the hex to be claimed contains dangerous hazards or monsters, they must first be cleared out—either via standard adventuring or the Clear Hex activity.",description:`Your surveyors fully explore the hex and attempt to add it into your kingdom’s domain. ${y(1)} and then attempt a basic Exploration, Intrigue, Magic, or Wilderness check.`,skills:r(["exploration","intrigue","magic","wilderness"]),criticalSuccess:{msg:"You claim the hex and immediately add it to your territory, increasing your kingdom's Size by 1 (this affects all statistics determined by Size; see page 532). Your occupation of the hex goes so smoothly that you can immediately attempt another Region activity."},success:{msg:"You claim the hex and add it to your territory, increasing your kingdom's Size by 1 (this affects all statistics determined by Size; see page 532)."},failure:{msg:"You fail to claim the hex."},criticalFailure:{msg:"You fail to claim the hex, and a number of early settlers and explorers are lost, causing you to take a –1 circumstance penalty to Stability-based checks until the end of your next Kingdom turn.",modifiers:()=>[{turns:2,enabled:!0,abilities:["stability"],value:-1,name:"Claim Hex: Critical Failure",type:"circumstance"}]},special:"At 1st level, when selecting the three activities you take during the Region Activities step of the Activity phase of the Kingdom turn, you may select this activity no more than once. Once your kingdom reaches 4th level, you may select it up to twice per turn, and after reaching 9th level you may select it up to three times per turn. When you successfully claim a hex, gain kingdom XP (see page 540). Many hexes have terrain features that grant benefits to your kingdom when claimed; see Terrain Features on page 535."},"clandestine-business":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Clandestine Business",description:"You know there are criminals in your kingdom, and they know you know. You encourage them to send kickbacks in the form of resources and Commodities to the government, but the common citizens will be more than upset if they find out! This starts as a basic check against your Control DC, but every subsequent Kingdom turn you pursue Clandestine Business, the DC increases by 2. Every Kingdom turn that passes without Clandestine Business reduces the DC by 1 (until you reach your Control DC).",skills:r(["intrigue"],1),criticalSuccess:{msg:`${p(2)}. In addition, you ${u("luxuries","1d4")}. The public is none the wiser.`},success:{msg:`Either ${p(2)}, or gain ${u("luxuries","1d4")}. Regardless of your choice, rumors spread about where the government is getting these “gifts.” ${v(1)}.`},failure:{msg:`${p(1)}. Rumors are backed up with eyewitness accounts. ${v(1)} and ${m("corruption",1)}.`},criticalFailure:{msg:`You gain nothing from the Clandestine Business but angry citizens. ${v("1d6")}, ${m("corruption",2)}, and one other Ruin of your choice by 1.`}},"clear-hex":{oncePerRound:!1,fortune:!1,enabled:!0,title:"Clear Hex",phase:"region",dc:"custom",description:`<p>Engineers and mercenaries attempt to prepare a hex to serve as the site for a settlement, or they work to remove an existing improvement, a dangerous hazard, or an encounter.</p>\n<p>If you’re trying to prepare a hex for a settlement or demolish an improvement you previously built (or that was already present in the hex), spend RP as determined by the hex’s most inhospitable terrain feature:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic Engineering check. If you’re trying to remove a hazard or encounter, instead attempt an Exploration check. The DC of this check is set by the highest level creature or hazard in the hex (as set by Table 10–5: DCs by Level, on page 503 of the Pathfinder Core Rulebook).</p>\n\n<p>If the hex you’re attempting to Clear has existing Ruins or an existing Structure, your action doesn’t physically remove the buildings from the area and you can later incorporate these buildings (or repair ruined ones) into a Settlement you build here later (see page 542). Regardless of the skill used, increase the basic DC by 2 if the hex to be cleared is not yet part of your kingdom.</p>`,skills:r(["engineering","exploration"]),criticalSuccess:{msg:`You successfully clear the hex. If you spent RP to attempt this activity, you’re refunded half of the RP cost. If you were removing dangerous creatures (but not hazards) from the hex, your explorers and mercenaries recover 2 Luxury Commodities as treasure. ${u("luxuries",2)}`},success:{msg:"You successfully clear the hex."},failure:{msg:"You fail to clear the hex."},criticalFailure:{msg:`You catastrophically fail to clear the hex and several workers lose their lives. ${v(1)}`}},"collect-taxes":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Collect Taxes",description:"Tax collectors travel through the lands to collect funds for the betterment of the kingdom. Attempt a basic check.",skills:r(["trade"],1),criticalSuccess:{msg:"Your tax collectors are wildly successful! For the remainder of the Kingdom turn, gain a +2 circumstance bonus to Economy-based checks.",modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:2,name:"Collect Taxes: Critical Success",type:"circumstance"}]},success:{msg:`Your tax collectors gather enough to grant you a +1 circumstance bonus to Economy-based checks for the remainder of the Kingdom turn. If you attempted to Collect Taxes during the previous turn, ${v(1)}`,modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:1,name:"Collect Taxes: Success",type:"circumstance"}]},failure:{msg:`Your tax collectors gather enough to grant you a +1 circumstance bonus to Economy-based checks for the remainder of the Kingdom turn. In addition, people are unhappy about taxes—${v(1)} (or ${v(2)} if you attempted to Collect Taxes the previous turn).`,modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:1,name:"Collect Taxes: Failure",type:"circumstance"}]},criticalFailure:{msg:`Your tax collectors encounter resistance from the citizens and their attempts to gather taxes are rebuffed. While the tax collectors still manage to gather enough taxes to support essential government, they have angered the kingdom's citizens and encouraged rebellious acts. ${v(2)}, and choose one Ruin to increase by 1.`}},"craft-luxuries":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Craft Luxuries",description:`You encourage your artisans to craft luxury goods and may even aid them in this pursuit. ${f(1)}. Then attempt a basic check.`,skills:r(["arts"]),criticalSuccess:{msg:`Your artisans exceed expectations and craft extravagant goods. ${u("luxuries","1d4")}`},success:{msg:`Your artisans produce some delightful goods. ${u("luxuries",1)}`},failure:{msg:"Your artisans fail to produce anything noteworthy."},criticalFailure:{msg:"Your artisans not only fail to produce anything noteworthy, but some took advantage of the opportunity to push their own agendas or earn more for themselves by selling to underground markets. Increase one of your Ruins by 1."}},"create-a-masterpiece":{oncePerRound:!0,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Create a Masterpiece",description:"You encourage your kingdom’s artists to create and display a masterful work of art to bolster your kingdom’s reputation. Attempt a basic check; the result affects either Fame or Infamy (depending on the type of kingdom you’re running). Create a Masterpiece may be attempted only once per Kingdom turn regardless of the number of leaders pursuing activities.",skills:r(["arts"],1),criticalSuccess:{msg:`${l(1)}, and ${w({turn:"next",type:"fame",value:"1"})}. ${p(2)}`},success:{msg:l(1)},failure:{msg:"Your attempt to create a masterpiece fails."},criticalFailure:{msg:`Not only does your attempt to create a masterpiece fail, it does so in a dramatic and humiliating way. ${c(1)}; if you have no Fame or Infamy points to lose, instead ${v("1d4")}`}},"creative-solution":{enabled:!0,oncePerRound:!1,fortune:!0,phase:"leadership",dc:"control",title:"Creative Solution",description:"You work with your kingdom’s scholars, thinkers, and practitioners of magical and mundane experimentation to come up with new ways to resolve issues when business as usual is just not working. Attempt a basic check.<br/><br/><b>Creative Solution:</b><p>You can decide to use Creative Solution before attemptin a Kingdom skil check. Attempt the same check second time, but with +2 circumstance bonus, and take whichever of the two results you prefer. This is a fortune effect. If you don’t use your Creative Solution by the end of this Kingdom turn, this benefit ends and you gain 10XP instead.</p>",skills:r(["scholarship"]),criticalSuccess:{msg:`You can call upon the solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("creative-solution")}.`,modifiers:()=>[{turns:1,enabled:!1,value:2,name:"Creative Solution: Critical Success",type:"circumstance",consumeId:""}]},success:{msg:`You can call upon the solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("creative-solution")}. In addition, ${f(1)} to research the solution. This cost is paid now, whether or not you use your Creative Solution.`,modifiers:()=>[{turns:1,enabled:!1,value:2,name:"Creative Solution: Success",type:"circumstance",consumeId:""}]},failure:{msg:`Your attempt at researching is a failure and you ${f(2)}. It provides no advantage.`},criticalFailure:{msg:`Your attempt at researching is a failure and you ${f(2)}. It provides no advantage. In addition, your scholars and thinkers are so frustrated that you cannot attempt a Creative Solution again for 2 Kingdom turns.`},special:"You cannot influence a check with Supernatural Solution and Creative Solution simultaneously."},"decadent-feasts":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Decadent Feasts",description:`Your goddess is more than just the goddess of undeath— she’s also the goddess of gluttony. And you are no fool; you understand the fear your goddess inspires in the living and knows that focusing on other aspects of her worship are more likely to result in positive growth for the nation. In order to distract the populace, you arrange for decadent feasts for the people, simultaneously feeding the hungry while camouflaging some of your faith’s more sinister aspects. ${d("food","1d8")} and ${d("luxuries",1)}, then attempt a basic Agriculture or Trade check to determine how effective the feasts are.`,skills:r(["agriculture"]),criticalSuccess:{msg:`The people rejoice and glut themselves on the repast! ${b("1d6")}, and the next time this Kingdom turn you suffer an effect that increases Unrest, do not increase your Unrest.`},success:{msg:`The people enjoy the meal, but no longer than it takes to gulp it down. ${b("1d3")}`},failure:{msg:`The meal is appreciated, but the people remain suspicious. ${b(1)}.`},criticalFailure:{msg:`The people are too suspicious of the feast to enjoy it. Worse, rumors that Jaethal is trying to distract the citizens from an evil ritual spread. ${v("1d4")} and ${m("corruption",1)}`}},"deliberate-planning":{oncePerRound:!1,fortune:!0,enabled:!1,phase:"leadership",dc:"custom",title:"Deliberate Planning",description:"Yout take time and weigh all options when faced with decisions, regardless of their importance. While this can sometimes lead you to taking too long to make choices, your theoretical analysis can be quite helpful in navigating continuous events. Choose a single continuous event that will affect your kingdom on this turn’s Event Phase, then attempt a Scholarship check against that event’s DC.",skills:r([...s.allSkills]),criticalSuccess:{msg:"Your aid has been monumentally helpful. When you roll to resolve the continuous event you chose, you can roll twice and choose which result to apply. You gain a +1 circumstance bonus to each roll. This is a Fortune effect.",modifiers:()=>[{turns:1,enabled:!1,value:1,name:"Deliberate Planning: Critical Success",type:"circumstance",phases:["event"]}]},success:{msg:"Your suggestions are useful, granting you a +1 circumstance bonus to rolls to resolve the chosen continuous event.",modifiers:()=>[{turns:1,enabled:!1,value:1,name:"Deliberate Planning: Success",type:"circumstance",phases:["event"]}]},failure:{msg:"Your advice isn’t helpful, but neither does it hinder your ability to handle the event."},criticalFailure:{msg:"You got too caught up in your theoretical analysis and spent too much time preparing. When you roll to resolve the continuous event you tried to plan for, roll twice and take the worse result."}},demolish:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"civic",dc:"control",title:"Demolish",description:"Choose a single occupied lot in one of your settlements and attempt a basic check to reduce it to Rubble and then clear the Rubble away to make ready for a new structure. For multiple-lot structures, you’ll need to perform multiple Demolish activities (or critically succeed at the activity) to fully clear all of the lots. As soon as you begin Demolishing a multiple-lot structure, all of the lots occupied by that structure no longer function.",skills:r(["engineering"]),criticalSuccess:{msg:"Choose one of the following effects: you demolish an entire multiple-lot structure all at once and clear all of the lots it occupied, or you recover [[/r 1d6#Commodities]] Commodities (chosen from lumber, stone, and ore) from the Rubble of a single-lot demolition."},success:{msg:"You demolish the lot successfully."},failure:{msg:"You fail to demolish the lot. It remains in Rubble and cannot be used for further construction until you successfully Demolish it."},criticalFailure:{msg:`You fail to demolish the lot. It remains in Rubble and cannot be used for further construction until you successfully Demolish it. In addition, accidents during the demolition cost you the lives of some of your workers. ${v(1)}`}},"deploy-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Deploy Army",description:"The army moves through your kingdom or beyond. Since this travel occurs over the course of the entire month that preceded the Kingdom turn, the ground an army covers when it deploys can be quite extensive. You can Deploy an Army with an Exploration, Boating, or Magic check.\n\nWhen you use an Exploration check, choose a location within 20 hexes of the army’s current hex. You can issue orders to force march. Doing so grants a +4 circumstance bonus on the check, but causes the army to increase its weary condition by 2.\n\nWhen you use a Boating check, the army’s starting point and ending point must be connected by a navigable body of water; choose any location within 20 hexes along this route.\n\nYou must be at least master in Magic to attempt a Magic check. When you do so, choose any location within 20 hexes of the army’s current hex, then roll your check. \n\nIf the army’s deployment causes it to cross your kingdom’s border, the DC increases by 5. If the army’s deployment causes it to cross an enemy kingdom’s border, the DC instead increases by 10.",skills:{exploration:0,boating:0,magic:3},criticalSuccess:{msg:"The army arrives much more quickly than you anticipated; it arrives at its destination and then becomes efficient."},success:{msg:"The army arrives at its destination. "},failure:{msg:"The army arrives at its destination, but ran into some sort of trouble along the way. Increase the army’s weary condition by 1 and attempt a @Check[type:flat|dc:6]; on a failure, reduce the army’s HP by 1."},criticalFailure:{msg:`Rather than arriving at its destination, the army becomes lost until it recovers from this condition. ${v("1d4")}, and attempt a @Check[type:flat|dc:11]; on a failure, reduce the army’s HP by 1.`}},"disband-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"none",title:"Disband Army",description:"You can choose to disband an army with no check needed. If the army consisted of conscripts from your kingdom, the soldiers revert to being citizens. If the army was recruited from creatures encountered in the wilds, they return to their homes. A disbanded army no longer contributes to your kingdom’s Consumption.",skills:r([...s.allSkills])},"establish-farmland":{title:"Establish Farmland",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`You plant crops and establish livestock in permanent farms, ranches, and other growing operations to create Farmland (page 535). If you’re attempting to Establish Farmland in a hex that is predominantly plains, you must ${y(1)} and the check is against your Control DC. If you’re targeting a hex that is predominantly hills, you must spend ${y(2)} and the check is against your Control DC + 5.`,requirement:"Plains or hills are the predominant terrain feature in the hex; the hex is in the influence of one of your settlements.",skills:r(["agriculture"]),criticalSuccess:{msg:"You establish two adjacent Farmland hexes instead of one. If your target hex was a hills hex, the additional hex may be a hills hex or a plains hex; otherwise, the additional hex must be a plains hex. If no appropriate hex is available, treat this result as a regular success instead."},success:{msg:"You establish one Farmland hex."},failure:{msg:"You fail to establish a Farmland hex."},criticalFailure:{msg:"You fail to establish a Farmland hex, and your attempt potentially causes the spread of a blight. At the start of each of the next two Event phases, attempt a @Check[type:flat|dc:6|showDC:all]; on a failure, your kingdom experiences a Crop Failure event in this and all adjacent hexes."}},"establish-settlement":{title:"Establish Settlement",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"You draw up plans, gather resources, entice citizens, and establish boundaries to found a brand new settlement in the hex. Attempt a basic Engineering, Industry, Politics, or Scholarship check. If you cannot pay the RP required by the result of this check, treat your result as a critical failure. A settlement always starts as a village. See page 540 for further details about building settlements.",requirement:"The hex in which you’re establishing the settlement has been Cleared and doesn’t currently have a settlement (including a Freehold) in it.",skills:r(["engineering","industry","politics","scholarship"]),criticalSuccess:{msg:`You establish the settlement largely with the aid of enthusiastic volunteers. ${y("1d6")}`},success:{msg:`You establish the settlement. ${y("3d6")}`},failure:{msg:`You establish the settlement, but inefficiently and at great expense. ${y("6d6")}`},criticalFailure:{msg:"You fail to establish the settlement."}},"establish-trade-agreement":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Establish Trade Agreement",description:"You send a band of merchants out to establish a trade agreement between your kingdom and a group with whom you’ve established diplomatic relations. If a navigable river connects your kingdom with the other group’s territory, you can attempt a Boating check to Establish the Trade Agreement. Otherwise, attempt a Trade check.\n\nThe check’s DC is either the group’s Negotiation DC (see sidebar) or your kingdom’s Control DC, whichever is higher.\n\nIf you are using boating and a navigable river connects not only your kingdom but a settlement of your kingdom with the other group's teritory, you gain +3 circumstance bonus to the roll. If you are using trade and a road connects your settlment with the other group's teritory, you gain the same bonus.",requirement:"You have diplomatic relations with the group you wish to establish an agreement with.",skills:{boating:0,trade:0},criticalSuccess:{msg:`You successfully establish a trade agreement with your target, and your merchants return with gifts! ${p(2)}`},success:{msg:"You successfully establish a trade agreement."},failure:{msg:`Your traders reach their destination but need to sweeten the deal to secure the trade agreement. ${f(2)}. If you do so, you successfully establish a trade agreement, otherwise the attempt fails.`},criticalFailure:{msg:`Your trade agreement is a total loss and your traders do not return. ${v(1)}, and until the end of the next Kingdom turn, take a –1 circumstance penalty to all Economy-related checks.`,modifiers:()=>[{turns:2,enabled:!1,value:-1,name:"Establish Trade Agreement: Critical Failure",type:"circumstance",abilities:["economy"]}]}},"establish-work-site-lumber":{title:"Establish Work Site Lumber",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>Your hire a crew of workers to travel to a hex that contains Lumber, Ore, or Stone to be harvested. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Lumber camps can be established in any hex that contains a significant amount of forest terrain. Mines and quarries can be established in any hex that contains a significant amount of hill or mountain terrain.</p>`,skills:r(["engineering"]),criticalSuccess:{msg:"You establish a Work Site in the hex and proceed to discover an unexpectedly rich supply of high quality Commodities. All Commodity yields granted by this site are doubled until the end of the next Kingdom turn."},success:{msg:"You establish a Work Site in the hex."},failure:{msg:"You fail to establish a Work Site in the hex."},criticalFailure:{msg:`Not only do you fail to establish a Work Site, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"establish-work-site-mine":{title:"Establish Work Site Mine",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>Your hire a crew of workers to travel to a hex that contains Lumber, Ore, or Stone to be harvested. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Lumber camps can be established in any hex that contains a significant amount of forest terrain. Mines and quarries can be established in any hex that contains a significant amount of hill or mountain terrain.</p>`,skills:r(["engineering"]),criticalSuccess:{msg:"You establish a Work Site in the hex and proceed to discover an unexpectedly rich supply of high quality Commodities. All Commodity yields granted by this site are doubled until the end of the next Kingdom turn."},success:{msg:"You establish a Work Site in the hex."},failure:{msg:"You fail to establish a Work Site in the hex."},criticalFailure:{msg:`Not only do you fail to establish a Work Site, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"establish-work-site-quarry":{title:"Establish Work Site Quarry",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:`<p>Your hire a crew of workers to travel to a hex that contains Lumber, Ore, or Stone to be harvested. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. Lumber camps can be established in any hex that contains a significant amount of forest terrain. Mines and quarries can be established in any hex that contains a significant amount of hill or mountain terrain.</p>`,skills:r(["engineering"]),criticalSuccess:{msg:"You establish a Work Site in the hex and proceed to discover an unexpectedly rich supply of high quality Commodities. All Commodity yields granted by this site are doubled until the end of the next Kingdom turn."},success:{msg:"You establish a Work Site in the hex."},failure:{msg:"You fail to establish a Work Site in the hex."},criticalFailure:{msg:`Not only do you fail to establish a Work Site, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"evangelize-the-end":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Evangelize the End",description:"You spend time preaching the End Times. While your sermons certainly aren’t for everyone, your methods avoid deliberately antagonizing those who see hope in the world while simultaneously providing ease and calm to the more desperate among the kingdom’s citizens. Attempt a basic Folklore check to determine how effective your sermons are.",skills:r(["folklore"]),criticalSuccess:{msg:`Your prayers soothe and calm the more criminal-minded citizens for the time being. ${b("1d4")}, and either ${h("crime",2)} or ${h("corruption",1)} or ${h("strife",1)}.`},success:{msg:`Your prayers serve to redirect and calm discord. ${b("1d3")}`},failure:{msg:`Your prayers serve to redirect and calm discord. ${b("1")}`},criticalFailure:{msg:`Your prayers have unsettled some of your citizens. ${v("1d4")} and ${m("decay",1)} `}},"false-victory":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"False Victory",description:"Your contacts with the criminal underworld and your knack for dodging punishment and claiming responsibility for victories you had no direct role in can be harnessed to engineer false victories to trick the kingdom’s citizens into thinking their leaders are doing more than they actually are to create a safe place to live. Such attempts are not without risks, though, for if things backfire, you can cause problems where none existed in the first place. When setting up a false victory, attempt a basic Intrigue check.",skills:r(["intrigue"]),criticalSuccess:{msg:`At the end of this Kingdom turn’s Event Phase, roll again on the random kingdom events table. Rumors of this event being resolved spread throughout your kingdom. You don’t gain any of the benefits of resolving this false victory, but instead ${b("1d6")} and one Ruin of your choice by 1. If you randomly roll that same random kingdom event at any time during the next four kingdom turns, you can attempt an Intrigue check with a +1 circumstance bonus to resolve it rather than the normal check to resolve it.`,modifiers:()=>[{turns:5,enabled:!1,value:1,name:"False Victory: Critical Success",type:"circumstance",phases:["event"],skills:["intrigue"]}]},success:{msg:`Vague rumors of the kingdom’s leaders attaining victories over vague threats spread through the kingdom. ${b("1d3")}`},failure:{msg:`The false event fails to manifest, and rumors of the truth spread throughout the kingdom. ${v(1)}. You cannot attempt False Victory on your next Kingdom turn.`},criticalFailure:{msg:"The truth comes out, and the citizens revolt against this attempt to manipulate them. A Public Scandal event takes place during this kingdom’s event phase, in addition to any other events that would normally take place. Attempt a DC @Check[type:flat|dc:11|showDC:all] check. On a success, the Public Scandal involves a randomly determined leader, but on a failure, the blame falls on Kanerah. Regardless of how the Public Scandal plays out, you cannot attempt False Victory again for 6 Kingdom turns."}},"focused-attention":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:20,title:"Focused Attention",description:"You set aside time to focus attention on aiding another leader in an activity. Choose another leader and a Kingdom skill, then attempt a DC 20 check using the chosen skill. On a success, you grant that leader a +2 circumstance bonus to one kingdom check using that skill, provided that leader attempts the skill check during the same Kingdom turn.\n\nThe Cooperative Leadership Kingdom feat (page 531) increases the efficiency of this activity.",skills:r([...s.allSkills]),criticalSuccess:{msg:"You grant that leader a +2 circumstance bonus to one kingdom check using that skill, provided that leader attempts the skill check during the same Kingdom turn",modifiers:e=>[{turns:1,enabled:!1,consumeId:"",value:(0,a.hasFeat)(e,"Cooperative Leadership")?3:2,name:"Focused Attention: Critical Success",type:"circumstance",rollOptions:["focused-attention"]}]},success:{msg:"You grant that leader a +2 circumstance bonus to one kingdom check using that skill, provided that leader attempts the skill check during the same Kingdom turn",modifiers:e=>[{turns:1,enabled:!1,consumeId:"",value:(0,a.hasFeat)(e,"Cooperative Leadership")?3:2,name:"Focused Attention: Success",type:"circumstance",rollOptions:["focused-attention"]}]}},"fortify-hex":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",title:"Fortify Hex",description:`<p>Your command your engineers to construct a protected encampment, such as a fort or barbican, to serve as a defensive post in the hex. Spend RP as determined by the hex’s most inhospitable terrain:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check. A fortified hex grants an additional bonus in warfare (see Appendix 3), but also gives traveling PCs a place to rest that prevents wandering monsters from interrupting their rest.</p>`,requirement:"The target hex must be claimed by your kingdom and must not have a settlement in it.",skills:r(["defense"]),criticalSuccess:{msg:`You find a defensible position for your fortification and finish construction efficiently. Gain a refund of half the RP you spent to build in the hex, then ${b(1)}`},success:{msg:`You establish your fortification in the hex. ${b(1)}`},failure:{msg:"You fail to fortify the hex."},criticalFailure:{msg:`Your attempt ends in disaster. Not only do you fail to build a structure, but you lose several workers to an accident, banditry, a vicious monster, or some other unforeseen occurrence. ${v(1)}`}},"garrison-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Garrison Army",description:"You move an army into a fortification and assign them to guard it. In order to garrison, the army must be located in a hex that contains a Refuge, Settlement, or Work Site. If you’re garrisoning the army in a Refuge hex, attempt a basic Defense check. If you’re garrisoning the army in a settlement, attempt a basic Politics check. If you’re garrisoning the army in a Work Site hex, attempt a basic Engineering check. This check’s DC increases by 5 if the hex is not part of your kingdom, or by 10 if the location is part of an enemy kingdom.",requirement:"The army is in the same hex as a Refuge, Settlement, or Work Site.",skills:r(["defense","politics","engineering"]),criticalSuccess:{msg:"The army becomes fortified until it is deployed. Additionally, the efficiency of the garrisoning reduces this army’s Consumption by 2 (to a minimum of 1) until it is deployed."},success:{msg:"The army becomes fortified until it is deployed."},failure:{msg:"The army becomes fortified until the next Kingdom turn begins, at which point you must use this activity again to maintain the fortified condition."},criticalFailure:{msg:`Your army clashes with local citizens, abuses their authority, lets their watchful readiness slack, and/or provokes confrontations where they are not needed. It does not become fortified, and you cannot attempt to garrison that army at this location again for 4 Kingdom turns. ${v(1)}`}},"gather-livestock":{title:"Gather Livestock",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"Attempt a basic check to gather excess livestock from local wildlife, ranches, and farms. This generates a number of Food commodities.",skills:r(["wilderness"]),criticalSuccess:{msg:u("food","1d4")},success:{msg:u("food",1)},failure:{msg:"Gain no Food commodities."},criticalFailure:{msg:`${d("food","1d4")} to spoilage. If you have no Food to lose, you instead ${v(1)}`}},"go-fishing":{title:"Go Fishing",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"Attempt a basic check to fish for food from the rivers and lakes in your kingdom.",requirement:"Must have at least one claimed hex that includes river or lake terrain.",skills:r(["boating"]),criticalSuccess:{msg:u("food","1d4")},success:{msg:u("food",1)},failure:{msg:"Gain no Food commodities."},criticalFailure:{msg:`You lose some fishers to tragic accidents; ${v(1)}`}},"harvest-lily-pollen":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"region",dc:"control",title:"Harvest Azure Lily Pollen",description:"You or a small group of trained herbalists or naturalists work to harvest and process @UUID[Compendium.pf2e.equipment-srd.Item.MvMa010Je10GN5dx]{Azure Lily Pollen} in hopes of creating a few doses of the poison (detailed on page 584). Attempt a DC 30 Agriculture check. You must then wait 1 Kingdom turn before attempting this activity again, to give the lilies time to recover.",skills:r(["agriculture"],3),criticalSuccess:{msg:"You create 2 doses of @UUID[Compendium.pf2e.equipment-srd.Item.MvMa010Je10GN5dx]{Azure Lily Pollen}."},success:{msg:`You create 1 dose of @UUID[Compendium.pf2e.equipment-srd.Item.MvMa010Je10GN5dx]{Azure Lily Pollen} but must also attempt a @Check[type:basic|dc:11|showDC:all]. On a failure, some of the poison makes its way into criminal hands; ${m("crime",1)}`},failure:{msg:`You fail to harvest any @UUID[Compendium.pf2e.equipment-srd.Item.MvMa010Je10GN5dx]{Azure Lily Pollen}, in part because many of the resources make their way into the kingdom’s criminal underworld. ${m("crime",1)}`},criticalFailure:{msg:`Not only do you fail to harvest any pollen, and not only do resources make their way into the hands of criminals, but whispers and rumors that you allowed this to happen on purpose spread through the kingdom. ${v("1d4")}, ${m("corruption",1)}, and ${m("crime",2)}`}},"harvest-crops":{title:"Harvest Crops",oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",description:"Attempt a basic check to forage for wild edibles or gather excess crops from farms.",skills:r(["agriculture"]),criticalSuccess:{msg:u("food","1d4")},success:{msg:u("food",1)},failure:{msg:"Gain no Food commodities."},criticalFailure:{msg:`${d("food","1d4")} to spoilage; if you have no Food to lose, you instead ${v(1)}`}},"hire-adventurers":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Hire Adventurers",description:`While the PCs can strike out themselves to deal with ongoing events, it’s often more efficient to Hire Adventurers. When you Hire Adventurers to help end an ongoing event, the DC is equal to your Control DC adjusted by the event’s level modifier. ${f(1)} each time you attempt this activity.`,skills:r(["exploration"]),criticalSuccess:{msg:"You end the continuous event."},success:{msg:"The continuous event doesn’t end, but you gain a +2 circumstance bonus to resolve the event during the next Event phase.",modifiers:()=>[{turns:2,enabled:!1,phases:["event"],value:2,name:"Hire Adventurers: Success",type:"circumstance"}]},failure:{msg:"You fail to end the continuous event. If you try to end the continuous event again, the cost in RP increases to 2 Resource Dice."},criticalFailure:{msg:"You fail to end the continuous event. If you try to end the continuous event again, the cost in RP increases to 2 Resource Dice. In addition, word spreads quickly through the region—you can no longer attempt to end this continuous event by Hiring Adventurers."}},"improve-lifestyle":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Improve Lifestyle",description:"Attempt a basic check to draw upon your kingdom’s treasury to enhance the quality of life for your citizens. This activity can be taken only during the Commerce phase of a Kingdom turn",skills:r(["politics"]),criticalSuccess:{msg:"Your push to Improve Lifestyles affords your citizens significant free time to pursue recreational activities. For the remainder of the Kingdom turn, you gain a +2 circumstance bonus to Culture-based checks.",modifiers:()=>[{turns:1,enabled:!0,abilities:["culture"],value:2,name:"Improve Lifestyle: Critical Success",type:"circumstance"}]},success:{msg:"Your push to Improve Lifestyles helps your citizens enjoy life. For the remainder of the Kingdom turn, you gain a +1 circumstance bonus to Culture-based checks.",modifiers:()=>[{turns:1,enabled:!0,abilities:["culture"],value:1,name:"Improve Lifestyle: Success",type:"circumstance"}]},failure:{msg:"Your push to Improve Lifestyles helps your citizens enjoy life. For the remainder of the Kingdom turn, you gain a +1 circumstance bonus to Culture-based checks. In addition, you’ve strained your treasury. Take a –1 circumstance penalty to Economy-based checks for the remainder of this Kingdom turn.",modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:-1,name:"Improve Lifestyle: Failure",type:"circumstance"},{turns:1,enabled:!0,abilities:["culture"],value:1,name:"Improve Lifestyle: Failure",type:"circumstance"}]},criticalFailure:{msg:`Your attempt to Improve Lifestyles backfires horribly as criminal elements in your kingdom abuse your generosity. You take a –1 circumstance penalty to Economy-based checks for the remainder of the Kingdom turn, ${v(1)}, and add 1 to a Ruin of your choice.`,modifiers:()=>[{turns:1,enabled:!0,abilities:["economy"],value:-1,name:"Improve Lifestyle: Critical Failure",type:"circumstance"}]}},infiltration:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Infiltration",description:"You send spies out to gather intelligence on a neighboring nation, a cult or thieves’ guild within your borders, an unclaimed Freehold, or even an unexplored adventure site. Alternately, you can simply send your spies out to investigate the current health of your kingdom. Attempt a basic check.",skills:r(["intrigue"]),criticalSuccess:{msg:`You learn something valuable or helpful. If you were infiltrating a specific target, the GM decides what is learned, but the information is exact and precise. For example, if you were infiltrating an unexplored ruin, you might learn that the site is infested with web lurkers and spider swarms. If you were investigating your kingdom’s health, your spies reveal easy methods to address citizen dissatisfaction, allowing you to choose one of the following: ${b("1d4")} or reduce a Ruin of your choice by 1.`},success:{msg:`You learn something helpful about the target, but the information is vague and imprecise. For example, if you were infiltrating the same ruin mentioned in the critical success above, you might learn that some sort of aberration uses the ruins as its lair. If you were investigating your kingdom’s health, your spies learn enough that you can take action. ${b(1)}`},failure:{msg:"Your spies fail to learn anything of import, but they are not themselves compromised."},criticalFailure:{msg:"You never hear from your spies again, but someone certainly does! You take a –2 circumstance penalty on all kingdom checks until the end of the next Kingdom turn as counter-infiltration from an unknown enemy tampers with your kingdom’s inner workings.",modifiers:()=>[{turns:2,enabled:!0,value:-2,name:"Infiltration: Critical Failure",type:"circumstance"}]}},irrigation:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"region",dc:"control",title:"Irrigation",description:`<p>You send excavators to build waterways, canals, or drainage systems to convey water from areas that have natural access to a river or lake. Spend RP as determined by the hex’s most inhospitable terrain feature:</p>\n<ul>\n<li><b>Mountains</b>: ${y(12)}</li>\n<li><b>Swamps</b>: ${y(8)}</li>\n<li><b>Forests</b>: ${y(4)}</li>\n<li><b>Hills</b>: ${y(2)}</li>\n<li><b>Plains</b>: ${y(1)}</li>\n</ul>\n<p>Then attempt a basic check.</p>`,requirement:"You control a hex adjacent to a river or lake that itself does not contain a river or lake.",skills:r(["engineering"],1),criticalSuccess:{msg:"The hex gains a river or lake terrain feature (or you change the effects of a previous critical failure at Irrigation in this hex into a failure); work with your GM to determine where these features appear in the hex. In addition, your workers were efficient and quick, and you regain half the RP you spent building the waterways."},success:{msg:"The hex gains a river or lake terrain feature (or you change the effects of a previous critical failure at Irrigation in this hex into a failure); work with your GM to determine where these features appear in the hex."},failure:{msg:"You fail to build workable systems or to restore a previous critical failure, and the hex does not gain the river or lake terrain feature."},criticalFailure:{msg:`You fail to build workable systems or to restore a previous critical failure, and the hex does not gain the river or lake terrain feature. Your attempts at Irrigation are so completely useless that they become breeding grounds for disease. ${v(1)}. From this point onward, at the start of your Kingdom turn’s Event phase, attempt a @Check[type:flat|dc:4]. This flat check’s DC increases by 1 for each hex in your kingdom that contains a critically failed attempt at Irrigation. If you fail this flat check, your kingdom suffers a Plague event in addition to any other event it might have. You can attempt this activity again in a later Kingdom turn to undo a critically failed Irrigation attempt.`}},"manage-trade-agreements":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Manage Trade Agreements",description:`You send agents out to attend to established trade agreements. ${y(2,!0)} per Trade Agreement you wish to manage. Then attempt a basic check. If you Managed Trade Agreements on the previous turn, increase this DC by 5.`,skills:r(["trade"]),criticalSuccess:{msg:`${w({value:"1",turn:"next",type:"resource-dice",multiple:!0})} per trade agreement, and 1 Commodity of your choice per trade agreement (no more than half of these Commodities may be Luxuries).`},success:{msg:`${w({value:"1",turn:"next",type:"resource-dice",multiple:!0})} per trade agreement, or 1 Commodity of your choice per trade agreement (no more than half of these Commodities may be Luxuries).`},failure:{msg:`${w({value:"1",turn:"next",type:"resource-points",multiple:!0})} per trade agreement`},criticalFailure:{msg:"You gain no benefit, as your traders and merchants met with bad luck on the road. You can’t Manage Trade Agreements for 1 Kingdom turn."}},"new-leadership":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"upkeep",dc:"control",title:"New Leadership",description:`<p>You announce the promotion of a character into a leadership role, whether they’re a newly appointed leader or just shifting from one leadership role to another. You normally perform this activity at the start of a Kingdom turn, but if unexpected events (such as the death of the character) remove a leader from a leadership role, you may immediately use the New Leadership activity to attempt to assign a new leader to that role, even outside of a Kingdom turn (applying the vacancy penalty for that role as appropriate). Attempt a basic Intrigue, Politics, Statecraft, or Warfare skill check—while any of these skills can be used, each skill is particularly suited to assigning two specific leadership roles.</p>\n<ul>\n<li><b>Intrigue</b>: Grants a +2 circumstance bonus to checks to assign Emissaries and Treasurers.</li>\n<li><b>Politics</b>: Grants a +2 circumstance bonus to checks to assign Counselors and Rulers.</li>\n<li><b>Statecraft</b>: Grants a +2 circumstance bonus to checks to assign Magisters and Viceroys.</li>\n<li><b>Warfare</b>: Grants a +2 circumstance bonus to checks to assign Generals and Wardens.</li>\n</ul>\n\n<p>Rulers are particularly difficult to assign; when you take this activity to assign a new Ruler, you take a –4 circumstance penalty to the skill check, and unless you achieve a critical success, you ${v(1)}. Whether or not you are simultaneously assigning a leader, you may also use this activity to attempt to reselect the four leadership roles that you have invested. Any result other than a critical failure allows this.</p>`,skills:r(["intrigue","politics","statecraft","warfare"]),criticalSuccess:{msg:"The people love the new leader. The leader immediately provides the benefits tied to occupying the new role and gains a +1 circumstance bonus to all Kingdom skill checks they attempt before the end of the next Kingdom turn.",modifiers:()=>[{turns:2,enabled:!1,value:1,name:"New Leadership: Critical Success",type:"circumstance"}]},success:{msg:`The people accept the new leader. The leader immediately provides the benefits tied to occupying the new role. ${v(1)}`},failure:{msg:`The people are unsure about the new leader. The leader takes a –1 circumstance penalty to all checks they attempt as part of their activities during the Activity phase of each Kingdom turn. At the end of the next Kingdom turn, the leader can attempt any Loyalty-based basic skill check to ingratiate themselves with the populace. The leader may attempt this check at the end of each Kingdom turn until they succeed. Success removes this penalty, but a critical failure results in the development detailed in Critical Failure below. ${v(1)}`,modifiers:()=>[{enabled:!1,value:-1,name:"New Leadership: Failure",type:"circumstance"}]},criticalFailure:{msg:`The people reject the new leader. The leadership role is treated as vacant and you must attempt to reassign it using the New Leadership activity at the start of the next Kingdom turn. ${v(1)}`}},"offensive-gambit":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"scouting",title:"Offensive Gambit",description:"You order an attack against an enemy army, causing a war encounter to begin after this Kingdom turn ends. No check is necessary if you wish to engage the enemy without attempting to gain an advantage in initiative. If you want to gain an advantage by surprising the enemy, attempt an Intrigue check. If you want to gain an advantage by intimidating the enemy, attempt a Warfare check. In either case, the DC is equal to the enemy army’s Scouting DC.",requirement:"You have at least one army in the same hex as an enemy army.",skills:r(["intrigue"]),criticalSuccess:{msg:"Your approach surprises or intimidates the enemy. Your armies in this hex gain a +2 circumstance bonus on their initiative checks, and one enemy army of the party’s choice in this hex becomes shaken 1."},success:{msg:"Your approach gives you an advantage. Your armies in this hex gain a +2 circumstance bonus on their initiative checks."},failure:{msg:"You gain no advantage in the battle."},criticalFailure:{msg:"Not only do you fail to gain advantage, but the enemy forces have anticipated the attack. Your armies take -2 circumstance penalty on their initiative checks,"}},"outfit-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Outfit Army",description:"You provide your army with better gear. Choose what sort of gear you wish to provide your army with from the list beginning on page 67. The level of the gear chosen must be equal to or less than the army’s level. If you’re purchasing gear, the level of the gear chosen must be equal to or less than level of items that can be bought in the city thr army is stationing in. If you are crafting gear, the level of the gear chosen must be equal to or less than level of the city the army is stationing in. If you’re distributing resources gained from battle, GM decides what is available. \n\nIf you’re purchasing the gear, this activity requires a basic Trade check and costs the standard amount of RP for the gear; you cannot purchase magic gear unless your kingdom is at least expert rank in Magic. \n\nIf you’re crafting gear, this activity require a basic Engineering check and costs the standard amount of RP for the gear, reduced by 25% on a critical success; you cannot craft magic gear unless your kingdom is at least expert rank in Magic.\n\nIf you’re distributing gear gained from battle, this activity requires a basic Warfare check and does not cost RP.",skills:r(["engineering","trade","warfare"]),criticalSuccess:{msg:"The gear proved particularly easy to outfit, and the army becomes efficient."},success:{msg:"The gear is sufficient, and your army becomes outfitted with it immediately."},failure:{msg:"The gear proves to be unusable and the attempt to outfit the army fails. If you spent RP on the check, it is refunded."},criticalFailure:{msg:"The gear proves to be unusable and the attempt to outfit the army fails. If the gear was distributed from the battle, your army gains Weary condition or increases its value by 1."}},"pledge-of-fealty":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Pledge of Fealty",description:"When your representatives encounter freeholders, refugees, independent groups, or other bands of individuals gathered in the wilderness who aren’t already part of a nation, you can offer them a place in your kingdom, granting them the benefits of protection, security, and prosperity in exchange for their fealty. The benefits granted to your kingdom can vary wildly, but often manifest as one-time boons to your commodities or unique bonuses against certain types of events. The adventure text in this campaign offers numerous examples of groups who could accept a Pledge of Fealty.\n\nYou can attempt this skill check with Intrigue, Statecraft, or Warfare; however, certain groups will respond better (or worse) to specific skills. The DC is the group’s Negotiation DC (see the sidebar on page 519).",skills:r(["intrigue","statecraft","warfare"],1),criticalSuccess:{msg:"The group becomes part of your kingdom, granting the specific boon or advantage listed in that group’s entry. If you haven’t already claimed the hex in which the group dwells, you immediately do so, gain 10XP and increasing your kingdom's Size by 1 (this affects all statistics determined by Size; see page 532). If the hex doesn’t share a border with your kingdom, it becomes a secondary territory and checks involving this location take a Control penalty."},success:{msg:`The group becomes part of your kingdom, granting the specific boon or advantage listed in that group’s entry. If the hex doesn’t share a border with your kingdom, it becomes a secondary territory and checks involving this location take a Control penalty. ${f(1)} to the result to integrate the group into your kingdom.`},failure:{msg:`The group refuses to pledge to you at this time. You can attempt to get them to Pledge Fealty next turn. ${v(1)}`},criticalFailure:{msg:`The group refuses to pledge to you—furthermore, it will never Pledge Fealty to your kingdom, barring significant in-play changes or actions by the PCs (subject to the GM’s approval). The group’s potentially violent rebuff of your offer ${v(2)} and increases a Ruin of your choice by 1.`}},"preventative-measures":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Preventative Measures",description:"You help to organize magical defenses and resources to combat potential upcoming disasters or dangers to the kingdom. Attempt a basic Magic check to determine how effective the magical preparations are.",skills:r(["magic"]),criticalSuccess:{msg:"The next time during this Kingdom turn that you attempt a Kingdom skill check to resolve a dangerous event, you gain a +2 circumstance bonus to the check and, unless you roll a critical failure, the result is improved one degree. If you reach the end of this Kingdom turn and haven’t had a dangerous event, you may decrease one Ruin of your choice by 1.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!1,value:2,name:"Preventative Measures: Critical Success",type:"circumstance"}]},success:{msg:"The next time during this Kingdom turn that you attempt a Kingdom skill check to resolve a dangerous event, you gain a +2 circumstance bonus to the check.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!1,value:2,name:"Preventative Measures: Success",type:"circumstance"}]},criticalFailure:{msg:`The attempt to put preventative measures in place has resulted in significant waste of resources. You can’t use Preventative Measures again on your next Kingdom turn, and ${w({turn:"next",value:"2",type:"resource-dice",mode:"lose"})}`}},"process-hidden-fees":{oncePerRound:!0,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Process Hidden Fees",description:"With your aid, you can process additional taxes, fees, and payments. Attempt a basic Trade check to determine what sorts of additional resources you gather.",skills:r(["trade"]),criticalSuccess:{msg:w({turn:"next",value:"2",type:"resource-dice"})},success:{msg:`${w({turn:"next",value:"1",type:"resource-dice"})}, but the citizens suspect something is going on: if you attempt to Process Hidden Fees on the next Kingdom turn, the result is worsened one degree.`},failure:{msg:`${w({turn:"next",value:"1",type:"resource-dice"})}, but the citizens catch wind of the fees and grow unhappy. ${v(1)}, and you cannot Process Hidden Fees on your next Kingdom turn.`},criticalFailure:{msg:`${w({turn:"next",value:"1",type:"resource-dice"})}, but the citizens catch wind of the fees and grow unhappy. ${v("1d6")}, and you cannot Process Hidden Fees on your next Kingdom turn.`}},prognostication:{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Prognostication",description:"Your kingdom’s spellcasters read the omens and provide advice on how best to prepare for near-future events. Attempt a basic check.",skills:r(["magic"],1),criticalSuccess:{msg:"If you have a random kingdom event this turn, roll twice to determine the event that takes place. The players choose which of the two results occurs, and the kingdom gains a +2 circumstance bonus to the check to resolve the event.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!0,value:2,name:"Prognostication: Critical Success",type:"circumstance"}]},success:{msg:"Gain a +1 circumstance bonus to checks made to resolve random kingdom events this turn.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!0,value:1,name:"Prognostication: Critical Success",type:"circumstance"}]},failure:{msg:"Your spellcasters divine no aid."},criticalFailure:{msg:"Your spellcasters provide inaccurate readings of the future. You automatically have a random kingdom event this turn. Roll twice to determine the event that takes place; the GM decides which of the two results occurs."}},"provide-care":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Provide Care",description:"Attempt a basic check to organize and encourage your settlements’ healers, apothecaries, medics, and other caregivers to provide care and support for citizens in need.",skills:r(["defense"]),criticalSuccess:{msg:`You provide unexpectedly compassionate support for the people. ${b(1)} and reduce one Ruin of your choice by 1.`},success:{msg:`Your care soothes the worries and fears of the populace; ${b(1)}.`},failure:{msg:"You don’t provide any notable care for the citizens, but at least you don’t make things worse."},criticalFailure:{msg:`Your attempt to provide care backfires. ${v(1)} or a Ruin of your choice by 1.`}},"purchase-commodities":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Purchase Commodities",description:`You can spend RP to Purchase Commodities, but doing so is more expensive than gathering them or relying upon trade agreements. When you Purchase Commodities, select the Commodity you wish to purchase (Food, Lumber, Luxuries, Ore, or Stone). ${y(8)} if you’re purchasing Luxuries or ${y(4)} if you’re purchasing any other Commodity. Then attempt a basic check.`,skills:r(["trade"]),criticalSuccess:{msg:`<p>You immediately gain 4 Commodities of the chosen type:</p> <ul>\n<li>${u("food","4")}</li>\n<li>${u("ore","4")}</li>\n<li>${u("lumber","4")}</li>\n<li>${u("stone","4")}</li>\n<li>${u("luxuries","4")}</li>\n</ul><p>and 2 Commodities of any other type (except Luxuries):</p> <ul>\n<li>${u("food","2")}</li>\n<li>${u("ore","2")}</li>\n<li>${u("lumber","2")}</li>\n<li>${u("stone","2")}</li>\n</ul>`},success:{msg:`<p>You gain 2 Commodities of the chosen type.<p> <ul>\n<li>${u("food","2")}</li>\n<li>${u("ore","2")}</li>\n<li>${u("lumber","2")}</li>\n<li>${u("stone","2")}</li>\n<li>${u("luxuries","2")}</li>\n</ul>`},failure:{msg:`<p>You gain 1 Commodity of the chosen type.</p> <ul>\n<li>${u("food","1")}</li>\n<li>${u("ore","1")}</li>\n<li>${u("lumber","1")}</li>\n<li>${u("stone","1")}</li>\n<li>${u("luxuries","1")}</li>\n</ul>`},criticalFailure:{msg:"Failure You gain no Commodities."}},"quell-unrest":{oncePerRound:!0,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Quell Unrest",description:"You send your agents among the citizenry with the charge of suppressing dissent and calming unrest. You can attempt a basic Arts, Folklore, Intrigue, Magic, Politics, or Warfare check to Quell Unrest, but you can never use the same skill for this activity in consecutive Kingdom turns. This activity cannot be attempted more than once per Kingdom turn.",skills:r(["arts","folklore","intrigue","magic","politics","warfare"]),criticalSuccess:{msg:b("1d6")},success:{msg:b(1)},failure:{msg:"You fail to reduce Unrest."},criticalFailure:{msg:`You not only fail to reduce Unrest, but actually incite further anger among the citizenry. Choose one of the following: ${v("1d4")} or increase two Ruins of your choice by 1.`}},"read-all-about-it":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Read All About It",description:"You take advantage of your nation’s paper to print an extra edition, a bonus-sized issue, or something to spread news to the citizens of the nation so that they are more prepared for upcoming events or more informed on how to deal with ongoing events. Attempt a basic Scholarship check to determine how helpful the information proves to be.",requirement:"You have built a Printing Press",skills:r(["scholarship"]),criticalSuccess:{msg:"Your kingdom becomes particularly prepared. The next time you attempt a skill check to resolve any event during this Kingdom turn, you gain a +4 circumstance bonus to the roll.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!0,value:4,name:"Read All About It: Critical Success",type:"circumstance"}]},success:{msg:"The information is helpful, but only against ongoing events. The next time you attempt a skill check to resolve an ongoing event during this Kingdom turn, you gain a +2 circumstance bonus to the roll.",modifiers:()=>[{turns:1,consumeId:"",phases:["event"],enabled:!1,value:2,name:"Read All About It: Success",type:"circumstance"}]},failure:{msg:"You fail to prepare your people for the worst."},criticalFailure:{msg:"Critical parts of the information you published are false. You take a –2 circumstance penalty to all skill checks made to resolve Kingdom events for the remainder of this Kingdom turn",modifiers:()=>[{turns:1,phases:["event"],enabled:!0,value:-2,name:"Read All About It: Critical Failure",type:"circumstance"}]}},"recover-army-damaged":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Recover Army: Damaged",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check.",skills:{defense:0,folklore:2},criticalSuccess:{msg:"You increase its HP by 2 up to its maximum."},success:{msg:"You increase its HP by 1 up to its maximum."},failure:{msg:"You fail to remove the affliction. "},criticalFailure:{msg:`You fail to remove the affliction and your soldier’s lowered morale spreads discontent; ${v(1)}.`}},"recover-army-defeated":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",dcAdjustment:5,title:"Recover Army: Defeated",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check. The DC is increased by 5.",skills:{politics:3,warfare:2},criticalSuccess:{msg:"You increase its HP by 2 up to its maximum and remove the affliction."},success:{msg:"You increase its HP by 1 up to its maximum and remove the affliction."},failure:{msg:"You fail to remove the affliction."},criticalFailure:{msg:`You fail to remove the affliction and your soldier’s lowered morale spreads discontent; ${v(1)}. The army is destroyed.`}},"recover-army-lost":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Recover Army: Lost",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check.",skills:{exploration:0,wilderness:2},criticalSuccess:{msg:"You remove the affliction."},success:{msg:"You remove the affliction."},failure:{msg:"You fail to remove the affliction."},criticalFailure:{msg:`You fail to remove the affliction and your soldier’s lowered morale spreads discontent; ${v(1)}.`}},"recover-army-mired-pinned":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Recover Army: Mired or Pinned",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check.",skills:{engineering:0,magic:2},criticalSuccess:{msg:"You reduce the affliction’s value by 2. If the affliction does not have a value, it is removed."},success:{msg:"As critical success but you reduce the affliction’s value by 1."},failure:{msg:"You fail to remove the affliction."},criticalFailure:{msg:`You fail to remove the affliction and your soldier’s lowered morale spreads discontent; ${v(1)}.`}},"recover-army-shaken":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Recover Army: Shaken",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check.",skills:{arts:0,warfare:2},criticalSuccess:{msg:"You reduce the affliction’s value by 2."},success:{msg:"You reduce the affliction’s value by 1."},failure:{msg:"You fail to remove the affliction."},criticalFailure:{msg:`You fail to remove the affliction and your soldier’s lowered morale spreads discontent; ${v(1)}.`}},"recover-army-weary":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Recover Army: Weary",description:"\n        When an army endures ill fortune, it can become afflicted by negative conditions. You can use the Recover Army activity to work at removing an affliction with a basic skill check.",skills:{defense:0,arts:2},criticalSuccess:{msg:"You reduce the affliction’s value by 2."},success:{msg:"You reduce the affliction’s value by 1."},failure:{msg:"You fail to remove the affliction."},criticalFailure:{msg:`You fail to remove the affliction and your soldier’s lowered morale spreads discontent; ${v(1)}.`}},"recruit-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Recruit Army",description:"Either you recruit an army from your kingdom’s citizens, or you secure the allegiance of a specialized army you encountered. If you’re recruiting an army from your kingdom’s citizens, choose one of the basic armies listed at the start of page 570 and attempt a Warfare check against the army’s Recruitment DC. If you’re securing a specialized army, you must attempt a Statecraft check against the Recruitment DC;",skills:r(["warfare","statecraft"]),criticalSuccess:{msg:"You recruit the army; it becomes efficient."},success:{msg:"You recruit the army."},failure:{msg:"You fail to recruit the army."},criticalFailure:{msg:`Many of the individuals in the army you attempted to recruit took offense at the attempt. ${v(1)}, and you cannot attempt to recruit an army again until the next Kingdom turn.`}},"recruit-monsters":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"region",dc:"control",title:"Recruit Monsters",description:"While you are quick to suggest that most of the monsters the party encounters during their adventures deserve killing, you also understands that there can be exceptions. Some can be bribed or allied with, while others can be trusted to act on their instincts—a canny person can capitalize on these instincts or alliances to bolster a kingdom’s defenses. Attempt a basic Intrigue check.",skills:r(["intrigue"]),criticalSuccess:{msg:"You manage to locate a monster’s lair and take steps to incorporate it into your kingdom’s defense. The next time your kingdom suffers a Bandit Activity, Monster Activity, Sacrifices, or Undead Uprising random event, you can use your recruited monster to help resolve the event. Doing so removes the Recruited Monster from your kingdom (you can attempt to recruit a new monster on a future kingdom turn though) but allows you to roll a skill check twice when resolving the Dangerous Hex event, taking the better of the two results as your actual result. This is a fortune effect.\n\nYour kingdom can support 1 Recruited Monster at a time. If your kingdom is master in Intrigue, you can support up to 2 Recruited Monsters at a time, and if your kingdom is legendary in Intrigue, you can support up to 3 Recruited Monsters at a time."},success:{msg:"You locate a monster’s lair but can’t recruit it into your kingdom’s defense just yet. If you attempt this activity on your next kingdom turn; the result of that check is improved one degree as you continue to build a rapport with the monster."},failure:{msg:"You fail to locate a monster, or if you were recruiting a monster you didn’t succeed at recruiting on the previous turn, that monster moves on and you must start the recruitment procedure from scratch in the future."},criticalFailure:{msg:"You found a monster, but it proves impossible to recruit. Worse, you’ve attracted its attention. A Monster Activity event occurs during the kingdom’s next Event Phase, in addition to any other potential random events."}},"relocate-capital":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Relocate Capital",description:"One of your settlements that is not your current capital must contain a Castle, Palace, or Town Hall. All leaders must spend all of their leadership activities during the Activity phase of a Kingdom turn on this activity. The kingdom leaders announce that they are uprooting the seat of government from its current home and reestablishing it in another settlement. Attempt a check with a DC equal to the kingdom’s Control DC + 5. You cannot Relocate your Capital again for at least 3 Kingdom turns.",skills:r(["industry"],1),criticalSuccess:{msg:"The move goes off splendidly, with people excited about the new capital and celebrating the leadership’s wisdom."},success:{msg:`The move goes smoothly and with minimal disruption, but some folks are upset or homesick. ${v(1)}`},failure:{msg:`The move causes unhappiness. ${v(1)} and increase two Ruins of your choice by 1.`},criticalFailure:{msg:`The people reject the idea of the new capital and demand you move it back. The move is unsuccessful, and your capital remains unchanged. ${v("1d4")}. Increase three Ruins of your choice by 1 and the fourth Ruin by 3.`}},"repair-reputation-corruption":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Corruption",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["arts"],1),criticalSuccess:{msg:`${h("corruption",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("corruption",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-reputation-crime":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Crime",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["trade"],1),criticalSuccess:{msg:`${h("crime",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("crime",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-reputation-decay":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Decay",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["engineering"],1),criticalSuccess:{msg:`${h("decay",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("decay",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-reputation-strife":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",dcAdjustment:2,title:"Repair Reputation Strife",description:"When things have gotten out of hand in the kingdom and the nation’s reputation has become damaged, you can focus efforts on a campaign to reassure the citizens and bring them closer together, stamp down crime, organize repairs and maintenance of public structures, or strive to adjust poor public opinions.\n\nThe skill used to Repair Reputation depends on which Ruin total you wish to reduce. If you wish to reduce your Corruption, you attempt an Arts check. If you wish to reduce your Crime, you attempt a Trade check. If you wish to reduce your Decay, you attempt an Engineering check. If you wish to reduce your Strife, you attempt an Intrigue check. In all cases, the DC is your Control DC + 2.",skills:r(["intrigue"],1),criticalSuccess:{msg:`${h("strife",2)} and reduce its current ruin penalty by 1 to a minimum of 0.`},success:{msg:h("strife",1)},failure:{msg:"You fail to reduce the targeted Ruin. You cannot attempt to Repair Reputation on this Ruin for 1 Kingdom turn."},criticalFailure:{msg:`You fail to reduce the targeted Ruin in a particularly public and embarrassing way. ${v("1d4")}, and you cannot attempt to Repair Reputation for 3 Kingdom turns.`}},"repair-the-flooded-mine":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:32,title:"Repair the Flooded Mine",description:`A group of engineers work to drain the flooded mine, shore up its damaged section, and establish the mine as a functional Work Site. ${y(20)}, then attempt a DC 32 Engineering check.`,skills:r(["engineering"],3),criticalSuccess:{msg:"The mine is repaired, and as a bonus, your workers Establish a Work Site at the mine immediately. This mine produces 2 Ore Commodities per Kingdom turn."},success:{msg:"The mine is repaired. This mine produces 2 Ore Commodities per Kingdom turn."},failure:{msg:"Work on repairing the mine proceeds, but at a much slower (and more expensive) pace than you’d hoped. The mine remains flooded, but you can attempt this check again on the next Kingdom turn."},criticalFailure:{msg:`Work on repairing the mine proceeds, but at a much slower (and more expensive) pace than you’d hoped. The mine remains flooded, but you can attempt this check again on the next Kingdom turn. In addition, a catastrophic failure costs the lives of several workers. ${v(2)} and ${m("decay",1)}. The next time you attempt to Repair the Flooded Mine, it costs 40 RP.`}},"request-foreign-aid":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"custom",title:"Request Foreign Aid",description:"When disaster strikes, you send out a call for help to another nation with whom you have diplomatic relations. The DC of this check is equal to the other group’s Negotiation DC +2 (see the sidebar on page 519).",requirement:"You have diplomatic relations with the group you are requesting aid from.",skills:r(["statecraft"],1),criticalSuccess:{msg:`Your ally’s aid grants a +4 circumstance bonus to any one Kingdom skill check attempted during the remainder of this Kingdom turn. You can choose to apply this bonus to any Kingdom skill check after the die is rolled, but must do so before the result is known. In addition, ${p(2)}; this RP does not accrue into XP at the end of the turn if you don’t spend it.`,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:4,name:"Request Foreign Aid: Critical Success",type:"circumstance"}]},success:{msg:`Your ally’s aid grants you either a +2 circumstance bonus to any one Kingdom skill check attempted during the remainder of this Kingdom turn or ${p(1)}. This RP does not accrue into XP at the end of the turn if you don’t spend it. You can choose to apply the bonus to any Kingdom skill check after the die is rolled, but must do so before the result is known.`,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:2,name:"Request Foreign Aid: Success",type:"circumstance"}]},failure:{msg:`Your ally marshals its resources but cannot get aid to you in time to deal with your current situation. ${w({turn:"next",value:"1d4",type:"resource-points"})}`},criticalFailure:{msg:`Your ally is tangled up in its own problems and is unable to assist you, is insulted by your request for aid, or might even have an interest in seeing your kingdom struggle against one of your ongoing events. Whatever the case, your pleas for aid make your kingdom look desperate. You gain no aid, but you do ${v("1d4")}.`}},"request-foreign-aid-vk":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Request Foreign Aid (V&K, HB)",description:"When disaster strikes, you send out a call for help to another nation with whom you have diplomatic relations. The DC of this check starts at the other group’s Negotiation DC +2, but every subsequent Kingdom turn you Request Foreign Aid from the same group, the DC increases by 2. Every Kingdom turn that passes without Requesting Foreign Aid from that Group reduces the DC by 1 (until you reach the other group’s Negotiation DC +2). You may only attempt to request Foreign Aid with a given group once per Kingdom turn regardless of the number of leaders pursuing activities.<br/>Using Request Foreign Aid too often may result in worsening diplomacy relations with multiple groups or result in other special negative effects at GM's discretion.",requirement:"You have diplomatic relations with the group you are requesting aid from.",skills:r(["statecraft"],1),criticalSuccess:{msg:`Your ally’s aid grants a +4 circumstance bonus to any one Kingdom skill check attempted during the remainder of this Kingdom turn and ${p(1)}, or ${p(3)}; this RP does not accrue into XP at the end of the turn if you don’t spend it.`,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:4,name:"Request Foreign Aid: Critical Success",type:"circumstance"}]},success:{msg:`Your ally’s aid grants you either a +2 circumstance bonus to any one Kingdom skill check attempted during the remainder of this Kingdom turn or ${p(1)}. This RP does not accrue into XP at the end of the turn if you don’t spend it.`,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:2,name:"Request Foreign Aid: Success",type:"circumstance"}]},failure:{msg:`Your ally marshals its resources but cannot get aid to you in time to deal with your current situation. ${w({turn:"next",value:"1d4",type:"resource-points"})}`},criticalFailure:{msg:`Your ally is tangled up in its own problems and is unable to assist you, is insulted by your request for aid, or might even have an interest in seeing your kingdom struggle against one of your ongoing events. Whatever the case, your pleas for aid make your kingdom look desperate. You gain no aid, but you do ${v("1d4")}.`}},"rest-and-relax":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Rest and Relax",description:"Working non-stop can burn out even the most devoted and dedicated individual. As such, it’s important to take time for yourself, and thus set a good example for the nation.\n\nYou take time to relax, and you extend the chance to unwind to your citizens as well. The Kingdom skill you use to determine the effectiveness of your time off depends on how you want to spend it: Use a basic Arts check to spend the time engaged in entertainment or the pursuit of a hobby. Use a basic Boating check to enjoy trips on the lakes and rivers of your kingdom. Use a basic Scholarship check to spend the time reading or studying a topic of personal interest beyond your daily duties. Use a basic Trade check to spend your time shopping or feasting. Use a basic Wilderness check to get away from the bustle and relax in the countryside. If your kingdom Rested and Relaxed the previous Kingdom turn, the DC increases by 4, as your kingdom’s production and output hasn’t had a chance to catch up to all those vacation days.",skills:r(["arts","boating","scholarship","trade","wilderness"]),criticalSuccess:{msg:"The citizens enjoy the time off and are ready to get back to work. "+b(1)+", and the next Leadership activity you take gains a +2 circumstance bonus.",modifiers:()=>[{turns:1,consumeId:"",phases:["leadership"],enabled:!0,value:2,name:"Rest and Relax: Success",type:"circumstance"}]},success:{msg:`The time spent relaxing has calmed nerves; ${b(1)}.`},failure:{msg:"The rest is welcome, but not particularly beneficial in the long term."},criticalFailure:{msg:"The time is wasted, and when you get back to work, you have to spend extra time catching up. Take a –2 circumstance penalty to your next skill check made as a Leadership activity.",modifiers:()=>[{turns:1,consumeId:"",phases:["leadership"],enabled:!0,value:-2,name:"Rest and Relax: Critical Failure",type:"circumstance"}]}},"restore-the-temple":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:25,title:"Restore the Temple of the Elk",description:`You work with several worshippers of the temple's faith, gifted masons, and skilled laborers to restore the temple and once more consecrate it as a sacred place devoted to the worship of their god. ${y("1d6")}, then attempt a DC 25 Folklore check.`,skills:r(["folklore"]),criticalSuccess:{msg:"The temple is restored and can now serve as a Refuge terrain feature. If you later build a settlement here, the temple instead functions as a free Shrine in the settlement. In addition, your work was so excellent that you’ve attracted their god’s attention! The PC who rolled the Folklore check is granted @UUID[Compendium.pf2e.boons-and-curses.Item.hrTl9kfSNrOQeNze]: whenever that PC critically fails a check to Subsist in the wild, they gain a failure instead."},success:{msg:"The temple is restored and can now serve as a Refuge terrain feature. If you later build a settlement here, the temple instead functions as a free Shrine in the settlement."},failure:{msg:"Work proceeds but is not yet complete; you can attempt to restore the temple again on the next Kingdom turn."},criticalFailure:{msg:`Disaster strikes as the temple’s cavern collapses and rubble spills out to bury and destroy much of the temple’s plaza. ${m("decay",1)} and ${v("1d4")}. You can still attempt to Restore the Temple, but the DC for success increases by 4. This increase is cumulative with successive critical failures.`}},"send-diplomatic-envoy":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Send Diplomatic Envoy",description:"You send emissaries to another group to foster positive relations and communication. The DC of this check is the group’s Negotiation DC (see the sidebar on page 519). Attempts to Send a Diplomatic Envoy to a nation with which your kingdom is at war take a –4 circumstance penalty to the check and have the result worsened one degree. At the GM’s option, some wars might be so heated that this activity has no chance of success.",skills:r(["statecraft"],1),criticalSuccess:{msg:"Your envoys are received quite warmly and make a good first impression. You establish diplomatic relations with the group (see page 534 for more information) and gain a +2 circumstance bonus to all checks made with that group until the next Kingdom turn.",modifiers:()=>[{turns:1,enabled:!1,value:2,name:"Send Diplomatic Envoy: Critical Success",type:"circumstance"}]},success:{msg:"You establish diplomatic relations."},failure:{msg:"Your envoys are received, but the target organization isn’t ready to engage in diplomatic relations. If you attempt to Send a Diplomatic Envoy to the group next Kingdom turn, you gain a +2 circumstance bonus to that check.",modifiers:()=>[{turns:2,enabled:!1,value:2,activities:["send-diplomatic-envoy"],name:"Send Diplomatic Envoy: Success",type:"circumstance"}]},criticalFailure:{msg:`Disaster! Your envoy fails to reach their destination, is turned back at the border, or is taken prisoner or executed, at the GM’s discretion. The repercussions on your kingdom’s morale and reputation are significant. Choose one of the following results: ${v("1d4")}, add 1 to a Ruin of your choice, or ${f(2)}. In any event, you cannot attempt to Send a Diplomatic Envoy to this same target for the next 3 Kingdom Turns.`}},"show-of-force":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Show of Force",description:"Using your advice, a public show of force is performed in an attempt to curtail criminal activity or subversive activity in the kingdom. Attempt a basic Warfare check to determine how effective the Show of Force is.",skills:r(["warfare"]),criticalSuccess:{msg:`The kingdom’s criminals are cowed by the show of force. ${h("crime",2)} and reduce one other Ruin of your choice by 1.`},success:{msg:`The kingdom’s criminals take note of the show of force. ${h("crime",1)}`},failure:{msg:`The show of force fails to impress criminals but unsettles the rest of the citizens. ${v(1)}.`},criticalFailure:{msg:`The criminals are emboldened by the failed show of force. ${v("1d4")} and ${m("crime",1)}.`}},"spread-the-legend":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Spread the Legend",description:"You work to spread the word of the party’s heroics and achievements, both through word of mouth and by distributing chapbooks or one-sheets detailing their exploits. Attempt a basic Arts check to determine the success of your efforts. If you have secured a printing press for the kingdom, the Arts check gains a +2 item bonus.",skills:r(["arts"]),criticalSuccess:{msg:`Not only do your stories bring pride and patriotism to the nation, but they also help increase its glory. ${b("1d6")}, and ${w({type:"fame",turn:"next",value:"1"})}. In addition, if the kingdom experiences a dangerous random event during this turn’s Event Phase, reduce that event’s level modifier by 1.`},success:{msg:`The rousing and inspiring stories you spread about the PCs helps to bring the nation together. ${b("1d6")}`},failure:{msg:`You avoid spreading unfortunate news, but only just barely. The citizens are only slightly entertained by their leaders’ exploits. ${b(1)}.`},criticalFailure:{msg:`You accidentally spreads news of a humiliating or embarrassing nature, causing the people of the kingdom to lose respect for their leaders. ${v("1d4")}.`}},"supernatural-solution":{enabled:!0,phase:"leadership",dc:"control",title:"Supernatural Solution",description:"Your spellcasters try to resolve issues when mundane solutions just aren’t enough. Attempt a basic check.<br/><br/><b>Supernatural Solution:</b><p>You can decide to use Supernatural Solution before attemptin a Kingdom skil check. Attempt the Magic check against the same DC but without any item bonuses unless original roll could be made with Magic, and take whichever of the two results you prefer. This is a fortune effect. If you don’t use your Supernatural Solution by the end of this Kingdom turn, this benefit ends and you gain 10XP instead.</p>",oncePerRound:!1,fortune:!0,skills:r(["magic"]),criticalSuccess:{msg:`You can call upon your spellcasters’ supernatural solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("supernatural-solution")}.`},success:{msg:`You can call upon your spellcasters’ supernatural solution to aid in resolving any Kingdom skill check made during the remainder of this Kingdom turn ${k("supernatural-solution")}. However, you ${f(1)} to research the solution. This cost is paid now, whether or not you use your supernatural solution.`},failure:{msg:`Your attempt at researching a supernatural solution costs additional RP to research, but is ultimately a failure, providing no advantage. ${f(2)}`},criticalFailure:{msg:`Your attempt at researching a supernatural solution costs additional RP to research, but is ultimately a failure, providing no advantage. ${f(2)}. In addition, your spellcasters’ resources and morale are impacted such that you cannot attempt a Supernatural Solution again for 2 Kingdom turns.`},special:"You cannot influence a check with Supernatural Solution and Creative Solution simultaneously."},"supplementary-hunting":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"region",dc:"control",title:"Supplementary Hunting",description:"Following your advice, rural-dwelling citizens work to supplement stores of food and resources through hunting and trapping. Attempt a basic Wilderness check to gather excess livestock from the local wildlife, ranches, and farms to generate food commodities.",skills:r(["wilderness"]),criticalSuccess:{msg:`${u("food","1d4")}, ${u("luxuries",1)}, and ${w({type:"resource-dice",turn:"next",value:"1"})}`},success:{msg:`Choose one: ${u("food","1d4")}, ${u("luxuries",1)}, or ${w({type:"resource-dice",turn:"next",value:"1"})}`},failure:{msg:"Your hunters and trappers fail to supplement your stores and must spend time resupplying and setting new traps; you cannot attempt Supplementary Hunting on the next Kingdom turn."},criticalFailure:{msg:`Your hunters and trappers fail to supplement your stores and must spend time resupplying and setting new traps; you cannot attempt Supplementary Hunting on the next Kingdom turn. In addition, your hunters and trappers have accidentally attracted the attention of dangerous wildlife. Either ${v("1d4")} or increase a Ruin of your choice by 1.`}},"tap-treasury":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Tap Treasury",description:"You tap into the cash reserves of your kingdom for the PCs’ personal use or to provide emergency funding for an event. This is a basic check, but after you succeed or critically succeed at this activity, all future attempts to Tap Treasury have their results worsened two degrees. This penalty persists until funds equal to those taken from the treasury are repaid via Capital Investment",skills:r(["statecraft"]),criticalSuccess:{msg:"You withdraw funds equal to the Currency per Additional PC column on Table 10–9: Party Treasure By Level @UUID[Compendium.pf2e.journals.S55aqwWIzpQRFhcq.JournalEntryPage.Ly8l2GT6dbvuY3A2]{Treasure}, or you successfully fund the unexpected event that required you to Tap your Treasury."},success:{msg:"You withdraw funds equal to the Currency per Additional PC column on Table 10–9: Party Treasure By Level @UUID[Compendium.pf2e.journals.S55aqwWIzpQRFhcq.JournalEntryPage.Ly8l2GT6dbvuY3A2]{Treasure}, or you successfully fund the unexpected event that required you to Tap your Treasury. In addition, you overdraw your treasury in the attempt. You take a –1 circumstance penalty to all Economy-based checks until the end of your next Kingdom turn.",modifiers:()=>[{value:-1,name:"Tap Treasury: Success",abilities:["economy"],turns:2,enabled:!0,type:"circumstance"}]},failure:{msg:"You fail to secure the funds you need, and rumors about the kingdom’s potential shortfall of cash cause you to take a –1 circumstance penalty to all Loyalty- and Economy-based checks until the end of your next Kingdom turn.",modifiers:()=>[{value:-1,name:"Tap Treasury: Success",abilities:["economy","loyalty"],turns:2,enabled:!0,type:"circumstance"}]},criticalFailure:{msg:`You fail to secure the funds you need, and rumors about the kingdom’s potential shortfall of cash cause you to take a –1 circumstance penalty to all Loyalty- and Economy-based checks until the end of your next Kingdom turn. In addition, rumors spiral out of control. ${v(1)} and add 1 to a Ruin of your choice.`,modifiers:()=>[{value:-1,name:"Tap Treasury: Success",abilities:["economy","loyalty"],turns:2,enabled:!0,type:"circumstance"}]}},"trade-commodities":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"commerce",dc:"control",title:"Trade Commodities",description:"There are five different categories of Commodities: Food, Lumber, Luxuries, Ore, and Stone. When you Trade Commodities, select one Commodity that your kingdom currently stockpiles and reduce that Commodity’s stockpile by up to 4. Then attempt a basic check. If you trade with a group that you’ve established diplomatic relations with, you gain a +1 circumstance bonus to the check.",skills:r(["industry"]),criticalSuccess:{msg:`${w({type:"resource-dice",turn:"next",value:"2",multiple:!0})} per point of stockpile expended from your Commodity now.`},success:{msg:`${w({type:"resource-dice",turn:"next",value:"1",multiple:!0})} per point of stockpile expended from your Commodity now.`},failure:{msg:w({type:"resource-dice",turn:"next",value:"1"})},criticalFailure:{msg:`You gain no bonus Resource Dice (though the Commodity remains depleted). If you Traded Commodities the previous turn, ${v(1)}`}},"train-army":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"army",dc:"control",title:"Train Army",description:"You train an army in the use of a tactic. Choose one of the tactics from those listed starting on page 68, then attempt a Scholarship or Warfare check against the tactic’s Training DC. If your army has already learned its maximum number of tactics, the newly learned tactic replaces a previously learned tactic of your choice. ",skills:r(["scholarship","warfare"]),criticalSuccess:{msg:"The army learns the tactic and then becomes efficient. If the army is below the level of your kingdom, its level is increased by 1."},success:{msg:"The army learns the tactic. If the army is below the level of your kingdom, its level is increased by 1."},failure:{msg:"The army fails to learn the tactic."},criticalFailure:{msg:"The army not only fails to learn the tactic but becomes frustrated and exhausted from the training; increase the army’s weary condition by 1."}},"warfare-exercises":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Warfare Exercises",description:"You spend time studying the nation’s armies, speaking with its commanders, researching historical records of battles, and running simulations in war rooms to help predict the best ways to prepare for upcoming conflicts. Attempt a basic Warfare check to determine the success of these exercises.",skills:r(["warfare"]),criticalSuccess:{msg:"The exercises reveal a wide range of suggestions for the PCs to use during that month’s military exercises. All Army activities taken during this Kingdom turn’s Activity Phase gain a +1 circumstance bonus. This bonus increases to +2 at Kingdom level 9 and +3 at Kingdom level 15. In addition, the next time this Kingdom turn that you roll a critical failure on an Army activity, the result is improved to a regular failure instead.",modifiers:e=>[{turns:1,consumeId:"",enabled:!0,phases:["army"],value:e.level<9?1:e.level<15?2:3,name:"Warfare Exercises: Critical Success",type:"circumstance"}]},success:{msg:"The exercises grant a +1 circumstance bonus to your first Army activity taken during the Kingdom turn’s Activity Phase. This bonus increases to +2 at Kingdom level 9 and +3 at Kingdom level 15.",modifiers:e=>[{turns:1,consumeId:"",enabled:!0,phases:["army"],value:e.level<9?1:e.level<15?2:3,name:"Warfare Exercises: Critical Success",type:"circumstance"}]},failure:{msg:"The warfare exercises provide no insight this turn."},criticalFailure:{msg:"You accidentally form incorrect assumptions about your military tactics. The next time you roll a failure on an Army activity this Kingdom turn, it becomes a critical failure instead."}},"reconnoiter-hex":{oncePerRound:!1,fortune:!1,enabled:!1,phase:"leadership",dc:"control",title:"Reconnoiter Hex (V&K)",description:`You send a team to spend time surveying and exploring a specific hex, getting the lay of the land and looking for unusual features and specific sites. ${y(1)} and then attempt a Basic check.`,skills:r(["wilderness"]),criticalSuccess:{msg:"Your team successfully explores the hex and it is now Reconnoitered for the purpose of Claim Hex. Your team automatically finds one Special or Hidden feature if the hex contains one. If the hex contains multiple Special or Hidden Features the GM chooses one. If the hex contains an Encounter or Hazard, the team avoids it and reports back useful and detailed information on it. In addition, your team's reconnaissance of the hex goes so smoothly you may immediately attempt an additional Reconnoiter Hex activity on an adjacent hex. Treat a Critical Success on this additional check as a Success instead."},success:{msg:"Your team successfully explores the hex and it is now Reconnoitered for the purpose of Claim Hex. If the hex contains a Special feature your team may find it if your GM wishes. If the hex contains an Encounter or Hazard, the team avoids it and reports basic information on it."},failure:{msg:"Your team fails to explore the hex sufficiently. If the hex contains an Encounter or Hazard, the team escapes it and reports basic information on it."},criticalFailure:{msg:"Your team fails to explore the hex sufficiently and a number of the team are lost, causing you to take a -1 circumstance penalty to Loyalty-based checks until the end of your next Kingdom turn. If the hex contains an Encounter or Hazard, the team members were lost to it and the survivors can report back basic information on it.",modifiers:()=>[{turns:2,enabled:!0,abilities:["loyalty"],value:-1,name:"Reconnoiter Hex: Critical Failure",type:"circumstance"}]}},"take-charge":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Take Charge (V&K, HB)",description:"You spend some time getting directly involved in helping your kingdom. Choose a skill that your Kingdom is at least Trained in, then attempt a basic check. You can never use the same skill for this activity twice in the same Kingdom turn.",skills:r([...s.allSkills],1),criticalSuccess:{msg:`${g(1)}. In addition you get a +1 Circumstance Bonus to the next Check you make this turn with the chosen skill. `,modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:1,name:"Take Charge: Critical Success",type:"circumstance"}]},success:{msg:g(1)},failure:{msg:"You fail to generate RP."},criticalFailure:{msg:"You take a -1 Circumstance Penalty to the next Check you make this turn with the chosen skill.",modifiers:()=>[{turns:1,consumeId:"",enabled:!1,value:-1,name:"Take Charge: Critical Failure",type:"circumstance"}]}},"cleanse-item":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"custom",title:"Cleanse Item (HB)",description:"You can remove curses from an item using a successful Magic counteract check. Your counteract level is your (kingdom level / 2) rounded up and the DC is an incredibly hard (+10) DC based on the item's level. In addition, you need to pay luxuries and have access to specific structures to prepare the ritual based on the item's level: <br/>1-5: 1 Luxury, Shrine; <br/>6-10: 2 Luxuries, Temple; <br/>11-15: 4 Luxuries, Temple; <br/>16-20: 8 Luxuries, Cathedral.",skills:r(["magic"],1),criticalSuccess:{msg:"If the (item level / 2) is no more than your (counteract level + 3), the item is cleansed."},success:{msg:"If the (item level / 2) is no more than your (counteract level + 1), the item is cleansed."},failure:{msg:"If the (item level / 2) is no more than your (counteract level - 1), the item is cleansed."},criticalFailure:{msg:"You couldn't cleanse the item."}},"naval-support":{oncePerRound:!1,fortune:!1,enabled:!0,phase:"leadership",dc:"control",title:"Naval Support (HB)",description:"You use your fleet to ship materials or transport skilled builders and specialists to where they are needed most, to gain additional Region Activities this turn.",skills:r(["boating"]),criticalSuccess:{msg:"You gain 2 additional Region Activities."},success:{msg:"You gain 1 additional Region Activity."},failure:{msg:`You gain 1 additional region activity by investing additional funds. ${y("2d6")}.`},criticalFailure:{msg:`You do not gain any region activities and ${y("2d6")}.`}},"insider-trading":{oncePerRound:!1,fortune:!1,enabled:!0,requiredFeat:"Insider Trading",phase:"leadership",dc:"control",title:"Insider Trading (Feat, HB)",description:"You facilitate the collaboration of business leaders behind the scenes to arbitrarily manipulate supply and demand for certain goods within your kingdom and surrounding lands. Attempt an Industry control check.",skills:r(["industry"],1),criticalSuccess:{msg:`You gain a +1 circumstance bonus to Establish Work Site, Establish Trade Agreement, and Trade Commodities for the remainder of the kingdom turn. This bonus increases to +2 if the kingdom is master in Industry, or +4 if it is legendary. ${w({value:"1",turn:"next",type:"resource-dice"})} due to your excellent control over supply and demand.`,modifiers:e=>[{name:"Insider Trading",turns:1,type:"circumstance",activities:["establish-work-site-quarry","establish-work-site-lumber","establish-work-site-mine","establish-trade-agreement","trade-commodities"],enabled:!0,value:4==e.skillRanks.industry?4:3==e.skillRanks.industry?2:1}]},success:{msg:"You gain a +1 circumstance bonus to Establish Work Site, Establish Trade Agreement, and Trade Commodities for the remainder of the kingdom turn. This bonus increases to +2 if the kingdom is master in Industry, or +4 if it is legendary.",modifiers:e=>[{name:"Insider Trading",turns:1,type:"circumstance",activities:["establish-work-site-quarry","establish-work-site-lumber","establish-work-site-mine","establish-trade-agreement","trade-commodities"],enabled:!0,value:4==e.skillRanks.industry?4:3==e.skillRanks.industry?2:1}]},failure:{msg:"You fail manipulating supply and demand."},criticalFailure:{msg:`Your attempts to manipulate the market are noticed and taken as bad faith dealing. ${v(1)} and take a –2 circumstance penalty to the activities listed for the success effect for the remainder of the turn.`,modifiers:()=>[{name:"Insider Trading (Critical Failure)",turns:1,type:"circumstance",activities:["establish-work-site-quarry","establish-work-site-lumber","establish-work-site-mine","establish-trade-agreement","trade-commodities"],enabled:!0,value:-2}]}},"channel-locks":{oncePerRound:!1,fortune:!1,enabled:!0,requiredFeat:"Channel Locks",phase:"region",dc:"control",title:"Channel Locks (Feat, HB)",description:`Your people are skilled in modifying or coping with difficult terrain features, such as using channel locks for steep elevation changes or rocky rapids. \n<br/>    \nChoose a nonnavigable river within your kingdom, then ${y(2)} and attempt an Engineering control check. \n<br/>\nYou have a +1circumstance bonus to this check; if the kingdom is at least master in Boating, this bonus increases to +2, or to +3 if it is legendary in Boating.`,skills:r(["engineering"],1),criticalSuccess:{msg:`The target river becomes navigable, and your efficiency allows you to regain some resources. ${g(1)}`},success:{msg:"The target river becomes navigable."},failure:{msg:"The river remains non-navigable; however, your next attempt to Channel Locks made in this hex does not cost any RP."},criticalFailure:{msg:"The river remains non-navigable and the spent RP is lost."}},"smuggler-network":{oncePerRound:!1,fortune:!1,enabled:!0,requiredFeat:"Smuggler Network",phase:"leadership",dc:"control",title:"Smuggler Network (Feat, HB)",description:`<b>Requirements</b> You have at least one trade agreement.<br/>\n        Covert agents within your kingdom use established trade\nroutes to mask the smuggling and sale of illicit goods.\nChoose a group with which you have a trade agreement\nand ${y(1)}, then attempt an Intrigue control check.\nRegardless of the result, the target becomes immune to\nfurther Smuggler Network attempts until the start of the\nnext kingdom turn.<br/>\n<b>Special</b> If targeting a group of higher level than your\nkingdom, reduce your degree of success by one step. If\nyou attempt to target the same group on subsequent turns,\nthe DC increases by 1 for each subsequent attempt; the\nDC returns to normal after a turn passes without using\nthis activity on the target.`,skills:r(["intrigue"],1),criticalSuccess:{msg:`${w({value:"1",turn:"next",type:"resource-dice",multiple:!1})} and 1 Commodity of your choice next turn (choose now).`},success:{msg:`${w({value:"1",turn:"next",type:"resource-dice",multiple:!1})} or 1 Commodity of your choice next turn (choose now)`},failure:{msg:"Your smugglers weren't able to gain you any goods."},criticalFailure:{msg:`Your smugglers are caught and never\nreturn! ${v("1d6")}, then attempt a @Check[flat|dc:11|showDc:all]; on a failure, the target ends its trade agreement\nwith you, and ends its diplomatic relations as well on a\ncritical failure.`}}};function l(e){return w({value:`${e}`,type:"fame"})}function c(e){return w({value:`${e}`,type:"fame",mode:"lose"})}function u(e,t){return w({value:`${t}`,type:e})}function d(e,t){return w({value:`${t}`,type:e,mode:"lose"})}function m(e,t){return w({value:`${t}`,type:e})}function h(e,t){return w({value:`${t}`,type:e,mode:"lose"})}function p(e){return w({value:`${e}`,type:"rolled-resource-dice"})}function f(e){return w({value:`${e}`,type:"rolled-resource-dice",mode:"lose"})}function g(e){return w({value:`${e}`,type:"resource-points"})}function y(e,t=!1){return w({value:`${e}`,type:"resource-points",mode:"lose",multiple:t})}function v(e){return w({value:`${e}`,type:"unrest"})}function b(e){return w({value:`${e}`,type:"unrest",mode:"lose"})}function k(e){return w({value:"1",type:e,mode:"gain"})}function w({turn:e="now",value:t,mode:i="gain",type:s,hints:a,multiple:r=!1}){const o="now"===e?"":" Next Turn";return`<button type="button" class="km-gain-lose" \n        data-type="${s}"\n        data-mode="${i}"\n        data-turn="${e}"\n        data-multiple="${r}"\n        ${void 0!==t?`data-value="${t}"`:""}\n        >${`${"gain"===i?"Gain":"Lose"} ${t} ${(0,n.unslugify)(s)}${o}`}${void 0!==a?`(${a})`:""}</button>`}function S(e){const t=new Set(e.map((e=>e.id)));return Array.from(Object.entries(o)).filter((([e])=>!t.has(e))).map((([e,t])=>({id:e,...t}))).concat(e)}t.gainXp=function(e){return w({value:`${e}`,type:"xp"})},t.gainFame=l,t.loseFame=c,t.gainCommodities=u,t.loseCommodities=d,t.gainRuin=m,t.loseRuin=h,t.gainRolledRD=p,t.loseRolledRD=f,t.gainRP=g,t.loseRP=y,t.gainUnrest=v,t.loseUnrest=b,t.gainSolution=k,t.createResourceButton=w,t.getKingdomActivitiesById=function(e){return Object.fromEntries(S(e).map((e=>[e.id,e])))},t.getKingdomActivities=S},554:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allFeatsByName=t.allFeats=void 0;const s=i(6185),a=i(6893);function n(e){return a.allSkills.map((t=>({...e,name:`${e.name} (${(0,s.capitalize)(t)})`})))}t.allFeats=[{name:"-",level:0,category:"general",text:""},{name:"Insider Trading",level:1,category:"industry",prerequisites:"Trained in Industry",text:"You facilitate the collaboration of business leaders behind the scenes to arbitrarily manipulate supply and demand for certain goods within your kingdom and surrounding lands. \n        As a Leadership activity, attempt an Industry control check. On a success, you gain +1 circumstance bonus to Establish Work Site, Establish Trade Agreement, and Trade Commodities for the remainder of the kingdom turn.\n        If the kingdom is master in Industry, the bonus increases to +2, or to +4 if it is legendary. \n        On a critical success, you additionally gain a bonus Resource Die on your next kingdom turn. \n        On a critical failure gain 1 Unrest and take a –2 circumstance penalty to those activities for the success effect for the remainder of the turn."},{name:"Smuggler Network",level:1,category:"intrigue",prerequisites:"Trained in Intrigue",text:"You try to use established trade rotues to mask the smuggling and sale of illicit goods. \n        As a Leadership activity, choose a group you have a trade agreement with, spend 1 RP and attempt an Intrigue control check. You cannot choose the same group twice during the same turn.\n        On a success, at the start of your next kingdom turn, you gain either 1 bonus Resource Die or 1 commodity of any type. \n        On a critical success, you gain both. On a critical failure, you gain 1d6 Unrest and attempt DC 11 flat check - on a failure the trade agreement ends, on a critical failure diplomatic relations ends as well.\n        Targeting the same group in subsequent turns increases DC by 1 for each turn, targeting group of a higher level reduces your degree of success by one step."},...n({automationNotes:"You need to manually increase the skill proficiency",name:"Skill Training",level:1,category:"general",text:"Your kingdom receives the trained proficiency rank in a Kingdom skill of your choice. You can select this feat\nmultiple times, choosing a new skill each time. If taken at 6th level or higher, you may choose trained skill instead and your kingdom becomes\nexpert in it. It taken at 12th level or higher - expert may become master instead."}),{automationNotes:"Decreasing Unrest is not automated",name:"Endure Anarchy",level:3,category:"general",prerequisites:"Loyalty 14",text:"Your kingdom holds together even in the midst of extreme peril. If your kingdom’s Unrest is 6 or higher and you use a Quell Unrest activity, decrease the Unrest by an additional 1. You do not fall into anarchy unless your kingdom’s Unrest reaches 24"},...n({name:"Kingdom Assurance",level:1,category:"general",text:"Even when things go poorly in other areas, you can count on consistency in carrying out kingdom activities\nwith a chosen skill. Choose one Kingdom skill in which your kingdom is trained. Once per Kingdom turn, when you would attempt a skill check for that skill, you can forgo rolling and instead take a result equal to 10 + your proficiency bonus; do not apply any other bonuses, penalties, or modifiers to this result. Special You can select this feat multiple times. Each time, choose a different skill and gain the benefits of this feat for that skill."}),{automationNotes:"First time you get luxuries is not automated",name:"Quality of Life",level:7,category:"general",text:"Your kingdom’s robust economy makes the creature comforts of civilization more readily available to all, and even finer luxuries are more easily had. The first time you gain Luxury Commodities in a Kingdom turn, increase the total gained by 1. All of your settlements are treated as 1 level higher than their actual level for the purposes of determining what sorts of magic items might be offered for sale at their markets and shops."},{name:"Channel Locks",level:2,category:"boating",prerequisites:"Expert in Boating, Trained in Engineering",text:"Your people are skilled in modifying or coping with\ndifficult terrain features, such as using channel locks for\nsteep elevation changes or rocky rapids. Choose a nonnavigable river within your kingdom, then spend 2 RP\nand attempt an Engineering control check. You have a +1\ncircumstance bonus to this check; if the kingdom is at\nleast master in Boating, this bonus increases to +2, or to\n+3 if it is legendary in Boating;\n\nCritical Success As success, and you regain 1 RP;\nSuccess The target river becomes navigable;\nFailure The river remains non-navigable; however, you\ndo not need to pay the RP cost for the next Channel\nLocks attempt made in this hex;\nCritical Failure The river remains non-navigable and the\nspent RP is lost",modifiers:e=>[{name:"Boating bonus",type:"circumstance",activities:["channel-locks"],value:e.skillRanks.boating-1,enabled:!0}]},{name:"Mage Corps",level:2,category:"magic",prerequisites:"Expert in Magic",automationNotes:"No automation for Armies",text:"Some of your kingdom’s mages are studied in the\napplication of war magics. You can add Mage Corps\nspecial units to your armies.\n\nThe Mage Corps special unit allows to use 2-action War Magic activity that deals damage to up to 3 armies \nor grants to their army temporary tactic that the army meets prerequicite for: Aerial Batalion, Aquatic Batalion, Darkvision or Flaming Shot.\n\nWar Magic can be used once per encounter, twice if your kingdom is legendatry in Magic."},{name:"Beast Mounts",level:1,category:"agriculture",prerequisites:"Trained in Agriculture",automationNotes:"No automation for Armies",text:"Your ranchers are exceptionally talented, capable of\ntaming and raising wilder animals, such as bears, lions,\nor wolves. When tamed, these beasts can serve as mounts\nfor the armies. You can add Bestial Mounts special units to your cavalry.\n\nBestial Mounts special unit grants army either Varied Weapons tactic, or +2 status bonus to melee attacks rolls (chosen when special unit is recruited)."},{name:"Beasts of Burden",level:1,category:"agriculture",prerequisites:"Trained in Agriculture",text:"Your people use domesticated animals like horses, oxen,\nand the like to make their work easier. With animals\nserving as transport for people and goods, powering mills\nand towing plows, the kingdom gains a +1 circumstance\nbonus to Agriculture, Engineering, and Wilderness\nchecks; if your kingdom is a master in Agriculture, this\nbonus increases to +2.",modifiers:e=>[{name:"Beasts of Burden",type:"circumstance",skills:["agriculture","engineering","wilderness"],value:e.skillRanks.agriculture>=3?2:1,enabled:!0}]},{name:"Dedicated Builders",level:1,category:"engineering",prerequisites:"Trained in Engineering",text:"Expansion and upgrades to structures and infrastructure\nare a constant feature of your people’s lives. Dedicated\nbuilders grant the kingdom a +2 circumstance bonus to\nall attempts to Build a Structure. If the kingdom is at least\nmaster in Engineering, this bonus increases to +3, or to\n+4 if the kingdom is legendary in Engineering.",modifiers:e=>[{name:"Dedicated Builders",type:"circumstance",activities:["build-structure"],value:4==e.skillRanks.engineering?4:3==e.skillRanks.engineering?3:2,enabled:!0}]}].sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))).sort(((e,t)=>e.level-t.level)).sort(((e,t)=>{const i=e.name.toLowerCase(),s=t.name.toLowerCase(),a=i.startsWith("skill training"),n=i.startsWith("kingdom assurance"),r=s.startsWith("skill training"),o=s.startsWith("kingdom assurance");return n&&o?0:n?1:o?-1:a&&r?0:a?1:r?-1:0})),t.allFeatsByName=Object.fromEntries(t.allFeats.map((e=>[e.name,e])))},2752:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uniqueFeatures=t.featuresByLevel=t.features=void 0;const s=i(6185);function a(e){return{level:e,name:"Kingdom Feat",description:"At 2nd level, and then every level thereafter, the kingdom gains a Kingdom feat."}}function n(e){return{level:e,name:"Skill Increase",description:"your kingdom gains a skill increase. You can use this to increase your rank to trained in one skill in which your kingdom is untrained, or to increase your rank to expert in one skill in which your kingdom is trained. Starting at 7th level, you can use your skill increases to increase your kingdom’s proficiency to master in a skill in which your kingdom is already an expert. Beginning at 15th level, you can use them to increase your proficiency to legendary in a skill in which your kingdom is already a master."}}function r(e){return{level:e,name:"Ability Boosts",description:"At 5th level and every 5 levels thereafter, you boost three different kingdom ability scores. You can use these ability boosts to increase your kingdom’s ability scores above 18. Boosting an ability score increases it by 2 if it starts out below 18, or by 1 if it’s already 18 or above."}}function o(e,t){return{level:e,name:`Settlement Construction (${t})`,description:"You can establish villages in your kingdom immediately. At 3rd level, you can expand villages into towns. At 9th level, you can expand towns into cities. expand towns into cities. And at 15th level, you can expand cities into metropolises. As villages grow into larger settlements, you not only gain more room to build, but the maximum item bonus you can gain from that settlement’s structures increases as well. Capital can have the amount of buildings as in the higher tier of the city."}}function l(e){return{level:e,name:"Ruin Resistance",description:"At 5th level and every 3 levels thereafter, your kingdom becomes more resistant to Ruin. Choose one of the four Ruin categories and increase its threshold by 2. When you do so, reset that Ruin’s penalty to 0. See page 38 for more information about Ruin."}}function c(e,t){return{level:e,name:`Expansion Expert (+${t})`,description:"Your kingdom is better at expanding its territory. You gain a +2 circumstance bonus to skill checks made to Claim Hex and can attempt to Claim Hex up to twice during a Kingdom turn. At 9th level, you can attempt to Claim Hex up to three times during a Kingdom turn."}}function u(e,t){return{level:e,name:`Experienced Leadership (+${t})`,description:"Invested leadership roles in your kingdom now grant a +2 status bonus to kingdom checks associated with their leadership role’s key ability. At 16th level, this increases to a +3 status bonus."}}t.features=[{level:1,name:"Charter",description:"Your kingdom gains the benefits of your selected charter"},{level:1,name:"Government",description:"Your kingdom gains the benefits of your selected government"},{level:1,name:"Heartland",description:"Your kingdom gains the benefits of your selected heartland"},{level:1,name:"Initial Proficiencies",description:"At 1st level, a kingdom receives the trained proficiency rank in two Kingdom skills gained from your initial choice of government and in up to four additional Kingdom skills determined by your invested leaders, giving you a proficiency bonus to checks using these skills equal to your kingdom level plus 2. Proficiencies cannot be changed, even if the kingdom’s government or leaders later change."},{level:1,name:"Favored Land",description:"Your heartland’s terrain becomes your kingdom’s favored land—the wilderness terrain that your people feel the strongest emotional ties to and to which your resource gatherers tend to flock. Once per Kingdom turn, during the Region Activities step of the Activity phase, you can attempt two Region activities simultaneously as long as both activities take place in the same hex and that hex contains the same terrain as your heartland. You take a –2 penalty to Kingdom skill checks made during these two activities."},o(1,"Village"),a(2),o(3,"Town"),n(3),a(3),c(4,2),{level:4,name:"Fine Living",description:"Your people celebrate by indulging you with feasts and finery. All PCs associated with the kingdom enjoy a Fine standard of living at no cost whenever they’re in the kingdom. Any PCs in hostile wilderness, a monster‑filled dungeon, or otherwise cut off from their citizens must provide their own sustenance as usual even if they are within the boundaries of their kingdom. You gain a +1 circumstance bonus to all checks made to Craft or Earn Income while in your kingdom."},a(4),r(5),l(5),n(5),a(5),a(6),n(7),a(7),u(8,2),a(8),l(8),c(9,3),o(9,"City"),n(9),a(9),r(10),a(10),{level:10,name:"Life of Luxury",description:"Your people lavish you with every creature comfort. This is identical to Fine Living, but all PC leaders enjoy an Extravagant standard of living at no cost whenever they’re in the kingdom. You gain a +2 circumstance bonus to all checks made to Craft or Earn Income while in your kingdom."},l(11),n(11),a(11),{level:12,name:"Civic Planning",description:"During the Civic Activities step of the Activities phase of a Kingdom turn, one settlement of the party’s choice can attempt two Civic activities rather than one. The second Civic activity occurs after all other settlements have taken their individual Civic activities."},a(12),n(13),a(13),a(14),l(14),r(15),o(15,"Metropolis"),n(15),a(15),u(16,3),a(16),l(17),n(17),a(17),a(18),n(19),a(20),r(20),{level:20,name:"Envy of the World",description:"Your kingdom is one of the world’s prominent nations. The first time in a Kingdom turn when your kingdom would gain Unrest or Ruin, ignore that increase. You can ignore additional increases to Unrest or Ruin later in the same turn as well, but you must spend a Fame or Infamy point each time you do so. Your maximum Fame or Infamy point total increases by 1."},a(20),l(20)],t.featuresByLevel=(0,s.groupBy)(t.features,(e=>e.level)),t.uniqueFeatures=(0,s.distinctBy)(t.features,(e=>e.name))},7894:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasFeat=t.getDefaultKingdomData=t.getCultEventMilestones=t.getControlDC=t.getSizeData=t.kingdomSizeData=t.getLevelData=t.allFameTypes=t.allHeartlands=void 0;const s=i(6690);function a(e){return t.kingdomSizeData.find((t=>e>=t.sizeFrom&&e<=(t.sizeTo??Number.MAX_SAFE_INTEGER)))}function n(){return[{name:"Cult Event (Chapter 5): Cult Activity",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Public Outburst",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Too Close to Home",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Urban Outburst",xp:80,completed:!1,homebrew:!1}]}t.allHeartlands=["forest-or-swamp","hill-or-plain","lake-or-river","mountain-or-ruins"],t.allFameTypes=["famous","infamous"],t.getLevelData=function(e){return{claimHexAttempts:e<4?1:e<9?2:3,claimHexCircumstanceBonus:e<4?0:2,investedLeadershipBonus:e<8?1:e<16?2:3,resourceDice:e+4}},t.kingdomSizeData=[{sizeFrom:0,sizeTo:9,type:"territory",resourceDieSize:"d4",controlDCModifier:0,commodityCapacity:4},{sizeFrom:10,sizeTo:24,type:"province",resourceDieSize:"d6",controlDCModifier:1,commodityCapacity:8},{sizeFrom:25,sizeTo:49,type:"state",resourceDieSize:"d8",controlDCModifier:2,commodityCapacity:12},{sizeFrom:50,sizeTo:99,type:"country",resourceDieSize:"d10",controlDCModifier:3,commodityCapacity:16},{sizeFrom:100,type:"dominion",resourceDieSize:"d12",controlDCModifier:4,commodityCapacity:20}],t.getSizeData=a,t.getControlDC=function(e,t,i){const s=a(t).controlDCModifier,n=e<5?e-1:e,r=i?2:0;return 14+n+Math.floor(n/3)+s+r},t.getCultEventMilestones=n,t.getDefaultKingdomData=function(){return{turnsWithoutEvent:0,turnsWithoutCultEvent:0,name:"",atWar:!1,charter:"",government:"",activeSettlement:"",notes:{public:"",gm:""},fame:{type:"famous",max:3,now:0,next:0},supernaturalSolutions:0,creativeSolutions:0,level:1,xpThreshold:1e3,xp:0,size:1,unrest:0,settlements:[],feats:[],bonusFeats:[],ongoingEvents:[],groups:[],milestones:[{name:"Build Roads for the first time",xp:20,completed:!1,homebrew:!0},{name:"Build your first Famous/Infamous Structure",xp:20,completed:!1,homebrew:!0},{name:"Build your first seat of government (Town Hall, Castle, or Palace)",xp:20,completed:!1,homebrew:!0},{name:"Build your first Structure requiring Expert in a Kingdom Skill",xp:20,completed:!1,homebrew:!0},{name:"Celebrate your first successful Holiday",xp:20,completed:!1,homebrew:!0},{name:"Claim your first new Hex (2nd hex overall)",xp:20,completed:!1,homebrew:!0},{name:"Complete your First successful Infiltration",xp:20,completed:!1,homebrew:!0},{name:"Create your first Masterpiece",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Farmland",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Lumber Camp",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Mine",xp:20,completed:!1,homebrew:!0},{name:"Establish your first Quarry",xp:20,completed:!1,homebrew:!0},{name:"Fortify your first hex",xp:20,completed:!1,homebrew:!0},{name:"Successfully use your first Creative Solution",xp:20,completed:!1,homebrew:!0},{name:"Successfully use your first Supernatural Solution",xp:20,completed:!1,homebrew:!0},{name:"Claim your first Landmark",xp:40,completed:!1,homebrew:!1},{name:"Claim your first Refuge",xp:40,completed:!1,homebrew:!1},{name:"Establish your first village",xp:40,completed:!1,homebrew:!1},{name:"Establish your second Village",xp:40,completed:!1,homebrew:!0},{name:"Reach kingdom Size 10",xp:40,completed:!1,homebrew:!1},{name:"Recruit your first regular Army",xp:40,completed:!1,homebrew:!0},{name:"Successfully resolve a random Kingdom Event",xp:40,completed:!1,homebrew:!0},{name:"Achieve your first successful Pledge of Fealty",xp:60,completed:!1,homebrew:!0},{name:"All eight leadership roles are assigned",xp:60,completed:!1,homebrew:!1},{name:"Build your first Structure requiring Master in a Kingdom Skill",xp:60,completed:!1,homebrew:!0},{name:"Establish diplomatic relations for the first time",xp:60,completed:!1,homebrew:!1},{name:"Expand a village into your first town",xp:60,completed:!1,homebrew:!1},{name:"Reach kingdom Size 25",xp:60,completed:!1,homebrew:!1},{name:"Recruit your first Specialized Army",xp:60,completed:!1,homebrew:!0},{name:"Win your first War Encounter",xp:60,completed:!1,homebrew:!0},{name:"Establish your first trade agreement",xp:80,completed:!1,homebrew:!1},{name:"Expand a town into your first city",xp:80,completed:!1,homebrew:!1},{name:"Reach kingdom Size 50",xp:80,completed:!1,homebrew:!1},{name:"Spend 100 RP during a Kingdom turn",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Cult Activity",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Public Outburst",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Too Close to Home",xp:80,completed:!1,homebrew:!1},{name:"Cult Event (Chapter 5): Urban Outburst",xp:80,completed:!1,homebrew:!1},{name:"Expand a city into your first metropolis",xp:120,completed:!1,homebrew:!1},{name:"Reach kingdom Size 100",xp:120,completed:!1,homebrew:!1},{name:"[Repeatable] Connect a settlement to your capital via roads",xp:40,completed:!1,homebrew:!0},{name:"[Repeatable] Claim all hexes in a region",xp:100,completed:!1,homebrew:!0}],realmSceneId:null,settings:{expandMagicUse:!1},workSites:{farmlands:{quantity:0,resources:0},quarries:{quantity:0,resources:0},lumberCamps:{quantity:0,resources:0},mines:{quantity:0,resources:0},luxurySources:{quantity:0,resources:0}},commodities:{now:{food:0,ore:0,lumber:0,stone:0,luxuries:0},next:{food:0,ore:0,lumber:0,stone:0,luxuries:0}},resourceDice:{now:0,next:0},resourcePoints:{next:0,now:0},heartland:"hill-or-plain",consumption:{armies:0,now:0,next:0},leaders:{ruler:{invested:!1,vacant:!1,name:""},counselor:{invested:!1,vacant:!1,name:""},general:{invested:!1,vacant:!1,name:""},emissary:{invested:!1,vacant:!1,name:""},magister:{invested:!1,vacant:!1,name:""},treasurer:{invested:!1,vacant:!1,name:""},viceroy:{invested:!1,vacant:!1,name:""},warden:{invested:!1,vacant:!1,name:""}},skillRanks:{agriculture:0,arts:0,boating:0,defense:0,engineering:0,exploration:0,folklore:0,industry:0,intrigue:0,magic:0,politics:0,scholarship:0,statecraft:0,trade:0,warfare:0,wilderness:0},abilityScores:{culture:10,economy:10,loyalty:10,stability:10},ruin:{corruption:{penalty:0,threshold:10,value:0},crime:{penalty:0,threshold:10,value:0},decay:{penalty:0,threshold:10,value:0},strife:{penalty:0,threshold:10,value:0}},activityBlacklist:(0,s.getKingdomActivities)([]).filter((e=>!e.enabled)).map((e=>e.id)),modifiers:[],homebrewActivities:[]}},t.hasFeat=function(e,t){return[...e.feats,...e.bonusFeats].map((e=>e.id)).includes(t)}},8577:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateInvestedBonus=t.isInvested=t.abilityLeaders=t.leaderAbilities=t.allLeaders=void 0;const s=i(7894);function a(e,i){const s=t.abilityLeaders[e];return i[s[0]].invested||i[s[1]].invested}t.allLeaders=["ruler","counselor","general","emissary","magister","treasurer","viceroy","warden"],t.leaderAbilities={ruler:"loyalty",counselor:"culture",general:"stability",emissary:"loyalty",magister:"culture",treasurer:"economy",viceroy:"economy",warden:"stability"},t.abilityLeaders={loyalty:["ruler","emissary"],culture:["counselor","magister"],stability:["general","warden"],economy:["treasurer","viceroy"]},t.isInvested=a,t.calculateInvestedBonus=function(e,t,i){const n=(0,s.getLevelData)(e);return a(t,i)?n.investedLeadershipBonus:0}},5281:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.abilityRuins=t.ruinAbilities=t.allRuins=void 0,t.allRuins=["corruption","crime","decay","strife"],t.ruinAbilities={corruption:"culture",crime:"economy",decay:"stability",strife:"loyalty"},t.abilityRuins={culture:"corruption",economy:"crime",stability:"decay",loyalty:"strife"}},6893:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allActorSkills=t.allTrainedSkillRanks=t.allSkillRanks=t.skillAbilities=t.allSkills=void 0,t.allSkills=["agriculture","arts","boating","defense","engineering","exploration","folklore","industry","intrigue","magic","politics","scholarship","statecraft","trade","warfare","wilderness"],t.skillAbilities={agriculture:"stability",arts:"culture",boating:"economy",defense:"stability",engineering:"stability",exploration:"economy",folklore:"culture",industry:"economy",intrigue:"loyalty",magic:"culture",politics:"loyalty",scholarship:"culture",statecraft:"loyalty",trade:"economy",warfare:"loyalty",wilderness:"stability"},t.allSkillRanks=["untrained","trained","expert","master","legendary"],t.allTrainedSkillRanks=["trained","expert","master","legendary"],t.allActorSkills=["perception","acrobatics","athletics","arcana","crafting","deception","diplomacy","intimidation","medicine","nature","occultism","performance","religion","society","stealth","survival","thievery"]},9549:(e,t)=>{"use strict";function i(e){return t.recoverArmyIds.map((t=>({value:e,activity:t})))}Object.defineProperty(t,"__esModule",{value:!0}),t.structuresByName=t.recoverArmyIds=t.itemGroups=t.mundaneItemGroups=t.magicalItemGroups=t.allBuildingTraits=void 0,t.allBuildingTraits=["edifice","yard","building","famous","infamous","residential","infrastructure"],t.magicalItemGroups=["magical","divine","occult","primal","arcane"],t.mundaneItemGroups=["alchemical","luxury","other"],t.itemGroups=t.mundaneItemGroups.concat(t.magicalItemGroups),t.recoverArmyIds=["recover-army-damaged","recover-army-defeated","recover-army-lost","recover-army-mired-pinned","recover-army-shaken","recover-army-weary"];const s=[{name:"Academy",activityBonusRules:[{value:2,activity:"creative-solution"}],notes:"While in a settlement with an Academy, you gain a +2 item bonus to Lore checks made to Recall Knowledge while Investigate, to all checks made while Researching, and to Decipher Writing.",traits:["building","edifice"],affectsDowntime:!0,level:10,upgradeFrom:["Library","Library (V&K)"],construction:{skills:[{skill:"scholarship",proficiencyRank:2}],dc:27,rp:52,lumber:12,luxuries:6,stone:12},lots:2},{name:"Alchemy Laboratory",activityBonusRules:[{value:1,activity:"demolish"}],availableItemsRules:[{value:1,group:"alchemical",maximumStacks:3}],notes:"Checks attempted to Identify Alchemy in any settlement with at least one alchemy laboratory gain a +1 item bonus.",traits:["building"],affectsDowntime:!0,level:3,construction:{skills:[{skill:"industry",proficiencyRank:1}],rp:18,ore:2,stone:5,dc:16},lots:1},{name:"Arcanist's Tower",skillBonusRules:[{value:1,skill:"magic",activity:"quell-unrest"}],availableItemsRules:[{value:1,group:"arcane",maximumStacks:3}],notes:"While in a settlement with an arcanist's tower, you gain a +1 item bonus to checks made to Borrow an Arcane Spell or Learn a Spell.",traits:["building"],affectsDowntime:!0,level:5,construction:{skills:[{skill:"magic",proficiencyRank:1}],rp:30,stone:6,dc:20},lots:1},{name:"Arena",activityBonusRules:[{value:2,activity:"celebrate-holiday"}],skillBonusRules:[{value:1,skill:"warfare",activity:"quell-unrest"}],notes:"An arena lets you to retrain combat-themed feats more efficiently while in the settlement; doing so takes only 5 days rather than a week of downtime.",traits:["edifice","yard"],affectsDowntime:!0,level:9,construction:{skills:[{skill:"warfare",proficiencyRank:2}],dc:26,rp:40,lumber:6,stone:12},lots:4},{name:"Bank",activityBonusRules:[{value:1,activity:"tap-treasury"}],enableCapitalInvestment:!0,traits:["building"],level:5,construction:{skills:[{skill:"trade",proficiencyRank:1}],dc:20,rp:28,ore:4,stone:6},lots:1},{name:"Barracks",activityBonusRules:[{value:1,activity:"garrison-army"},...i(1),{value:1,activity:"recruit-army"}],traits:["building","residential"],reducesUnrest:!0,reduceUnrestBy:{value:"1",moreThanOncePerTurn:!0},level:3,construction:{skills:[{skill:"defense"}],dc:16,rp:6,lumber:2,stone:1},lots:1},{name:"Brewery",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],traits:["building"],reducesUnrest:!0,reduceUnrestBy:{value:"1",moreThanOncePerTurn:!0,note:"as long as you have fewer than 4 breweries in the settlement at that time"},level:1,construction:{skills:[{skill:"agriculture"}],dc:15,rp:6,lumber:2},lots:1},{name:"Bridge",isBridge:!0,traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{skills:[{skill:"engineering"}],dc:16,rp:6,lumber:1}},{name:"Bridge, Stone",isBridge:!0,traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{skills:[{skill:"engineering"}],dc:16,rp:6,stone:1}},{name:"Castle",activityBonusRules:[{value:2,activity:"new-leadership"},{value:2,activity:"pledge-of-fealty"},{value:2,activity:"send-diplomatic-envoy"},{value:2,activity:"garrison-army"},{value:2,activity:"recruit-army"},...i(2)],increaseLeadershipActivities:!0,traits:["building","edifice","famous","infamous"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1d4"},level:9,upgradeFrom:["Town Hall","Town Hall (V&K)"],construction:{skills:[{skill:"defense",proficiencyRank:2},{skill:"industry",proficiencyRank:2},{skill:"magic",proficiencyRank:2},{skill:"statecraft",proficiencyRank:2}],rp:54,dc:26,lumber:12,stone:12},lots:4},{name:"Cathedral",activityBonusRules:[{value:3,activity:"celebrate-holiday"},{value:3,activity:"provide-care"},{value:3,activity:"repair-reputation-corruption"}],availableItemsRules:[{value:3,group:"divine",maximumStacks:3}],notes:"While in a settlement with a cathedral, you gain a +3 item bonus to Lore and Religion checks made to Recall Knowledge while Investigating, and to all faith-themed checks made while Researching. Cathedral also gives a +1 status bonus to perform rituals if a ritual is performed in this settlement.",traits:["building","edifice","famous","infamous"],affectsDowntime:!0,reducesUnrest:!0,reduceUnrestBy:{value:"4"},level:15,upgradeFrom:["Temple"],construction:{skills:[{skill:"folklore",proficiencyRank:3}],rp:58,dc:34,lumber:20,stone:20},lots:4},{name:"Cemetery",traits:["yard"],affectsEvents:!0,affectsDowntime:!1,reducesUnrest:!0,level:1,construction:{skills:[{skill:"folklore"}],dc:15,rp:4,stone:1},lots:1},{name:"Construction Yard",activityBonusRules:[{value:1,activity:"build-structure"},{value:1,activity:"repair-reputation-decay"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:10,construction:{skills:[{skill:"engineering"}],dc:27,rp:40,lumber:10,stone:10},lots:4},{name:"Dump",activityBonusRules:[{value:1,activity:"demolish"}],traits:["yard"],affectsEvents:!0,affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{skills:[{skill:"industry"}],dc:16,rp:4},lots:1},{name:"Embassy",activityBonusRules:[{value:1,activity:"send-diplomatic-envoy"},{value:1,activity:"request-foreign-aid"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:8,construction:{skills:[{skill:"politics"}],dc:24,rp:26,lumber:10,stone:4,luxuries:6},lots:2},{name:"Festival Hall",activityBonusRules:[{value:1,activity:"celebrate-holiday"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{skills:[{skill:"arts"}],dc:18,rp:7,lumber:3},lots:1},{name:"Foundry",activityBonusRules:[{value:1,activity:"establish-work-site-mine"}],storage:{ore:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{skills:[{skill:"industry",proficiencyRank:1}],dc:18,rp:16,lumber:5,stone:3,ore:2},lots:2},{name:"Garrison",activityBonusRules:[{value:1,activity:"outfit-army"},{value:1,activity:"train-army"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{moreThanOncePerTurn:!0,value:"1"},level:5,upgradeFrom:["Barracks"],construction:{skills:[{skill:"warfare",proficiencyRank:1}],dc:20,rp:28,lumber:6,stone:3},lots:2},{name:"General Store",preventItemLevelPenalty:!0,traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{skills:[{skill:"trade"}],dc:15,rp:8,lumber:1},lots:1},{name:"Gladiatorial Arena",activityBonusRules:[{value:3,activity:"celebrate-holiday"},{value:3,activity:"hire-adventurers"}],skillBonusRules:[{value:3,skill:"warfare",activity:"quell-unrest"}],notes:"A gladiatorial arena allows a PC in the settlement to retrain combat-themed feats (at the GM's discretion) more efficiently; doing so takes only 4 days rather than a week of downtime.",traits:["edifice","famous","infamous","yard"],affectsDowntime:!0,reducesUnrest:!1,level:15,construction:{rp:58,lumber:10,stone:30,skills:[{skill:"warfare",proficiencyRank:3}],dc:34},lots:4},{name:"Houses",traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:1,upgradeFrom:["Tenement"],construction:{rp:3,lumber:1,skills:[{skill:"industry"}],dc:15},lots:1},{name:"Granary",storage:{food:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:12,lumber:2,skills:[{skill:"agriculture"}],dc:15},lots:1},{name:"Guildhall",notes:"While in a settlement with a guildhall, you gain a +1 item bonus to all related skill checks to Earn Income or to Repair.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:5,construction:{rp:34,lumber:8,skills:[{skill:"trade",proficiencyRank:2}],dc:20},upgradeFrom:["Trade Shop"],lots:2},{name:"Herbalist",activityBonusRules:[{value:1,activity:"provide-care"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:10,lumber:1,skills:[{skill:"wilderness"}],dc:15},lots:1},{name:"Hospital",activityBonusRules:[{value:1,activity:"provide-care"},{value:1,activity:"quell-unrest"}],notes:"While in a settlement with a hospital, you gain a +2 item bonus to Medicine checks to Treat Disease and Treat Wounds.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:9,upgradeFrom:["Herbalist"],construction:{rp:30,lumber:10,stone:6,skills:[{skill:"defense",proficiencyRank:2}],dc:26},lots:2},{name:"Illicit Market",activityBonusRules:[{value:1,activity:"clandestine-business"}],availableItemsRules:[{value:1,maximumStacks:3}],traits:["building","infamous"],gainRuin:{value:"1",ruin:"crime",moreThanOncePerTurn:!0},affectsDowntime:!1,reducesUnrest:!1,level:6,construction:{rp:50,lumber:5,skills:[{skill:"intrigue",proficiencyRank:1}],dc:22},lots:1},{name:"Inn",activityBonusRules:[{value:1,activity:"hire-adventurers"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:10,lumber:2,skills:[{skill:"trade"}],dc:15},lots:1},{name:"Jail",skillBonusRules:[{value:1,skill:"intrigue",activity:"quell-unrest"}],reduceRuinBy:{value:"1",ruin:"crime"},traits:["building"],affectsDowntime:!1,reducesRuin:!0,level:2,construction:{rp:14,lumber:4,stone:4,ore:2,skills:[{skill:"defense"}],dc:16},lots:1},{name:"Keep",activityBonusRules:[{value:1,activity:"deploy-army"},{value:1,activity:"garrison-army"},{value:1,activity:"train-army"}],traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:3,construction:{rp:32,lumber:8,stone:8,skills:[{skill:"defense",proficiencyRank:1}],dc:18},lots:2},{name:"Library",skillBonusRules:[{value:1,skill:"scholarship",activity:"rest-and-relax"}],notes:"While in a settlement with a library, you gain a +1 item bonus to Lore checks made to Recall Knowledge while Investigating, as well as to Researching checks, and to Decipher Writing checks.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:2,construction:{rp:6,lumber:4,stone:2,skills:[{skill:"scholarship",proficiencyRank:1}],dc:16},lots:1},{name:"Lumberyard",activityBonusRules:[{value:1,activity:"establish-work-site-lumber"}],storage:{lumber:1},traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:16,lumber:5,ore:1,skills:[{skill:"industry",proficiencyRank:1}],dc:18},lots:2},{name:"Luxury Store",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],availableItemsRules:[{value:1,group:"luxury",maximumStacks:3}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:6,upgradeFrom:["General Store"],construction:{rp:28,lumber:10,luxuries:6,skills:[{skill:"trade",proficiencyRank:2}],dc:22},lots:1},{name:"Magic Shop",activityBonusRules:[{value:1,activity:"supernatural-solution"}],availableItemsRules:[{value:1,group:"magical",maximumStacks:3}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:8,upgradeFrom:["Luxury Store"],construction:{rp:44,lumber:8,stone:6,luxuries:6,skills:[{skill:"magic",proficiencyRank:2}],dc:24},lots:1},{name:"Magical Streetlamps",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesRuin:!0,reduceRuinBy:{value:"1",ruin:"crime"},level:5,construction:{rp:20,skills:[{skill:"magic",proficiencyRank:2}],dc:20}},{name:"Mansion",activityBonusRules:[{value:1,activity:"improve-lifestyle"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:5,upgradeFrom:["Houses"],construction:{rp:10,lumber:6,stone:3,luxuries:6,skills:[{skill:"industry",proficiencyRank:1}],dc:20},lots:1},{name:"Marketplace",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],preventItemLevelPenalty:!0,traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!1,level:4,upgradeFrom:["General Store"],construction:{rp:48,lumber:4,skills:[{skill:"trade",proficiencyRank:1}],dc:19},lots:2},{name:"Menagerie",skillBonusRules:[{value:2,skill:"wilderness",activity:"rest-and-relax"}],notes:"A menagerie typically contains a selection of level 5 or lower animals. If your party captures a living creature of level 6 or higher and can transport the creature back to a settlement with a menagerie, you can add that creature to the menagerie as long as your kingdom level is at least 4 higher than the creature's level. Each time such a creature is added to a menagerie, gain 1 Fame or Infamy point (as appropriate) or reduce one Ruin of your choice by 1.\nOnly creatures with Intelligence modifiers of –4 or –5 are appropriate to place in a menagerie. A kingdom gains 1 Unrest at the start of a Kingdom turn for each sapient creature (anything with an Intelligence modifier of –3 or higher) on display in a menagerie.",traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!1,reducesRuin:!0,level:12,upgradeFrom:["Park"],construction:{rp:26,lumber:14,stone:10,ore:10,skills:[{skill:"wilderness",proficiencyRank:2}],dc:30},lots:4},{name:"Military Academy",activityBonusRules:[{value:2,activity:"train-army"}],skillBonusRules:[{value:2,skill:"warfare",activity:"pledge-of-fealty"}],traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!1,level:12,upgradeFrom:["Academy"],construction:{rp:36,lumber:12,stone:10,ore:6,skills:[{skill:"warfare",proficiencyRank:2}],dc:30},lots:2},{name:"Mill",activityBonusRules:[{value:1,activity:"harvest-crops"}],consumptionReduction:1,traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:2,construction:{rp:6,lumber:2,stone:1,skills:[{skill:"industry",proficiencyRank:1}],dc:16},lots:1},{name:"Mint",activityBonusRules:[{value:3,activity:"capital-investment"},{value:3,activity:"collect-taxes"},{value:3,activity:"repair-reputation-crime"}],traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!1,level:15,construction:{rp:30,lumber:12,stone:16,ore:20,skills:[{skill:"trade",proficiencyRank:3}],dc:34},lots:1},{name:"Monument",traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},reduceRuinBy:{value:"1",ruin:"any"},level:3,construction:{rp:6,stone:1,skills:[{skill:"arts",proficiencyRank:1}],dc:18},lots:1},{name:"Museum",skillBonusRules:[{value:1,skill:"arts",activity:"rest-and-relax"}],notes:"A magic item of level 6 or higher that has a particular import or bears significant historical or regional value (at the GM's discretion) can be donated to a museum. Each time such an item is donated, reduce Unrest by 1. If that item is later removed from display, increase Unrest by 1.",traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,level:5,construction:{rp:30,lumber:6,stone:2,skills:[{skill:"exploration",proficiencyRank:1}],dc:20},lots:2},{name:"Noble Villa",activityBonusRules:[{value:1,activity:"improve-lifestyle"}],skillBonusRules:[{value:1,skill:"politics",activity:"quell-unrest"}],traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"2"},level:9,upgradeFrom:["Mansion"],construction:{rp:24,lumber:10,stone:8,luxuries:6,skills:[{skill:"politics",proficiencyRank:2}],dc:19},lots:2},{name:"Occult Shop",activityBonusRules:[{value:2,activity:"prognostication"}],availableItemsRules:[{value:1,group:"occult",maximumStacks:3}],notes:"While in a settlement with an occult shop, you gain a +2 item bonus to all checks made to Research esoteric subjects or to Recall Knowledge about the same.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:13,construction:{rp:68,lumber:12,stone:6,luxuries:12,skills:[{skill:"magic",proficiencyRank:3}],dc:32},lots:1},{name:"Opera House",activityBonusRules:[{value:3,activity:"celebrate-holiday"},{value:3,activity:"create-a-masterpiece"}],notes:"While in a settlement with an opera house, you gain a +3 item bonus to Performance checks made to Earn Income.",traits:["building","edifice","famous","infamous"],affectsDowntime:!0,reducesUnrest:!0,reduceUnrestBy:{value:"2"},level:15,upgradeFrom:["Theater"],construction:{rp:40,lumber:20,stone:16,luxuries:18,skills:[{skill:"arts",proficiencyRank:3}],dc:34},lots:2},{name:"Orphanage",traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:2,upgradeFrom:["Houses"],construction:{rp:6,lumber:2,skills:[{skill:"industry"}],dc:16},lots:1},{name:"Palace",activityBonusRules:[{value:3,activity:"new-leadership"},{value:3,activity:"pledge-of-fealty"},{value:3,activity:"send-diplomatic-envoy"},{value:3,activity:"garrison-army"},...i(3),{value:3,activity:"recruit-army"}],leadershipActivityRules:[{value:3}],increaseLeadershipActivities:!0,traits:["building","edifice","famous","infamous"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"10"},level:15,upgradeFrom:["Castle","Castle (V&K)"],construction:{rp:108,lumber:20,stone:20,ore:15,luxuries:12,skills:[{skill:"defense",proficiencyRank:3},{skill:"industry",proficiencyRank:3},{skill:"magic",proficiencyRank:3},{skill:"statecraft",proficiencyRank:3}],dc:34},lots:4},{name:"Park",skillBonusRules:[{value:1,skill:"wilderness",activity:"rest-and-relax"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:3,construction:{rp:5,skills:[{skill:"wilderness"}],dc:18},lots:1},{name:"Paved Streets",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!1,level:4,construction:{rp:12,stone:6,skills:[{skill:"industry",proficiencyRank:1}],dc:19}},{name:"Pier",activityBonusRules:[{value:1,activity:"go-fishing"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:16,lumber:2,skills:[{skill:"boating"}],dc:18},lots:1},{name:"Rubble",traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:0,lots:1},{name:"Printing House",activityBonusRules:[{value:2,activity:"improve-lifestyle"},{value:2,activity:"quell-unrest"}],notes:"A PC in a settlement with a printing house gains a +2 item bonus to checks to Gather Information or to Research any topic in a library or similar structure.",unlockActivities:["read-all-about-it"],traits:["building","edifice"],affectsDowntime:!0,reducesUnrest:!1,level:10,construction:{rp:48,lumber:14,luxuries:12,skills:[{skill:"industry",proficiencyRank:3}],dc:27},lots:2},{name:"Sacred Grove",skillBonusRules:[{value:1,skill:"folklore",activity:"quell-unrest"}],availableItemsRules:[{value:1,group:"primal",maximumStacks:3}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:5,construction:{rp:36,skills:[{skill:"wilderness",proficiencyRank:1}],dc:20},lots:1},{name:"Secure Warehouse",activityBonusRules:[{value:1,activity:"craft-luxuries"}],storage:{luxuries:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:6,construction:{rp:24,lumber:6,stone:6,ore:4,skills:[{skill:"industry",proficiencyRank:2}],dc:22},lots:2},{name:"Sewer System",activityBonusRules:[{value:1,activity:"clandestine-business"}],consumptionReduction:1,traits:["infrastructure"],lots:0,affectsEvents:!0,affectsDowntime:!1,reducesUnrest:!1,level:7,construction:{rp:24,lumber:8,stone:8,skills:[{skill:"engineering",proficiencyRank:2}],dc:23}},{name:"Shrine",activityBonusRules:[{value:1,activity:"celebrate-holiday"}],availableItemsRules:[{value:1,group:"divine",maximumStacks:3}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:1,construction:{rp:8,lumber:2,stone:1,skills:[{skill:"folklore",proficiencyRank:1}],dc:15},lots:1},{name:"Smithy",activityBonusRules:[{value:1,activity:"trade-commodities"},{value:1,activity:"outfit-army"}],notes:"While in a settlement with a smithy, you gain a +1 item bonus to Craft checks made to work with metal.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:3,construction:{rp:8,lumber:2,stone:1,ore:1,skills:[{skill:"industry",proficiencyRank:1}],dc:18},lots:1},{name:"Specialized Artisan",activityBonusRules:[{value:1,activity:"craft-luxuries"}],notes:"While in a settlement with a specialized artisan, you gain a +1 item bonus to Craft checks made to craft specialized goods like jewelry.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:4,construction:{rp:10,lumber:4,luxuries:1,skills:[{skill:"trade",proficiencyRank:2}],dc:19},lots:1},{name:"Stable",activityBonusRules:[{value:1,activity:"establish-trade-agreement"}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:10,lumber:2,skills:[{skill:"wilderness",proficiencyRank:1}],dc:18},lots:1},{name:"Stockyard",activityBonusRules:[{value:1,activity:"gather-livestock"}],consumptionReduction:1,traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:20,lumber:4,skills:[{skill:"industry"}],dc:18},lots:4},{name:"Stonemason",activityBonusRules:[{value:1,activity:"establish-work-site-quarry"}],storage:{stone:1},traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:16,lumber:2,skills:[{skill:"industry",proficiencyRank:1}],dc:18},lots:2},{name:"Tannery",activityBonusRules:[{value:1,activity:"trade-commodities"}],traits:["building"],affectsDowntime:!1,reducesUnrest:!1,level:3,construction:{rp:6,lumber:2,skills:[{skill:"industry",proficiencyRank:1}],dc:18},lots:1},{name:"Tavern, Dive",traits:["building"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:1,construction:{rp:12,lumber:1,skills:[{skill:"trade",proficiencyRank:1}],dc:15},lots:1},{name:"Tavern, Luxury",activityBonusRules:[{value:2,activity:"hire-adventurers"}],skillBonusRules:[{value:2,skill:"trade",activity:"rest-and-relax"}],notes:"If attempt a Performance check to Earn Income in a settlement with a luxury tavern, you gain a +2 item bonus to the check. All checks made to Gather Information in a settlement with at least one luxury tavern gain a +2 item bonus.",traits:["building","famous"],affectsDowntime:!0,reducesUnrest:!0,reduceUnrestBy:{value:"1d4+1"},level:9,upgradeFrom:["Tavern, Popular","Tavern, Popular (V&K)"],construction:{rp:48,lumber:10,stone:8,luxuries:8,skills:[{skill:"trade",proficiencyRank:3}],dc:26},lots:2},{name:"Tavern, Popular",activityBonusRules:[{value:1,activity:"hire-adventurers"}],skillBonusRules:[{value:1,skill:"trade",activity:"rest-and-relax"}],notes:"If you attempt a Performance check to Earn Income in a settlement with a popular tavern, you gain a +1 item bonus to the check. All checks made to Gather Information in a settlement with at least one popular tavern gain a +1 item bonus.",traits:["building"],affectsDowntime:!0,reducesUnrest:!0,reduceUnrestBy:{value:"2"},level:3,upgradeFrom:["Tavern, Dive","Tavern, Dive (V&K)"],construction:{rp:24,lumber:6,stone:2,skills:[{skill:"trade",proficiencyRank:2}],dc:18},lots:1},{name:"Tavern, World-Class",activityBonusRules:[{value:3,activity:"hire-adventurers"},{value:3,activity:"repair-reputation-strife"}],skillBonusRules:[{value:3,skill:"trade",activity:"rest-and-relax"}],notes:"If you attempt a Performance check to Earn Income in a settlement with a world-class tavern, you gain a +3 item bonus to the check. All checks made to Gather Information in a settlement with a world-class tavern gain a +3 item bonus.",traits:["building","edifice","famous"],affectsDowntime:!0,reducesUnrest:!0,reduceUnrestBy:{value:"2d4"},level:15,upgradeFrom:["Tavern, Luxury","Tavern, Luxury (V&K)"],construction:{rp:64,lumber:18,stone:15,luxuries:15,skills:[{skill:"trade",proficiencyRank:3}],dc:34},lots:2},{name:"Temple",activityBonusRules:[{value:1,activity:"celebrate-holiday"},{value:1,activity:"provide-care"}],notes:"Temple gives a +1 status bonus to perform rituals if a ritual is performed in this settlement.",availableItemsRules:[{value:1,group:"divine",maximumStacks:3}],traits:["building","famous","infamous"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"2"},level:7,upgradeFrom:["Shrine"],construction:{rp:32,lumber:6,stone:6,skills:[{skill:"folklore",proficiencyRank:1}],dc:23},lots:2},{name:"Tenement",traits:["building","residential"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},gainRuin:{value:"1",ruin:"any",moreThanOncePerTurn:!0},level:0,construction:{rp:1,lumber:1,skills:[{skill:"industry"}],dc:14},lots:1},{name:"Theater",activityBonusRules:[{value:2,activity:"celebrate-holiday"}],notes:"While in a settlement with a theater, you gain a +2 item bonus to Performance checks made to Earn Income.",traits:["building"],affectsDowntime:!0,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:9,upgradeFrom:["Festival Hall","Festival Hall (V&K)"],construction:{rp:24,lumber:8,stone:3,skills:[{skill:"arts",proficiencyRank:2}],dc:26},lots:2},{name:"Thieves' Guild",activityBonusRules:[{value:1,activity:"infiltration"}],notes:"While in a settlement with a thieves' guild, you gain a +1 item bonus to Create Forgeries.",traits:["building","infamous"],affectsDowntime:!0,reducesUnrest:!1,gainRuin:{value:"1",ruin:"crime",moreThanOncePerTurn:!0},level:5,construction:{rp:25,lumber:4,skills:[{skill:"intrigue",proficiencyRank:1}],dc:20},lots:1},{name:"Town Hall",increaseLeadershipActivities:!0,traits:["building","edifice"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:2,construction:{rp:22,lumber:4,stone:4,skills:[{skill:"defense",proficiencyRank:1},{skill:"industry",proficiencyRank:1},{skill:"magic",proficiencyRank:1},{skill:"statecraft",proficiencyRank:1}],dc:16},lots:2},{name:"Trade Shop",activityBonusRules:[{value:1,activity:"purchase-commodities"}],notes:"When you build a trade shop, indicate the kind of shop it is, such as a bakery, carpenter, tailor, and so on. While in a settlement with a trade shop, you gain a +1 item bonus to all associated Crafting checks.",traits:["building"],affectsDowntime:!0,reducesUnrest:!1,level:3,construction:{rp:10,lumber:2,skills:[{skill:"trade",proficiencyRank:1}],dc:18},lots:1},{name:"University",activityBonusRules:[{value:3,activity:"creative-solution"}],notes:"While in a settlement with a university, you gain a +3 item bonus to Lore checks made to Recall Knowledge while Investigating, to Research checks (Gamemastery Guide 154), and to Decipher Writing.",traits:["building","edifice","famous"],affectsDowntime:!0,reducesUnrest:!1,level:15,upgradeFrom:["Academy"],construction:{rp:78,lumber:18,stone:18,luxuries:18,skills:[{skill:"scholarship",proficiencyRank:3}],dc:34},lots:4},{name:"Wall, Stone",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1",moreThanOncePerTurn:!0,note:"as long as it's the first wall in a settlement"},level:5,upgradeFrom:["Wall, Wooden"],construction:{rp:4,stone:8,skills:[{skill:"defense",proficiencyRank:1}],dc:20}},{name:"Wall, Wooden",traits:["infrastructure"],lots:0,affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1",moreThanOncePerTurn:!0,note:"as long as it's the first wall in a settlement"},level:1,construction:{rp:2,lumber:4,skills:[{skill:"defense"}],dc:15}},{name:"Watchtower",settlementEventRules:[{value:1}],traits:["building"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:3,construction:{rp:12,lumber:4,skills:[{skill:"defense",proficiencyRank:1}],dc:18},lots:1},{name:"Watchtower, Stone",stacksWith:"Watchtower",settlementEventRules:[{value:1}],traits:["building"],affectsDowntime:!1,reducesUnrest:!0,reduceUnrestBy:{value:"1"},level:3,construction:{rp:12,stone:4,skills:[{skill:"defense",proficiencyRank:1}],dc:18},lots:1},{name:"Waterfront",activityBonusRules:[{value:1,activity:"go-fishing"},{value:1,activity:"establish-trade-agreement"}],availableItemsRules:[{value:1,maximumStacks:1}],traits:["yard"],affectsDowntime:!1,reducesUnrest:!1,level:8,upgradeFrom:["Pier"],construction:{rp:90,lumber:10,skills:[{skill:"boating",proficiencyRank:2}],dc:24},lots:4}];t.structuresByName=new Map,s.forEach((e=>t.structuresByName.set(e.name,e)));Array.from(Object.entries({Bank:{activityBonusRules:[{value:1,activity:"capital-investment"},{value:1,activity:"collect-taxes"}]},Castle:{activityBonusRules:[{value:2,activity:"manage-trade-agreements"},{value:2,activity:"relocate-capital"}]},"Construction Yard":{activityBonusRules:[{value:1,activity:"build-roads"},{value:1,activity:"irrigation"}]},"Festival Hall":{skillBonusRules:[{activity:"quell-unrest",skill:"arts",value:1}]},Garrison:{activityBonusRules:[{value:1,activity:"fortify-hex"}]},Granary:{activityBonusRules:[{value:1,activity:"establish-farmland"}]},Inn:{skillBonusRules:[{value:1,activity:"clear-hex",skill:"exploration"}]},Library:{activityBonusRules:[{value:1,activity:"creative-solution"}]},"Magic Shop":{activityBonusRules:[{value:1,activity:"prognostication"}]},Monument:{activityBonusRules:[{value:1,activity:"create-a-masterpiece"}]},"Occult Shop":{activityBonusRules:[{value:2,activity:"supernatural-solution"}]},Palace:{activityBonusRules:[{value:3,activity:"manage-trade-agreements"},{value:3,activity:"relocate-capital"}]},Smithy:{skillBonusRules:[{value:1,activity:"clear-hex",skill:"engineering"}]},"Tavern, Dive":{skillBonusRules:[{value:1,activity:"clear-hex",skill:"exploration"}]},"Tavern, Luxury":{activityBonusRules:[{value:2,activity:"reconnoiter-hex"}]},"Tavern, Popular":{activityBonusRules:[{value:1,activity:"reconnoiter-hex"}]},"Tavern, World-Class":{activityBonusRules:[{value:3,activity:"reconnoiter-hex"}]},"Town Hall":{activityBonusRules:[{value:1,activity:"manage-trade-agreements"}]}})).forEach((([e,i])=>{const s=t.structuresByName.get(e);if(void 0===s)throw new Error(`VK Adjustment typo: ${e}`);const a=JSON.parse(JSON.stringify(s));"Granary"===e&&(a.construction.skills[0].proficiencyRank=1),i.skillBonusRules?.forEach((e=>{void 0===a.skillBonusRules&&(a.skillBonusRules=[]),a.skillBonusRules?.push(e)})),i.activityBonusRules?.forEach((e=>{void 0===a.activityBonusRules&&(a.activityBonusRules=[]),a.activityBonusRules?.push(e)})),a.name=`${a.name} (V&K)`,t.structuresByName.set(a.name,a)}))},8422:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateUnrestPenalty=void 0,t.calculateUnrestPenalty=function(e){return e<1?0:e<4?1:e<8?2:e<12?3:4}},8480:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.manageKingdomActivitiesDialog=void 0;const s=i(6185),a=i(4767),n=i(6690),r=i(138);class ManageKingdomActivitiesDialog extends FormApplication{game;actor;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-manage-kingdom-activities",e.title="Manage Kingdom Activities",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/manage-activities.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.game=t.game,this.actor=t.actor}getData(){const e=(0,a.getKingdom)(this.actor);return{activities:this.buildActivities(e)}}async _updateObject(e,t){await(0,a.saveKingdom)(this.actor,{activityBlacklist:Object.entries(t).filter((([,e])=>!e)).map((([e])=>e))}),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,s.listenClick)(t,".add-activity",(async()=>{const e=(0,a.getKingdom)(this.actor);(0,r.addActivityDialog)({onOk:this.onSave.bind(this),homebrewActivities:e.homebrewActivities})})),(0,s.listenClick)(t,".edit-activity",(async e=>{const t=(0,a.getKingdom)(this.actor),i=e.currentTarget.dataset.id,s=t.homebrewActivities.find((e=>e.id===i));(0,r.addActivityDialog)({onOk:this.onSave.bind(this),activity:s,homebrewActivities:t.homebrewActivities})})),(0,s.listenClick)(t,".delete-activity",(async e=>{const t=e.currentTarget.dataset.id,i=(0,a.getKingdom)(this.actor);await(0,a.saveKingdom)(this.actor,{homebrewActivities:i.homebrewActivities.filter((e=>e.id!==t))}),this.render()}))}async onSave(e){const t=[...(0,a.getKingdom)(this.actor).homebrewActivities.filter((t=>t.id!==e.id)),e];await(0,a.saveKingdom)(this.actor,{homebrewActivities:t}),this.render()}buildActivities(e){const t=new Set(e.activityBlacklist),i=new Set(e.homebrewActivities.map((e=>e.id)));return(0,n.getKingdomActivities)(e.homebrewActivities).map((e=>({enabled:!t.has(e.id),title:e.title,id:e.id,isHomebrew:i.has(e.id)}))).sort(((e,t)=>e.title.localeCompare(t.title)))}}t.manageKingdomActivitiesDialog=function(e,t){new ManageKingdomActivitiesDialog(null,{game:e,actor:t}).render(!0)}},138:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addActivityDialog=void 0;const s=i(6185),a=i(6893),n=i(4309),r=i(3824);function o(e){return(0,s.isBlank)(e)?void 0:{msg:e}}class AddKingdomActivities extends FormApplication{onSubmitCallback;activity;edit;homebrewActivities;static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-add-kingdom-activities",e.title="Manage Kingdom Activities",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/add-activity-dialog.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e.width=400,e}constructor(e,t){super(e,t),this.onSubmitCallback=t.onOk,this.edit=void 0!==t.activity,this.activity={special:t.activity?.special??"",requirement:t.activity?.requirement??"",description:t.activity?.description??"",dcAdjustment:t.activity?.dcAdjustment??0,fortune:t.activity?.fortune??!1,failure:{msg:t.activity?.failure?.msg??""},success:{msg:t.activity?.success?.msg??""},criticalFailure:{msg:t.activity?.criticalFailure?.msg??""},criticalSuccess:{msg:t.activity?.criticalSuccess?.msg??""},dc:t.activity?.dc??"control",title:t.activity?.title??"",hint:t.activity?.hint??"",id:t.activity?.id??"",skills:t.activity?.skills??{agriculture:0},phase:t.activity?.phase??"leadership",oncePerRound:t.activity?.oncePerRound??!1,enabled:t.activity?.enabled??!0},this.homebrewActivities=t.homebrewActivities}async getData(){return{phases:["army","leadership","region"].map((e=>({label:(0,s.capitalize)(e),value:e}))),phase:this.activity.phase,dc:this.activity.dc,fortune:this.activity.fortune,edit:this.edit,hint:this.activity.hint??"",id:this.activity.id,title:this.activity.title,special:this.activity.special??"",requirement:this.activity.requirement??"",description:this.activity.description,oncePerRound:this.activity.oncePerRound,dcAdjustment:this.activity.dcAdjustment??0,criticalSuccess:this.activity.criticalSuccess?.msg??"",success:this.activity.success?.msg??"",failure:this.activity.failure?.msg??"",criticalFailure:this.activity.criticalFailure?.msg??"",dcs:["none","control","custom","scouting",...(0,s.range)(14,51).map((e=>e.toString()))].map((e=>({value:e,label:(0,s.deCamelCase)(e)}))),skills:Array.from(Object.entries(this.activity.skills)).map((([e,t])=>({proficiency:(0,r.rankToProficiency)(t),id:e,label:(0,s.capitalize)(e)}))),errors:await this.validate(this.activity)}}async _updateObject(e,t){var i;console.log(t),this.edit||(this.activity.id=t.id),this.activity.title=t.title,this.activity.description=t.description,this.activity.hint=(0,s.blankToUndefined)(t.hint),this.activity.special=(0,s.blankToUndefined)(t.special),this.activity.requirement=(0,s.blankToUndefined)(t.requirement),this.activity.phase=t.phase,this.activity.dc="control"===(i=t.dc)||"custom"===i||"none"===i||"scouting"===i?i:parseInt(i,10)||0,this.activity.dcAdjustment=t.dcAdjustment,this.activity.oncePerRound=t.oncePerRound,this.activity.fortune=t.fortune,this.activity.criticalSuccess=o(t.criticalSuccess),this.activity.success=o(t.success),this.activity.failure=o(t.failure),this.activity.criticalFailure=o(t.criticalFailure),this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];(0,s.listenClick)(t,".save",(async()=>{await this.onSubmitCallback(this.activity),await this.close()})),(0,s.listenClick)(t,".edit-skills",(async()=>{const e=this.activity.skills,t=Object.entries(e).map((([e,t])=>({id:e,proficiency:(0,r.rankToProficiency)(t)})))||void 0;(0,n.skillDialog)({selectedSkills:t,atLeastOne:!0,onSave:e=>{this.activity.skills=Object.fromEntries(e.selectedSkills.map((e=>[e.id,(0,r.proficiencyToRank)(e.proficiency)]))),this.render()},availableSkills:[...a.allSkills]})}))}async validate(e){const t=[];return/^[a-z\\-]+$/.test(e.id)||t.push("ID must only contain lower case English letters and hyphens!"),this.homebrewActivities.find((t=>e.id===t.id))&&!this.edit&&t.push(`Homebrew activity with id ${e.id} exists already, can not add another one`),(0,s.isBlank)(e.title)&&t.push("Title must not be blank"),t}}t.addActivityDialog=function(e){new AddKingdomActivities(null,e).render(!0)}},567:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddBonusFeatDialog=void 0;class AddBonusFeatDialog extends FormApplication{feats;onOk;selected="-";static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-add-bonus-feat",e.title="Kingdom",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/add-bonus-feat.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}constructor(e,t){super(e,t),this.feats=t.feats,this.onOk=t.onOk}getData(e){return{feats:this.feats,selected:this.selected,feat:this.feats.find((e=>e.name===this.selected)),...super.getData(e)}}async _updateObject(e,t){this.selected=t.selected,this.render()}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector("button")?.addEventListener("click",(async()=>{const e=this.feats.find((e=>e.name===this.selected));this.onOk({id:e.name}),await this.close()}))}}t.AddBonusFeatDialog=AddBonusFeatDialog},9522:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addEffectDialog=void 0;const s=i(1290),a=i(3824),n=i(6185),r=i(6893),o=i(5593),l=a.allModifierTypes.flatMap((e=>"vacancy"===e?[{label:(0,n.capitalize)(e)+" Penalty",value:`${e}-penalty`}]:[{label:(0,n.capitalize)(e)+" Bonus",value:`${e}-bonus`},{label:(0,n.capitalize)(e)+" Penalty",value:`${e}-penalty`}])),c=(0,n.createLabels)(s.allKingdomPhases),u=(0,n.createLabels)(r.allSkills),d=(0,n.createLabels)(o.allAbilities);function m(e){const t=(0,n.createLabels)(e,!0);return`\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-effect-name">Name</label>\n                <input type="text" name="name" id="km-effect-name">\n            </div>\n            <div>\n                <label for="km-effect-type"></label>\n                <select name="type" id="km-effect-type">\n                    ${l.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-value">Value</label>\n                <input type="number" name="value" id="km-effect-value">\n            </div>\n            <div>\n                <label for="km-effect-phase">Phase</label>\n                <select name="phase" id="km-effect-phase">\n                    <option value="-">-</option>\n                    ${c.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-activity">Activity</label>\n                <select name="activity" id="km-effect-activity">\n                    <option value="-">-</option>\n                    ${t.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-ability">Ability</label>\n                <select name="ability" id="km-effect-ability">\n                    <option value="-">-</option>\n                    ${d.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-skill">Skill</label>\n                <select name="skill" id="km-effect-skill">\n                    <option value="-">-</option>\n                    ${u.map((e=>`<option value="${e.value}">${e.label}</option>`))}\n                </select>\n            </div>\n            <div>\n                <label for="km-effect-enabled">Enabled</label>\n                <input type="checkbox" name="enabled" id="km-effect-enabled" checked>\n            </div>\n            <div>\n                <label for="km-effect-turns">Turns (0 for indefinite)</label>\n                <input type="number" name="turns" id="km-effect-turns" value="1">\n            </div>\n            <div>\n                <label for="km-effect-consumable">Consume after Use</label>\n                <input type="checkbox" name="consumable" id="km-effect-consumable">\n            </div>\n        </form>\n        `}function h(e,t){const i=(0,n.parseSelect)(e,t);return"-"===i?void 0:[i]}t.addEffectDialog=function(e,t){new Dialog({title:"Add Effect",content:m(e),buttons:{add:{icon:'<i class="fa-solid fa-plus"></i>',label:"Add",callback:async e=>{const i=e,s=(0,n.parseNumberInput)(i,"turns"),{type:a,value:r}=function(e,t){const[i,s]=e.split("-");return"penalty"===s?{type:i,value:-Math.abs(t)}:{type:i,value:Math.abs(t)}}((0,n.parseSelect)(i,"type"),(0,n.parseNumberInput)(i,"value")),o=h(i,"phase"),l=h(i,"activity"),c=h(i,"skill"),u=h(i,"ability");t({name:(0,n.parseTextInput)(i,"name"),type:a,value:r,enabled:(0,n.parseCheckbox)(i,"enabled"),consumeId:(0,n.parseCheckbox)(i,"consumable")?crypto.randomUUID():void 0,phases:o,activities:l,skills:c,abilities:u,turns:0===s?void 0:s})}}},default:"add"},{jQuery:!1,width:400}).render(!0)}},5970:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addGroupDialog=void 0,t.addGroupDialog=function(e){new Dialog({title:"Add Group",content:'\n        <form class="simple-dialog-form">\n            <div>\n                <label>Name</label> \n                <input name="name" type="text">\n            </div>\n            <div>\n                <label>Negotiation DC</label>\n                <input name="negotiationDC" type="number">\n            </div>\n        </form>\n        ',buttons:{add:{icon:'<i class="fa-solid fa-plus"></i>',label:"Add",callback:async t=>{const i=t,s=i.querySelector("input[name=name]"),a=i.querySelector("input[name=negotiationDC]"),n=parseInt(a.value,10),r={name:s.value,negotiationDC:isNaN(n)?0:n,atWar:!1,relations:"none"};e(r)}}},default:"add"},{jQuery:!1,width:380}).render(!0)}},3195:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addOngoingEventDialog=void 0,t.addOngoingEventDialog=function(e){new Dialog({title:"Add Ongoing Event",content:'\n        <form class="simple-dialog-form">\n            <div>\n                <label>Name</label> \n                <input name="name" type="text">\n            </div>\n        </form>\n        ',buttons:{add:{icon:'<i class="fa-solid fa-plus"></i>',label:"Add",callback:async t=>{const i=t.querySelector("input[name=name]");e(i.value)}}},default:"add"},{jQuery:!1,width:380}).render(!0)}},3306:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showArmyBrowser=void 0;const s=i(8937),a=i(9884),n=i(4913),r=i(6185);class ArmyBrowserApp extends FormApplication{game;kingdom;sheetActor;onRoll;armies;static get defaultOptions(){const e=super.defaultOptions;return e.id="army-browser-app",e.title="Army Browser",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/army-browser.hbs",e.classes=["kingmaker-tools-app","army-browser-app"],e.height="auto",e.width=500,e.submitOnChange=!0,e.closeOnSubmit=!1,e}constructor(e){super(null,e),this.game=e.game,this.kingdom=e.kingdom,this.sheetActor=e.sheetActor,this.onRoll=e.onRoll,this.armies=this.getArmies()}getArmies(){return(0,n.getPlayerArmies)(this.game)}async getData(){return{armies:await this.toView(this.armies),isGM:(0,r.isGm)(this.game)}}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelectorAll(".km-tactic-link").forEach((e=>e.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.uuid,i=await fromUuid(t);i?.sheet?.render(!0)})))),(0,r.listenClick)(t,".km-import-basic-armies",(async()=>{ui.notifications?.info("Importing Basic Armies into Player Armies folder");const e=await Folder.create({name:"Recruitable Armies",type:"Actor",parent:null,color:null}),t=(await(this.game.packs.get("pf2e.kingmaker-bestiary")?.getDocuments())??[]).filter((e=>"army"===e.type&&e.name?.startsWith("Basic"))).map((t=>({...t.toObject(),folder:e?.id,permission:0,ownership:{default:3}})));await Actor.createDocuments(t),ui.notifications?.info("Finished Import"),this.armies=this.getArmies(),this.render()})),t.querySelectorAll(".km-recruit-army").forEach((e=>e.addEventListener("click",(e=>this.trainTactic(e)))))}async _updateObject(e,t){console.log(t),this.render()}async trainTactic(e){const t=e.currentTarget.dataset.id,i=await fromUuid(t);if(null!==i&&(0,n.isPlayerArmyActor)(i)){const e=await TextEditor.enrichHTML((0,r.createUUIDLink)(i.uuid));new s.CheckDialog(null,{activity:"recruit-army",kingdom:this.kingdom,overrideSkills:(0,n.isSpecialArmy)(i)?{statecraft:0}:{warfare:0},dc:i.system.recruitmentDC,game:this.game,type:"activity",onRoll:this.onRoll,actor:this.sheetActor,afterRoll:async()=>{await this.close()},additionalChatMessages:[{[a.DegreeOfSuccess.CRITICAL_SUCCESS]:e,[a.DegreeOfSuccess.SUCCESS]:e}]}).render(!0)}}async toView(e){return await Promise.all(e.filter((e=>null!==e.name)).sort(((e,t)=>e.name.localeCompare(t.name))).map((async e=>({link:await TextEditor.enrichHTML((0,r.createUUIDLink)(e.uuid)),dc:e.system.recruitmentDC,name:e.name,uuid:e.uuid,special:(0,n.isSpecialArmy)(e),type:(0,r.capitalize)(e.system.traits.type)}))))}}t.showArmyBrowser=async function(e){new ArmyBrowserApp(e).render(!0)}},9774:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showArmyTacticsBrowser=void 0;const s=i(8937),a=i(9884),n=i(4913),r=i(6185);class ArmyTacticsBrowserApp extends FormApplication{game;army;kingdom;sheetActor;onRoll;static get defaultOptions(){const e=super.defaultOptions;return e.id="army-tactics-browser-app",e.title="Army Tactics Browser",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/army-tactics-browser.hbs",e.classes=["kingmaker-tools-app","army-tactics-browser-app"],e.height="auto",e.submitOnChange=!0,e.closeOnSubmit=!1,e}constructor(e){super(null,e),this.game=e.game,this.army=e.army,this.kingdom=e.kingdom,this.sheetActor=e.sheetActor,this.onRoll=e.onRoll}async getData(){const e=await(0,n.getArmyTactics)(this.game);return{tactics:await this.toViewTactics(e)}}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelectorAll(".km-tactic-link").forEach((e=>e.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.uuid,i=await fromUuid(t);i?.sheet?.render(!0)})))),t.querySelectorAll(".km-train-tactic").forEach((e=>e.addEventListener("click",(e=>this.trainTactic(e)))))}async _updateObject(e,t){console.log(t),this.render()}async trainTactic(e){const t=e.currentTarget.dataset.id,i=await fromUuid(t);if(null!==i&&(0,n.isArmyTactic)(i)){const e=await TextEditor.enrichHTML((0,r.createUUIDLink)(i.uuid));new s.CheckDialog(null,{activity:"train-army",kingdom:this.kingdom,dc:(0,r.getLevelBasedDC)(i.system.level.value),game:this.game,type:"activity",onRoll:this.onRoll,actor:this.sheetActor,afterRoll:async()=>{await this.close()},additionalChatMessages:[{[a.DegreeOfSuccess.CRITICAL_SUCCESS]:e,[a.DegreeOfSuccess.SUCCESS]:e}]}).render(!0)}}async toViewTactics(e){return await Promise.all(e.filter((e=>e.system.traits.value.includes(this.army.system.traits.type)&&!(0,r.hasArmyTactic)(this.army,e))).sort(((e,t)=>e.system.level.value-t.system.level.value||e.name.localeCompare(t.name))).map((async e=>{const t=e.system.level.value;return{enabled:t<=this.army.level,link:await TextEditor.enrichHTML((0,r.createUUIDLink)(e.uuid)),level:t,dc:(0,r.getLevelBasedDC)(t),name:e.name,uuid:e.uuid}})))}}t.showArmyTacticsBrowser=async function(e){new ArmyTacticsBrowserApp(e).render(!0)}},8937:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CheckDialog=void 0;const s=i(3824),a=i(1290),n=i(6893),r=i(8534),o=i(7894),l=i(6185),c=i(6690),u=i(1694),d=i(1098),m=i(1451),h=i(4913);function p(e){return e.modifiers.filter((e=>e.enabled)).map((e=>({type:e.type,value:e.value,name:e.name})))}class CheckDialog extends FormApplication{type;activity;skill;game;kingdom;selectedSkill;dc;phase="event";customModifiers={item:{bonus:0,penalty:0},circumstance:{bonus:0,penalty:0},status:{bonus:0,penalty:0},untyped:{bonus:0,penalty:0}};modifierOverrides={};consumeModifiers=new Set;onRoll;actor;overrideSkills;afterRoll;rollOptions=[];rollMode="publicroll";additionalChatMessages;constructor(e,t){super(e,t),this.type=t.type,this.activity=t.activity,this.skill=t.skill,this.game=t.game,this.kingdom=t.kingdom,this.actor=t.actor,this.additionalChatMessages=t.additionalChatMessages??[],this.onRoll=t.onRoll,this.afterRoll=t.afterRoll??(async()=>{}),this.overrideSkills=t.overrideSkills;const i=(0,m.getStringSetting)(this.game,"automateResources"),{size:s}=(0,d.getStolenLandsData)(this.game,i,this.kingdom),a=(0,o.getControlDC)(this.kingdom.level,s,this.kingdom.leaders.ruler.vacant);if("skill"===this.type)this.selectedSkill=t.skill,this.dc=t.dc??a;else{const e=(0,c.getKingdomActivitiesById)(this.kingdom.homebrewActivities);this.phase=e[this.activity].phase,this.selectedSkill=this.getActivitySkills(t.kingdom.skillRanks,e)[0];const i=e[this.activity],s=i.dc;if(void 0!==t.dc)this.dc=t.dc;else if("control"===s)this.dc=a;else if("custom"===s)this.dc=0;else if("scouting"===s)this.dc=(0,h.getScoutingDC)(this.game);else{if("none"===s)throw Error("Can not perform activity with no DC");this.dc=s}this.dc=this.dc+(i.dcAdjustment??0)}}static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-check",e.title="Skill Check",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/check.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e}getData(e){const t=(0,d.getActiveSettlementStructureResult)(this.game,this.kingdom),i=(0,d.getSettlement)(this.game,this.kingdom,this.kingdom.activeSettlement),n=(0,c.getKingdomActivitiesById)(this.kingdom.homebrewActivities),r="skill"===this.type?[this.skill]:this.getActivitySkills(this.kingdom.skillRanks,n),u=(0,s.createActiveOtherModifiers)(this.kingdom,i?.settlement,t,(0,d.getSettlementsWithoutLandBorders)(this.game,this.kingdom)).concat((0,h.getArmyModifiers)(this.game));if((0,o.hasFeat)(this.kingdom,"Practical Magic (V&K)")){const e={skills:["engineering"],value:1,type:"circumstance",name:"Practical Magic",enabled:!0};2===this.kingdom.skillRanks.magic?u.push(e):this.kingdom.skillRanks.magic>2&&u.push({...e,value:2})}this.kingdom.unrest>0&&(0,o.hasFeat)(this.kingdom,"Inspiring Entertainment")&&u.push({name:"Inspiring Entertainment",type:"circumstance",enabled:!0,abilities:["culture"],value:2});const m=this.createCustomModifiers(this.customModifiers),f=this.calculateModifiers(r,t,u,m,n),g=this.calculateModifiers(r,t,[...u,{enabled:!0,type:"circumstance",value:2,name:"Creative Solution"}],m,n)[this.selectedSkill],y=this.calculateModifiers(["magic"],t,u,m,n).magic,v=f[this.selectedSkill];this.rollOptions=v.total.rollOptions,this.consumeModifiers=new Set(v.modifiers.filter((e=>e.enabled&&void 0!==e.consumeId)).map((e=>e.consumeId)));const b=(0,l.encodeJson)({creativeSolution:p(g),supernaturalSolution:p(y),selected:p(v)});return{...super.getData(e),invalid:void 0===this.selectedSkill,dc:this.dc,title:this.activity?(0,l.unslugify)(this.activity):(0,l.capitalize)(this.skill),activity:this.activity,selectableSkills:this.createSelectableSkills(f),selectedSkill:this.selectedSkill,modifiers:this.createModifiers(v),phase:this.phase,customModifiers:this.customModifiers,creativeSolutionModifier:g.total.value,supernaturalSolutionModifier:y.total.value,modifierBreakdown:b,rollMode:this.rollMode,rollModeChoices:l.rollModeChoices,phases:(0,l.toLabelAndValue)([...a.allKingdomPhases],{capitalizeLabel:!0}),overrides:(0,l.toLabelAndValue)(["enabled","disabled"],{emptyChoice:"-",capitalizeLabel:!0}),assuranceDisabled:this.shouldDisableAssurance(this.kingdom,this.selectedSkill)}}shouldDisableAssurance(e,t){const i=`Kingdom Assurance (${(0,l.capitalize)(t)})`;return!(0,o.hasFeat)(e,i)}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector("#km-roll-skill-assurance")?.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.dc??"0",10),s=parseInt(t.dataset.modifier??"0",10),a=parseInt(t.dataset.creativeSolutionModifier??"0",10),n=parseInt(t.dataset.supernaturalSolutionModifier??"0",10),r=t.dataset.activity,l=t.dataset.type,d=t.dataset.skill,m=`${s}`,h=await(0,u.rollCheck)({formula:m,label:l,activity:r?(0,c.getKingdomActivitiesById)(this.kingdom.homebrewActivities)[r]:void 0,dc:i,skill:d,modifier:s,actor:this.actor,adjustDegreeOfSuccess:(0,u.cooperativeLeadership)((0,o.hasFeat)(this.kingdom,"Cooperative Leadership"),this.kingdom.level,this.kingdom.skillRanks[d],[...this.rollOptions]),rollOptions:this.rollOptions,creativeSolutionModifier:a,supernaturalSolutionModifier:n,rollType:"selected",rollMode:this.rollMode,additionalChatMessages:this.additionalChatMessages});await this.onRoll(this.consumeModifiers),await this.afterRoll(h),await this.close()})),t.querySelector("#km-roll-skill")?.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.dc??"0",10),s=parseInt(t.dataset.modifier??"0",10),a=t.dataset.activity,n=t.dataset.type,r=t.dataset.modifierBreakdown,l=t.dataset.skill,d=parseInt(t.dataset.creativeSolutionModifier??"0",10),m=parseInt(t.dataset.supernaturalSolutionModifier??"0",10),h=`1d20+${s}`,p=await(0,u.rollCheck)({formula:h,label:n,activity:a?(0,c.getKingdomActivitiesById)(this.kingdom.homebrewActivities)[a]:void 0,dc:i,skill:l,modifier:s,modifierBreakdown:r,actor:this.actor,adjustDegreeOfSuccess:(0,u.cooperativeLeadership)((0,o.hasFeat)(this.kingdom,"Cooperative Leadership"),this.kingdom.level,this.kingdom.skillRanks[l],[...this.rollOptions]),rollOptions:this.rollOptions,creativeSolutionModifier:d,supernaturalSolutionModifier:m,rollType:"selected",rollMode:this.rollMode,additionalChatMessages:this.additionalChatMessages});await this.onRoll(this.consumeModifiers),await this.afterRoll(p),await this.close()}))}async _updateObject(e,t){const i=foundry.utils.expandObject(t);console.log(i),this.selectedSkill=i.selectedSkill,this.dc=i.dc,this.phase=i.phase,this.rollMode=i.rollMode,this.customModifiers=this.homogenize(i.customModifiers),this.modifierOverrides=Object.entries(i.overrideModifiers??{}).filter((([,e])=>"-"!==e)).map((([e,t])=>({[e]:"enabled"===t}))).reduce(((e,t)=>Object.assign(e,t)),{}),this.render()}getActivitySkills(e,t){const i=this.activity,s=new Set(["celebrate-holiday","craft-luxuries","create-a-masterpiece","rest-and-relax"]),n=(0,m.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements")?void 0:e,r=(0,a.getActivitySkills)(this.overrideSkills??t[i].skills,n),l=r.includes("engineering")&&(0,o.hasFeat)(this.kingdom,"Practical Magic")?["magic"]:[],c=this.kingdom.settings.expandMagicUse&&s.has(i)?["magic"]:[];return Array.from(new Set([...r,...c,...l]))}calculateModifiers(e,t,i,a,o){return Object.fromEntries(e.map((e=>{const l=(0,r.createSkillModifiers)({ruin:this.kingdom.ruin,unrest:this.kingdom.unrest,skillRank:this.kingdom.skillRanks[e],abilityScores:this.kingdom.abilityScores,leaders:this.kingdom.leaders,kingdomLevel:this.kingdom.level,untrainedProficiencyMode:(0,s.getUntrainedProficiencyMode)(this.game),ability:n.skillAbilities[e],skillItemBonus:t?.merged?.skillBonuses?.[e],additionalModifiers:[...i,...a],activity:this.activity,phase:this.phase,skill:e,overrides:this.modifierOverrides,activities:o});return[e,{total:(0,s.calculateModifiers)(l),modifiers:l}]})))}createSelectableSkills(e){return Object.entries(e).map((([e,t])=>{const i=t.total.value,s=i>=0?`+${i}`:i;return{label:`${(0,l.capitalize)(e)} ${s}`,value:e}}))}createCustomModifiers(e){return Object.entries(e).flatMap((([e,t])=>[{value:t.bonus,type:e,name:(0,l.capitalize)(e)+" Bonus",enabled:!0},{value:-t.penalty,type:e,name:(0,l.capitalize)(e)+" Penalty",enabled:!0}]))}createModifiers(e){if(e){const t=e.total.value;return{total:t,totalLabel:t>=0?`+${t}`:t,assurance:e.total.assurance,modifiers:e.modifiers.map((e=>{const t=(0,l.capitalize)(e.type),i=this.modifierOverrides[e.id];return{name:e.name,type:e.value<0?`${t} Penalty`:`${t} Bonus`,value:e.value,enabled:e.enabled,override:void 0===i?"-":i?"enabled":"disabled",id:e.id,consumable:void 0!==e.consumeId&&this.consumeModifiers.has(e.consumeId)}}))}}}homogenize(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,{bonus:Math.abs(t.bonus),penalty:Math.abs(t.penalty)}])))}}t.CheckDialog=CheckDialog},5317:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.editSettlementDialog=void 0;const s=i(6185);t.editSettlementDialog=function(e,t,i,a){const n=!0===i.manualSettlementLevel||!e;new Dialog({title:`Edit Settlement: ${t}`,content:`\n        <form class="simple-dialog-form">\n            <div>\n                <label>Type</label>\n                <select name="type">\n                    <option value="capital" ${"capital"===i.type?"selected":""}>Capital</option>\n                    <option value="settlement" ${"settlement"===i.type?"selected":""}>Settlement</option>\n                </select>\n            </div>\n            <div ${n?"":"hidden"}>\n                <label>Occupied Blocks</label>\n                <input name="lots" type="number" value="${i.lots}">\n            </div>\n            <div ${n?"":"hidden"}>\n                <label>Level</label>\n                <input name="level" type="number" value="${i.level}">\n            </div>\n            <div>\n                <label>Water Borders</label>\n                <input name="waterBorders" type="number" value="${i.waterBorders}">\n            </div>\n            <div>\n                <label>Secondary Territory</label>\n                <input name="secondaryTerritory" type="checkbox" ${i.secondaryTerritory?"checked":""}>\n            </div>\n            <div>\n                <label>Manual Settlement Level (reopen dialog after saving)</label>\n                <input name="manualSettlementLevel" type="checkbox" ${!0===i.manualSettlementLevel?"checked":""}>\n            </div>\n        </form>\n        `,buttons:{save:{icon:'<i class="fa-solid fa-save"></i>',label:"Save",callback:async e=>{const t=e;a({level:(0,s.parseNumberInput)(t,"level"),secondaryTerritory:(0,s.parseCheckbox)(t,"secondaryTerritory"),type:(0,s.parseSelect)(t,"type"),lots:(0,s.parseNumberInput)(t,"lots"),waterBorders:(0,s.parseNumberInput)(t,"waterBorders"),sceneId:i.sceneId,manualSettlementLevel:(0,s.parseCheckbox)(t,"manualSettlementLevel")})}}},default:"save"},{jQuery:!1,width:580}).render(!0)}},5639:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showKingdomSettings=void 0;const s=i(1451),a=i(4913),n=i(6185),r=i(4767);class KingdomSettings extends FormApplication{game;onSave;data;actor;kingdom;constructor(e){super(null,e),this.game=e.game,this.onSave=e.onSave,this.actor=e.sheetActor,this.kingdom=(0,r.getKingdom)(this.actor),this.data={expandMagicUse:this.kingdom.settings.expandMagicUse,allStructuresItemBonusesStack:(0,s.getBooleanSetting)(this.game,"kingdomAllStructureItemBonusesStack"),ignoreSkillRequirements:(0,s.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements"),automaticallyCalculateArmyConsumption:(0,s.getBooleanSetting)(this.game,"autoCalculateArmyConsumption"),doubleSkillIncreases:(0,s.getBooleanSetting)(this.game,"kingdomSkillIncreaseEveryLevel"),rpToXpConversionLimit:(0,s.getNumberSetting)(this.game,"rpToXpConversionLimit"),rpToXPConversionRate:(0,s.getNumberSetting)(this.game,"rpToXpConversionRate"),untrainedSkillProficiency:this.getUntrainedProficiency(),vkXpRules:(0,s.getBooleanSetting)(this.game,"vanceAndKerensharaXP"),xpPerClaimedHex:(0,s.getNumberSetting)(this.game,"xpPerClaimedHex"),cultOfTheBloomEvents:(0,s.getBooleanSetting)(this.game,"cultOfTheBloomEvents"),autoCalculateSettlementLevel:(0,s.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),kingdomEventsTable:(0,s.getStringSetting)(this.game,"kingdomEventsTable"),kingdomCultTable:(0,s.getStringSetting)(this.game,"kingdomCultTable"),kingdomEventRollMode:(0,s.getStringSetting)(this.game,"kingdomEventRollMode"),capitalInvestmentInCapital:(0,s.getBooleanSetting)(this.game,"capitalInvestmentInCapital"),reduceDCToBuildLumberStructures:(0,s.getBooleanSetting)(this.game,"reduceDCToBuildLumberStructures"),automateResources:(0,s.getStringSetting)(this.game,"automateResources"),rollModeChoices:n.rollModeChoices,untrainedSkillProficiencies:[{value:"level",label:"Full Level"},{value:"halfLevel",label:"Half Level"},{value:"none",label:"None"}],automateResourcesChoices:[{value:"kingmaker",label:"Official Module"},{value:"tileBased",label:"Tile/Drawing Based"},{value:"manual",label:"Manual"}],maxFamePoints:this.kingdom.fame.max}}static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-settings",e.title="Kingdom Settings",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/settings.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=[],e.height="auto",e.width=600,e}getData(){return this.data}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector(".save")?.addEventListener("click",(async()=>{await this.save(),await this.close(),this.onSave()}))}async _updateObject(e,t){this.data={...this.data,...foundry.utils.expandObject(t)},this.render(),console.log(this.data)}getUntrainedProficiency(){return(0,s.getBooleanSetting)(this.game,"kingdomAlwaysAddLevel")?"level":(0,s.getBooleanSetting)(this.game,"kingdomAlwaysAddHalfLevel")?"halfLevel":"none"}async save(){await(0,s.setSetting)(this.game,"kingdomAllStructureItemBonusesStack",this.data.allStructuresItemBonusesStack),await(0,s.setSetting)(this.game,"autoCalculateArmyConsumption",this.data.automaticallyCalculateArmyConsumption),await(0,s.setSetting)(this.game,"kingdomSkillIncreaseEveryLevel",this.data.doubleSkillIncreases),await(0,s.setSetting)(this.game,"rpToXpConversionLimit",this.data.rpToXpConversionLimit),await(0,s.setSetting)(this.game,"rpToXpConversionRate",this.data.rpToXPConversionRate),await(0,s.setSetting)(this.game,"vanceAndKerensharaXP",this.data.vkXpRules),await(0,s.setSetting)(this.game,"xpPerClaimedHex",this.data.xpPerClaimedHex),await(0,s.setSetting)(this.game,"cultOfTheBloomEvents",this.data.cultOfTheBloomEvents),await(0,s.setSetting)(this.game,"kingdomEventsTable",this.data.kingdomEventsTable),await(0,s.setSetting)(this.game,"kingdomCultTable",this.data.kingdomCultTable),await(0,s.setSetting)(this.game,"kingdomEventRollMode",this.data.kingdomEventRollMode),await(0,s.setSetting)(this.game,"kingdomIgnoreSkillRequirements",this.data.ignoreSkillRequirements),await(0,s.setSetting)(this.game,"autoCalculateSettlementLevel",this.data.autoCalculateSettlementLevel),await(0,s.setSetting)(this.game,"capitalInvestmentInCapital",this.data.capitalInvestmentInCapital),await(0,s.setSetting)(this.game,"reduceDCToBuildLumberStructures",this.data.reduceDCToBuildLumberStructures),await(0,s.setSetting)(this.game,"automateResources",this.data.automateResources),await(0,r.saveKingdom)(this.actor,{settings:{expandMagicUse:this.data.expandMagicUse}}),"level"===this.data.untrainedSkillProficiency?(await(0,s.setSetting)(this.game,"kingdomAlwaysAddLevel",!0),await(0,s.setSetting)(this.game,"kingdomAlwaysAddHalfLevel",!1)):"halfLevel"===this.data.untrainedSkillProficiency?(await(0,s.setSetting)(this.game,"kingdomAlwaysAddLevel",!1),await(0,s.setSetting)(this.game,"kingdomAlwaysAddHalfLevel",!0)):(await(0,s.setSetting)(this.game,"kingdomAlwaysAddLevel",!1),await(0,s.setSetting)(this.game,"kingdomAlwaysAddHalfLevel",!1)),this.data.automaticallyCalculateArmyConsumption&&await(0,a.updateKingdomArmyConsumption)({kingdomActor:this.actor,game:this.game,forceUpdate:!0}),await(0,r.saveKingdom)(this.actor,{fame:{...this.kingdom.fame,now:(0,n.clamped)(this.kingdom.fame.now,0,this.data.maxFamePoints),next:(0,n.clamped)(this.kingdom.fame.next,0,this.data.maxFamePoints),max:Math.max(this.data.maxFamePoints,0)}})}}t.showKingdomSettings=function(e){new KingdomSettings(e).render(!0)}},1032:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kingdomSizeDialog=void 0;const s=i(7894),a=i(6185);class KingdomSizeDialog extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"modules/pf2e-kingmaker-tools/templates/kingdom/kingdom-size-help.hbs",classes:["dialog"],width:"auto",jQuery:!1})}getData(){return{data:s.kingdomSizeData.map((e=>({size:e.sizeFrom+(e.sizeTo?"-"+e.sizeTo:""),type:(0,a.capitalize)(e.type),dice:"1"+e.resourceDieSize,modifier:"+"+e.controlDCModifier,storage:e.commodityCapacity})))}}}t.kingdomSizeDialog=function(){(new KingdomSizeDialog).render(!0)}},5388:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.settlementSizeDialog=void 0;const s=i(5302);class SettlementSizeDialog extends Application{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:"modules/pf2e-kingmaker-tools/templates/kingdom/settlement-size-help.hbs",classes:["dialog"],width:"auto",jQuery:!1})}getData(){return{data:s.settlementTypeData.map((e=>({type:e.type,blocks:e.maximumLots,population:e.population,level:e.levelFrom&&e.levelTo?e.levelFrom!==e.levelTo?e.levelFrom+"-"+e.levelTo:e.levelFrom:e.levelFrom+"+",consumption:e.consumption,maxItemBonus:"+"+e.maxItemBonus,influence:1===e.influence?"1 hex":e.influence+" hexes"})))}}}t.settlementSizeDialog=function(){(new SettlementSizeDialog).render(!0)}},1145:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showSettlement=void 0;const s=i(6185),a=i(5302),n=i(7894),r=i(1098),o=i(1451),l=i(6690);class SettlementApp extends Application{kingdom;static get defaultOptions(){const e=super.defaultOptions;return e.id="settlement-app",e.title="Settlement",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/settlement.hbs",e.classes=["kingmaker-tools-app","settlement-app"],e.width=400,e.height="auto",e}game;settlementId;nav="status";constructor(e){super(e),this.game=e.game,this.settlementId=e.settlementId,this.kingdom=e.kingdom}async getData(){const e=(0,r.getSettlement)(this.game,this.kingdom,this.settlementId),t=(0,r.getCapitalSettlement)(this.game,this.kingdom),i=(0,r.getStructureStackMode)(this.game),a=(0,o.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),n=(0,l.getKingdomActivitiesById)(this.kingdom.homebrewActivities),c=(0,r.getStructureResult)(i,a,n,e,this.kingdom.level,t),u=await this.getBuiltStructures(e),d=this.getStorage(c),m=(0,r.getSettlementInfo)(e,a,this.kingdom.level),h=this.getSkillBonuses(c.skillBonuses),p=c.notes.length>0,f=Object.keys(d).length>0,g=h.map((e=>e.value>0||e.actions.some((e=>e.value>0)))),y=u.length>0;return"capital"===e.settlement.type&&(c.config.influence=Math.max(c.config.influence,1),m.lots>1&&(c.consumption=2),m.lots>4&&(c.consumption=4),m.lots>9&&(c.consumption=6)),"effects"!==this.nav||p||(this.nav="status"),"storage"!==this.nav||f||(this.nav="status"),"bonuses"!==this.nav||g||(this.nav="status"),"buildings"!==this.nav||y||(this.nav="status"),{name:e.scene.name,type:(0,s.capitalize)(e.settlement.type),secondaryTerritory:e.settlement.secondaryTerritory,hasBridge:c.hasBridge,waterBorders:e.settlement.waterBorders,...m,...this.getActiveTabs(),config:c.config,builtStructures:u,hasStorage:f,hasEffects:p,hasBonuses:g,hasBuildings:y,overcrowded:m.lots>c.residentialLots,residentialLots:c.residentialLots,consumption:c.consumption,consumptionSurplus:c.consumptionSurplus,capitalInvestmentPossible:c.allowCapitalInvestment?"yes":"no",settlementEventBonus:c.settlementEventBonus,leadershipActivityBonus:c.leadershipActivityBonus,notes:c.notes,leadershipActivities:c.increaseLeadershipActivities?3:2,availableItems:this.getAvailableItems(m.level,c.itemLevelBonuses),storage:d,skillItemBonuses:h}}sceneChange(){this.render()}activateListeners(e){super.activateListeners(e),Hooks.on("createToken",this.sceneChange.bind(this)),Hooks.on("sightRefresh",this.sceneChange.bind(this)),Hooks.on("deleteToken",this.sceneChange.bind(this));const t=e[0];t.querySelectorAll(".km-nav a")?.forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget;this.nav=t.dataset.tab,this.render()}))}))}close(e){return Hooks.off("createToken",this.sceneChange),Hooks.off("sightRefresh",this.sceneChange),Hooks.off("deleteToken",this.sceneChange),super.close(e)}getAvailableItems(e,t){const i=(0,n.hasFeat)(this.kingdom,"Quality of Life")?1:0,s=(0,a.calculateAvailableItems)(t,e,i),r=(0,a.groupAvailableItems)(s);return Array.from(Object.entries(r)).map((([e,t])=>({label:c[e],value:t})))}getStorage(e){return Object.entries(e.storage).filter((([,e])=>e>0)).map((([e,t])=>({label:(0,s.capitalize)(e),value:t})))}getSkillBonuses(e){return Object.entries(e).filter((([,e])=>e.value>0||e.activities&&Object.keys(e.activities).length>0)).map((([e,t])=>({label:(0,s.capitalize)(e),value:t.value,actions:Object.entries(t.activities).map((([e,t])=>({label:(0,s.unslugify)(e),value:t})))})))}async getBuiltStructures(e){const t=(0,r.getSceneActorStructures)(e.scene),i=(0,a.countStructureOccurrences)(t);return await Promise.all(Array.from(i.entries()).sort((([e],[t])=>e.localeCompare(t))).map((([,e])=>[e.item,e.count])).map((async([e,t])=>({link:await TextEditor.enrichHTML((0,s.createUUIDLink)(e.actor.uuid,e.name)),occurrences:t}))))}getActiveTabs(){return{statusTab:"status"===this.nav,bonusesTab:"bonuses"===this.nav,effectsTab:"effects"===this.nav,shoppingTab:"shopping"===this.nav,buildingsTab:"buildings"===this.nav,storageTab:"storage"===this.nav}}}t.showSettlement=async function(e,t,i){new SettlementApp({game:e,settlementId:t,kingdom:i}).render(!0)};const c={alchemical:"Alchemical",magical:"Magical",luxuryMagical:"Magical (Luxury)",arcane:"Arcane",luxuryArcane:"Arcane (Luxury)",divine:"Divine",luxuryDivine:"Divine (Luxury)",occult:"Occult",luxuryOccult:"Occult (Luxury)",primal:"Primal",luxuryPrimal:"Primal (Luxury)",other:"Other"}},3934:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setupDialog=void 0,t.setupDialog=function(e,t,i){new Dialog({title:`${t} Sheet Setup`,content:`\n        <p>No ${t} Sheet found! Click "Import" which creates an NPC actor called "${t} Sheet" which will be used to store your data. Adjust permissions as usual to give your players access</p>\n        `,buttons:{importSheet:{icon:'<i class="fa-solid fa-plus"></i>',label:"Import",callback:async()=>{i()}}},default:"importSheet"},{jQuery:!1,width:380}).render(!0)}},6492:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showHelpDialog=void 0;const s=i(6690),a=i(6185),n=i(3824),r=i(171),o=i(4767);class HelpApplication extends Application{activity;game;actor;constructor(e){super(e),this.activity=e.activity,this.game=e.game,this.actor=e.actor}static get defaultOptions(){const e=super.defaultOptions;return e.id="help-app",e.title="Help",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/help.hbs",e.classes=["kingmaker-tools-app","help-app"],e.width=500,e.height="auto",e}async getData(){const e=(0,o.getKingdom)(this.actor),t=(0,s.getKingdomActivitiesById)(e.homebrewActivities)[this.activity],i=(t.fortune?[(0,a.capitalize)(t.phase),"Downtime","Fortune"]:[(0,a.capitalize)(t.phase),"Downtime"]).join(", "),r=Object.entries(t.skills).map((([e,t])=>0===t?(0,a.capitalize)(e):`${(0,a.capitalize)(e)}: ${(0,n.rankToLabel)(t)}`)).join(", ");return{...t,criticalSuccess:await this.enrichIfDefined(t.criticalSuccess?.msg),success:await this.enrichIfDefined(t.success?.msg),failure:await this.enrichIfDefined(t.failure?.msg),criticalFailure:await this.enrichIfDefined(t.criticalFailure?.msg),description:await this.enrichIfDefined(t.description),requirement:await this.enrichIfDefined(t.requirement),title:t.title,special:t.special,traits:i,skills:r}}activateListeners(e){super.activateListeners(e);const t=e[0];t.querySelector("#km-close-help")?.addEventListener("click",(async()=>{await this.close()})),t.querySelectorAll(".km-gain-lose")?.forEach((e=>{e.addEventListener("click",(async e=>{e.preventDefault();const t=e.currentTarget;await(0,r.updateResources)(this.game,this.actor,t)}))})),t.querySelectorAll("[data-pf2-check]")?.forEach((e=>{e.addEventListener("click",(async e=>{e.preventDefault();const t=e.currentTarget.dataset.pf2Dc??1,i=this.game,s=new i.pf2e.CheckModifier("Flat Check",{modifiers:[]});await i.pf2e.Check.roll(s,{type:"flat-check",dc:{value:t}})}))}))}async enrichIfDefined(e){if(e){const t={async:!0};return await TextEditor.enrichHTML(e,t)}}}t.showHelpDialog=async function(e,t,i){new HelpApplication({activity:i,actor:t,game:e}).render(!0)}},1436:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showStructureBrowser=t.payStructure=t.parsePayButton=void 0;const s=i(6185),a=i(3824),n=i(8937),r=i(1451),o=i(4767),l=i(9884),c=i(1098);function u(e,t){return void 0===e.construction?.skills||0===e.construction.skills.length||e.construction.skills.some((e=>t.skillRanks[e.skill]>=(e.proficiencyRank??0)))}function d(e,t,i){return(e.construction?.rp??0)-(i?.rp??0)<=t.resourcePoints.now}function m(e,t,i){return(e.construction?.lumber??0)-(i?.lumber??0)<=t.commodities.now.lumber}function h(e,t,i){return(e.construction?.ore??0)-(i?.ore??0)<=t.commodities.now.ore}function p(e,t,i){return(e.construction?.stone??0)-(i?.stone??0)<=t.commodities.now.stone}function f(e,t,i){return(e.construction?.luxuries??0)-(i?.luxuries??0)<=t.commodities.now.luxuries}class StructureBrowserApp extends FormApplication{level;structureActors;kingdom;currentTab="buildable";static get defaultOptions(){const e=super.defaultOptions;return e.id="structure-browser-app",e.title="Structure Browser",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/structure-browser.hbs",e.classes=["kingmaker-tools-app","structure-browser-app"],e.width=960,e.height=600,e.height="auto",e.submitOnChange=!0,e.closeOnSubmit=!1,e.scrollY=["#km-structure-browser-content","#km-structure-browser-sidebar"],e}game;filters;sheetActor;onRoll;constructor(e){super(null,e),this.game=e.game,this.level=e.kingdom.level,this.structureActors=this.getActors(),this.kingdom=e.kingdom,this.sheetActor=e.sheetActor,this.onRoll=e.onRoll}getActors(){return this.game.actors?.filter((e=>"npc"===e.type&&(0,s.isNonNullable)(e.getFlag("pf2e-kingmaker-tools","structureData"))))??[]}async resetFilters(){const e=function(e){return Array.from(new Set(e.flatMap((e=>Array.from(g(e)))))).sort(((e,t)=>e.localeCompare(t)))}((0,c.getStructuresFromActors)(this.structureActors));return{search:"",reducesUnrest:!1,housing:!1,affectsDowntime:!1,affectsEvents:!1,items:!1,storage:!1,consumption:!1,reducesRuin:!1,upgradeFrom:!1,upgradeTo:!1,infrastructure:!1,ignoreProficiencyRequirements:!1,ignoreStructureCost:!1,minLots:0,lots:4,activities:Object.fromEntries(e.map((e=>[e,{name:(0,s.unslugify)(e),enabled:!1}]))),level:this.level}}async getData(){this.kingdom=(0,o.getKingdom)(this.sheetActor),void 0===this.filters&&(this.filters=await this.resetFilters());const{buildableStructures:e,freeStructures:t,upgradableStructures:i,sceneStructures:a}=this.getStructureActors(),n=await this.toViewStructures(this.filterStructures(e,a,this.filters,"buildable")),r=await this.toViewStructures(this.filterStructures(i,a,this.filters,"upgradable")),l=await this.toViewStructures(this.filterStructures(t,a,this.filters,"free"));let u;return u="buildable"===this.currentTab?n:"upgradable"===this.currentTab?r:l,{...this.filters,...this.getActiveTabs(),constructableBuildings:{buildable:n.length,free:l.length,upgradable:r.length},isGM:(0,s.isGm)(this.game),structures:u,activities:this.filters.activities,noStructures:0===e.length,activeSettlement:(0,c.getScene)(this.game,this.kingdom.activeSettlement)?.id??void 0,settlements:this.kingdom.settlements.map((e=>(0,c.getScene)(this.game,e.sceneId))).filter(s.isNonNullable).map((e=>({label:e.name??"",value:e.id??""})))}}getStructureActors(){const e=(0,c.getStructuresFromActors)(this.structureActors).filter((e=>"Rubble"!==e.name)),t=(0,c.getScene)(this.game,this.kingdom.activeSettlement);if(t){const i=(0,c.getSceneActorStructures)(t),a=(0,s.groupBy)(i,(e=>e.name)),n=e.filter((e=>a.get(e.name)?.some((e=>!(0,c.isStructureActorActive)(e.actor))))),r=e.filter((e=>e.upgradeFrom?.some((e=>a.get(e)?.some((e=>(0,c.isStructureActorActive)(e.actor)))))));return{buildableStructures:e,upgradableStructures:r,freeStructures:n,sceneStructures:i}}return{buildableStructures:e,upgradableStructures:[],freeStructures:[],sceneStructures:[]}}activateListeners(e){super.activateListeners(e);const t=e[0];(0,s.listenClick)(t,"#km-structure-browser-clear",(async()=>{this.filters=void 0,this.render()})),(0,s.listenClick)(t,".km-import-structures",(async()=>{await(this.game.packs.get("pf2e-kingmaker-tools.kingmaker-tools-structures")?.importAll({folderName:"Structures"})),this.structureActors=this.getActors(),this.render()})),t.querySelectorAll(".km-structure-link").forEach((e=>e.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.uuid,i=await fromUuid(t);i?.sheet?.render(!0)})))),t.querySelectorAll(".km-nav a")?.forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget;this.currentTab=t.dataset.tab,this.render()}))})),t.querySelectorAll(".km-build-structure-dialog").forEach((e=>e.addEventListener("click",(e=>this.buildStructure(e)))))}filterStructures(e,t,i,a){const n=(0,s.groupBy)(t,(e=>e.name)),r=[];return i.storage&&r.push((e=>void 0!==e.storage)),i.affectsEvents&&r.push((e=>!0===e.affectsEvents)),i.affectsDowntime&&r.push((e=>!0===e.affectsDowntime)),i.housing&&r.push((e=>!0===e.traits?.includes("residential"))),i.infrastructure&&r.push((e=>!0===e.traits?.includes("infrastructure"))),i.reducesUnrest&&r.push((e=>!0===e.reducesUnrest)),i.reducesRuin&&r.push((e=>!0===e.reducesRuin)),i.consumption&&r.push((e=>void 0!==e.consumptionReduction&&e.consumptionReduction>0)),i.items&&r.push((e=>void 0!==e.availableItemsRules&&e.availableItemsRules.length>0)),i.upgradeFrom&&r.push((e=>void 0!==e.upgradeFrom&&e.upgradeFrom.length>0)),i.upgradeTo&&r.push((t=>this.hasUpgradeTo(t,e))),i.ignoreProficiencyRequirements||r.push((e=>u(e,this.kingdom))),i.ignoreStructureCost||r.push((e=>function(e,t,i,s){return"free"===s||("upgradable"===s?e.upgradeFrom?.flatMap((e=>t.get(e)??[]))?.some((t=>{const s={rp:t?.construction?.rp??0,lumber:t?.construction?.lumber??0,luxuries:t?.construction?.luxuries??0,ore:t?.construction?.ore??0,stone:t?.construction?.stone??0};return m(e,i,s)&&d(e,i,s)&&f(e,i,s)&&h(e,i,s)&&p(e,i,s)}))??!1:m(e,i)&&d(e,i)&&f(e,i)&&h(e,i)&&p(e,i))}(e,n,this.kingdom,a))),(0,s.isBlank)(i.search)||r.push((e=>e.name.toLowerCase().includes(i.search.trim().toLowerCase()))),r.push((e=>function(e,t){const i=g(e),s=Array.from(Object.entries(t)).filter((([,e])=>e?.enabled)).map((([e])=>e));return 0===s.length||s.every((e=>i.has(e)))}(e,i.activities))),r.push((e=>(e.level??0)<=i.level)),r.push((e=>e.lots<=i.lots)),r.push((e=>e.lots>=i.minLots)),e.filter((e=>r.every((t=>t(e))))).sort(((e,t)=>e.name.localeCompare(t.name)))}async toViewStructures(e){return await Promise.all(e.map((async e=>{const t=await TextEditor.enrichHTML((0,s.createUUIDLink)(e.actor.uuid,e.name)),i=!u(e,this.kingdom),n=e.construction?.skills.map((e=>{const t=e.proficiencyRank?` (${(0,a.rankToLabel)(e.proficiencyRank)})`:"";return(0,s.unslugify)(e.skill)+t}))??[];return{link:t,name:e.name,uuid:e.actor.uuid,dc:this.getStructureDC(e),skills:n,lacksProficiency:i,disableBuild:i&&!(0,r.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements"),lumber:e.construction?.lumber,ore:e.construction?.ore,stone:e.construction?.stone,luxuries:e.construction?.luxuries,rp:e.construction?.rp,insufficientStone:!p(e,this.kingdom),insufficientLumber:!m(e,this.kingdom),insufficientRp:!d(e,this.kingdom),insufficientLuxuries:!f(e,this.kingdom),insufficientOre:!h(e,this.kingdom),lots:0===e.lots?void 0:e.lots,id:e.actor.id,img:e.actor.img,residential:e.traits?.includes("residential")??!1,infrastructure:e.traits?.includes("infrastructure")??!1,proficiencyRequirements:n.join(" or ")}})))}getStructureDC(e){const t=(0,r.getBooleanSetting)(this.game,"reduceDCToBuildLumberStructures")&&(e.construction?.lumber??0)>0?-2:0,i=e.construction?.dc;return void 0===i?void 0:i+t}getActiveTabs(){return{buildableTab:"buildable"===this.currentTab,upgradableTab:"upgradable"===this.currentTab,freeTab:"free"===this.currentTab}}async _updateObject(e,t){console.log(t),this.filters={search:t.search,housing:t.housing,affectsDowntime:t.affectsDowntime,affectsEvents:t.affectsEvents,items:t.items,storage:t.storage,consumption:t.consumption,reducesRuin:t.reducesRuin,reducesUnrest:t.reducesUnrest,infrastructure:t.infrastructure,upgradeFrom:t.upgradeFrom,upgradeTo:t.upgradeTo,ignoreStructureCost:t.ignoreStructureCost,ignoreProficiencyRequirements:t.ignoreProficiencyRequirements,level:t.level,lots:t.lots,minLots:t.minLots,activities:Object.fromEntries(Object.keys(t).filter((e=>e.startsWith("activity-"))).map((e=>e.replace("activity-",""))).map((e=>[e,{name:(0,s.unslugify)(e),enabled:t["activity-"+e]}])))},await(0,o.saveKingdom)(this.sheetActor,{activeSettlement:t.activeSettlement}),this.render()}async buildStructure(e){const t=e.currentTarget.dataset.id,i=(0,c.getStructuresFromActors)(this.structureActors).find((e=>e.actor.id===t));if(i){const e=i.construction?.skills?.map((e=>[e.skill,e.proficiencyRank??0]));new n.CheckDialog(null,{activity:"build-structure",kingdom:this.kingdom,dc:this.getStructureDC(i),overrideSkills:void 0===e?void 0:Object.fromEntries(e),game:this.game,type:"activity",onRoll:this.onRoll,actor:this.sheetActor,afterRoll:async()=>{await this.close()},additionalChatMessages:[{[l.DegreeOfSuccess.CRITICAL_SUCCESS]:await this.payStructure(i,l.DegreeOfSuccess.CRITICAL_SUCCESS),[l.DegreeOfSuccess.SUCCESS]:await this.payStructure(i,l.DegreeOfSuccess.SUCCESS),[l.DegreeOfSuccess.FAILURE]:await this.payStructure(i,l.DegreeOfSuccess.FAILURE),[l.DegreeOfSuccess.CRITICAL_FAILURE]:await this.payStructure(i,l.DegreeOfSuccess.CRITICAL_FAILURE)}]}).render(!0)}}async getPaymentChatData(e,t){const i=(0,c.getStructuresFromActors)(this.structureActors),a=e.upgradeFrom?.map((e=>i.find((t=>t.actor.name===e))))?.filter((e=>(0,s.isNonNullable)(e)))??[],n=t===l.DegreeOfSuccess.CRITICAL_SUCCESS?"criticalSuccess":"success",r=a.map((t=>{const i={rp:Math.max(0,(e.construction?.rp??0)-(t.construction?.rp??0)),lumber:Math.max(0,(e.construction?.lumber??0)-(t.construction?.lumber??0)),stone:Math.max(0,(e.construction?.stone??0)-(t.construction?.stone??0)),ore:Math.max(0,(e.construction?.ore??0)-(t.construction?.ore??0)),luxuries:Math.max(0,(e.construction?.luxuries??0)-(t.construction?.luxuries??0))};return{name:t.name,costs:v(i,n)}})),o=v(e.construction??{},n),u=t===l.DegreeOfSuccess.CRITICAL_SUCCESS?"ruinCriticalSuccess":"ruinSuccess",d=v(e.construction??{},u),m=t===l.DegreeOfSuccess.CRITICAL_FAILURE?i.find((e=>"Rubble"===e.actor.name))?.actor:e?.actor;return{structureLink:m?await TextEditor.enrichHTML((0,s.createUUIDLink)(m.uuid,m.name)):void 0,costs:o,upgradeCosts:r,ruinCosts:d}}async payStructure(e,t){const{structureLink:i,costs:a,upgradeCosts:n,ruinCosts:r}=await this.getPaymentChatData(e,t),o=n.map((e=>`<p><b>Upgrade from ${(0,s.escapeHtml)(e.name)}:</b></p>`+y(e.costs))).join(""),c=`<h3>Constructing ${(0,s.escapeHtml)(e.name)}</h3>`,u="<p><b>Build from Ruin:</b></p>"+y(r),d="<p><b>Build Directly:</b></p>"+y(a),m=t===l.DegreeOfSuccess.FAILURE?" and apply the @UUID[Compendium.pf2e.conditionitems.Item.xYTAsEpcJE1Ccni3]{Slowed} condition to signal that the structure is under construction":"";return c+o+u+d+(i?`<p><b>Drag onto scene to build${m}:</b></p><p>${i}</p>`:"")}hasUpgradeTo(e,t){return t.some((t=>t.upgradeFrom?.includes(e.name)??!1))}}function g(e){const t=e.activityBonusRules?.map((e=>e.activity))??[],i=e.skillBonusRules?.filter((e=>void 0!==e.activity))?.map((e=>e.activity))??[];return new Set([...t,...i])}function y(e){return`<button type="button" \n                data-rp="${e.rp}" \n                data-lumber="${e.lumber}"\n                data-luxuries="${e.luxuries}"\n                data-stone="${e.stone}"\n                data-ore="${e.ore}"\n                class="km-pay-structure"><b>Pay</b>: ${b(e)}</button>`}function v(e,t){const i={rp:e.rp??0,ore:e.ore??0,lumber:e.lumber??0,luxuries:e.luxuries??0,stone:e.stone??0};return"success"===t?i:"criticalSuccess"===t?{rp:i.rp,ore:Math.ceil(i.ore/2),lumber:Math.ceil(i.lumber/2),luxuries:Math.ceil(i.luxuries/2),stone:Math.ceil(i.stone/2)}:"ruinSuccess"===t?{rp:Math.ceil(i.rp/2),ore:Math.ceil(i.ore/2),lumber:Math.ceil(i.lumber/2),luxuries:Math.ceil(i.luxuries/2),stone:Math.ceil(i.stone/2)}:{rp:Math.ceil(i.rp/2),ore:Math.ceil(i.ore/4),lumber:Math.ceil(i.lumber/4),luxuries:Math.ceil(i.luxuries/4),stone:Math.ceil(i.stone/4)}}function b(e){return Object.entries(e).filter((([,e])=>e>0)).map((([e,t])=>`${(0,s.capitalize)(e)}: ${t}`)).join(", ")}t.parsePayButton=function(e){return{rp:parseInt(e.dataset.rp??"0",10),lumber:parseInt(e.dataset.lumber??"0",10),luxuries:parseInt(e.dataset.luxuries??"0",10),stone:parseInt(e.dataset.stone??"0",10),ore:parseInt(e.dataset.ore??"0",10)}},t.payStructure=async function(e,t){const i=(0,o.getKingdom)(e);await(0,o.saveKingdom)(e,{commodities:{...i.commodities,now:{...i.commodities.now,ore:Math.max(0,i.commodities.now.ore-t.ore),lumber:Math.max(0,i.commodities.now.lumber-t.lumber),luxuries:Math.max(0,i.commodities.now.luxuries-t.luxuries),stone:Math.max(0,i.commodities.now.stone-t.stone)}},resourcePoints:{...i.resourcePoints,now:Math.max(0,i.resourcePoints.now-t.rp)}}),await ChatMessage.create({content:`<b>Paid:</b> ${b(t)}`})},t.showStructureBrowser=async function(e,t,i,s){new StructureBrowserApp({game:e,kingdom:t,sheetActor:i,onRoll:s}).render(!0)}},623:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.structureTokenMappingDialog=void 0;const s=i(1098),a=i(6185),n=[{name:"Academy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/academy.webp"},{name:"Alchemy Laboratory",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/alchemy-laboratory.webp"},{name:"Arcanist's Tower",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/arcanists-tower.webp"},{name:"Arena",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/arena.webp"},{name:"Bank",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/bank.webp"},{name:"Bank (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/bank.webp"},{name:"Barracks",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/barracks.webp"},{name:"Brewery",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/brewery.webp"},{name:"Castle",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/castle.webp"},{name:"Castle (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/castle.webp"},{name:"Cathedral",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/cathedral.webp"},{name:"Cemetary",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/cemetery.webp"},{name:"Construction Yard",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/construction-yard.webp"},{name:"Construction Yard (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/construction-yard.webp"},{name:"Dump",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/dump.webp"},{name:"Embassy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/embassy.webp"},{name:"Festival Hall",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/festival-hall.webp"},{name:"Festival Hall (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/festival-hall.webp"},{name:"Foundry",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/foundry.webp"},{name:"Garrison",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/garrison.webp"},{name:"Garrison (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/garrison.webp"},{name:"General Store",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/general-store.webp"},{name:"Granary",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/granary.webp"},{name:"Granary (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/granary.webp"},{name:"Guildhall",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/guildhall.webp"},{name:"Herbalist",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/herbalist.webp"},{name:"Hospital",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/hospital.webp"},{name:"Houses",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/houses.webp"},{name:"Illicit Market",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/illicit-market.webp"},{name:"Inn",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/inn.webp"},{name:"Inn (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/inn.webp"},{name:"Jail",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/jail.webp"},{name:"Keep",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/keep.webp"},{name:"Library",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/library.webp"},{name:"Library (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/library.webp"},{name:"Lumberyard",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/lumberyard.webp"},{name:"Luxury Store",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/luxury-store.webp"},{name:"Magic Shop",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/magic-shop.webp"},{name:"Magic Shop (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/magic-shop.webp"},{name:"Mansion",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/mansion.webp"},{name:"Marketplace",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/marketplace.webp"},{name:"Menagerie",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/menagerie.webp"},{name:"Military Academy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/military-academy.webp"},{name:"Mill",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/mill.webp"},{name:"Mint",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/mint.webp"},{name:"Monument",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/monument.webp"},{name:"Monument (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/monument.webp"},{name:"Museum",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/museum.webp"},{name:"Noble Villa",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/noble-villa.webp"},{name:"Occult Shop",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/occult-shop.webp"},{name:"Occult Shop (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/occult-shop.webp"},{name:"Opera House",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/opera-house.webp"},{name:"Orphanage",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/orphanage.webp"},{name:"Palace",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/palace.webp"},{name:"Palace (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/palace.webp"},{name:"Park",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/park.webp"},{name:"Pier",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/pier.webp"},{name:"Rubble",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/rubble.webp"},{name:"Sacred Grove",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/sacred-grove.webp"},{name:"Secure Warehouse",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/secure-warehouse.webp"},{name:"Shrine",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/shrine.webp"},{name:"Smithy",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/smithy.webp"},{name:"Smithy (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/smithy.webp"},{name:"Specialized Artisan",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/special-artisan.webp"},{name:"Stable",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/stable.webp"},{name:"Stockyard",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/stockyard.webp"},{name:"Stonemason",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/stonemason.webp"},{name:"Tannery",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tannery.webp"},{name:"Tavern, Dive",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-dive.webp"},{name:"Tavern, Dive (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-dive.webp"},{name:"Tavern, Luxury",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-luxury.webp"},{name:"Tavern, Luxury (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-luxury.webp"},{name:"Tavern, Popular",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-popular.webp"},{name:"Tavern, Popular (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-popular.webp"},{name:"Tavern, World-Class",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-worldclass.webp"},{name:"Tavern, World-Class (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tavern-worldclass.webp"},{name:"Temple",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/temple.webp"},{name:"Tenement",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/tenement.webp"},{name:"Theater",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/theatre.webp"},{name:"Thieves' Guild",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/thieves-guild.webp"},{name:"Town Hall",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/town-hall.webp"},{name:"Town Hall (V&K)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/town-hall.webp"},{name:"Trade Shop",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/trade-shop.webp"},{name:"University",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/university.webp"},{name:"Watchtower",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/watchtower.webp"},{name:"Watchtower, Stone",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/watchtower.webp"},{name:"Waterfront (Corner)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/waterfront.webp"},{name:"Waterfront (Side)",img:"modules/pf2e-kingmaker/assets/maps-settlements/buildings/waterfront-2.webp"}],r=[{name:"Academy",img:"structures/Academy.webp"},{name:"Alchemy Laboratory",img:"structures/Alchemy%20Laboratory.webp"},{name:"Arcanist's Tower",img:"structures/Arcanist%20Tower.webp"},{name:"Arena",img:"structures/Arena.webp"},{name:"Bank",img:"structures/Bank.webp"},{name:"Bank (V&K)",img:"structures/Bank.webp"},{name:"Barracks",img:"structures/Barracks.webp"},{name:"Brewery",img:"structures/Brewery.webp"},{name:"Castle (V&K)",img:"structures/Castle.webp"},{name:"Cathedral",img:"structures/Cathedral.webp"},{name:"Cemetary",img:"structures/Cemetery.webp"},{name:"Construction Yard",img:"structures/Construction%20Yard.webp"},{name:"Construction Yard (V&K)",img:"structures/Construction%20Yard.webp"},{name:"Dump",img:"structures/Dump.webp"},{name:"Embassy",img:"structures/Embassy.webp"},{name:"Festival Hall",img:"structures/Festival%20Hall.webp"},{name:"Festival Hall (V&K)",img:"structures/Festival%20Hall.webp"},{name:"Foundry",img:"structures/Foundry.webp"},{name:"Garrison",img:"structures/Garrison.webp"},{name:"Garrison (V&K)",img:"structures/Garrison.webp"},{name:"General Store",img:"structures/General%20Store.webp"},{name:"Granary",img:"structures/Granary.webp"},{name:"Granary (V&K)",img:"structures/Granary.webp"},{name:"Guildhall",img:"structures/Guildhall.webp"},{name:"Herbalist",img:"structures/Herbalist.webp"},{name:"Hospital",img:"structures/Hospital.webp"},{name:"Houses",img:"structures/Houses.webp"},{name:"Illicit Market",img:"structures/Illicit%20Market.webp"},{name:"Inn",img:"structures/Inn.webp"},{name:"Inn (V&K)",img:"structures/Inn.webp"},{name:"Jail",img:"structures/Jail.webp"},{name:"Keep",img:"structures/Keep.webp"},{name:"Library",img:"structures/Library.webp"},{name:"Library (V&K)",img:"structures/Library.webp"},{name:"Lumberyard",img:"structures/Lumberyard.webp"},{name:"Luxury Store",img:"structures/Luxury%20Store.webp"},{name:"Magic Shop",img:"structures/Magic%20Shop.webp"},{name:"Magic Shop (V&K)",img:"structures/Magic%20Shop.webp"},{name:"Mansion",img:"structures/Mansion.webp"},{name:"Marketplace",img:"structures/Marketplace.webp"},{name:"Menagerie",img:"structures/Menagerie.webp"},{name:"Military Academy",img:"structures/Military%20Academy.webp"},{name:"Mill",img:"structures/Mill.webp"},{name:"Mint",img:"structures/Mint.webp"},{name:"Monument",img:"structures/Monument.webp"},{name:"Monument (V&K)",img:"structures/Monument.webp"},{name:"Museum",img:"structures/Museum.webp"},{name:"Noble Villa",img:"structures/Noble%20Villa.webp"},{name:"Occult Shop",img:"structures/Occult%20Shop.webp"},{name:"Occult Shop (V&K)",img:"structures/Occult%20Shop.webp"},{name:"Opera House",img:"structures/Opera%20House.webp"},{name:"Orphanage",img:"structures/Orphanage.webp"},{name:"Palace",img:"structures/Palace.webp"},{name:"Palace (V&K)",img:"structures/Palace.webp"},{name:"Park",img:"structures/Park.webp"},{name:"Pier",img:"structures/Pier.webp"},{name:"Rubble",img:"structures/Rubble.webp"},{name:"Sacred Grove",img:"structures/Sacred%20Grove.webp"},{name:"Secure Warehouse",img:"structures/Secure%20Warehouse.webp"},{name:"Shrine",img:"structures/Shrine.webp"},{name:"Smithy",img:"structures/Smithy.webp"},{name:"Smithy (V&K)",img:"structures/Smithy.webp"},{name:"Specialized Artisan",img:"structures/Special%20Artisan.webp"},{name:"Stable",img:"structures/Stable.webp"},{name:"Stockyard",img:"structures/Stockyard.webp"},{name:"Stonemason",img:"structures/Stonemason.webp"},{name:"Tannery",img:"structures/Tannery.webp"},{name:"Tavern, Dive",img:"structures/Tavern%2C%20Dive.webp"},{name:"Tavern, Dive (V&K)",img:"structures/Tavern%2C%20Dive.webp"},{name:"Tavern, Luxury",img:"structures/Tavern%2C%20Luxury.webp"},{name:"Tavern, Luxury (V&K)",img:"structures/Tavern%2C%20Luxury.webp"},{name:"Tavern, Popular",img:"structures/Tavern%2C%20Popular.webp"},{name:"Tavern, Popular (V&K)",img:"structures/Tavern%2C%20Popular.webp"},{name:"Tavern, World-Class",img:"structures/Tavern%2C%20World%20Class.webp"},{name:"Tavern, World-Class (V&K)",img:"structures/Tavern%2C%20World%20Class.webp"},{name:"Temple",img:"structures/Temple.webp"},{name:"Tenement",img:"structures/Tenement.webp"},{name:"Theater",img:"structures/Theater.webp"},{name:"Thieves' Guild",img:"structures/Thieves%20Guild.webp"},{name:"Town Hall",img:"structures/Town%20Hall.webp"},{name:"Town Hall (V&K)",img:"structures/Town%20Hall.webp"},{name:"Trade Shop",img:"structures/Trade%20Shop.webp"},{name:"University",img:"structures/University.webp"},{name:"Watchtower",img:"structures/Watchtower.webp"},{name:"Watchtower, Stone",img:"structures/Watchtower.webp"},{name:"Waterfront (Corner)",img:"structures/Waterfront%20(Corner).webp"},{name:"Waterfront (Side)",img:"structures/Waterfront%20(Side).webp"}];async function o(e,t){const i=(0,a.groupBy)(t,(e=>e.name));await Promise.all(e.map((async e=>{const t=i.get(e.name??"")?.[0];if(t){const i=t.img;await e.update({"prototypeToken.texture.src":i,img:i})}})))}function l(e="pf2e-kingmaker-tools-tokens/"){return r.map((t=>({name:t.name,img:e+t.img})))}t.structureTokenMappingDialog=async function(e){const t=e.actors?.filter((e=>(0,s.isStructureActor)(e)))??[],i=await TextEditor.enrichHTML((0,a.createUUIDLink)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY","Kingmaker Tools Manual"));new Dialog({title:"Change Structure Token Images",content:`\n        <p>Run this macro to change all images of imported structures. The <b>Unofficial Module</b> mapping will use the folder structure described in the ${i} Tokens section.</p> \n        <p>You can change the base directory from <b>pf2e-kingmaker-tools-tokens/</b> to a different folder by adding a different value in the Custom Directory input. That way you can make use of token modules which offers tokens organized in the same folder structure as the Unofficial Module.</p>\n        <form class="simple-dialog-form">\n            <div>\n                <label for="km-token-mapping-official">Official Module</label>\n                <input type="radio" value="official" name="mapping" id="km-token-mapping-official" checked>\n            </div>\n            <div>\n                <label for="km-token-mapping-unofficial">Unofficial Module</label>\n                <input type="radio" value="unofficial" name="mapping" id="km-token-mapping-unofficial">\n            </div>\n            <div>\n                <label for="km-token-mapping-custom">Custom</label>\n                <input type="radio" value="custom" name="mapping" id="km-token-mapping-custom">\n            </div>\n            <div>\n                <label for="km-token-mapping-custom">Custom Directory</label>\n                <input type="text" name="customDirectory" placeholder="modules/token-module/img/">\n            </div>\n        </form>\n        `,buttons:{migrate:{icon:'<i class="fa-solid fa-save"></i>',label:"Migrate",callback:async e=>{const i=e,s=(0,a.parseRadio)(i,"mapping"),r=(0,a.parseTextInput)(i,"customDirectory");if("custom"===s)if((0,a.isBlank)(r))ui.notifications?.error("Custom Directory can not be empty!");else{const e=r.replace(/\/$/,"")+"/";await o(t,l(e))}else"official"===s?await o(t,n):"unofficial"===s&&await o(t,l())}}},default:"migrate"},{jQuery:!1,width:380}).render(!0)}},5663:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gainFame=t.getConsumption=t.getCapacity=void 0;const s=i(7894),a=i(1098),n=i(6185),r=i(1451);t.getCapacity=function(e,t){const i=(0,r.getStringSetting)(e,"automateResources"),{size:n}=(0,a.getStolenLandsData)(e,i,t),o=(0,s.getSizeData)(n).commodityCapacity,{storage:l}=(0,a.getAllMergedSettlements)(e,t);return function(e,t){return{food:e+t.food,ore:e+t.ore,luxuries:e+t.luxuries,lumber:e+t.lumber,stone:e+t.stone}}(o,l)},t.getConsumption=function(e,t){const i=(0,a.getAllMergedSettlements)(e,t).settlementConsumption,s=(0,r.getStringSetting)(e,"automateResources"),n=(0,a.getStolenLandsData)(e,s,t).workSites.farmlands,o=n.resources+n.quantity,l=t.consumption.armies+t.consumption.now+i;return{current:Math.max(0,l-o),surplus:Math.max(0,o-l)}},t.gainFame=function(e,t){return{fame:{...e.fame,now:(0,n.clamped)(e.fame.now+t,0,e.fame.max)}}}},3824:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStructureModifiers=t.createRuinModifier=t.createUnrestModifier=t.createProficiencyModifier=t.proficiencyToRank=t.rankToProficiency=t.rankToLabel=t.createAbilityModifier=t.createInvestedModifier=t.createVacancyModifiers=t.processModifiers=t.createActiveOtherModifiers=t.calculateModifiers=t.removeLowestModifiers=t.removePredicatedModifiers=t.removeUninterestingZeroModifiers=t.modifierToLabel=t.allModifierTypes=t.getUntrainedProficiencyMode=void 0;const s=i(6185),a=i(7894),n=i(554),r=i(6893),o=i(5593),l=i(8577),c=i(8422),u=i(5281),d=i(1451);function m(e,t){return e?`${t}: ${e.map((e=>(0,s.unslugify)(e))).join(", ")}`:void 0}function h(e){return e.filter((e=>0!==e.value))}function p(e,t,i,s,a,n){return e.filter((e=>{const o=[];e.abilities&&o.push((e=>!0===e.abilities?.includes(r.skillAbilities[s]))),e.skills&&o.push((e=>!0===e.skills?.includes(s))),t&&e.phases&&o.push((e=>!0===e.phases?.includes(t))),i&&e.activities&&o.push((e=>!0===e.activities?.includes(i))),e.activities&&o.push((e=>e.activities.some((e=>{const t=n[e].skills[s];return void 0!==t&&t<=a}))));let l=!0;for(const t of o)l=l&&t(e);return l})).map((e=>{let s=e.enabled;return!t&&e.phases&&(s=!1),!i&&e.activities&&(s=!1),{...e,enabled:s}}))}function f(e){const t=(0,s.groupBy)(e,(e=>e.value>0?e.type:e.type+"-penalty")),i=[];for(const[e,s]of t.entries())if("untyped"===e||"untyped-penalty"===e)s.forEach((e=>i.push(e)));else{const e=Math.max(0,...s.filter((e=>e.enabled)).map((e=>Math.abs(e.value))));if(s.some((e=>e.enabled))){const t=s.find((t=>t.enabled&&Math.abs(t.value)===e));s.forEach((e=>{e.id!==t.id?i.push({...e,enabled:!1}):i.push(e)}))}else s.forEach((e=>i.push(e)))}return i}function g(e,t,i,s){return{name:t,value:-(i?e+1:e),phases:s?[s]:void 0,type:"vacancy",enabled:!0}}function y(e){return 0===e?"Untrained":1===e?"Trained":2===e?"Expert":3===e?"Master":"Legendary"}t.getUntrainedProficiencyMode=function(e){return(0,d.getBooleanSetting)(e,"kingdomAlwaysAddLevel")?"full":(0,d.getBooleanSetting)(e,"kingdomAlwaysAddHalfLevel")?"half":"none"},t.allModifierTypes=["ability","proficiency","item","status","circumstance","vacancy","untyped"],t.modifierToLabel=function(e){return`${e.value>=0?`+${e.value}`:`${e.value}`} ${e.value>=0?(0,s.capitalize)(e.type)+" Bonus":(0,s.capitalize)(e.type)+" Penalty"}${e.skills||e.abilities||e.activities||e.phases?" to: ":""}${[m(e.phases,"Phases"),m(e.activities,"Activities"),m(e.abilities,"Abilities"),m(e.skills,"Skills")].filter((e=>void 0!==e)).join("; ")}`},t.removeUninterestingZeroModifiers=h,t.removePredicatedModifiers=p,t.removeLowestModifiers=f,t.calculateModifiers=function(e){const t={item:{bonus:0,penalty:0},circumstance:{bonus:0,penalty:0},status:{bonus:0,penalty:0},ability:{bonus:0,penalty:0},proficiency:{bonus:0,penalty:0},untyped:{bonus:0,penalty:0},vacancyPenalty:0,value:0,assurance:10,rollOptions:[]},i=e.filter((e=>e.enabled&&0!==e.value));for(const e of i)if(e.rollOptions?.forEach((e=>t.rollOptions.push(e))),"vacancy"===e.type)t.vacancyPenalty=e.value;else{const i=t[e.type],s=e.value>0?"bonus":"penalty";"untyped"===e.type?i[s]+=e.value:i[s]=e.value}return t.assurance=10+i.filter((e=>"proficiency"===e.type&&(e.value>0||e.value<0))).map((e=>e.value)).reduce(((e,t)=>e+t),0),t.value=i.map((e=>e.value)).reduce(((e,t)=>e+t),0),t},t.createActiveOtherModifiers=function(e,t,i,s){const r=(0,a.getLevelData)(e.level),o=new Set([...e.feats.map((e=>e.id)),...e.bonusFeats.map((e=>e.id))]),l=Array.from(o).flatMap((t=>n.allFeatsByName[t]?.modifiers?.(e)??[]));e.modifiers.forEach((e=>l.push(e)));const c=t?.secondaryTerritory;s>0&&l.push({name:"Settlements Without Land Borders",value:-1*s,type:"item",skills:["trade"],enabled:!0}),c&&l.push({name:"Check in Secondary Territory",type:"circumstance",value:-4,enabled:!0}),e.level>=4&&l.push({name:"Expansion Expert",type:"circumstance",activities:["claim-hex"],value:2,enabled:!0});const u=i?.active.settlementEventBonus??0;u>0&&l.push({name:"Event Phase Structure Bonus",type:"circumstance",value:u,enabled:!0,phases:["event"]});const d=i?.merged.leadershipActivityBonus??0;return d>0&&l.push({name:"Ruler performs Leadership Activity",type:"item",value:d,enabled:!1,phases:["leadership"]}),l.push({name:"Invested, Non-Vacant Leader Handles Event",type:"circumstance",value:r.investedLeadershipBonus,enabled:!1,phases:["event"]}),l},t.processModifiers=function({modifiers:e,skill:t,rank:i,phase:s,activity:a,overrides:n={},activities:r}){return f(p(h(e.map(((e,t)=>({...foundry.utils.deepClone(e),id:`${t}`})))),s,a,t,i,r).map((e=>{const t=n[e.id];return void 0===t?e:{...e,enabled:t}})))},t.createVacancyModifiers=function(e,t){const i=[],s=t.ruler.vacant;return t.counselor.vacant&&"culture"===e&&i.push(g(1,"Vacancy: Counselor",s)),t.general.vacant&&i.push(g(4,"Vacancy: General",s,"army")),t.emissary.vacant&&"loyalty"===e&&i.push(g(1,"Vacancy: Emissary",s)),t.magister.vacant&&i.push(g(4,"Vacancy: Magister",s,"army")),t.treasurer.vacant&&"economy"===e&&i.push(g(1,"Vacancy: Treasurer",s)),t.viceroy.vacant&&"stability"===e&&i.push(g(1,"Vacancy: Viceroy",s)),t.warden.vacant&&i.push(g(4,"Vacancy: Warden",s,"region")),s&&i.push(g(0,"Vacancy: Ruler",s)),i},t.createInvestedModifier=function(e,t,i){if((0,l.isInvested)(t,i))return{value:(0,a.getLevelData)(e).investedLeadershipBonus,enabled:!0,name:"Invested Leadership Role",type:"status"}},t.createAbilityModifier=function(e,t){return{type:"ability",name:(0,s.capitalize)(e),enabled:!0,value:(0,o.calculateAbilityModifier)(t[e])}},t.rankToLabel=y,t.rankToProficiency=function(e){return 1===e?"trained":2===e?"expert":3===e?"master":4===e?"legendary":void 0},t.proficiencyToRank=function(e){return"trained"===e?1:"expert"===e?2:"master"===e?3:"legendary"===e?4:0},t.createProficiencyModifier=function(e,t,i){return{value:function(e,t,i){return e>0?t+2*e:"full"===i?t:"half"===i?Math.floor(t/2):0}(e,i,t),enabled:!0,name:e>0?y(e):"Kingdom Level",type:"proficiency"}},t.createUnrestModifier=function(e){const t=(0,c.calculateUnrestPenalty)(e);if(t>0)return{type:"status",name:"Unrest",enabled:!0,value:-t}},t.createRuinModifier=function(e,t){const i=t[u.abilityRuins[e]].penalty;if(i>0)return{value:-i,enabled:!0,name:"Ruin",type:"item"}},t.createStructureModifiers=function(e,t){const i=function(e,t){return Object.entries(e).map((([e,i])=>{const a=[t[e].phase];return{type:"item",enabled:!0,value:i,name:`Structure - ${(0,s.unslugify)(e)}`,activities:[e],phases:a}}))}(e.activities,t),a=function(e){if(e>0)return{value:e,enabled:!0,name:"Structure",type:"item"}}(e.value);return a&&i.push(a),i}},171:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateResources=t.parseResourceButton=t.createUpdate=t.evaluateValue=t.getLimit=t.getCurrentValue=t.calculateNewValue=void 0;const s=i(6185),a=i(7894),n=i(4767),r=i(5663),o=i(1451),l=i(1098);async function c({currentValue:e,newValue:t,type:i,turn:a,mode:n,limit:r,multiple:o,showMissing:l}){const c=t*(o?await async function(){return new Promise((e=>{new Dialog({title:"Perform How Many Times?",content:'<form class="simple-dialog-form">\n            <div>\n                <label>Perform How Many Times?</label>\n                <input type="number" value="1" name="times">\n            </div>\n        </form>',buttons:{multiply:{icon:'<i class="fa-solid fa-check"></i>',label:"Apply",callback:async t=>{const i=t,a=(0,s.parseNumberInput)(i,"times");e(a)}}},default:"multiply"},{jQuery:!1,width:400}).render(!0)}))}():1),u="gain"===n?e+c:e-c,d=u<0?Math.abs(u):0,m=void 0===r?u:Math.min(r,u),h="rolled-resource-dice"===i?"Resource Points":(0,s.unslugify)(i),p="now"===a?"this turn":"next turn",f=`${"gain"===n?"Gaining":"Losing"} ${Math.abs(c)} ${h} ${p}`,g=l&&d>0&&"now"===a?`Missing ${d} ${h}`:"";return{value:"now"===a?Math.max(0,m):m,message:f,missingMessage:g}}function u(e,t,i){if("food"===t||"luxuries"===t||"ore"===t||"lumber"===t||"stone"===t)return e.commodities[i][t];if("unrest"===t)return e.unrest;if("resource-dice"===t)return e.resourceDice[i];if("resource-points"===t||"rolled-resource-dice"===t)return e.resourcePoints[i];if("crime"===t||"decay"===t||"strife"===t||"corruption"===t)return e.ruin[t].value;if("xp"===t)return e.xp;if("fame"===t)return e.fame[i];if("supernatural-solution"===t)return e.supernaturalSolutions;if("creative-solution"===t)return e.creativeSolutions;throw Error(`Unhandled type ${t}`)}function d(e,t,i,s){return"now"!==s||"food"!==i&&"luxuries"!==i&&"lumber"!==i&&"ore"!==i&&"stone"!==i?"fame"===i?t.fame.max:void 0:(0,r.getCapacity)(e,t)[i]}async function m(e,t,i,n){if("rolled-resource-dice"===i){const i=n.includes("d")?`(${n})`:n,s=(0,o.getStringSetting)(e,"automateResources"),{size:r}=(0,l.getStolenLandsData)(e,s,t),c=(0,a.getSizeData)(r).resourceDieSize,u=await new Roll(`${i}${c}`).roll();return await u.toMessage({flavor:"Rolling Resource Dice"}),u.total}if(n.includes("d")){const e=await new Roll(n).roll();return await e.toMessage({flavor:`Rolling ${(0,s.unslugify)(i)}`}),e.total}return parseInt(n,10)}function h(e,t,i,s){if("rolled-resource-dice"===t||"resource-points"===t)return{resourcePoints:{...e.resourcePoints,[i]:s}};if("xp"===t)return{xp:s};if("fame"===t)return{fame:{...e.fame,[i]:s}};if("supernatural-solution"===t)return{supernaturalSolutions:s};if("creative-solution"===t)return{creativeSolutions:s};if("resource-dice"===t)return{resourceDice:{...e.resourceDice,[i]:s}};if("unrest"===t)return{unrest:s};if("strife"===t||"crime"===t||"decay"===t||"corruption"===t)return{ruin:{...e.ruin,[t]:{...e.ruin[t],value:s}}};if("lumber"===t||"ore"===t||"stone"===t||"food"===t||"luxuries"===t)return{commodities:{...e.commodities,[i]:{...e.commodities[i],[t]:s}}};throw Error(`Unhandled type ${t}`)}t.calculateNewValue=c,t.getCurrentValue=u,t.getLimit=d,t.evaluateValue=m,t.createUpdate=h;const p=new Set(["crime","decay","strife","corruption","unrest"]);function f(e){const t=e.dataset.type,i=e.dataset.mode,s=e.dataset.turn,a="true"===e.dataset.multiple;return{type:t,mode:i,turn:s,value:e.dataset.value,multiple:a}}t.parseResourceButton=f,t.updateResources=async function(e,t,i){const{multiple:s,type:a,mode:r,turn:o,value:l}=f(i),g=(0,n.getKingdom)(t),y=await m(e,g,a,l),v=u(g,a,o),b=d(e,g,a,o),{missingMessage:k,message:w,value:S}=await c({mode:r,limit:b,turn:o,newValue:y,type:a,currentValue:v,multiple:s,showMissing:!p.has(a)});await ChatMessage.create({content:`${w}`}),k&&await ChatMessage.create({content:`${k}`});const x=h(g,a,o,S);await(0,n.saveKingdom)(t,x)}},1694:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addOngoingEvent=t.rollCheck=t.changeDegree=t.reRoll=t.cooperativeLeadership=t.parseUpgradeMeta=t.parseMeta=void 0;const s=i(9884),a=i(6185),n=i(6690),r=i(3824),o=i(4767),l=i(5663),c=i(7894);function u(e){const t=e.querySelector(".km-roll-meta"),i=t.dataset.rollOptions,s=t.dataset.additionalChatMessages;return{total:parseInt(t.dataset.total??"0",10),dc:parseInt(t.dataset.dc??"0",10),activity:t.dataset.activity??void 0,skill:t.dataset.skill,degree:t.dataset.degree,formula:t.dataset.formula,modifier:parseInt(t.dataset.modifier??"0",10),rollType:t.dataset.rollType,rollOptions:(0,a.isNotBlank)(i)?(0,a.decodeJson)(i):[],additionalChatMessages:(0,a.isNotBlank)(s)?(0,a.decodeJson)(s):[],creativeSolutionModifier:parseInt(t.dataset.creativeSolutionModifier??"0",10),supernaturalSolutionModifier:parseInt(t.dataset.supernaturalSolutionModifier??"0",10),modifierBreakdown:(0,a.isNotBlank)(t.dataset.modifierBreakdown)?t.dataset.modifierBreakdown:void 0,rollMode:t.dataset.rollMode}}function d(e){const t=e.querySelector(".km-upgrade-result"),i=t.dataset.additionalChatMessages;return{activity:t.dataset.activity,rollMode:t.dataset.rollMode,degree:t.dataset.degree,additionalChatMessages:(0,a.isNotBlank)(i)?(0,a.decodeJson)(i):[]}}function m(e,t,i,a){return n=>(e&&a.includes("focused-attention")&&t>=11&&(n===s.DegreeOfSuccess.CRITICAL_FAILURE?n=s.DegreeOfSuccess.FAILURE:n===s.DegreeOfSuccess.FAILURE&&i>=2&&(n=s.DegreeOfSuccess.SUCCESS)),n)}async function h(e,t,i){const s=e.map((e=>e[t])).filter((e=>(0,a.isNotBlank)(e)));await Promise.all(s.map((async e=>{await(0,a.postChatMessage)(e.trimEnd(),i)})))}async function p({formula:e,label:t,activity:i,dc:n,skill:r,modifier:o,actor:l,adjustDegreeOfSuccess:c=(e=>e),rollOptions:u,modifierBreakdown:d,supernaturalSolutionModifier:m,creativeSolutionModifier:p,rollType:g,rollMode:v,additionalChatMessages:b}){const k=await new Roll(e).roll(),w=k.total,S=w-o,x=(0,s.determineDegreeOfSuccess)(S,w,n),R=c(x),_=`\n        <div class="km-roll-meta" hidden \n            data-formula="${e}" \n            ${void 0===i?"":`data-activity="${i.id}"`}\n            data-degree="${(0,s.degreeToProperty)(R)}"\n            data-skill="${r}"\n            data-roll-options="${u?(0,a.encodeJson)(u):""}"\n            data-dc="${n}"\n            data-total="${w}"\n            data-modifier-breakdown="${d??""}"\n            data-modifier="${o}"\n            data-roll-type="${g}"\n            data-roll-mode="${v}"\n            data-additional-chat-messages="${(0,a.encodeJson)(b)}"\n            data-creative-solution-modifier="${p}"\n            data-supernatural-solution-modifier="${m}"\n        ></div>`,C=function(e,t){if((0,a.isNotBlank)(e)){const i=(0,a.decodeJson)(e),s=function(e,t){return"supernatural-solution"===t?e.supernaturalSolution:"creative-solution"===t?e.creativeSolution:e.selected}(i,t);return console.log(i,s),`<div class="km-modifier-breakdown">${s.map((e=>{const t=e.value;return`<span class="km-modifier-pill">${(0,a.unslugify)(e.name)} ${t>=0?`+${t}`:t}</span>`})).join("")}</div>`}return""}(d,g);return await k.toMessage({flavor:`<span class="km-skill-check-header">Skill Check: ${t}, DC ${n}</span>${_}<hr>${C}`},{rollMode:v}),await async function(e,t,i,s,a,n){i?await y(e,i,t,s,a,n):await f(t,a,n)}(l,v,i,b,x,R===x?void 0:R),await h(b,R,v),R}async function f(e,t,i){await(0,a.postDegreeOfSuccessMessage)({degreeOfSuccess:t,upgradedDegreeOfSuccess:i,messageConfig:{critSuccess:`${g([],"criticalSuccess")}`,rollMode:e}})}function g(e,t,i){return e.length>0||"criticalSuccess"===t?`\n        <div class="km-chat-buttons">\n            ${"criticalSuccess"===t?'<button type="button" class="km-gain-fame-button">Gain 1 Fame</button>':""}\n            ${e.map(((e,s)=>{const a=(0,r.modifierToLabel)(e);return`<button class="km-apply-modifier-effect" \n                        data-activity="${i}" \n                        data-degree="${t}" \n                        data-index="${s}">Apply Effect: ${a}</button>`})).join("")}    \n        </div>`:""}async function y(e,t,i,n,r,l){const c=function(e){return e===s.DegreeOfSuccess.CRITICAL_SUCCESS?"criticalSuccess":e===s.DegreeOfSuccess.SUCCESS?"success":e===s.DegreeOfSuccess.FAILURE?"failure":"criticalFailure"}(l??r),u=t[c];if(u){const s=(0,o.getKingdom)(e),d=u.modifiers,m=u.msg,h=(void 0===d?g([],c):g(d(s),c,t.id))+`<div class="km-upgrade-result"\n                data-roll-mode="${i}" \n                data-activity="${t.id}" \n                data-degree="${c}"\n                data-additional-chat-messages="${(0,a.encodeJson)(n)}"></div>`,p=`<h3>${t.title}</h3>${t.description.trimEnd()}<hr>`;await(0,a.postDegreeOfSuccessMessage)({degreeOfSuccess:r,upgradedDegreeOfSuccess:l,beforeHeader:p,messageConfig:{critSuccess:`${m}${h}`,success:`${m}${h}`,failure:`${m}${h}`,critFailure:`${m}${h}`,rollMode:i}})}else await f(i,r,l)}t.parseMeta=u,t.parseUpgradeMeta=d,t.cooperativeLeadership=m,t.reRoll=async function(e,t,i){const{total:s,formula:r,activity:d,skill:h,dc:f,modifier:g,rollOptions:y,creativeSolutionModifier:v,supernaturalSolutionModifier:b,modifierBreakdown:k,rollType:w,rollMode:S,additionalChatMessages:x}=u(t),R=d?(0,a.unslugify)(d):(0,a.unslugify)(h);let _=r;const C=(0,o.getKingdom)(e);let A;"fame"===i?await(0,o.saveKingdom)(e,(0,l.gainFame)(C,-1)):"creative-solution"===i?(_=`1d20+${v}`,A="creative-solution",await(0,o.saveKingdom)(e,{creativeSolutions:C.creativeSolutions-1})):"supernatural-solution"===i?(A="supernatural-solution",_=`1d20+${b}`,await(0,o.saveKingdom)(e,{supernaturalSolutions:C.supernaturalSolutions-1})):"keep-higher"===i?_=`{${r},${s}}kh`:"keep-lower"===i&&(_=`{${r},${s}}kl`),await p({formula:_,label:R,activity:d?(0,n.getKingdomActivitiesById)(C.homebrewActivities)[d]:void 0,dc:f,skill:h,modifier:g,modifierBreakdown:k,actor:e,adjustDegreeOfSuccess:m((0,c.hasFeat)(C,"Cooperative Leadership"),C.level,C.skillRanks[h],y),rollOptions:y,rollType:A??w,supernaturalSolutionModifier:b,creativeSolutionModifier:v,rollMode:S,additionalChatMessages:x})},t.changeDegree=async function(e,t,i){const{activity:a,degree:r,rollMode:l,additionalChatMessages:c}=d(t),u=(0,o.getKingdom)(e),m=(0,n.getKingdomActivitiesById)(u.homebrewActivities)[a],p="upgrade"===i?function(e){return"success"===e?"criticalSuccess":"failure"===e?"success":"criticalFailure"===e?"failure":e}(r):function(e){return"criticalSuccess"===e?"success":"success"===e?"failure":"failure"===e?"criticalFailure":e}(r),f="criticalSuccess"===(g=p)?s.DegreeOfSuccess.CRITICAL_SUCCESS:"success"===g?s.DegreeOfSuccess.SUCCESS:"failure"===g?s.DegreeOfSuccess.FAILURE:s.DegreeOfSuccess.CRITICAL_FAILURE;var g;await y(e,m,l,c,f,f),await h(c,f,l)},t.rollCheck=p,t.addOngoingEvent=async function(e,t,i){const s=(0,o.getKingdom)(e),a=`@UUID[${t}]{${i}}`;await(0,o.saveKingdom)(e,{ongoingEvents:[...s.ongoingEvents,{name:a}]})}},1098:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeResourceDrawing=t.makeResourceTileOrDrawing=t.getStolenLandsData=t.parseSceneTiles=t.parseKingmaker=t.getSettlementsWithoutLandBorders=t.getActiveSettlementStructureResult=t.getAllMergedSettlements=t.getStructureStackMode=t.getStructureResult=t.getAllSettlements=t.getSettlement=t.getCapitalSettlement=t.getCurrentScene=t.getScene=t.getSceneStructures=t.getSettlementInfo=t.isStructureActorActive=t.isStructureActor=t.getStructuresFromActors=t.getStructureFromActor=t.getSceneActorStructures=void 0;const s=i(5302),a=i(9311),n=i(9549),r=i(1451),o=i(6185),l=i(6893),c=i(6690);class StructureError extends Error{}function u(e,t,i){return void 0!==e.lots?e:{...e,lots:0}}function d(e,t,i,s,r){if(null!=t){if("object"==typeof t&&"ref"in t){const i=t,s=n.structuresByName.get(i.ref);if(void 0===s)throw console.log(i,n.structuresByName),new StructureError(`No predefined structure data found for actor with name ${e}, aborting`);return u(s)}if((0,o.isNonNullable)(e)&&(0,o.isNonNullable)(r)){const i={name:e,level:r,construction:{skills:l.allSkills.map((e=>({skill:e}))),dc:0,rp:0},lots:0,...t},s=a.ruleSchema.validate(i);if(s.error)throw console.error(`Failed to validate structure with name ${e}`,t),console.error("Validation Error",s.error),new StructureError(`Structure with name ${e} failed to validate, aborting. See console log (F12) for more details`);return u(i)}return u(t)}}function m(e){e.token?.width??e.prototypeToken,e.token?.height??e.prototypeToken;const t=d(e.name,e.getFlag("pf2e-kingmaker-tools","structureData"),0,0,e.level);return t?{...t,actor:e}:null}function h(e){return e.map((e=>m(e))).filter((e=>null!==e))}function p(e){return(0,o.isNonNullable)(e.getFlag("pf2e-kingmaker-tools","structureData"))}function f(e){return void 0===e.itemTypes.condition?.find((e=>"condition"===e.type&&e.name.startsWith("Slowed")))}function g(e){return null!==e.actor&&void 0!==e.actor&&p(e.actor)&&f(e.actor)}function y(e,t,i){return t.xStart>=e.xStart-i&&t.xEnd<=e.xEnd+i&&t.yStart>=e.yStart-i&&t.yEnd<=e.yEnd+i}function v(e){const t=e.grid.size,i=Math.floor(.1*t),s=e.tokens.filter(g).map((e=>({xStart:e.x,yStart:e.y,xEnd:e.x+e.width*t,yEnd:e.y+e.height*t})));return function(e){return e.tiles.filter((e=>(0,o.isNonNullable)(e.getFlag("pf2e-kingmaker-tools","settlementBlockDrawing"))))}(e).filter((e=>function(e,t,i){return t.some((t=>y(e,t,i)))}({xStart:e.x,xEnd:e.x+e.width,yStart:e.y,yEnd:e.y+e.height},s,i))).length||1}function b(e,t,i){if(t&&!e.settlement.manualSettlementLevel){const t=v(e.scene);let s=Math.min(20,t);return i<15&&(s=Math.min(s,9)),i<9&&(s=Math.min(s,4)),i<3&&(s=Math.min(s,1)),{level:s,lots:t}}return{level:e.settlement.level,lots:e.settlement.lots}}function k(e){try{return e.tokens.filter(g).map((e=>[e.actor,e.width??1,e.height??1])).map((([e,t,i])=>d(e.name,e.getFlag("pf2e-kingmaker-tools","structureData"),0,0,e.level))).filter((e=>void 0!==e))??[]}catch(e){if(!(e instanceof StructureError))throw e;ui.notifications?.error(e.message)}return[]}function w(e,t){return e?.scenes?.find((e=>e.id===t))}function S(e,t){const i=t.settlements.find((e=>"capital"===e.type)),s=i?w(e,i.sceneId):void 0;if(s&&i)return{scene:s,settlement:i}}function x(e,t,i){const s=t.settlements.find((e=>e.sceneId===i)),a=w(e,i);if(a&&s)return{settlement:s,scene:a}}function R(e,t){return e.scenes?.map((i=>x(e,t,i.id)))?.filter((e=>void 0!==e))??[]}function _(e,t,i,a,n){const r=k(e.scene),o=b(e,i,n).level;return(0,s.evaluateStructures)(r,o,t,a)}function C(e,t,i,a,n,r){return r&&r.scene.id!==a.scene.id?(0,s.includeCapital)(_(r,e,t,i,n),_(a,e,t,i,n)):_(a,e,t,i,n)}function A(e){return(0,r.getBooleanSetting)(e,"kingdomAllStructureItemBonusesStack")?"all-structures-stack":"same-structures-stack"}function $(e,t,i){return e.filter((e=>e.camp===t)).reduce(((e,s)=>{const a=s.commodity===i?1:0,n="mine"===t&&"luxuries"===s.commodity?0:1;return"luxuries"===i?{quantity:e.quantity+a,resources:e.resources}:{quantity:e.quantity+n,resources:e.resources+a}}),{quantity:0,resources:0})}function T(e){const t=Object.values(e.hexes).filter((e=>e.claimed)),i=t.filter((e=>e.features?.some((e=>"farmland"===e.type)))),s=t.filter((e=>"food"===e.commodity));return{size:t.length,workSites:{farmlands:{quantity:i.length,resources:s.length},quarries:$(t,"quarry","stone"),mines:$(t,"mine","ore"),lumberCamps:$(t,"lumber","lumber"),luxurySources:$(t,"mine","luxuries")}}}function I(e,t){const i=e.getFlag("pf2e-kingmaker-tools","realmTile");if(i){const{width:s,height:a}=t(e);return{...i,xStart:e.x,xEnd:e.x+s,yStart:e.y,yEnd:e.y+a}}}function D(e,t){const i={lumberCamp:"lumber",mine:"ore",quarry:"stone",luxuryWorksite:"luxury"}[e],s=t.filter((t=>t.type===e)).length;return{quantity:s,resources:s>0?t.filter((e=>e.type===i)).length:0}}function M(e,t){return{luxurySources:{resources:e.luxurySources.resources+t.luxurySources.resources,quantity:e.luxurySources.quantity+t.luxurySources.quantity},lumberCamps:{resources:e.lumberCamps.resources+t.lumberCamps.resources,quantity:e.lumberCamps.quantity+t.lumberCamps.quantity},quarries:{resources:e.quarries.resources+t.quarries.resources,quantity:e.quarries.quantity+t.quarries.quantity},farmlands:{resources:e.farmlands.resources+t.farmlands.resources,quantity:e.farmlands.quantity+t.farmlands.quantity},mines:{resources:e.mines.resources+t.mines.resources,quantity:e.mines.quantity+t.mines.quantity}}}function E(e,t){const i=e.filter((e=>"claimed"===e.type)),s=new Set(e.filter((e=>"claimed"!==e.type))),a=i.map((e=>{const i=Array.from(s).filter((i=>y(e,i,t)));i.forEach((e=>s.delete(e)));return{farmlands:{quantity:i.filter((e=>"farmland"===e.type)).length,resources:i.filter((e=>"food"===e.type)).length},lumberCamps:D("lumberCamp",i),mines:D("mine",i),quarries:D("quarry",i),luxurySources:D("luxuryWorksite",i)}})).reduce(M,{luxurySources:{resources:0,quantity:0},lumberCamps:{resources:0,quantity:0},quarries:{resources:0,quantity:0},farmlands:{resources:0,quantity:0},mines:{resources:0,quantity:0}});return{size:i.length,workSites:a}}function L(e,t){const i=function(e,t){if((0,o.isNonNullable)(t))return e.scenes?.find((e=>e.id===t))}(e,t);if(i){const e=Math.floor(.1*i.grid.size);return E([...i.tiles.filter((e=>e.visible)).map((e=>I(e,(e=>({width:e.width,height:e.height}))))).filter((e=>(0,o.isNonNullable)(e))),...i.drawings.filter((e=>e.visible)).map((e=>I(e,(e=>({width:e.shape.width,height:e.shape.height}))))).filter((e=>(0,o.isNonNullable)(e)))],e)}return{workSites:{luxurySources:{resources:0,quantity:0},lumberCamps:{resources:0,quantity:0},quarries:{resources:0,quantity:0},farmlands:{resources:0,quantity:0},mines:{resources:0,quantity:0}},size:0}}t.getSceneActorStructures=function(e){return h(e.tokens.map((e=>e.actor)).filter((e=>(0,o.isNonNullable)(e))))},t.getStructureFromActor=m,t.getStructuresFromActors=h,t.isStructureActor=p,t.isStructureActorActive=f,t.getSettlementInfo=b,t.getSceneStructures=k,t.getScene=w,t.getCurrentScene=function(e){return e.scenes?.viewed},t.getCapitalSettlement=S,t.getSettlement=x,t.getAllSettlements=R,t.getStructureResult=C,t.getStructureStackMode=A,t.getAllMergedSettlements=function(e,t){const i=A(e),s=(0,c.getKingdomActivitiesById)(t.homebrewActivities),a=(0,r.getBooleanSetting)(e,"autoCalculateSettlementLevel");return R(e,t).map((e=>{const n=_(e,i,a,s,t.level);return{leadershipActivityNumber:n.increaseLeadershipActivities?3:2,settlementConsumption:n.consumption,storage:n.storage,unlockedActivities:new Set(n.unlockActivities)}})).reduce(((e,t)=>({leadershipActivityNumber:Math.max(e.leadershipActivityNumber,t.leadershipActivityNumber),settlementConsumption:e.settlementConsumption+t.settlementConsumption,storage:{ore:e.storage.ore+t.storage.ore,stone:e.storage.stone+t.storage.stone,luxuries:e.storage.luxuries+t.storage.luxuries,lumber:e.storage.lumber+t.storage.lumber,food:e.storage.food+t.storage.food},unlockedActivities:new Set([...e.unlockedActivities,...t.unlockedActivities])})),{leadershipActivityNumber:2,settlementConsumption:0,storage:{ore:0,stone:0,luxuries:0,lumber:0,food:0},unlockedActivities:new Set})},t.getActiveSettlementStructureResult=function(e,t){const i=x(e,t,t.activeSettlement),s=S(e,t),a=(0,c.getKingdomActivitiesById)(t.homebrewActivities),n=(0,r.getBooleanSetting)(e,"autoCalculateSettlementLevel");if(i){const r=A(e);return{active:C(r,n,a,i,t.level),merged:C(r,n,a,i,t.level,s)}}},t.getSettlementsWithoutLandBorders=function(e,t){const i=A(e),s=(0,r.getBooleanSetting)(e,"autoCalculateSettlementLevel"),a=(0,c.getKingdomActivitiesById)(t.homebrewActivities);return R(e,t).filter((e=>{const n=C(i,s,a,e,t.level);return(e.settlement?.waterBorders??0)>=4&&!n.hasBridge})).length},t.parseKingmaker=T,t.parseSceneTiles=E,t.getStolenLandsData=function(e,t,i){return"kingmaker"===t&&(0,o.isKingmakerInstalled)(e)?T(kingmaker.state):"tileBased"===t?L(e,i.realmSceneId):{size:i.size,workSites:i.workSites}},t.makeResourceTileOrDrawing=async function(e,t){await e.setFlag("pf2e-kingmaker-tools","realmTile",{type:t})},t.makeResourceDrawing=async function(e,t){await e.setFlag("pf2e-kingmaker-tools","realmTile",{type:t})}},9311:function(e,t,i){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ruleSchema=t.refSchema=void 0;const a=s(i(6075)),n=i(6893),r=i(9549),o=r.structuresByName.keys();t.refSchema=a.default.object({ref:a.default.string().valid(...o)}),t.ruleSchema=a.default.object({name:a.default.string().required(),notes:a.default.string().optional(),preventItemLevelPenalty:a.default.boolean().optional(),enableCapitalInvestment:a.default.boolean().optional(),increaseLeadershipActivities:a.default.boolean().optional(),consumptionReduction:a.default.number().optional(),activityBonusRules:a.default.array().items(a.default.object({value:a.default.number().required(),activity:a.default.string().required()})).optional(),skillBonusRules:a.default.array().items(a.default.object({value:a.default.number().required(),skill:a.default.string().valid(...n.allSkills).required(),activity:a.default.string().optional()})).optional(),availableItemsRules:a.default.array().items(a.default.object({value:a.default.number().required(),group:a.default.string().valid(...r.itemGroups).optional(),maximumStacks:a.default.number().optional()})).optional(),settlementEventRules:a.default.array().items(a.default.object({value:a.default.number().required()})).optional(),leadershipActivityRules:a.default.array().items(a.default.object({value:a.default.number().required()})).optional(),storage:a.default.object({ore:a.default.number().optional(),food:a.default.number().optional(),lumber:a.default.number().optional(),stone:a.default.number().optional(),luxuries:a.default.number().optional()}).optional(),unlockActivities:a.default.array().items(a.default.string()).optional(),traits:a.default.array().items(a.default.string().valid(...r.allBuildingTraits)).optional(),isBridge:a.default.boolean().optional(),stacksWith:a.default.string().optional(),lots:a.default.number().optional(),level:a.default.number().optional(),affectsEvents:a.default.boolean().optional(),upgradeFrom:a.default.array().items(a.default.string()).optional(),affectsDowntime:a.default.boolean().optional(),reducesUnrest:a.default.boolean().optional(),reducesRuin:a.default.boolean().optional(),construction:a.default.object({skills:a.default.array().items(a.default.object({skill:a.default.array().valid(...n.allSkills),proficiencyRank:a.default.number().valid(0,1,2,3,4).optional()})),lumber:a.default.number().optional(),luxuries:a.default.number().optional(),ore:a.default.number().optional(),stone:a.default.number().optional(),rp:a.default.number(),dc:a.default.number()})})},3897:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showKingdom=void 0;const s=i(1451),a=i(7894),n=i(6185),r=i(1098),o=i(554),l=i(5970),c=i(567),u=i(3195),d=i(4227),m=i(8796),h=i(3934),p=i(2752),f=i(1290),g=i(5593),y=i(8534),v=i(8577),b=i(8937),k=i(6492),w=i(1145),S=i(3824),x=i(9522),R=i(4767),_=i(5663),C=i(8422),A=i(5317),$=i(5639),T=i(2865),I=i(1436),D=i(6690),M=i(8480),E=i(1032),L=i(5388),O=i(4913),P=i(9774),F=i(3306),B=[...Array.from(Array(20).keys()).map((e=>e+1))];class KingdomApp extends FormApplication{sheetActor;game;nav="turn";constructor(e,t){super(e,t),this.game=t.game,this.sheetActor=t.sheetActor,this.sheetActor.apps[this.appId]=this}static get defaultOptions(){const e=super.defaultOptions;return e.id="kingdom-app",e.title="Kingdom",e.template="modules/pf2e-kingmaker-tools/templates/kingdom/sheet.hbs",e.submitOnChange=!0,e.closeOnSubmit=!1,e.classes=["kingmaker-tools-app","kingdom-app"],e.width=850,e.height="auto",e.scrollY=[".km-content",".km-sidebar"],e}async getData(){const e=this.game.user?.isGM??!1,t=this.getKingdom();this.object=t;const i=(0,s.getStringSetting)(this.game,"automateResources"),o=(0,s.getBooleanSetting)(this.game,"autoCalculateArmyConsumption"),{size:l,workSites:c}=(0,r.getStolenLandsData)(this.game,i,t),u=(0,a.getSizeData)(l),d=(0,s.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),{leadershipActivityNumber:m,settlementConsumption:h,unlockedActivities:g}=(0,r.getAllMergedSettlements)(this.game,t),{current:v,surplus:b}=(0,_.getConsumption)(this.game,t),k=(0,s.getBooleanSetting)(this.game,"vanceAndKerensharaXP"),w=(0,s.getBooleanSetting)(this.game,"kingdomSkillIncreaseEveryLevel"),x=(0,r.getActiveSettlementStructureResult)(this.game,t),R=(0,r.getSettlement)(this.game,t,t.activeSettlement),A=(new Set([...g]),(0,r.getCurrentScene)(this.game)?.id),$=void 0===t.settlements.find((e=>e.sceneId===A)),T=(0,n.isNonNullable)(A)&&A!==t.realmSceneId,I=(0,r.getStructureStackMode)(this.game),M="manual"!==i,E=e&&"tileBased"===i,L="kingmaker"===i||"manual"===i||(0,n.isNonNullable)(t.realmSceneId)&&void 0!==this.game.scenes?.find((e=>e.id===t.realmSceneId)),O=(0,s.getBooleanSetting)(this.game,"kingdomIgnoreSkillRequirements"),P=(0,D.getKingdomActivitiesById)(t.homebrewActivities),F=(0,f.getPerformableActivities)(t.skillRanks,!0===x?.active?.allowCapitalInvestment||"capital"===R?.settlement.type&&(0,s.getBooleanSetting)(this.game,"capitalInvestmentInCapital"),O,P),j=(0,f.groupKingdomActivities)(P);let K=t.activityBlacklist.map((e=>({[e]:!0})));Object.keys(P).forEach((e=>{const i=P[e];i.requiredFeat&&!(0,a.hasFeat)(t,i.requiredFeat)&&K.push({[e]:!0})}));const q=K.reduce(((e,t)=>Object.assign(e,t)),{});return{notes:{gm:await TextEditor.enrichHTML(t.notes.gm),public:await TextEditor.enrichHTML(t.notes.public)},hideActivities:q,isGM:e,isUser:!e,enabledActivities:F,leadershipActivityNumber:m,name:t.name,size:l,xp:t.xp,xpThreshold:t.xpThreshold,level:t.level,fame:t.fame,charter:t.charter,heartland:t.heartland,heartlandLabel:(0,n.unslugify)(t.heartland),government:t.government,type:(0,n.capitalize)(u.type),controlDC:(0,a.getControlDC)(t.level,l,t.leaders.ruler.vacant),atWar:t.atWar,unrest:t.unrest,unrestPenalty:(0,C.calculateUnrestPenalty)(t.unrest),anarchyAt:this.calculateAnarchy(t.feats,t.bonusFeats),resourceDieSize:u.resourceDieSize,resourceDiceNum:this.getResourceDiceNum(t),resourceDice:t.resourceDice,resourcePoints:t.resourcePoints,consumption:t.consumption,activeSettlement:t.activeSettlement,supernaturalSolutions:t.supernaturalSolutions,creativeSolutions:t.creativeSolutions,autoCalculateArmyConsumption:o,levels:(0,n.toLabelAndValue)(B),settlementConsumption:h,totalConsumption:v,farmSurplus:b,ruin:this.getRuin(t.ruin),commodities:this.getCommodities(t),workSites:this.getWorkSites(c),farmlands:c.farmlands.quantity,food:c.farmlands.resources,...this.getActiveTabs(),skills:(0,y.calculateSkills)({ruin:t.ruin,skillRanks:t.skillRanks,leaders:t.leaders,abilityScores:t.abilityScores,unrest:t.unrest,kingdomLevel:t.level,untrainedProficiencyMode:(0,S.getUntrainedProficiencyMode)(this.game),skillItemBonuses:x?.merged?.skillBonuses,additionalModifiers:(0,S.createActiveOtherModifiers)(t,R?.settlement,x,(0,r.getSettlementsWithoutLandBorders)(this.game,t)),activities:P}),leaders:this.getLeaders(t.leaders),abilities:this.getAbilities(t.abilityScores,t.leaders,t.level),fameTypes:a.allFameTypes,fameLabel:this.getFameLabel(t.fame.type),groups:t.groups,...this.getFeats(t.feats,t.bonusFeats,t.level),tradeAgreementsSize:t.groups.filter((e=>"trade-agreement"===e.relations)).length,ranks:[{label:"Untrained",value:0},{label:"Trained",value:1},{label:"Expert",value:2},{label:"Master",value:3},{label:"Legendary",value:4}],heartlands:a.allHeartlands.map((e=>({label:(0,n.unslugify)(e),value:e}))),fameValues:(0,n.toLabelAndValue)((0,n.range)(0,t.fame.max+1)),aspirations:[{value:"famous",label:"Fame"},{value:"infamous",label:"Infamy"}],settlements:t.settlements.map((e=>(0,r.getSettlement)(this.game,t,e.sceneId))).filter((e=>void 0!==e)).map((e=>{const i=e,s=i.settlement.waterBorders??0,a=(0,r.getStructureResult)(I,d,P,i,t.level),n=(0,r.getSettlementInfo)(i,d,t.level),o="capital"===e?.settlement.type;return{...i.settlement,...n,waterBorders:s,overcrowded:this.isOvercrowded(i,t.level),residentialLots:a.residentialLots,lacksBridge:s>=4&&!a.hasBridge,isCapital:o,name:i.scene.name??void 0}})),groupRelationTypes:[{label:"None",value:"none"},{label:"Diplomatic Relations",value:"diplomatic-relations"},{label:"Trade Agreement",value:"trade-agreement"}],ongoingEvents:await Promise.all(t.ongoingEvents.map((e=>TextEditor.enrichHTML(e.name)))),milestones:t.milestones.map((t=>({...t,display:(k||!t.homebrew)&&(e||!t.name.startsWith("Cult Event"))}))),leadershipActivities:Array.from(j.leadership).map((e=>({label:(0,f.createActivityLabel)(j,e,t),value:e}))).sort(((e,t)=>e.label.localeCompare(t.label))),regionActivities:Array.from(j.region).map((e=>({label:(0,f.createActivityLabel)(j,e,t),value:e}))),armyActivities:Array.from(j.army).map((e=>({label:(0,f.createActivityLabel)(j,e,t),value:e}))),featuresByLevel:Array.from(p.featuresByLevel.entries()).map((([e,t])=>{const i=t.map((e=>e.name));return w&&e%2==0&&i.push("Skill Increase"),{level:e,features:i.join(", ")}})),uniqueFeatures:p.uniqueFeatures,canLevelUp:t.xp>=t.xpThreshold&&t.level<20,turnsWithoutEvent:t.turnsWithoutEvent,eventDC:this.calculateEventDC(t.turnsWithoutEvent),turnsWithoutCultEvent:t.turnsWithoutCultEvent,cultEventDC:this.calculateCultEventDC(t.turnsWithoutCultEvent),civicPlanning:t.level>=12,useXpHomebrew:k,canAddSettlement:$,effects:(U=t.modifiers,U.map((e=>({name:e.name,effect:(0,S.modifierToLabel)(e),turns:void 0===e.turns?"indefinite":`${e.turns}`,consumable:void 0!==e.consumeId})))),cultOfTheBloomEvents:(0,s.getBooleanSetting)(this.game,"cultOfTheBloomEvents")&&e,automateResources:M,canAddRealm:T,showRealmData:L,showAddRealmButton:E};var U}async _updateObject(e,t){console.log(t);const i=this.getKingdom().milestones,s=foundry.utils.expandObject(t);s.groups=(0,n.unpackFormArray)(s.groups),s.feats=(0,n.unpackFormArray)(s.feats),s.bonusFeats=(0,n.unpackFormArray)(s.bonusFeats),s.milestones=(0,n.unpackFormArray)(s.milestones).map(((e,t)=>({...i[t],completed:e.completed}))),await this.saveKingdom(s)}sceneChange(){this.render()}activateListeners(e){super.activateListeners(e),Hooks.on("closeKingmakerHexEdit",this.sceneChange.bind(this)),Hooks.on("deleteScene",this.sceneChange.bind(this)),Hooks.on("canvasReady",this.sceneChange.bind(this)),Hooks.on("createToken",this.sceneChange.bind(this)),Hooks.on("deleteToken",this.sceneChange.bind(this)),Hooks.on("sightRefresh",this.sceneChange.bind(this)),Hooks.on("applyTokenStatusEffect",this.sceneChange.bind(this)),Hooks.on("createTile",this.sceneChange.bind(this)),Hooks.on("updateTile",this.sceneChange.bind(this)),Hooks.on("deleteTile",this.sceneChange.bind(this)),Hooks.on("createDrawing",this.sceneChange.bind(this)),Hooks.on("updateDrawing",this.sceneChange.bind(this)),Hooks.on("deleteDrawing",this.sceneChange.bind(this));const t=e[0];t.querySelectorAll(".km-nav a")?.forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget;this.nav=t.dataset.tab,this.render()}))})),t.querySelectorAll(".km-reduce-ruin").forEach((e=>e.addEventListener("click",(async e=>await this.reduceRuin(e))))),t.querySelector("#km-kingdom-size-help")?.addEventListener("click",(async e=>{e.stopPropagation(),e.preventDefault(),(0,E.kingdomSizeDialog)()})),t.querySelector("#km-settlement-size-help")?.addEventListener("click",(async e=>{e.stopPropagation(),e.preventDefault(),(0,L.settlementSizeDialog)()})),t.querySelector("#km-gain-fame")?.addEventListener("click",(async()=>await this.upkeepGainFame())),t.querySelector("#km-adjust-unrest")?.addEventListener("click",(async()=>await this.adjustUnrest())),t.querySelector("#km-collect-resources")?.addEventListener("click",(async()=>await this.collectResources())),t.querySelector("#km-reduce-unrest")?.addEventListener("click",(async()=>await this.reduceUnrest())),t.querySelector("#km-pay-consumption")?.addEventListener("click",(async()=>await this.payConsumption())),t.querySelector("#km-check-event")?.addEventListener("click",(async()=>await this.checkForEvent())),t.querySelector("#km-check-cult-event")?.addEventListener("click",(async()=>await this.checkForCultEvent())),t.querySelector("#km-roll-event")?.addEventListener("click",(async()=>await(0,d.rollKingdomEvent)(this.game))),t.querySelector("#km-roll-cult-event")?.addEventListener("click",(async()=>await(0,d.rollCultEvent)(this.game))),t.querySelector("#claimed-refuge")?.addEventListener("click",(async()=>await this.claimedHexFeature("refuge"))),t.querySelector("#km-open-structure-browser")?.addEventListener("click",(async()=>await this.showStructureBrowser())),t.querySelector(".kingdom-activity[data-activity=train-army]")?.addEventListener("click",(async()=>await this.showTacticsBrowser())),t.querySelector(".kingdom-activity[data-activity=recruit-army]")?.addEventListener("click",(async()=>await this.showArmyBrowser())),t.querySelectorAll(".km-view-settlement-scene")?.forEach((e=>{e.addEventListener("click",(async e=>{await this.viewSettlementScene(e)}))})),t.querySelector("#claimed-landmark")?.addEventListener("click",(async()=>await this.claimedHexFeature("landmark"))),t.querySelector("#km-add-event")?.addEventListener("click",(async()=>(0,u.addOngoingEventDialog)((e=>{const t=this.getKingdom();this.saveKingdom({ongoingEvents:[...t.ongoingEvents,{name:e}]})})))),t.querySelectorAll(".km-remove-event")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"ongoingEvents")))})),t.querySelectorAll(".km-event-xp")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.modifier??"0",10);await this.increaseXP((0,m.calculateEventXP)(i))}))})),t.querySelectorAll(".km-claimed-hexes-xp")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget,i=parseInt(t.dataset.hexes??"0",10),a=this.getKingdom(),n=(0,s.getStringSetting)(this.game,"automateResources"),{size:o}=(0,r.getStolenLandsData)(this.game,n,a),l=(0,s.getBooleanSetting)(this.game,"vanceAndKerensharaXP");await this.increaseXP((0,m.calculateHexXP)({hexes:i,kingdomSize:o,useVK:l,xpPerClaimedHex:(0,s.getNumberSetting)(this.game,"xpPerClaimedHex")}))}))})),t.querySelector("#km-rp-to-xp")?.addEventListener("click",(async()=>{const e=this.getKingdom(),t=(0,s.getBooleanSetting)(this.game,"vanceAndKerensharaXP");await this.increaseXP((0,m.calculateRpXP)({useVK:t,kingdomLevel:e.level,rpToXpConversionLimit:(0,s.getNumberSetting)(this.game,"rpToXpConversionLimit"),rpToXpConversionRate:(0,s.getNumberSetting)(this.game,"rpToXpConversionRate"),rp:e.resourcePoints.now}))})),t.querySelector("#solutions-to-xp")?.addEventListener("click",(async()=>{const e=this.getKingdom();await this.increaseXP(10*(e.supernaturalSolutions+e.creativeSolutions))})),t.querySelector("#km-level-up")?.addEventListener("click",(async()=>{const e=this.getKingdom();e.xp>=e.xpThreshold?await this.saveKingdom({level:e.level+1,xp:e.xp-e.xpThreshold}):ui.notifications?.error("Can not level up, not enough XP")})),t.querySelector("#km-add-group")?.addEventListener("click",(async()=>{(0,l.addGroupDialog)((e=>this.saveKingdom({groups:[...this.getKingdom().groups,e]})))})),t.querySelectorAll(".km-delete-group")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"groups")))})),t.querySelector("#km-add-bonus-feat")?.addEventListener("click",(async()=>{new c.AddBonusFeatDialog(null,{feats:o.allFeats,onOk:e=>this.saveKingdom({bonusFeats:[...this.getKingdom().bonusFeats,e]})}).render(!0)})),t.querySelector("#manage-kingdom-activities")?.addEventListener("click",(async()=>{(0,M.manageKingdomActivitiesDialog)(this.game,this.sheetActor)})),t.querySelectorAll(".km-delete-bonus-feat")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"bonusFeats")))})),t.querySelectorAll(".kingdom-activity:not([data-activity=train-army]):not([data-activity=recruit-army])")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget.dataset.activity,i=this.getKingdom();"none"===(0,D.getKingdomActivitiesById)(i.homebrewActivities)[t].dc?await(0,k.showHelpDialog)(this.game,this.sheetActor,t):new b.CheckDialog(null,{activity:t,kingdom:i,game:this.game,type:"activity",onRoll:this.consumeModifiers.bind(this),actor:this.sheetActor}).render(!0)}))})),t.querySelectorAll(".kingdom-skill")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget.dataset.skill;new b.CheckDialog(null,{kingdom:this.getKingdom(),game:this.game,skill:t,type:"skill",onRoll:this.consumeModifiers.bind(this),actor:this.sheetActor}).render(!0)}))})),t.querySelector("#km-end-turn")?.addEventListener("click",(async()=>await this.endTurn())),t.querySelectorAll(".show-help")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e.currentTarget.dataset.help;t&&await(0,k.showHelpDialog)(this.game,this.sheetActor,t)}))})),t.querySelector("#make-current-scene-realm")?.addEventListener("click",(async()=>{const e=(0,r.getCurrentScene)(this.game),t=e?.id;t&&await this.saveKingdom({realmSceneId:t})})),t.querySelector("#make-current-scene-settlement")?.addEventListener("click",(async()=>{const e=(0,r.getCurrentScene)(this.game),t=e?.id;if(t){const e={sceneId:t,level:0,type:"settlement",lots:0,secondaryTerritory:!1,waterBorders:0},i=this.getKingdom();await this.saveKingdom({settlements:[...i.settlements,e],activeSettlement:0===i.settlements.length?t:i.activeSettlement})}})),t.querySelectorAll(".km-delete-settlement")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"settlements")))})),t.querySelectorAll(".inspect-settlement")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=this.getKingdom(),i=e.currentTarget.dataset.id;await(0,w.showSettlement)(this.game,i,t)}))})),t.querySelector("#km-add-effect")?.addEventListener("click",(async()=>{const e=Object.keys((0,D.getKingdomActivitiesById)(this.getKingdom().homebrewActivities));(0,x.addEffectDialog)(e,(async e=>{const t=this.getKingdom();t.modifiers.push(e),await this.saveKingdom(t)}))})),t.querySelectorAll(".km-delete-effect")?.forEach((e=>{e.addEventListener("click",(async e=>await this.deleteKingdomPropertyAtIndex(e,"modifiers")))})),t.querySelector(".kingdom-settings")?.addEventListener("click",(()=>(0,$.showKingdomSettings)({game:this.game,sheetActor:this.sheetActor,onSave:()=>{this.render()}}))),t.querySelectorAll(".edit-settlement")?.forEach((e=>{e.addEventListener("click",(async e=>{const t=e?.currentTarget,i=parseInt(t?.dataset?.index,10),a=this.getKingdom(),n=a.settlements[i],o=(0,r.getScene)(this.game,n.sceneId)?.name,l=(0,s.getBooleanSetting)(this.game,"autoCalculateSettlementLevel");(0,A.editSettlementDialog)(l,o,n,(e=>{a.settlements[i]=e,this.saveKingdom({settlements:a.settlements})}))}))}))}close(e){return Hooks.off("closeKingmakerHexEdit",this.sceneChange),Hooks.off("deleteScene",this.sceneChange),Hooks.off("canvasReady",this.sceneChange),Hooks.off("createToken",this.sceneChange),Hooks.off("sightRefresh",this.sceneChange),Hooks.off("deleteToken",this.sceneChange),Hooks.off("applyTokenStatusEffect",this.sceneChange),Hooks.off("createTile",this.sceneChange),Hooks.off("updateTile",this.sceneChange),Hooks.off("deleteTile",this.sceneChange),Hooks.off("createDrawing",this.sceneChange),Hooks.off("updateDrawing",this.sceneChange),Hooks.off("deleteDrawing",this.sceneChange),super.close(e)}_getHeaderButtons(){const e=super._getHeaderButtons();return e.unshift({label:"Help",class:"pf2e-kingmaker-tools-hb1",icon:"fas fa-question",onclick:()=>(0,T.openJournal)("Compendium.pf2e-kingmaker-tools.kingmaker-tools-journals.JournalEntry.iAQCUYEAq4Dy8uCY.JournalEntryPage.ty6BS5eSI7ScfVBk")}),this.game.user?.isGM&&e.unshift({label:"Show Players",class:"something-made-up",icon:"fas fa-eye",onclick:()=>this.game.socket.emit("module.pf2e-kingmaker-tools",{action:"openKingdomSheet"})}),e}getFameLabel(e){return"famous"===e?"Fame":"Infamy"}getActiveTabs(){return{statusTab:"status"===this.nav,skillsTab:"skills"===this.nav,turnTab:"turn"===this.nav,groupsTab:"groups"===this.nav,featsTab:"feats"===this.nav,notesTab:"notes"===this.nav,settlementsTab:"settlements"===this.nav,effectsTab:"effects"===this.nav}}async upkeepGainFame(){await ChatMessage.create({content:"Gaining 1 Fame"}),await this.saveKingdom((0,_.gainFame)(this.getKingdom(),1))}async consumeModifiers(e){const t=this.getKingdom();await this.saveKingdom({modifiers:t.modifiers.filter((t=>{const i=t.consumeId;return null==i||!e.has(i)}))})}async reduceRuin(e){const t=e.currentTarget.dataset.ruin,i=await new Roll("1d20").roll();if(await i.toMessage({flavor:`Reducing ${(0,n.capitalize)(t)} on a 16 or higher`}),i.total>=16){const e=this.getKingdom();await this.saveKingdom({ruin:{...e.ruin,[t]:{...e.ruin[t],penalty:Math.max(0,e.ruin[t].penalty-1)}}})}}async increaseXP(e){await ChatMessage.create({content:`Gained ${e} Kingdom XP`}),await this.saveKingdom({xp:this.getKingdom().xp+e})}async endTurn(){const e=this.getKingdom(),t=(0,_.getCapacity)(this.game,e);await ChatMessage.create({content:"<h2>Ending Turn</h2>\n            <ul>\n                <li>Setting Resource Points to 0</li>\n                <li>Reducing Effects' Turns by 1</li>\n                <li>Setting available Supernatural and Creative Solutions to 0</li>\n                <li>Adding values from the <b>next</b> columns to the <b>now</b> columns respecting their resource limits</li>\n            </ul>\n            "});const i=e.modifiers.map((e=>{const t=void 0===e.turns?void 0:e.turns-1;return{...e,turns:t}})).filter((e=>(e?.turns??1)>0));await this.saveKingdom({modifiers:i,fame:{...e.fame,now:(0,n.clamped)(e.fame.next,0,e.fame.max),next:0},resourceDice:{now:e.resourceDice.next,next:0},supernaturalSolutions:0,creativeSolutions:0,resourcePoints:{now:e.resourcePoints.next,next:0},consumption:{now:e.consumption.next,next:0,armies:e.consumption.armies},commodities:{now:{food:Math.min(t.food,e.commodities.now.food+e.commodities.next.food),luxuries:Math.min(t.luxuries,e.commodities.now.luxuries+e.commodities.next.luxuries),stone:Math.min(t.stone,e.commodities.now.stone+e.commodities.next.stone),lumber:Math.min(t.lumber,e.commodities.now.lumber+e.commodities.next.lumber),ore:Math.min(t.ore,e.commodities.now.ore+e.commodities.next.ore)},next:{food:0,luxuries:0,stone:0,lumber:0,ore:0}}})}isOvercrowded(e,t){const i=(0,r.getStructureStackMode)(this.game),a=(0,s.getBooleanSetting)(this.game,"autoCalculateSettlementLevel"),n=(0,D.getKingdomActivitiesById)(this.getKingdom().homebrewActivities),o=(0,r.getStructureResult)(i,a,n,e,t);return(0,r.getSettlementInfo)(e,a,t).lots>o.residentialLots}async adjustUnrest(){const e=this.getKingdom(),t=(0,r.getAllSettlements)(this.game,e),i=t.filter((t=>this.isOvercrowded(t,e.level))).length,s=t.some((e=>e.settlement.secondaryTerritory))?1:0,a=e.atWar?1:0;let n=0;if(e.leaders.ruler.vacant){const e=await new Roll("1d4").roll();await e.toMessage({flavor:"Gaining Unrest because Leader is vacant"}),n=e.total}const o=a+i+s+n;let l=o+e.unrest;if(e.level>=20&&l>0?(l=0,await ChatMessage.create({content:'Ignoring any Unrest increase due to "Envy of the World" Kingdom Feature'})):await ChatMessage.create({content:`<h2>Gaining Unrest</h2> \n                <ul>\n                    <li><b>Overcrowded Settlements</b>: ${i}</li>\n                    <li><b>Secondary Territories</b>: ${s}</li>\n                    <li><b>Kingdom At War</b>: ${a}</li>\n                    <li><b>Ruler Vacancy Penalty</b>: ${n}</li>\n                    <li><b>Total</b>: ${o}</li>\n                </ul>\n                `}),l>=8){const e=await new Roll("1d10").roll();await e.toMessage({flavor:"Gaining points to Ruin (distribute as you wish)"});const t=await new Roll("1d20").roll();await t.toMessage({flavor:"Check if losing a hex on DC 11"}),t.total>=11&&await ChatMessage.create({content:"You lose one hex of your choice"})}l>=this.calculateAnarchy(e.feats,e.bonusFeats)&&await ChatMessage.create({content:"Kingdom falls into anarchy, unless you spend all fame/infamy points. Only Quell Unrest leadership activities can be performed and all checks are worsened by a degree"}),await this.saveKingdom({unrest:l})}async checkForEvent(){const e=(0,s.getStringSetting)(this.game,"kingdomEventRollMode"),t=this.getKingdom().turnsWithoutEvent,i=this.calculateEventDC(t),a=await new Roll("1d20").roll();await a.toMessage({flavor:`Checking for Event on DC ${i}`},{rollMode:e}),a.total>=i?(await(0,n.postChatMessage)("An event occurs, roll a Kingdom Event!",e),await this.saveKingdom({turnsWithoutEvent:0})):await this.saveKingdom({turnsWithoutEvent:t+1})}async checkForCultEvent(){const e=(0,s.getStringSetting)(this.game,"kingdomEventRollMode"),t=this.getKingdom().turnsWithoutCultEvent,i=this.calculateCultEventDC(t),a=await new Roll("1d20").roll();await a.toMessage({flavor:`Checking for Cult Event on DC ${i}`},{rollMode:e}),a.total>=i?(await(0,n.postChatMessage)("An event occurs, roll a Cult Event!",e),await this.saveKingdom({turnsWithoutCultEvent:0})):await this.saveKingdom({turnsWithoutCultEvent:t+1})}async deleteKingdomPropertyAtIndex(e,t){const i=e.currentTarget.dataset.deleteIndex;if(i){const e=parseInt(i,10),s=[...this.getKingdom()[t]];s.splice(e,1),await this.saveKingdom({[t]:s})}}async collectResources(){const e=this.getKingdom(),t=(0,s.getStringSetting)(this.game,"automateResources"),{size:i,workSites:n}=(0,r.getStolenLandsData)(this.game,t,e),o=(0,a.getSizeData)(i),l=(0,_.getCapacity)(this.game,e),c=this.getResourceDiceNum(e),u=await this.rollResourceDice(o.resourceDieSize,c),d=this.calculateCommoditiesThisTurn(n);await ChatMessage.create({content:`\n        <h2>Collecting Resources</h2>\n        <ul>\n            <li><b>Resource Points</b>: ${u}</li>\n            <li><b>Ore</b>: ${d.ore}</li>\n            <li><b>Lumber</b>: ${d.lumber}</li>\n            <li><b>Stone</b>: ${d.stone}</li>\n            <li><b>Luxuries</b>: ${d.luxuries}</li>\n        </ul>\n        `}),await this.saveKingdom({resourcePoints:{now:e.resourcePoints.now+u,next:e.resourcePoints.next},resourceDice:{now:0,next:e.resourceDice.next},commodities:{now:{ore:Math.min(l.ore,e.commodities.now.ore+d.ore),lumber:Math.min(l.lumber,e.commodities.now.lumber+d.lumber),luxuries:Math.min(l.luxuries,e.commodities.now.luxuries+d.luxuries),stone:Math.min(l.stone,e.commodities.now.stone+d.stone),food:e.commodities.now.food},next:e.commodities.next}})}getResourceDiceNum(e){const t=(0,a.hasFeat)(e,"Insider Trading")?1:0,i=(0,a.getLevelData)(e.level);return Math.max(0,i.resourceDice+e.resourceDice.now+t)}calculateCommoditiesThisTurn(e){return{ore:e.mines.quantity+e.mines.resources,lumber:e.lumberCamps.quantity+e.lumberCamps.resources,luxuries:e.luxurySources.quantity+e.luxurySources.resources,stone:e.quarries.quantity+e.quarries.resources}}getRuin(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,{label:(0,n.capitalize)(e),...t,canReduce:0===t.value&&t.penalty>0}])))}getWorkSites(e){return{lumberCamps:{label:"Lumber",total:e.lumberCamps.quantity+e.lumberCamps.resources,...e.lumberCamps},mines:{label:"Ore",total:e.mines.quantity+e.mines.resources,...e.mines},quarries:{label:"Stone",total:e.quarries.quantity+e.quarries.resources,...e.quarries},luxurySources:{label:"Luxuries",total:e.luxurySources.quantity+e.luxurySources.resources,...e.luxurySources}}}getCommodities(e){const t=e.commodities.now,i=e.commodities.next,s=(0,_.getCapacity)(this.game,e);return Object.fromEntries(Object.entries(t).map((([e,t])=>[e,{label:(0,n.capitalize)(e),value:t,capacity:s[e],next:i[e]}])))}getLeaders(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[e,{label:(0,n.capitalize)(e),...t}])))}getAbilities(e,t,i){return Object.fromEntries(Object.entries(e).map((([e,s])=>[e,{label:(0,n.capitalize)(e),score:s,modifier:(0,g.calculateAbilityModifier)(s),invested:(0,v.isInvested)(e,t),investedBonus:(0,v.calculateInvestedBonus)(i,e,t)}])))}getFeats(e,t,i){const s=[],a=Object.fromEntries(e.map((e=>[e.level,e]))),r=o.allFeatsByName["-"];for(let e=1;e<=i;e+=1){const t=a[e];t&&t.id in o.allFeatsByName?s.push({...o.allFeatsByName[t.id],takenAt:e}):s.push({...r,takenAt:e})}return{featIds:(0,n.toLabelAndValue)(Object.keys(o.allFeatsByName)),levelFeats:s,bonusFeats:t.filter((e=>e.id in o.allFeatsByName)).map((e=>o.allFeatsByName[e.id]))}}async rollResourceDice(e,t){const i=await new Roll(t+e).roll();return await i.toMessage({flavor:"Rolling Resource Dice"}),i.total}async reduceUnrest(){const e=await new Roll("1d20").roll();await e.toMessage({flavor:"Reducing Unrest by 1 on an 11 or higher"}),e.total>10&&await this.saveKingdom({unrest:Math.max(0,this.getKingdom().unrest-1)})}calculateEventDC(e){return Math.max(1,11-5*e)}calculateCultEventDC(e){return Math.max(1,20-2*e)}calculateAnarchy(e,t){return e.some((e=>"Endure Anarchy"===e.id))||t.some((e=>"Endure Anarchy"===e.id))?19:16}async payConsumption(){const e=this.getKingdom(),t=(0,_.getConsumption)(this.game,e).current,i=e.commodities.now.food,s=t-i,a=5*s;t>0&&(await ChatMessage.create({content:`<h2>Paying Consumption</h2>\n            <ul>\n                <li>Reducing food commodities by ${Math.min(i,t)}</li>\n                ${s>0?`<li>Missing ${s} food commodities. Either pay ${(0,D.loseRP)(a)} or gain ${(0,D.gainUnrest)("1d4")}</li>`:""}\n            </ul>\n            `}),await this.saveKingdom({commodities:{now:{...e.commodities.now,food:Math.max(0,i-t)},next:e.commodities.next}}))}async saveKingdom(e){await(0,R.saveKingdom)(this.sheetActor,e)}getKingdom(){return(0,R.getKingdom)(this.sheetActor)}async claimedHexFeature(e){const t=this.getKingdom();if("refuge"===e)await ChatMessage.create({content:"Claimed a Refuge, please reduce a Ruin of your choice by 1"}),await this.saveKingdom({modifiers:[...t.modifiers,{name:"Claimed Refuge",enabled:!0,value:2,type:"circumstance",abilities:["loyalty","stability"],turns:2}]});else{const e=await new Roll("1d4").roll();await e.toMessage({flavor:"Claimed a Landmark, reducing Unrest by:"}),await this.saveKingdom({unrest:Math.max(0,t.unrest-e.total),modifiers:[...t.modifiers,{name:"Claimed Landmark",enabled:!0,value:2,type:"circumstance",abilities:["culture","economy"],turns:2}]})}}async viewSettlementScene(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.id,i=this.game.scenes?.filter((e=>e.id===t))?.[0];i&&(e.ctrlKey?(await(0,R.saveKingdom)(this.sheetActor,{activeSettlement:i.id}),await i.activate()):await i.view())}async showStructureBrowser(){await(0,I.showStructureBrowser)(this.game,this.getKingdom(),this.sheetActor,this.consumeModifiers.bind(this))}async showTacticsBrowser(){const e=(0,O.getSelectedArmies)(this.game);if(1!==e.length)ui.notifications?.error('Please target a single army on the scene (<i class="fa-solid fa-keyboard"></i> <b>t</b>)');else{const t=e[0];await(0,P.showArmyTacticsBrowser)({game:this.game,army:t,kingdom:this.getKingdom(),onRoll:this.consumeModifiers.bind(this),sheetActor:this.sheetActor})}}async showArmyBrowser(){await(0,F.showArmyBrowser)({game:this.game,kingdom:this.getKingdom(),onRoll:this.consumeModifiers.bind(this),sheetActor:this.sheetActor})}}t.showKingdom=async function e(t){const i=t?.actors?.find((e=>"Kingdom Sheet"===e.name));if(i){const e=(0,R.getKingdom)(i);new KingdomApp(e,{game:t,sheetActor:i}).render(!0)}else(0,h.setupDialog)(t,"Kingdom",(async()=>{const i=await Actor.create({type:"npc",name:"Kingdom Sheet",img:"icons/sundries/documents/document-sealed-red-yellow.webp"});await(i?.setFlag("pf2e-kingmaker-tools","kingdom-sheet",(0,a.getDefaultKingdomData)())),await e(t)}))}},8534:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateSkills=t.createSkillModifiers=void 0;const s=i(6185),a=i(6893),n=i(3824);function r({skill:e,ruin:t,unrest:i,skillRank:s,abilityScores:a,leaders:r,kingdomLevel:o,untrainedProficiencyMode:l,skillItemBonus:c,ability:u,activity:d,phase:m,additionalModifiers:h=[],overrides:p={},activities:f}){const g=(0,n.createAbilityModifier)(u,a),y=(0,n.createProficiencyModifier)(s,l,o),v=(0,n.createVacancyModifiers)(u,r),b=(0,n.createInvestedModifier)(o,u,r),k=c?(0,n.createStructureModifiers)(c,f):[],w=(0,n.createUnrestModifier)(i),S=(0,n.createRuinModifier)(u,t),x=[g,y,...v,...k,...h];return S&&x.push(S),w&&x.push(w),b&&x.push(b),(0,n.processModifiers)({modifiers:x,skill:e,rank:s,phase:m,activity:d,overrides:p,activities:f})}t.createSkillModifiers=r,t.calculateSkills=function({ruin:e,unrest:t,skillRanks:i,abilityScores:o,leaders:l,kingdomLevel:c,untrainedProficiencyMode:u,skillItemBonuses:d,additionalModifiers:m,activities:h}){return a.allSkills.map((p=>{const f=a.skillAbilities[p],g=r({ruin:e,unrest:t,skillRank:i[p],abilityScores:o,leaders:l,kingdomLevel:c,untrainedProficiencyMode:u,ability:f,skillItemBonus:d?.[p],skill:p,additionalModifiers:m,activities:h}),y=(0,n.calculateModifiers)(g);return{skill:p,rank:i[p],ability:f,skillLabel:(0,s.capitalize)(p),abilityLabel:(0,s.capitalize)(f),total:y}}))}},4767:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.saveKingdom=t.getKingdom=void 0;const s=i(6185);function a(e){const t=e.getFlag("pf2e-kingmaker-tools","kingdom-sheet");return console.log(t),t}t.getKingdom=a,t.saveKingdom=async function(e,t){const i=a(e);!function(e){const t=e.ruin;void 0!==t&&(t.corruption.penalty=Math.abs(t.corruption.penalty),t.crime.penalty=Math.abs(t.crime.penalty),t.decay.penalty=Math.abs(t.decay.penalty),t.strife.penalty=Math.abs(t.strife.penalty))}(t),await async function(e,t){const i=e.milestones;if(void 0!==i){const a=t.milestones,n=(0,s.groupBy)(a,(e=>e.name)),r=(0,s.groupBy)(i,(e=>e.name));for(const i of n.keys()){const s=n.get(i)?.[0],a=r.get(i)?.[0];if(void 0!==a&&void 0!==s&&a.completed!==s.completed){const i=a.completed?a.xp:-a.xp,s=a.completed?"Gained":"Lost";await ChatMessage.create({content:`${s} ${Math.abs(i)} Kingdom XP`}),e.xp=t.xp+i}}}}(t,i),console.info("Saving",t),await e.setFlag("pf2e-kingmaker-tools","kingdom-sheet",t)}},5302:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.showStructureHints=t.groupAvailableItems=t.calculateAvailableItems=t.evaluateStructures=t.includeCapital=t.getSettlementConfig=t.settlementTypeData=t.groupStructures=t.countStructureOccurrences=void 0;const s=i(6185),a=i(1290),n=i(6690),r=i(1098),o=i(5281);function l(e){return t=e=>e.stacksWith??e.name,e.reduce(((e,i)=>{const s=t(i),a=(e.get(s)?.count??0)+1;return e.set(s,{count:a,item:i})}),new Map);var t}function c(e,t){const i=l(e);return Array.from(i.values()).map((e=>{const i=e.item,s={...i,skillBonusRules:i?.skillBonusRules?.map((i=>({...i,value:Math.min(i.value*e.count,t)}))),availableItemsRules:i?.availableItemsRules?.map((t=>{const i=void 0===t.maximumStacks?e.count:Math.min(e.count,t.maximumStacks),s=t.value*i;return{...t,value:s}})),settlementEventRules:i?.settlementEventRules?.map((i=>({...i,value:Math.min(i.value*e.count,t)}))),leadershipActivityRules:i?.leadershipActivityRules?.map((i=>({...i,value:Math.min(i.value*e.count,t)})))};return s}))}function u(e,t,i="never-stack"){const a=e.flatMap((e=>e.availableItemsRules??[])).filter((e=>e.group===t)).map((e=>e.value));return"always-stack"===i?(0,s.sum)(a):Math.max(...a,0)}function d(e,t){return e.map((e=>{const i=function(e,t){return e.flatMap((e=>{const i=e.activity;return(0,a.getActivitySkills)(t[i].skills).map((t=>({value:e.value,skill:t,activity:i})))}))}(e.activityBonusRules??[],t);return{...e,skillBonusRules:[...e.skillBonusRules??[],...i]}}))}function m(e){return{...t.settlementTypeData.find((t=>e>=t.levelFrom&&e<=(t.levelTo??Number.MAX_SAFE_INTEGER))),level:e}}function h(e,t){const i=e.value>t.value?e.value:t.value,a=(0,s.mergePartialObjects)(e.activities,t.activities,((e,t)=>Math.max(e??0,t??0))),n=Object.fromEntries(Object.entries(a).filter((([,e])=>(e??0)>i)));return{value:i,activities:n}}function p(e,t,i){const s={},a=e[t];return i.forEach((t=>{const i=e[t];i!==a&&(s[t]=i)})),s}t.countStructureOccurrences=l,t.groupStructures=c,t.settlementTypeData=[{type:"Village",consumption:1,influence:0,maximumLots:"1",requiredKingdomLevel:1,levelFrom:1,levelTo:1,maxItemBonus:1,population:"400 or less"},{type:"Town",consumption:2,influence:1,requiredKingdomLevel:3,maximumLots:"4",levelFrom:2,levelTo:4,maxItemBonus:1,population:"401-2000"},{type:"City",consumption:4,influence:2,requiredKingdomLevel:9,maximumLots:"9",levelFrom:5,levelTo:9,maxItemBonus:2,population:"2001–25000"},{type:"Metropolis",consumption:6,influence:3,maximumLots:"10+",requiredKingdomLevel:15,levelFrom:10,maxItemBonus:3,population:"25001+"}],t.getSettlementConfig=m,t.includeCapital=function(e,t){return{...t,increaseLeadershipActivities:e.increaseLeadershipActivities,unlockActivities:e.unlockActivities.concat(t.unlockActivities),leadershipActivityBonus:Math.max(e.leadershipActivityBonus,t.leadershipActivityBonus),skillBonuses:(0,s.mergeObjects)(e.skillBonuses,t.skillBonuses,h)}},t.evaluateStructures=function(e,t,i,s){const a=m(t),n=a.maxItemBonus,r=e.some((e=>!0===e.enableCapitalInvestment)),o=Array.from(new Set(e.flatMap((e=>e.notes??[])))),l=function(e){const t=new Map;return e.filter((e=>e.consumptionReduction)).forEach((e=>{const i=e.name,s=t.get(i),a=e?.consumptionReduction??0;(void 0===s||s<a)&&t.set(i,a)})),Array.from(t.values()).reduce(((e,t)=>e+t),0)}(e),h={config:a,allowCapitalInvestment:r,notes:o,skillBonuses:{agriculture:{value:0,activities:{}},arts:{value:0,activities:{}},boating:{value:0,activities:{}},defense:{value:0,activities:{}},engineering:{value:0,activities:{}},exploration:{value:0,activities:{}},folklore:{value:0,activities:{}},industry:{value:0,activities:{}},intrigue:{value:0,activities:{}},magic:{value:0,activities:{}},politics:{value:0,activities:{}},scholarship:{value:0,activities:{}},statecraft:{value:0,activities:{}},trade:{value:0,activities:{}},warfare:{value:0,activities:{}},wilderness:{value:0,activities:{}}},itemLevelBonuses:{divine:0,alchemical:0,primal:0,occult:0,arcane:0,magical:0,other:0,luxuryOccult:0,luxuryArcane:0,luxuryDivine:0,luxuryMagical:0,luxuryPrimal:0},settlementEventBonus:0,leadershipActivityBonus:0,storage:{ore:0,food:0,lumber:0,luxuries:0,stone:0},increaseLeadershipActivities:e.some((e=>!0===e.increaseLeadershipActivities)),consumptionReduction:l,consumption:Math.max(0,a.consumption-l),consumptionSurplus:Math.max(0,l-a.consumption),unlockActivities:[],residentialLots:e.filter((e=>e?.traits?.includes("residential"))).map((e=>e.lots)).reduce(((e,t)=>e+t),0),lots:e.map((e=>e.lots)).reduce(((e,t)=>e+t),0),hasBridge:e.some((e=>e.isBridge))},p=d(e,s);!function(e,t){t.filter((e=>e.storage)).forEach((t=>{["ore","lumber","food","stone","luxuries"].forEach((i=>{const s=t.storage;s&&i in s&&(e[i]+=s[i]??0)}))}))}(h.storage,e);const f=c(p,n),g="all-structures-stack"===i?function(e,t){const i=e.flatMap((e=>e.skillBonusRules??[])),s=i.filter((e=>e.activity)),a=i.filter((e=>!e.activity)),n=new Map;a.forEach((e=>{const i=n.get(e.skill)??0;n.set(e.skill,Math.min(t,i+e.value))}));const r=new Map;return s.forEach((e=>{const i=e.skill;r.set(i,r.get(i)??new Map);const s=e.activity,a=r.get(i)?.get(s)??0,n=Math.min(t,a+e.value);r.get(i)?.set(s,n)})),Array.from(r.keys()).forEach((e=>{const i=r.get(e)??new Map;Array.from(i.keys()).forEach((s=>{const a=i.get(s)??0,o=Math.min(t,a+(n.get(e)??0));r.get(e)?.set(s,o)}))})),e.map((e=>({...e,skillBonusRules:e.skillBonusRules?.map((e=>{const t=e.activity?r.get(e.skill)?.get(e.activity):n.get(e.skill);return{...e,value:t??0}}))})))}(f,n):f;return function(e,t){t.flatMap((e=>e?.unlockActivities??[])).forEach((t=>{e.push(t)}))}(h.unlockActivities,g),function(e,t){t.forEach((t=>{t.settlementEventRules?.forEach((t=>{t.value>e.settlementEventBonus&&(e.settlementEventBonus=t.value)}))}))}(h,g),function(e,t){t.forEach((t=>{t.leadershipActivityRules?.forEach((t=>{t.value>e.leadershipActivityBonus&&(e.leadershipActivityBonus=t.value)}))}))}(h,g),function(e,t){t.forEach((t=>{t.skillBonusRules?.forEach((t=>{const i=e[t.skill];t.activity||t.value>i.value&&(i.value=t.value)}))})),t.forEach((t=>{t.skillBonusRules?.forEach((t=>{const i=e[t.skill],s=t.activity;s&&t.value>i.value&&t.value>(i.activities[s]??0)&&(i.activities[s]=t.value)}))}))}(h.skillBonuses,g),function(e,t){const i=t.some((e=>!0===e.preventItemLevelPenalty))?0:-2,s=u(t,void 0,"always-stack"),a=u(t,"alchemical"),n=u(t,"luxury"),r=u(t,"magical"),o=u(t,"divine"),l=u(t,"primal"),c=u(t,"arcane"),d=u(t,"occult");e.other=s+i,e.alchemical=a+e.other,e.magical=r+e.other,e.divine=e.magical+o,e.primal=e.magical+l,e.arcane=e.magical+c,e.occult=e.magical+d,e.luxuryMagical=e.magical+n,e.luxuryOccult=e.occult+n,e.luxuryArcane=e.arcane+n,e.luxuryPrimal=e.primal+n,e.luxuryDivine=e.divine+n}(h.itemLevelBonuses,g),h},t.calculateAvailableItems=function(e,t,i=0){return{alchemical:e.alchemical+t,magical:e.magical+i+t,luxuryMagical:e.luxuryMagical+i+t,arcane:e.arcane+i+t,luxuryArcane:e.luxuryArcane+i+t,divine:e.divine+i+t,luxuryDivine:e.luxuryDivine+i+t,occult:e.occult+i+t,luxuryOccult:e.luxuryOccult+i+t,primal:e.primal+i+t,luxuryPrimal:e.luxuryPrimal+i+t,other:e.other+t}},t.groupAvailableItems=function(e){return{other:e.other,...p(e,"luxuryMagical",["luxuryArcane","luxuryDivine","luxuryOccult","luxuryPrimal"]),...p(e,"magical",["arcane","divine","occult","primal","luxuryMagical"]),...p(e,"other",["magical","alchemical"])}},t.showStructureHints=async function(e,t){if((0,s.isFirstGm)(e)&&t&&(0,r.isStructureActor)(t)){const e=(0,r.getStructureFromActor)(t);if(e){const t=[],i=e.reduceUnrestBy;if(i){const e=i.moreThanOncePerTurn?"Each time you build this structure ":"The first time you build this structure each turn ",s=void 0===i.note?"":` ${i.note}`;t.push(e+(0,n.loseUnrest)(i.value)+s)}const a=e.reduceRuinBy;if(a){const e=a.moreThanOncePerTurn?"Each time you build this structure ":"The first time you build this structure each turn ",i=a.value;"any"===a.ruin?t.push(`${e}choose one of: <ul>${o.allRuins.map((e=>`<li>${(0,n.loseRuin)(e,i)}</li>`)).join("")}</ul>`):t.push(e+(0,n.loseRuin)(a.ruin,i))}const r=e.gainRuin;if(r){const e=r.moreThanOncePerTurn?"Each time you build this structure ":"The first time you build this structure each turn ",i=r.value;"any"===r.ruin?t.push(`${e}choose one of: <ul>${o.allRuins.map((e=>`<li>${(0,n.gainRuin)(e,i)}</li>`)).join("")}</ul>`):t.push(e+(0,n.gainRuin)(r.ruin,i))}t.length>0&&await(0,s.postChatMessage)(t.map((e=>`<div>${e}</div>`)).join(""))}}}},8796:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.calculateEventXP=t.calculateRpXP=t.calculateHexXP=void 0,t.calculateHexXP=function({hexes:e,kingdomSize:t,useVK:i,xpPerClaimedHex:s}){return i?t<10?80*e:t<25?50*e:t<50?25*e:t<100?10*e:5*e:e*s},t.calculateRpXP=function({rp:e,kingdomLevel:t,rpToXpConversionRate:i,rpToXpConversionLimit:s,useVK:a}){let n=0;return a?t<5?n=8*e:t<9?n=6*e:t<13?n=4*e:t<17&&(n=2*e):n=e*i,Math.min(s,n)},t.calculateEventXP=function(e){const t={"-4":10,"-3":15,"-2":20,"-1":30,0:30,1:30,2:40,3:60,4:80},i=`${e}`;return i in t?t[i]:0}},6375:(e,t)=>{"use strict";function i(e){return e?.tables?.map((e=>e))??[]}function s(e){const t=i(e);return Object.fromEntries(t.map((e=>[`RollTable.${e.id}`,e.name])))}function a(e,t){return Object.entries(s(e)).filter((([e,i])=>i===t)).map((([e])=>e))[0]}async function n(e,t,i="pf2e-kingmaker-tools.kingmaker-tools-rolltables"){return(await r(e,i))[t]}async function r(e,t="pf2e-kingmaker-tools.kingmaker-tools-rolltables"){const i=await e.packs.get(t,{strict:!0}),s=await i.getDocuments({});return Object.fromEntries(s.map((e=>[e.name,`Compendium.${t}.${e.id}`])))}Object.defineProperty(t,"__esModule",{value:!0}),t.buildUuids=t.rollRollTable=t.findCompendiumTableUuid=t.findWorldTableUuid=t.getWorldTableUuidMappings=t.getWorldTables=t.findRollTableUuidWithFallback=void 0,t.findRollTableUuidWithFallback=async function(e,t,i="pf2e-kingmaker-tools.kingmaker-tools-rolltables"){const s=a(e,t),r=await n(e,t,i);return console.log(`Looking up ${t} in ${i}, world: ${s}, compendium: ${r}`),s??r},t.getWorldTables=i,t.getWorldTableUuidMappings=s,t.findWorldTableUuid=a,t.findCompendiumTableUuid=n,t.rollRollTable=async function(e,t,i){const s=await fromUuid(t);if(s&&s instanceof RollTable)return{table:s,draw:await s.draw(i)};throw new Error(`Could not find table with uuid ${t}`)},t.buildUuids=r},1451:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setSetting=t.getBooleanSetting=t.getStringSetting=t.getNumberSetting=void 0;const i="pf2e-kingmaker-tools";t.getNumberSetting=function(e,t){return e.settings.get(i,t)??0},t.getStringSetting=function(e,t){return e.settings.get(i,t)??""},t.getBooleanSetting=function(e,t){return e.settings.get(i,t)??!1},t.setSetting=async function(e,t,s){await e.settings.set(i,t,s)}},6185:(e,t,i)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasArmyTactic=t.toLabelAndValue=t.rollModeChoices=t.decodeJson=t.encodeJson=t.isNonNullable=t.sum=t.isKingmakerInstalled=t.blankToUndefined=t.isBlank=t.isNotBlank=t.slugifyable=t.deCamelCase=t.clamped=t.parseCheckbox=t.parseRadio=t.parseSelect=t.parseTextInput=t.parseNumberInput=t.createLabels=t.listenClick=t.createLabel=t.distinctBy=t.groupBy=t.range=t.mergePartialObjects=t.mergeObjects=t.unslugify=t.loreToLoreSkill=t.slugify=t.postChatMessage=t.unpackFormArray=t.capitalize=t.postDegreeOfSuccessMessage=t.roll=t.createUUIDLink=t.getLevelBasedDC=t.isGm=t.isFirstGm=t.escapeHtml=void 0;const s=i(9884),a=i(8127),n=i(4913);function r(e,t=!1){return e===s.DegreeOfSuccess.CRITICAL_SUCCESS?`<span class="${t?"strike-through":""}">Critical Success</span>`:e===s.DegreeOfSuccess.SUCCESS?`<span class="${t?"strike-through":""}">Success</span>`:e===s.DegreeOfSuccess.FAILURE?`<span class="${t?"strike-through":""}">Failure</span>`:`<span class="${t?"strike-through":""}">Critical Failure</span>`}function o(e){return e[0].toUpperCase()+e.substring(1)}async function l(e,t){const i={content:e};t&&ChatMessage.applyRollMode(i,t),await ChatMessage.create(i)}function c(e){return e.trim().replaceAll(" ","-").toLowerCase()}function u(e){return e.replaceAll("action:","").split("-").map((e=>o(e))).join(" ")}function d(e,t=!1){return{label:t?u(e):o(e),value:e}}function m(e){return!h(e)}function h(e){return null==e||0===e.trim().length}t.escapeHtml=function(e){const t=document.createTextNode(e),i=document.createElement("p");return i.appendChild(t),i.innerHTML},t.isFirstGm=function(e){return e?.user?.id===e.users?.find((e=>e.isGM&&e.active))?.id},t.isGm=function(e){return void 0!==e.users?.find((t=>t.isGM&&t.active&&t.id===e?.user?.id))},t.getLevelBasedDC=function(e){return 14+e+Math.floor(e/3)},t.createUUIDLink=function(e,t){return void 0===t?`@UUID[${e}]`:`@UUID[${e}]{${t}}`},t.roll=async function(e,t){const i=await new Roll(e).evaluate();return await i.toMessage({flavor:t}),i.total},t.postDegreeOfSuccessMessage=async function({degreeOfSuccess:e,upgradedDegreeOfSuccess:t,messageConfig:i,beforeHeader:a}){const n=function(e,t){return void 0===t?`<b>${r(e)}</b>`:`<b>${r(e,!0)} ${r(t)}</b>`}(e,t),o=t??e;let c="";o===s.DegreeOfSuccess.CRITICAL_SUCCESS&&void 0!==i.critSuccess?c=`${i.critSuccess}`:o===s.DegreeOfSuccess.SUCCESS&&void 0!==i.success?c=`${i.success}`:o===s.DegreeOfSuccess.FAILURE&&void 0!==i.failure?c=`${i.failure}`:o===s.DegreeOfSuccess.CRITICAL_FAILURE&&void 0!==i.critFailure&&(c=`${i.critFailure}`);const u=(a??"")+[n,c].filter((e=>m(e))).join(": ");m(u)&&await l(u.trimEnd(),i.rollMode??(i.isPrivate?"blindroll":"publicroll"))},t.capitalize=o,t.unpackFormArray=function(e){return e?Object.keys(e).map((e=>parseInt(e,10))).sort(((e,t)=>e-t)).map((e=>`${e}`)).map((t=>e[t])):[]},t.postChatMessage=l,t.slugify=c,t.loreToLoreSkill=function(e){return c(e.replace(/\s[lL]ore$/,""))},t.unslugify=u,t.mergeObjects=function(e,t,i){const s=[];for(const a of[...Object.keys(e),...Object.keys(t)])a in e&&a in t?s.push([a,i(e[a],t[a])]):a in e?s.push([a,e[a]]):a in t&&s.push([a,t[a]]);return Object.fromEntries(s)},t.mergePartialObjects=function(e,t,i){const s=[];for(const a of[...Object.keys(e),...Object.keys(t)])a in e&&a in t?s.push([a,i(e[a],t[a])]):a in e?s.push([a,e[a]]):a in t&&s.push([a,t[a]]);return Object.fromEntries(s)},t.range=function(e,t){const i=[];for(let s=e;s<t;s+=1)i.push(s);return i},t.groupBy=function(e,t){const i=new Map;for(const s of e){const e=t(s),a=i.get(e);a?a.push(s):i.set(e,[s])}return i},t.distinctBy=function(e,t){const i=new Set,s=[];for(const a of e){const e=t(a);i.has(e)||(s.push(a),i.add(e))}return s},t.createLabel=d,t.listenClick=function(e,t,i){e.querySelectorAll(t).forEach((e=>{e.addEventListener("click",(async e=>await i(e)))}))},t.createLabels=function(e,t=!1){return e.map((e=>d(e,t)))},t.parseNumberInput=function(e,t){const i=e.querySelector(`input[name="${t}"]`);return parseInt(i.value,10)},t.parseTextInput=function(e,t){const i=e.querySelector(`input[name="${t}"]`);return i.value?.trim()},t.parseSelect=function(e,t){return e.querySelector(`select[name="${t}"]`).value},t.parseRadio=function(e,t){const i=Array.from(e.querySelectorAll(`input[name="${t}"]`));return i.find((e=>e.checked))?.value??null},t.parseCheckbox=function(e,t){return e.querySelector(`input[name="${t}"]`).checked},t.clamped=function(e,t,i){return Math.min(Math.max(e,t),i)},t.deCamelCase=function(e){const t=e.trim();return""===t?"":t.replace(/([a-z])([A-Z])/g,"$1 $2").split(" ").map(o).join(" ")},t.slugifyable=function(e){return/^([a-zA-Z0-9]*)(\s[a-zA-Z0-9]*)*$/.test(e)},t.isNotBlank=m,t.isBlank=h,t.blankToUndefined=function(e){if(!h(e))return e},t.isKingmakerInstalled=function(e){return!0===e.modules.get("pf2e-kingmaker")?.active},t.sum=function(e){return e.reduce(((e,t)=>e+t),0)},t.isNonNullable=function(e){return null!=e},t.encodeJson=function(e){return(0,a.encode)(JSON.stringify(e))},t.decodeJson=function(e){return JSON.parse((0,a.decode)(e))},t.rollModeChoices={publicroll:"Public Roll",gmroll:"Private GM Roll",blindroll:"Blind GM Roll",selfroll:"Self Roll"},t.toLabelAndValue=function(e,{capitalizeLabel:t=!1,emptyChoice:i}={}){return[...void 0===i?[]:[{label:i,value:i}],...e.map((e=>{const i=e.toString();return{label:t?i.capitalize():i,value:e.toString()}}))]},t.hasArmyTactic=function(e,t){return e.items.some((e=>(0,n.isArmyTactic)(e)&&e.name===t.name))}}},t={};function i(s){var a=t[s];if(void 0!==a)return a.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,i),n.exports}i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();(()=>{"use strict";const e=i(6185),t=i(3897),s=i(4767),a=i(1694),n=i(9602),r=i(4913),o=i(623),l=i(5302);function c(e){return e?.actors?.find((e=>"Kingdom Sheet"===e.name))}function u(e,t,i){const s=c(e);s?i(s):ui.notifications?.error("Could not find actor with name Kingdom Sheet")}Hooks.on("ready",(async()=>{if(game instanceof Game){const i=game;i.pf2eKingmakerTools.macros.structureTokenMappingMacro=o.structureTokenMappingDialog.bind(null,game),i.pf2eKingmakerTools.macros.viewKingdomMacro=t.showKingdom.bind(null,game),i.settings.register("pf2e-kingmaker-tools","rpToXpConversionRate",{default:1,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","rpToXpConversionLimit",{default:120,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","xpPerClaimedHex",{default:10,config:!1,type:Number,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","cultOfTheBloomEvents",{default:!0,config:!1,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","autoCalculateSettlementLevel",{default:!0,config:!1,type:Boolean,scope:"world"}),i.settings.register("pf2e-kingmaker-tools","kingdomEventRollMode",{name:"Kingdom Events Roll Mode",scope:"world",config:!1,default:"gmroll",type:String,choices:e.rollModeChoices}),i.settings.register("pf2e-kingmaker-tools","vanceAndKerensharaXP",{name:"Enable Vance and Kerenshara XP rules",hint:"Adds additional Milestone Events, more XP for claiming hexes and RP",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","capitalInvestmentInCapital",{name:"Enable Capital Investment without Bank in Capital",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","reduceDCToBuildLumberStructures",{name:"Reduce DC to Build Lumber Structures",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","automateResources",{name:"Automatically sum worksites and farmlands",scope:"world",config:!1,default:"kingmaker",requiresReload:!0,type:String,choices:{kingmaker:"Kingmaker",tileBased:"Tile Based",manual:"Manual"}}),i.settings.register("pf2e-kingmaker-tools","kingdomAlwaysAddHalfLevel",{name:"Always add half Level to Skill",hint:"If enabled, always adds half of the kingdom's level to a skill, even if it is untrained",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomAlwaysAddLevel",{name:"Always add Level to Skill",hint:"If enabled, always adds the kingdom's level to a skill, even if it is untrained. Overrides Always add half Level to Skill",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomSkillIncreaseEveryLevel",{name:"Double Skill Increases",hint:"If enabled, adds Skill Increases for all even levels from level 2 onwards",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomAllStructureItemBonusesStack",{name:"All Structure Item Bonuses Stack",hint:"If enabled, groups item bonuses from all structures, regardless of if they are same building type",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","kingdomIgnoreSkillRequirements",{name:"Ignore Skill Proficiency Requirements for Kingdom Activities",scope:"world",config:!1,default:!1,requiresReload:!0,type:Boolean}),i.settings.register("pf2e-kingmaker-tools","autoCalculateArmyConsumption",{name:"Automatically Calculate Army Consumption",hint:"If enabled, gets all visible army tokens on all scenes and sums up their consumption",scope:"world",config:!1,default:!0,requiresReload:!0,type:Boolean});const s=async e=>{await(0,r.updateKingdomArmyConsumption)({actor:e,kingdomActor:c(i),game:i})},a=async()=>{await(0,r.updateKingdomArmyConsumption)({forceUpdate:!0,kingdomActor:c(i),game:i})};Hooks.on("createToken",(e=>{(0,l.showStructureHints)(game,e.actor),s(e.actor)})),Hooks.on("updateToken",(e=>s(e.actor))),Hooks.on("deleteToken",(e=>s(e.actor))),Hooks.on("updateActor",(e=>s(e))),Hooks.on("updateItem",(e=>s(e.actor))),Hooks.on("createItem",(e=>s(e.actor))),Hooks.on("deleteItem",(e=>s(e.actor))),Hooks.on("deleteScene",(()=>a())),function(e){const t=c(e);t&&!t.getFlag("pf2e-kingmaker-tools","kingdom-sheet")&&ui.notifications?.error('Found an Actor with name "Kingdom Sheet" that has not been imported using the "View Kingdom" Macro! Please delete the actor and re-import it.')}(i),i.socket.on("module.pf2e-kingmaker-tools",(async e=>{"openKingdomSheet"===e.action&&await(0,t.showKingdom)(i)}))}})),Hooks.on("init",(async()=>{await loadTemplates(["modules/pf2e-kingmaker-tools/templates/common/skills.partial.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/structure-browser-item.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/sidebar.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/status.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/skills.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/turn.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/groups.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/feats.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/notes.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/settlements.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/settlement.hbs","modules/pf2e-kingmaker-tools/templates/kingdom/effects.hbs"])})),Hooks.on("renderChatLog",(()=>{if(game instanceof Game){const e=game,t=$("#chat-log");for(const i of n.kingdomChatButtons)t.on("click",i.selector,(t=>{const s=c(e);if(s)return i.callback(e,s,t)}))}})),Hooks.on("getChatLogEntryContext",((e,t)=>{if(game instanceof Game){const e=game,i=()=>void 0!==c(e),n=e=>i()&&null!==e[0].querySelector(".content-link"),r=e=>i()&&null!==e[0].querySelector(".km-roll-meta"),o=(e,t)=>{const s="upgrade"===t?"criticalSuccess":"criticalFailure",n=e.querySelector(".km-upgrade-result");return i()&&null!==n&&(0,a.parseUpgradeMeta)(e).degree!==s},l=t=>{const i=c(e);return!!i&&((0,s.getKingdom)(i).fame.now>0&&r(t))},d=t=>{const i=c(e);return!!i&&((0,s.getKingdom)(i).creativeSolutions>0&&r(t))},m=t=>{const i=c(e);return!!i&&((0,s.getKingdom)(i).supernaturalSolutions>0&&r(t))};t.push({name:"Re-Roll Using Fame/Infamy",icon:'<i class="fa-solid fa-dice-d20"></i>',condition:l,callback:t=>u(e,t[0],(e=>(0,a.reRoll)(e,t[0],"fame")))},{name:"Re-Roll Using Creative Solution",icon:'<i class="fa-solid fa-dice-d20"></i>',condition:d,callback:t=>u(e,t[0],(e=>(0,a.reRoll)(e,t[0],"creative-solution")))},{name:"Re-Roll Using Supernatural Solution",icon:'<i class="fa-solid fa-dice-d20"></i>',condition:m,callback:t=>u(e,t[0],(e=>(0,a.reRoll)(e,t[0],"supernatural-solution")))},{name:"Re-Roll",condition:r,icon:'<i class="fa-solid fa-dice-d20"></i>',callback:t=>u(e,t[0],(e=>(0,a.reRoll)(e,t[0],"re-roll")))},{name:"Re-Roll Keep Higher",condition:r,icon:'<i class="fa-solid fa-dice-d20"></i>',callback:t=>u(e,t[0],(e=>(0,a.reRoll)(e,t[0],"keep-higher")))},{name:"Re-Roll Keep Lower",condition:r,icon:'<i class="fa-solid fa-dice-d20"></i>',callback:t=>u(e,t[0],(e=>(0,a.reRoll)(e,t[0],"keep-lower")))},{name:"Upgrade Degree of Success",condition:e=>o(e[0],"upgrade"),icon:'<i class="fa-solid fa-arrow-up"></i>',callback:t=>u(e,t[0],(e=>(0,a.changeDegree)(e,t[0],"upgrade")))},{name:"Downgrade Degree of Success",condition:e=>o(e[0],"downgrade"),icon:'<i class="fa-solid fa-arrow-down"></i>',callback:t=>u(e,t[0],(e=>(0,a.changeDegree)(e,t[0],"downgrade")))},{name:"Add to Ongoing Events",icon:'<i class="fa-solid fa-plus"></i>',condition:n,callback:async t=>{u(e,t[0],(async e=>{const i=t[0].querySelector(".content-link"),s=i?.dataset?.uuid,n=i?.innerText;s&&n&&await(0,a.addOngoingEvent)(e,s,n)}))}})}}))})()})();
//# sourceMappingURL=main.js.map